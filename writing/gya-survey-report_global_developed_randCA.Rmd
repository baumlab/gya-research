---
title: "Developed countries online survey on fundamental research (only 340 Canadian)"
author: ''
date: " 2018"
output:
  pdf_document: null
  fig_width: 18
  html_document: default
  word_document: default
  fig_height: 4
---

**Introduction**  
We developed and ran a quantitative online survey to query researchers about their perceptions of, and experiences with, funding for fundamental research. An important aim of the survey was to provide an understanding researcher's personal experiences and outlook on the research funding landscape. We had an excellent response to the survey, with over xxxx  researchers completing it, suggesting that fundamental research funding is a high priority topic for researchers. Herein, we detail the survey questions and results. 

**Methods**  
Online Survey  
The survey was open to researchers from all disciplines (e.g. science, social sciences, humanities, engineering, medicine) and career stages, with the proviso that they had some experience applying for research funding. The survey gathered detailed information in four major areas: 1) the types of research the scholars conduct (fundamental, use-inspired, applied), 2) the extent of external partnerships in their research, 3) their grant success rates, and 4) how important they perceive fundamental research is to the  federal government and its future prospects in . The survey also enquired how each of these factors have changed over time for the researchers. Finally, the survey gathered basic information from each respondent about gender, discipline, career stage and the year their PhD was obtained. The full survey is provided in Appendix 2. 

The online survey was open from the end of May through xxxxxxx , and ran on the Fluid Surveys platform (fluidsurveys.com). Note that the survey was open to researchers from any country in the world because it is was run as part of a global survey through the Global Young Academy. To disseminate the survey to researchers, we gathered email addresses from  university websites for as many faculty members as possible and emailed individual researchers directly. We also shared the survey broadly on social media, as well as through the Global Young Academy network, on scientific list serves, and through personal connections. 

Survey Data Analysis  

**Note that numbers not all the same because respondents did not always answer every question**
```{r message=FALSE, warning=FALSE, include=FALSE, loading_data, warning=FALSE, paged.print=FALSE}
rm(list=ls())

dev.off()

#<!-- Import Canadian data, calculate sample sizes -->
 ## CHANGE WORKING DIRECTORY FOR YOUR LOCAL MACHINE BEFORE KNITTING ##
setwd("/Users/kristinatietjen/Documents/git_hub/gya-research/writing")
#setwd("/Users/IMAC3/Documents/git-jpwrobinson/gya-research")
#setwd("/Users/jpwrobinson/Documents/git_repos/gya-research")
#setwd("/Users/Julia_2013MacBookAir/Desktop/GitRepos/gya-research/writing")
## load in survey data
survey<-read.csv(file="../data/gya-without-incomplete.csv")
#Count how many responses from  researchers
survey.what<-read.csv(file="../data/gya-country-responses.csv")
research<-read.csv(file="../data/gya-surveys-cleaned-research.csv")
#research.past<-read.csv(file="data/gya-surveys-cleaned-research-past.csv")
research.change<-read.csv(file="../data/gya-change-reason.csv")
part4<-read.csv(file="../data/gya-survey-part4.csv")
part2.b.a<-read.csv(file="../data/gya-part2.before.after.csv")
part2.change<-read.csv(file="../data/gya-part2.change.csv")
part2.reason<-read.csv(file="../data/gya-part2.reason.csv")
part2.view<-read.csv(file="../data/gya-part2.view.csv")
part1.view<-read.csv(file="../data/gya-part1.view.csv")
part3.change<-read.csv(file="../data/gya-part3.change.csv")
part3.grants.long<-read.csv(file="../data/gya-part3.grants.long.csv")
part3.success.long<-read.csv(file="../data/gya-part3.success.long.csv")
part3.prac.long<-read.csv(file="../data/gya-part3.prac.long.csv")
part3.part.long<-read.csv(file="../data/gya-part3.part.long.csv")
p3_master.long<-read.csv(file="../data/gya-p3_master.long.csv")
p3_master <- read.csv(file="../data/gya-p3_master.csv")

##selecting for developed countries
developed<-c("Canada","Australia", "Israel", "Barbados","Russia","Germany", "United Kingdom", "Netherlands", "Japan","United States", "Taiwan","New Zealand","France", "Switzerland", "Poland",              
 "Portugal", "Italy",  "Belgium",  "Norway", "Finland", "Greece","Cyprus",  "Hungary", "Spain","Singapore", "Korea, South","Romania", "Denmark","Austria", "Sweden",                
 "Estonia", "Malta" )

n.gbl.devp<-survey[survey$nation%in% developed,]
#dim(n.gbl.devp)  #2641  79


## now to randomly select for 340 canadian surveys so it does not scew the data 
#create two data frames 1:Canadian   2: non Canadian
#1: Canadian
ca <- n.gbl.devp[n.gbl.devp$nation == "Canada",]
#head(ca)
ca<-droplevels(ca)
#unique(ca$nation)

#2: others
other <- n.gbl.devp[!n.gbl.devp$nation == "Canada",]
#head(other)
other<- droplevels(other)
#unique(other$nation)

#now randomly select 340 Canadian
# dim(ca) #528   16
# randca <- ca[sample(nrow(ca), 340), ]
# dim(randca)  #340  16     188 subtracted
# randcaid<-unique(randca$id)  # now use this to select from for all future so it doesnt change everytime i run the code
#write a csv (then comment it out) with the data so it stays permanent
#write.csv(randcaid, "data/gya_survey_response_developed_randCA_IDs.csv", row.names = FALSE)

#now read in the csv so it will be the same random surveys from here on out
randcaid <- read.csv("data/gya_survey_response_developed_randCA_IDs.csv", col.names = TRUE)
randid <- unique(randcaid$TRUE.)
#head(randid)

randca <- ca[ca$id %in% randid,]
#head(randca)
#dim(randca)  #340   16
#dim(ca)   #1331  16   subtracted 991

#now combine them back together
n.gbl.devp <- rbind(randca, other)
#head(n.gbl.devp)
#dim(n.gbl.devp)  # 1650   16    991 subtracted so we are good to go

#Count how many responses from researchers 

#Gender:
n.gbl.res.men <- n.gbl.devp[n.gbl.devp$gender=="Male",]               #Count how many responses from  male researchers
percent.men<-((dim(n.gbl.res.men)[1])/(dim(n.gbl.devp)[1]))*100      #Calculate the % of responses from  male researchers
n.gbl.res.women <- n.gbl.devp[n.gbl.devp$gender=="Female",]           #Count how many responses from  female researchers
percent.women<-((dim(n.gbl.res.women)[1])/(dim(n.gbl.devp)[1]))*100  #Calculate the % of responses from  female researchers

#Career Stage Tabulations:
#table(n.gbl.devp$what_participant_group)
n.seniorac <- n.gbl.devp[n.gbl.devp$what_participant_group=="Senior academic researcher with >10 years of experience applying for research grants",]
percent.seniorac<-((dim(n.seniorac)[1])/(dim(n.gbl.devp)[1]))*100 #Calculate the % of responses from  senior academic researchers
n.earlyac <- n.gbl.devp[n.gbl.devp$what_participant_group=="Early career academic researcher with <10 years experience applying for research grants since completion of PhD",]
percent.earlyac<-((dim(n.earlyac)[1])/(dim(n.gbl.devp)[1]))*100 #Calculate the % of responses from  early academic researchers
n.pdf <- n.gbl.devp[n.gbl.devp$what_participant_group=="Postdoctoral fellow or research assistant with experience applying for research grants, or anticipating the need to apply for grants in the near future",]
percent.pdf<-((dim(n.pdf)[1])/(dim(n.gbl.devp)[1]))*100 #Calculate the % of responses from  post-docs
n.nonACearly <- n.gbl.devp[n.gbl.devp$what_participant_group=="Non-academic researcher conducting or managing research in industry or government with <10 years of experience",]
percent.nonACearly<-((dim(n.nonACearly)[1])/(dim(n.gbl.devp)[1]))*100 #Calculate the % of responses from early career non-academics
n.nonACsenior <- n.gbl.devp[n.gbl.devp$what_participant_group=="Non-academic researcher conducting or managing research in industry or government with >10 years of experience",]
percent.nonACsenior<-((dim(n.nonACsenior)[1])/(dim(n.gbl.devp)[1]))*100 #Calculate the % of responses from early career non-academics
n.unk <- n.gbl.devp[n.gbl.devp$what_participant_group=="",]
percent.unk<-((dim(n.unk)[1])/(dim(n.gbl.devp)[1]))*100 #Calculate the % of responses from unknown career stage

#Discipline Tabulations:
n.natural <- n.gbl.devp[n.gbl.devp$field_research=="Natural Science",]
percent.natural <- ((dim(n.natural)[1])/(dim(n.gbl.devp)[1]))*100 #Calculate the % of responses from  natural scientists
n.physics <- n.gbl.devp[n.gbl.devp$field_research=="Physical Science (eg. math, physics, chemistry, computer science)",]
percent.physics <- ((dim(n.physics)[1])/(dim(n.gbl.devp)[1]))*100 #Calculate the % of responses from  physical scientists
n.med <- n.gbl.devp[n.gbl.devp$field_research=="Medicine and Life Science",]
percent.med <- ((dim(n.med)[1])/(dim(n.gbl.devp)[1]))*100 #Calculate the % of responses from  med/life scientists
n.eng <- n.gbl.devp[n.gbl.devp$field_research=="Engineering",]
percent.eng <- ((dim(n.eng)[1])/(dim(n.gbl.devp)[1]))*100 #Calculate the % of responses from  engineering scientists
n.int <- n.gbl.devp[n.gbl.devp$field_research=="Interdisciplinary Science",]
percent.int <- ((dim(n.int)[1])/(dim(n.gbl.devp)[1]))*100 #Calculate the % of responses from  interdisciplinary scientists
n.ssh <- n.gbl.devp[n.gbl.devp$field_research=="Social Science / Humanities",]
percent.ssh <- ((dim(n.ssh)[1])/(dim(n.gbl.devp)[1]))*100 #Calculate the % of responses from  interdisciplinary scientists

## load required packages
require(gridExtra); require(tidyr); require(ggplot2); require(stringr);require(RColorBrewer); require(colorRamps); require(plotrix); require(plyr); require(grid);require(gtable); require(dplyr)


theme_set(theme_bw())

```

**Results**  
In total, `r dim(n.gbl.devp)[1]`  researchers from developed countries completed the online survey. Of these, almost xxxxx were male (`r ceiling(percent.men)`%) and xxxxx were female (`r round(percent.women)`%); xxxx proportion either did not input their gender or selected other. xxxx of the survey respondents (`r round(sum(percent.seniorac,percent.earlyac))`%) were either senior academics (`r round(percent.seniorac)`%), defined as those researchers with more than ten years experience applying for research grants since completion of their PhD, or early career academics (`r round(percent.earlyac)`%) (Figure 4.1). xxxxx also came from post-doctoral researchers (`r round(percent.pdf)`%), non-academic researchers (`r  round(sum(percent.nonACearly,percent.nonACsenior))`%), or those who did not indicate their career stage (`r round(percent.unk, digits=1)`%).

Researchers from many different disciplines were represented in the survey. Almost xxxx percent of responses came from either the natural or physical sciences (Figure 4.2). The remaining responses were spread amongst the medical and life sciences (`r round(percent.med)`%), engineering (`r round(percent.eng)`%), interdisciplinary research (`r round(percent.int)`%), and social sciences and humanities (`r round(percent.ssh)`%). 




```{r echo=FALSE, fig.cap="Number of responses by country", message=FALSE, warning=FALSE}

#data
#head(n.gbl.devp)
#dim(n.gbl.devp)  #2641


###create figures

locations<-aggregate(gender ~ nation, n.gbl.devp, length)
locations<-locations[!locations$nation=="",]
locations<-droplevels(locations)

#pdf(file="figures/developed/responses_country_randCA.pdf", width = 11, height= 8)

ggplot(locations, aes(x = reorder(nation, -gender), gender)) + geom_bar(stat='identity',position = position_dodge(width=0.5),fill='#1f78b4') + theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5)) + labs(y="Number of responses", x="", title="Responses by Country")  + 
  geom_text(aes(label=gender), angle=90, hjust=-0.5, size=3) +
  #geom_text(aes(label=Country), angle=90, hjust=-0.5) 
   theme(legend.title=element_text(size=12), 
                             legend.text=element_text(size=10), axis.text=element_text(size=8), axis.title=element_text(size=12), plot.title = element_text(hjust = 0.5)) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+scale_y_continuous(expand = c(0,0), limits=c(0, 360)) 

#dev.off()  
  
### responses by country gap plot
locations<-aggregate(gender ~ nation, n.gbl.devp, length)
locations<-locations[!locations$nation=="",]

barlabs<-locations$nation[order(locations$gender, decreasing=TRUE)]

#pdf(file="figures/developed/responses_country_gapplot_randCA.pdf", height=8, width=11)

par(mar=c(11,4,4,2))
gap.barplot(sort(locations$gender,decreasing=TRUE), gap=c(48,100),horiz=F, xaxlab=barlabs, xlab="     ", 
            ylab="Number of responses", ytics=c(0,45,116,200,250, 300, 350), main = "Responses by country",las=2, col=c(blue2red(29)))

#dev.off()


## >10 responses

locations.more<-aggregate(gender ~ nation, n.gbl.devp, length)
locations.more<-locations.more[!locations.more$nation=="",]
locations.more$gender<-as.numeric(locations.more$gender)
locations.more<-locations.more[locations.more$gender>10,]
barlabs<-locations.more$nation[order(locations.more$gender, decreasing=TRUE)]

color1<-c('#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4')


#pdf(file="figures/developed/responses_country_10+_gapplot_randCA.pdf", height=8, width=11)

par(mar=c(7,4,4,2))
gap.barplot(sort(locations.more$gender,decreasing=TRUE), gap=c(48,100),horiz=F, xaxlab=barlabs, xlab="     ", 
            ylab="Number of responses", ytics=c(0,45,116,200,250, 300, 350), main = "Countries with greater than 10 responses",las=2, col=color1)

#dev.off()

#col=c(blue2red(29))

## <=10 responses

locations.less<-aggregate(gender ~ nation, n.gbl.devp, length)
locations.less<-locations.less[!locations.less$nation=="",]
locations.less$gender<-as.numeric(locations.less$gender)
locations.less<-locations.less[locations.less$gender<=10,]
barlabs<-locations.less$nation[order(locations.less$gender, decreasing=TRUE)]

color2<-'#1f78b4'
color2<-rep(color2,55)

#pdf(file="figures/developed/responses_country_10-_gapplot_randCA.pdf", height=8, width=11)

par(mar=c(11,4,4,2))
barplot(sort(locations.less$gender,decreasing=TRUE), names.arg = locations.less$nation[order(locations.less$gender, decreasing=TRUE)] ,horiz=F, xlab="", 
            ylab="Number of responses", main = "Countries with 10 or fewer responses",las=2, ylim=c(-0.1,10),col=color2, axis.lty="solid", space=0, xaxs="i")
box()

#dev.off()

#c(blue2red(55)


##combine  >10 and <= 10 figures

locations.more<-aggregate(gender ~ nation, n.gbl.devp, length)
locations.more<-locations.more[!locations.more$nation=="",]
locations.more$gender<-as.numeric(locations.more$gender)
locations.more<-locations.more[locations.more$gender>10,]
barlabs<-locations.more$nation[order(locations.more$gender, decreasing=TRUE)]

color1<-c('#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4')
#pdf(file="figures/developed/responses_country_10+&10-_gapplot_randCA.pdf", height=8, width=15)
layout(matrix(c(1,2),1,2, byrow = TRUE), widths=c(0.7,2))
par(mar=c(11,4,4,2))
gap.barplot(sort(locations.more$gender,decreasing=TRUE), gap=c(48,100),horiz=F, xaxlab=barlabs, xlab="     ", 
            ylab="Number of responses", ytics=c(0,45,116,200,250, 300, 350), main = "Countries with greater\nthan 10 responses",las=2, col=color1)
par(mar=c(11,2,4,1))
barplot(sort(locations.less$gender,decreasing=TRUE), names.arg = locations.less$nation[order(locations.less$gender, decreasing=TRUE)] ,horiz=F, xlab="", 
            ylab="", main = "Countries with 10 or\nfewer responses",las=2, ylim=c(-0.1,10),col=color2, axis.lty="solid", space=0, xaxs="i")
box()

#dev.off()

```

<!-- Generate  career stage figure -->
```{r echo=FALSE, fig.cap="Figure 4.1 Number of survey respondents from developed nations by career stage", fig.width=14, message=FALSE, warning=FALSE}

## setting colour scale to keep colours identical between similar plots
## myColors <- brewer.pal(6,"Set1")

experience<-data.frame(table(n.gbl.devp$what_participant_group))
experience<-experience[!experience$Var1=="",]
experience<-droplevels(experience)

experience$Var1<-revalue(experience$Var1, c("Early career academic researcher with <10 years experience applying for research grants since completion of PhD" = "Early career academic researcher", "Non-academic researcher conducting or managing research in industry or government with >10 years of experience" = "Non-academic research >10 yrs experience", "Non-academic researcher conducting or managing research in industry or government with <10 years of experience" = "Non-academic researcher <10 yrs experience", "Postdoctoral fellow or research assistant with experience applying for research grants, or anticipating the need to apply for grants in the near future" = "Postdoc or RA", "Senior academic researcher with >10 years of experience applying for research grants" = "Senior academic researcher"))
experience$Var1<-reorder(experience$Var1, experience$Freq)

# assign colour scale
myColors1<-(brewer.pal(9, "Blues"))
myColors1<-myColors1[-c(1:2)]
names(myColors1)<- levels(experience$Var1)
colScale <- scale_fill_manual(name = "Var1",values = myColors1)

#pdf(file="figures/developed_randCA/4.1_CareerStage.pdf", width = 11, height= 7)

ggplot(experience, aes(x = reorder(Var1, -Freq), Freq, fill=Var1)) + 
  geom_bar(stat='identity',position = position_dodge(width=0.5)) + 
  geom_text(aes(label=Freq, vjust=-0.5), size=3)+
  scale_x_discrete(labels=c("Senior academic", "Early career\nacademic", "Postdoc or RA", "Senior\nnon-academic", "Early career\nnon-academic")) +
  labs(y="Number of responses", x="", title="Responses by career stage (developed nations, 340 CA)") +
  guides(fill=guide_legend(title=NULL, reverse=TRUE, nrow=3)) +  
  theme(aspect.ratio=1/2,legend.title=element_blank(), 
        legend.text=element_text(size=10), 
        axis.text.y=element_text(size=9),
        axis.text.x=element_text(angle=0, size=9), 
        axis.title=element_text(size=11),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), plot.title = element_text(hjust = 0.5)) + 
  colScale + guides(fill=FALSE)+
  scale_y_continuous(expand = c(0,0), limits = c(0,1100))
#dev.off()

```

<!-- Generate  research discipline figure -->
```{r echo=FALSE, fig.cap="Figure 4.2 survey responses by field of research", fig.width=14, message=FALSE, warning=FALSE}
field<-data.frame(table(n.gbl.devp$field_research))
field<-field[!field$Var1=="",]
field$Var1<-reorder(field$Var1, field$Freq)
field$Var1<-revalue(field$Var1, c("Physical Science (eg. math, physics, chemistry, computer science)" = "Physical Science"))

## setting colour scale to keep colours identical between similar plots
myColors2<-(brewer.pal(9, "Blues"))
myColors2<-myColors2[-c(1)]
names(myColors2) <- levels(field$field_research)
colScale <- scale_fill_manual(name = "field_research",values = myColors2)

#pdf(file="figures/developed_randCA/4.2_FieldofResearch.pdf", width = 11, height= 7)

ggplot(field, aes(x = reorder(Var1, -Freq), Freq, fill=Var1)) + 
    geom_bar(stat='identity',position = position_dodge(width=0.5)) + 
  labs(y="Number of responses",x="", title="Responses by field of research (developed nations, 340 CA)")  +
  scale_x_discrete(labels=c("Physical\n Science", "Natural\n Science", "Medicine &\nLife Science", "Engineering", "Social Science/\nHumanities","Interdisciplinary\nScience",  "Other")) +
  geom_text(aes(label=Freq), vjust=-0.25, size=3) + 
  theme( aspect.ratio=1/2, axis.text.y=element_text(size=9),
         axis.text.x=element_text(angle=0, size=9),
         axis.title=element_text(size=11),
         panel.grid.major = element_blank(),
         panel.grid.minor = element_blank(), plot.title = element_text(hjust = 0.5)) + 
  guides(fill=FALSE) + colScale+
  scale_y_continuous(expand = c(0,0), limits = c(0,445))

#dev.off()
```

```{r eval=FALSE, fig.cap="Figure 4.1 + 4.2 Career Stage and Field of research", message=FALSE, warning=FALSE, include=FALSE}
##plot1

# assign colour scale
myColors1<-(brewer.pal(9, "Blues"))
myColors1<-myColors1[-c(1:2)]
names(myColors1)<- levels(experience$Var1)
colScale <- scale_fill_manual(name = "Var1",values = myColors1)

g4.1<-ggplot(experience, aes(x = reorder(Var1, -Freq), Freq, fill=Var1)) + 
  geom_bar(stat='identity',position = position_dodge(width=0.5)) + 
  geom_text(aes(label=Freq, vjust=-1), size=3)+
  scale_x_discrete(labels=c("Senior academic", "Early career\nacademic", "Postdoc or RA", "Senior\nnon-academic", "Early career\nnon-academic")) +
  labs(y="Number of responses", x="") +
  guides(fill=guide_legend(title=NULL, reverse=TRUE, nrow=3)) +  
  theme(aspect.ratio=1/2,legend.title=element_blank(), 
        legend.text=element_text(size=10), 
        axis.text.y=element_text(size=9),
        axis.text.x=element_text(angle=0, size=9), 
        axis.title=element_text(size=11),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) + 
  colScale + guides(fill=FALSE)+
  scale_y_continuous(expand = c(0,0), limits = c(0,150))


##plot 2

## setting colour scale to keep colours identical between similar plots
myColors2<-(brewer.pal(9, "Blues"))
myColors2<-myColors2[-c(1)]
names(myColors2) <- levels(field.is$field_research)
colScale <- scale_fill_manual(name = "field_research",values = myColors2)

g4.2<-ggplot(field.is, aes(x = reorder(field_research, -Freq), Freq, fill=field_research)) + 
    geom_bar(stat='identity',position = position_dodge(width=0.5)) + 
  labs(y="Number of responses",x="", title="")  +
  scale_x_discrete(labels=c("Natural\n Science", "Physical\n Science", "Medicine\n& Life\nScience", "Engineering", "Inter-\ndisciplinary\nScience", "Social\nScience/\nHumanities", "Other")) +
  geom_text(aes(label=Freq), vjust=-0.25, size=3) + 
  theme( aspect.ratio=1/2, axis.text.y=element_text(size=9),
         axis.text.x=element_text(angle=0, size=9),
         axis.title=element_text(size=11),
         panel.grid.major = element_blank(),
         panel.grid.minor = element_blank()) + 
  guides(fill=FALSE) + colScale+
  scale_y_continuous(expand = c(0,0), limits = c(0,100))

#pdf(file="figures/developed/4.1and4.2(old)_CareerStageAndFieldOfResearch.pdf", width = 11, height= 7)

grid.arrange(g4.1,g4.2, heights=c(0.475,0.525), ncol=1)

#dev.off()
```

<!--**4.1 Type of Research Conducted**  -->

<!-- Generate figure showing current and past fundamental, use-inspiried, and applied research %s -->
```{r echo=FALSE, message=FALSE, warning=FALSE}
#selecting for developed countries
research.devp<-research[research$nation%in% developed,]
#dim(research.devp)   #6354  11

## now to randomly select for 340 canadian surveys so it does not scew the data 
#create two data frames 1:Canadian   2: non Canadian
#1: Canadian
ca <- research.devp[research.devp$nation == "Canada",]
#head(ca)
ca<-droplevels(ca)
#unique(ca$nation)

#2: others
other <- research.devp[!research.devp$nation == "Canada",]
#head(other)
other<- droplevels(other)
#unique(other$nation)

#now randomly select 340 Canadian
# dim(ca) #528   16
# randca <- ca[sample(nrow(ca), 340), ]
# dim(randca)  #340  16     188 subtracted
# randcaid<-unique(randca$id)  # now use this to select from for all future so it doesnt change everytime i run the code
#write a csv (then comment it out) with the data so it stays permanent
#write.csv(randcaid, "data/gya_survey_response_developed_randCA_IDs.csv", row.names = FALSE)

#now read in the csv so it will be the same random surveys from here on out
randcaid <- read.csv("data/gya_survey_response_developed_randCA_IDs.csv", col.names = TRUE)
randid <- unique(randcaid$TRUE.)
#head(randid)

randca <- ca[ca$id %in% randid,]
#head(randca)
#dim(randca)  #2040   11
#dim(ca)   #3168  11    1128 substracted

#now combine them back together
research.devp <- rbind(randca, other)
#head(research.devp)
#dim(research.devp)  # 5226   11    1128 subtracted so we are good to go

## make sure that Use-inspired is the middle level in the legend
res.plot<-subset(research.devp, type%in%c("percent_fundemental_research_current",  "percent_Applied_Research_current" , "percent_Use_inspired_Research_current","percent_Applied_Research_past",  "percent_Fundamental_Research_past" , "percent_Use_inspired_Research_past"))

res.plot$percent<-str_replace_all(res.plot$percent, "%", "")
res.plot$percent<-as.numeric(as.character(res.plot$percent))
res.plot$type<-as.character(res.plot$type)

# add time variable
res.plot$time<-ifelse(grepl( "current", res.plot$type),"Current", "Past")
res.plot$type[res.plot$type=="percent_Applied_Research_past"]<-"Applied"
res.plot$type[res.plot$type=="percent_Applied_Research_current"]<-"Applied"
res.plot$type[res.plot$type=="percent_Fundamental_Research_past"]<-"Fundamental"
res.plot$type[res.plot$type=="percent_fundemental_research_current"]<-"Fundamental"
res.plot$type[res.plot$type=="percent_Use_inspired_Research_past"]<-"Use-inspired"
res.plot$type[res.plot$type=="percent_Use_inspired_Research_current"]<-"Use-inspired"

# change order of the levels
res.plot$time<-as.factor(res.plot$time)
res.plot$time<-factor(res.plot$time, levels(res.plot$time)[c(2,1)])

res.plot$type<-as.factor(res.plot$type)
res.plot$type<-factor(res.plot$type, levels(res.plot$type)[c(2,3,1)])

res.plot$time<-factor(res.plot$time)
res.plot$time<-factor(res.plot$time, levels(res.plot$time)[c(1,2)])

#myColors<-(brewer.pal(9, "Blues"))
#myColors<-myColors[c(5,9)]


mycols<-c('#a6cee3','#1f78b4','#b2df8a','#33a02c','#fb9a99','#e31a1c')

colScale <- scale_fill_manual(name = "ID",values = mycols)

res.plot$ID<-paste(res.plot$type, res.plot$time)

#table(res.plot$percent,res.plot$time,res.plot$type)
#write.csv(res.plot, file="data/4.1a.calculations.csv", row.names = FALSE)

# change order of the levels
res.plot$ID<-as.factor(res.plot$ID)
res.plot$ID<-factor(res.plot$ID, levels(res.plot$ID)[c(4,3,6,5,2,1)])

# add colours to res.plot
mycols<-c('#33a02c','#a6cee3','#fb9a99','#1f78b4', '#e31a1c','#b2df8a')
mycols<-as.data.frame(mycols)
mycols$ID<-levels(res.plot$ID)
res.plot$col<-mycols$mycols[match(res.plot$ID, mycols$ID)]
res.plot$col<-factor(res.plot$col, levels(res.plot$col)[c(3,1,4,2,6,5)])
mycols<-as.character(unique(res.plot$col))
colScale <- scale_fill_manual(name = "ID",values =mycols, labels=c("2006-2010 Fundamental", "2011-2015 Fundamental","2006-2010 Use-inspired", "2011-2015 Use-inspired","2006-2010 Applied", "2011-2015 Applied"))
#table(res.plot$type, res.plot$time, res.plot$col)

#pdf(file="figures/developed_randCA/4.3.1_ResearchProportion.pdf", width = 11, height= 7)

ggplot(res.plot, aes(percent, fill=ID)) +
    geom_histogram(position='dodge', binwidth=10, bins=seq(0, 100, 10))  +
    guides(fill=guide_legend(title=NULL, reverse=FALSE, nrow=2)) +
    labs(x="Percent", y="Number of responses", title="Reseach type by proportion (developed nations, 340 CA)")+
    theme(aspect.ratio=3/4, panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),legend.text=element_text(size = 9),
          strip.text.y = element_text(size=12, face="bold", color="black"),
          strip.background = element_rect(colour="white", fill="white"),
          legend.position=c(0.7, 0.92), legend.margin=unit(100,"cm"), axis.title.y=element_text(size=11),
          axis.title.x=element_text(size=11), axis.text.x=element_text(size=9), axis.text.y=element_text(size=9), title=element_text(size = 12), plot.title = element_text(hjust = 0.5)) + colScale + 
  scale_x_continuous(breaks=seq(0,100,10))+scale_y_continuous(expand=c(0,0), limits=c(0,475),breaks=seq(0,475,50))

#dev.off()

#+annotate('text',5.4 ,294, label="(a)", size=5)

#out<-by(data = res.plot, INDICES = res.plot$type, FUN = function(m){
#  m <- droplevels(m)
#  m$col<-factor(m$col, levels(m$col)[c(3,1,4,2,6,5)])
#  mycols<-as.character(unique(m$col))
#  colScale <- scale_fill_manual(name = "ID",values =mycols, labels=c("2006-2010", "2011-2015"))
#  m <- ggplot(m, aes(percent, fill=ID)) +
#    geom_histogram(position='dodge', binwidth=10, bins=seq(0, 100, 10))  +
#    guides(fill=guide_legend(title=NULL, reverse=FALSE, nrow=2)) +
#    labs(x="Percent", y="Number of responses", title=m$type)+
#    theme(panel.grid.major = element_blank(),
#          panel.grid.minor = element_blank(),
#          strip.text.y = element_text(size=12, face="bold", color="black"),
#          strip.background = element_rect(colour="white", fill="white"),
#          legend.position=c(0.94, 0.72), legend.margin=unit(100,"cm"), axis.title.y=element_text(size=11),
#          axis.title.x=element_text(size=11), axis.text.x=element_text(size=9), axis.text.y=element_text(size=9), title=element_text(size = 12)) + colScale + 
#  scale_x_continuous(breaks=seq(0,100,10))+scale_y_continuous(expand=c(0,0), limits=c(0,300),breaks=c(0,100,200,300)) 
# })
#do.call(grid.arrange, out)
  
```

```{r eval=FALSE, fig.cap="Figure 4.3 (different layout)", warning=FALSE, include=FALSE, message=FALSE}
#selecting for developed countries
n.gbl.devp<-research[research$nation%in% developed,]

## make sure that Use-inspired is the middle level in the legend
res.plot<-subset(n.gbl.devp, type%in%c("percent_fundemental_research_current",  "percent_Applied_Research_current" , "percent_Use_inspired_Research_current","percent_Applied_Research_past",  "percent_Fundamental_Research_past" , "percent_Use_inspired_Research_past"))

res.plot$percent<-str_replace_all(res.plot$percent, "%", "")
res.plot$percent<-as.numeric(as.character(res.plot$percent))
res.plot$type<-as.character(res.plot$type)

# add time variable
res.plot$time<-ifelse(grepl( "current", res.plot$type),"Current", "Past")
res.plot$type[res.plot$type=="percent_Applied_Research_past"]<-"Applied"
res.plot$type[res.plot$type=="percent_Applied_Research_current"]<-"Applied"
res.plot$type[res.plot$type=="percent_Fundamental_Research_past"]<-"Fundamental"
res.plot$type[res.plot$type=="percent_fundemental_research_current"]<-"Fundamental"
res.plot$type[res.plot$type=="percent_Use_inspired_Research_past"]<-"Use-inspired"
res.plot$type[res.plot$type=="percent_Use_inspired_Research_current"]<-"Use-inspired"
res.plot$time[res.plot$time=="Current"]<-"2011-2015"
res.plot$time[res.plot$time=="Past"]<-"2006-2010"

# change order of the levels
#res.plot$time<-as.factor(res.plot$time)
#res.plot$time<-factor(res.plot$time, levels(res.plot$time)[c(2,1)])

res.plot$type<-as.factor(res.plot$type)
res.plot$type<-factor(res.plot$type, levels(res.plot$type)[c(2,3,1)])

res.plot$time<-factor(res.plot$time)
res.plot$time<-factor(res.plot$time, levels(res.plot$time)[c(1,2)])

#myColors<-(brewer.pal(9, "Blues"))
#myColors<-myColors[c(5,9)]
#colScale <- scale_fill_manual(name = "time",values = myColors)

res.plot$ID<-paste(res.plot$type, res.plot$time)

# change order of the levels
res.plot$ID<-as.factor(res.plot$ID)
res.plot$ID<-factor(res.plot$ID, levels(res.plot$ID)[c(4,3,6,5,2,1)])


# add colours 
mycols<-c('#33a02c','#a6cee3','#fb9a99','#1f78b4', '#e31a1c','#b2df8a')
mycols<-as.data.frame(mycols)
mycols$ID<-levels(res.plot$ID)
res.plot$col<-mycols$mycols[match(res.plot$ID, mycols$ID)]
res.plot$col<-factor(res.plot$col, levels(res.plot$col)[c(3,5,4,2,6,1)])
mycols<-as.character(unique(res.plot$col))
colScale <- scale_fill_manual(name = "ID",values =mycols, labels=c("2006-2010", "2011-2015"))


#ggplot(res.plot, aes(percent, fill=time)) +
#    geom_histogram(position='dodge', binwidth=10, bins=seq(0, 100, 10))  +
#    guides(fill=guide_legend(title=NULL, reverse=FALSE, nrow=2)) +
#    labs(x="Percent", y="Number of responses", title="")+
#    theme(panel.grid.major = element_blank(),
#          panel.grid.minor = element_blank(),
#          strip.text.y = element_text(size=12, face="bold", color="black"),
#          strip.background = element_rect(colour="white", fill="white"),
#          legend.position=c(0.95, 0.19), legend.margin=unit(100,"cm")) + 
#    facet_wrap(~type, nrow=3) + colScale +
#  scale_x_continuous(breaks=seq(0,100,10))+scale_y_continuous(expand=c(0,0), limits=c(0,300),breaks=c(0,100,200,300))

library(gridExtra)
#####add (a)
xs <- split(res.plot,f = res.plot$type)
p1 <- ggplot(xs$Fundamental,aes(percent, fill=time)) +
    geom_histogram(position='dodge', binwidth=10, bins=seq(0, 100, 10))  +
    guides(fill=guide_legend(title=NULL, reverse=FALSE, nrow=2)) +
    labs(x="Percent", y="Number of responses", title="")+
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          strip.text.x = element_text(size=12, face="bold", color="black"),
          strip.background = element_rect(colour="white", fill="white"),
          legend.position=c(0.93, 0.74), legend.spacing=unit(100,"cm"))+ 
    facet_wrap(~type, nrow=3) +
  scale_x_continuous(breaks=seq(0,100,10))+scale_y_continuous(expand=c(0,0), limits=c(0,570),breaks=seq(0,550,100))

p2 <- p1 %+% xs$`Use-inspired`
p3 <- p1 %+% xs$Applied
p1<-p1+scale_fill_manual(name = "ID",values =mycols[4:5], labels=c("2006-2010", "2011-2015"))+labs(x="", title="Type of research by proportion (developed nations)")+ theme(plot.margin=unit(c(1,1,-0.45,1), "cm"), plot.title = element_text(hjust = 0.5))
p2<-p2+scale_fill_manual(name = "ID",values =mycols[c(6,1)], labels=c("2006-2010", "2011-2015"))+labs(x="")+ theme(plot.margin=unit(c(-0.25,1,-0.3,1), "cm"))
p3<-p3+scale_fill_manual(name = "ID",values =mycols[2:3], labels=c("2006-2010", "2011-2015"))+ theme(plot.margin=unit(c(-0.5,1,1,1), "cm"))


#pdf(file="figures/developed/4.3.2_ResearchProportion.pdf", width = 11, height= 7)

#grid.arrange(p1,p2,p3, left= textGrob("(a)", gp = gpar(fontsize=14), y=0.93, hjust = -.75), heights=c(0.35,0.3,0.35))
grid.arrange(p1,p2,p3, heights=c(0.35,0.3,0.35))

#dev.off()
```

```{r eval=FALSE, fig.cap="Figure 4.4a&b", fig.width=10, warning=FALSE, include=FALSE, message=FALSE}
#selecting for developed countries
research.change.devp<-research.change[research.change$nation%in% developed,]
#dim(research.change.devp)    #2641

## now to randomly select for 340 canadian surveys so it does not scew the data 
#create two data frames 1:Canadian   2: non Canadian
#1: Canadian
ca <- research.change.devp[research.change.devp$nation == "Canada",]
#head(ca)
ca<-droplevels(ca)
#unique(ca$nation)

#2: others
other <- research.change.devp[!research.change.devp$nation == "Canada",]
#head(other)
other<- droplevels(other)
#unique(other$nation)

#now randomly select 340 Canadian
# dim(ca) #528   16
# randca <- ca[sample(nrow(ca), 340), ]
# dim(randca)  #340  16     188 subtracted
# randcaid<-unique(randca$id)  # now use this to select from for all future so it doesnt change everytime i run the code
#write a csv (then comment it out) with the data so it stays permanent
#write.csv(randcaid, "data/gya_survey_response_developed_randCA_IDs.csv", row.names = FALSE)

#now read in the csv so it will be the same random surveys from here on out
randcaid <- read.csv("data/gya_survey_response_developed_randCA_IDs.csv", col.names = TRUE)
randid <- unique(randcaid$TRUE.)
#head(randid)

randca <- ca[ca$id %in% randid,]
#head(randca)
#dim(randca)  #340   16
#dim(ca)   #1331  16   subtracted  991

#now combine them back together
research.change.devp <- rbind(randca, other)
#head(research.change.devp)
#dim(research.change.devp)  # 1650    991 subtracted so we are good to go

#Change yes or no
yes.no<-subset(research.change.devp, select=c("Location","Country", "Country_work",  "gender", "changed_10yrs"))

global.yes.no<-aggregate(gender~ changed_10yrs, yes.no, length)
global.yes.no<-global.yes.no[!global.yes.no$changed_10yrs=="",]

p1<-ggplot(data=global.yes.no, aes(x=changed_10yrs, y=gender, fill=gender))+ geom_bar(stat='identity') + guides(fill=FALSE)+
  theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), axis.title.x=element_blank(), plot.title = element_text(hjust = 0.5))+geom_text(aes(label=gender), vjust=-0.5)+labs(y="Number of responses", title="Change in research type\n(developed nations, 340 CA)")+ scale_y_continuous(expand = c(0, 0), limits = c(0,910))+ annotate('text', 0.5,900, label="(a)", size=5)
  
####reason for change  
reason<-subset(research.change.devp, select=c("Location","Country","Country_work",  "gender", "Main_reason_change_interest_related",
                                       "Main_reason_change_Career_related","Main_reason_change_Funding_related", "Main_reason_change_Socially_related","Main_reason_change_Other"))

# switch to long format
require(tidyr)
global.long<-gather(reason, reason.change.glb, yes.glb, -Location, -gender, -Country_work, -Country)
# using table to count cases of each category
sum.global<-data.frame(table(global.long$reason.change.glb, global.long$yes.glb))
#remove non-response
sum.global<-sum.global[!sum.global$Var1=="",]

sum.global$Var1<-revalue(sum.global$Var1, c("Main_reason_change_Career_related" = "Career", "Main_reason_change_Funding_related" = "Funding", "Main_reason_change_interest_related" = "Interest", "Main_reason_change_Other" = "Other", "Main_reason_change_Socially_related"  = "Social"))
# change order of the levels
sum.global$Var1<-factor(sum.global$Var1,levels(sum.global$Var1)[c(2,3,1,5,4)])

myColors4<-(brewer.pal(9, "Blues"))
myColors4<-myColors4[c(9, 8,7,6,5,3)]

p2<-ggplot(sum.global, aes(x=Var1, y=Freq, fill=Var1)) + geom_bar(stat='identity')+ 
  theme( axis.text.x = element_text(angle=0, vjust=0.5, size=9), axis.text.y=element_text(size = 9), axis.title=element_text(size = 11), panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),legend.text=element_text(size = 9),axis.title.x=element_blank(), plot.title = element_text(hjust = 0.5)) +guides(fill=FALSE) +
  scale_fill_manual(name = "Var1",values = myColors4)+
  labs(y="Number of responses", title="Reason for change in research type\n(developed nations, 340 CA)")+
  scale_y_continuous(expand = c(0, 0), limits = c(0, 660))+annotate('text', 5.4,650, label="(b)", size=5)+geom_text(aes(label=Freq), vjust=-0.5, size=3)
  

#pdf(file="figures/developed_randCA/4.4_ReasonForFieldChange.pdf", width = 11, height= 7)

#print(p2)

#dev.off()

#pdf(file="figures/developed_randCA/4.4a&b_ReasonForFieldChange.pdf", width = 11, height= 7)

grid.arrange(p1, p2, widths=c(0.5, 0.5), nrow=1)

#dev.off()
```

```{r message=FALSE, warning=FALSE, include=FALSE}
## looking to see what direction respondents research changed (when it did)
##data frame with the research proportions data
#selecting for developed countries
res.devp<-research[research$nation%in% developed,]
#head(res.devp)
#dim(res.devp)     #6354  11

##data frame with whether or not they changed 
#selecting for developing nations
research.change.devp <- research.change[research.change$nation%in% developed,]
#head(research.change.devp)
#dim(research.change.devp)   #2641 14

## the data frame that has the info on the proportions of research is in the long format so that is why it is so much longer than the other data frame
# make it not long format
res.port.devp <- spread(res.devp, type, percent)
#head(res.port.devp)
#dim(res.port.devp)  #1059   16   - this is just the ones that had answers for both current and past research proportions (there was only one person that answered 'yes' to if their research type had changed but did not provide 'past' proportions)

##add in the yes/no response to the proportions data frame using the survey id
#remove 'no' and 'can't comment' first
yes.devp<- research.change.devp[!research.change.devp$changed_10yrs == "No",]
yes.devp<- yes.devp[!yes.devp$changed_10yrs == "Can't comment (new researcher)",]
yes.devp<- yes.devp[!yes.devp$changed_10yrs == "",]
yes.devp<- droplevels(yes.devp)
#dim(yes.devp)  # 1064 14   
#head(yes.devp)

res.port.devp$changed<-yes.devp$changed_10yrs[match(res.port.devp$id, yes.devp$id)]
#head(res.port.devp)
#colnames(res.port.devp)
#str(res.port.devp)
#dim(res.port.devp)   #1059  16

## now to randomly select for 340 canadian surveys so it does not scew the data 
#create two data frames 1:Canadian   2: non Canadian
#1: Canadian
ca <- res.port.devp[res.port.devp$nation == "Canada",]
#head(ca)
ca<-droplevels(ca)
#unique(ca$nation)

#2: others
other <- res.port.devp[!res.port.devp$nation == "Canada",]
#head(other)
other<- droplevels(other)
#unique(other$nation)

#now randomly select 340 Canadian
# dim(ca) #528   16
# randca <- ca[sample(nrow(ca), 340), ]
# dim(randca)  #340  16     188 subtracted
# randcaid<-unique(randca$id)  # now use this to select from for all future so it doesnt change everytime i run the code
#write a csv (then comment it out) with the data so it stays permanent
#write.csv(randcaid, "data/gya_survey_response_developed_randCA_IDs.csv", row.names = FALSE)

#now read in the csv so it will be the same random surveys from here on out
randcaid <- read.csv("data/gya_survey_response_developed_randCA_IDs.csv", col.names = TRUE)
randid <- unique(randcaid$TRUE.)
#head(randid)

randca <- ca[ca$id %in% randid,]
#head(randca)
#dim(randca)  #340   16
#dim(ca)   #528  16

#now combine them back together
res.port.devp <- rbind(randca, other)
#head(res.port.devp)
#dim(res.port.devp)  # 871   16    188 subtracted so we are good to go

##### ok have the data - now we have to see how people's research changed
# idea - so do a 3 axis box with one set of points for 6-10 and another for 11-15 with arrow between like in the one figure for platy
# might be a bit busy but we will see
# arrow between - geom path


# or just look at what their majority was for the two time points
#head(res.port.devp)
#add a column indicating which was the majority currently
res.port.devp$majority_current <- "fund.current"
#head(res.port.devp)
res.port.devp$majority_current <- ifelse((res.port.devp$percent_Applied_Research_current >= 50), "app.current", res.port.devp$majority_current)
res.port.devp$majority_current <- ifelse((res.port.devp$percent_Use_inspired_Research_current >= 50), "use.current", res.port.devp$majority_current)


#now past
res.port.devp$majority_past <- "fund.past"
#head(res.port.devp)
res.port.devp$majority_past <- ifelse((res.port.devp$percent_Applied_Research_past >= 50), "app.past", res.port.devp$majority_past)
res.port.devp$majority_past <- ifelse((res.port.devp$percent_Use_inspired_Research_past >= 50), "use.past", res.port.devp$majority_past)

#head(res.port.devp)

#now deal with the 50%
res.port.devp$majority_current <- ifelse((res.port.devp$percent_Applied_Research_current == 50 & res.port.devp$percent_fundemental_research_current == 50), "fund.app.half.current", res.port.devp$majority_current)
res.port.devp$majority_current <- ifelse((res.port.devp$percent_Applied_Research_current == 50 & res.port.devp$percent_Use_inspired_Research_current == 50), "use.app.half.current", res.port.devp$majority_current)
res.port.devp$majority_current <- ifelse((res.port.devp$percent_Use_inspired_Research_current == 50 & res.port.devp$percent_fundemental_research_current == 50), "fund.use.half.current", res.port.devp$majority_current)

res.port.devp$majority_past <- ifelse((res.port.devp$percent_Fundamental_Research_past == 50 & res.port.devp$percent_Applied_Research_past == 50), "fund.app.half.past", res.port.devp$majority_past)
res.port.devp$majority_past <- ifelse((res.port.devp$percent_Fundamental_Research_past == 50 & res.port.devp$percent_Use_inspired_Research_past == 50), "fund.use.half.past", res.port.devp$majority_past)
res.port.devp$majority_past <- ifelse((res.port.devp$percent_Use_inspired_Research_past == 50 & res.port.devp$percent_Applied_Research_past == 50), "use.app.half.past", res.port.devp$majority_past)

#head(res.port.devp)



# add in column with current - past for each type
res.port.devp$curr_past.app <- (res.port.devp$percent_Applied_Research_current - res.port.devp$percent_Applied_Research_past)
res.port.devp$curr_past.use <- (res.port.devp$percent_Use_inspired_Research_current - res.port.devp$percent_Use_inspired_Research_past)
res.port.devp$curr_past.fund <- (res.port.devp$percent_fundemental_research_current - res.port.devp$percent_Fundamental_Research_past)

#head(res.port.devp)

# going to calculate average and sd for the current - past columns for each to plot
res.port.devp$app_mean <- mean(res.port.devp$curr_past.app)
res.port.devp$app_sd <- sd(res.port.devp$curr_past.app)
res.port.devp$use_mean <- mean(res.port.devp$curr_past.use)
res.port.devp$use_sd <- sd(res.port.devp$curr_past.use)
res.port.devp$fund_mean <- mean(res.port.devp$curr_past.fund)
res.port.devp$fund_sd <- sd(res.port.devp$curr_past.fund)

#head(res.port.devp)

#save as csv
write.csv(res.port.devp, file = "data/developed_research_direction_change.csv", row.names = FALSE)


#<--------------------------------->
###################################
# now going to plot the means of the changes 

change <- subset(res.port.devp, select = c("app_mean", "use_mean", "fund_mean"))
#head(change)

colnames(change) <- c("app_mean" = "Applied", "use_mean" = "Use-inspired", "fund_mean" = "Fundamental")

change.long <- gather(change, type, aver)
#change.long <- gather(change.long, type_sd, sd, -type, -aver)
#head(change.long)
#dim(change.long)
change.long <- change.long[-c(2:1741, 1744:2613),]
#change.long

#add in sd
change.long$sd <- 1
change.long$sd <- ifelse(change.long$type == "Applied", res.port.devp$app_sd, change.long$sd)
change.long$sd <- ifelse(change.long$type == "Use-inspired", res.port.devp$use_sd, change.long$sd)
change.long$sd <- ifelse(change.long$type == "Fundamental", res.port.devp$fund_sd, change.long$sd)
#head(change.long)

# change the order 
#str(change.long$type)
change.long$type <- as.factor(change.long$type)
#levels(change.long$type)
change.long$type <- factor(change.long$type, levels(change.long$type)[c(2,3,1)])


# add colours 
mycols<-c('#e31a1c','#33a02c', '#1f78b4')   #'#a6cee3', tried -'#fb9a99', '#e31a1c','#b2df8a'
mycols<-as.data.frame(mycols)
mycols$type<-levels(change.long$type)
change.long$col<-mycols$mycols[match(change.long$type, mycols$type)]
#change.long$col<-factor(change.long$col, levels(change.long$col)[c(1,2,3)])
mycols<-as.character(unique(change.long$col))
#colScale <- scale_fill_manual(name = "Type",values =mycols)
#table(res.plot$type, res.plot$time, res.plot$col)

#pdf(file="figures/developed/4.3.4_ResearchProportion_DirectionChange.pdf", width = 11, height= 7)
#pdf(file="figures/developed/4.3.4_ResearchProportion_DirectionChange_coordflip.pdf", width = 11, height= 7)

ggplot(change.long, aes(type, aver, fill = type))+ geom_bar(stat = "identity") +
  geom_errorbar(aes(ymax = aver+sd, ymin = aver-sd))+
  scale_fill_manual(values = mycols)+ guides(fill = FALSE) +
  labs(x = "", y = "Average change", fill = "", title ="Reseach type change (Developed nations)") +
  scale_y_continuous(breaks = seq(-45,35, 5))+
  theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),legend.text=element_text(size = 9),
          strip.text.y = element_text(size=12, face="bold", color="black"),
          strip.background = element_rect(colour="white", fill="white"),
           axis.title.y=element_text(size=11),
          axis.title.x=element_text(size=11), axis.text.x=element_text(size=9), axis.text.y=element_text(size=9), 
        title=element_text(size = 12), plot.title = element_text(hjust = 0.5)) #+ coord_flip()

#dev.off()

#<--------------------------------->
###################################
#now aggregate
pastmajor <- aggregate(gender ~ majority_past, res.port.devp, length)
#pastmajor
# change the column names so they can be joined
colnames(pastmajor) <- c("major.research", "gender")
#pastmajor
# add in basic colors for now  - just going to do past and current
pastmajor$color <- "darkturquoise"
#pastmajor

currentmajor <- aggregate(gender ~ majority_current, res.port.devp, length)
#currentmajor
colnames(currentmajor) <- c("major.research", "gender")
#currentmajor
# add in basic colors for now  - just going to do past and current
currentmajor$color <- "paleturquoise"
#currentmajor
# join them 
majority <- full_join(pastmajor, currentmajor)
#majority



# change the order 
#str(majority$major.research)
majority$major.research <- as.factor(majority$major.research)
#levels(majority$major.research)
majority$major.research <- factor(majority$major.research, levels(majority$major.research)[c(6,5,8,7,12,11,10,9,2,1,4,3)])

# graph the aggregates

#pdf(file="figures/developed/4.3.3_ResearchProportion_DirectionChange.pdf", width = 11, height= 7)

ggplot(majority, aes(major.research, gender, fill = color)) + geom_bar(stat='identity') + labs(x = "Majority type of research", y = "Number of responses", title = "Respondent's major proportion of research type\n(Developed countries)") + guides(fill =FALSE) +
  theme(axis.text.x = element_text(angle = 90), plot.title = element_text(hjust = 0.5))

#dev.off()

#what about graphing the individuals and their switch
#head(res.port.devp)

res.port.devp.long <- gather(res.port.devp, time, what, - Location, -nation, -id, -Country, -Country_work, -gender, -what_participant_group, -field_research, -total_research, -percent_Applied_Research_current, -percent_Applied_Research_past, -percent_Fundamental_Research_past, -percent_fundemental_research_current, -percent_Use_inspired_Research_current, -percent_Use_inspired_Research_past, -changed)

#head(res.port.devp.long)

#hmm not sure right now

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
## going to subset for those responses that had a 25%+ decrease in Fundamental and then look too see what they thought of the change
# use res.port.dev
#head(res.port.devp)
#dim(res.port.devp)  #871

#get rid of columns that we dont need so it is easier to work with
#colnames(res.port.devp)
res.port.devp$"app_mean" <- NULL
res.port.devp$"app_sd"  <- NULL
res.port.devp$"use_mean"  <- NULL
res.port.devp$"use_sd"  <- NULL
res.port.devp$"fund_mean"  <- NULL
res.port.devp$"fund_sd"  <- NULL
res.port.devp$"changed"  <- NULL
res.port.devp$"majority_current"  <- NULL
res.port.devp$"majority_past"  <- NULL
res.port.devp$"Country_work"  <- NULL
res.port.devp$"Country"  <- NULL
res.port.devp$"Location"  <- NULL
res.port.devp$"app.use.fund.past"  <- NULL
res.port.devp$"app.use.fund.past"  <- NULL

#head(res.port.devp)

#now select for the ones that had 25% + decrease in Fundamental
#str(res.port.devp)
#dim(res.port.devp)
fund.dec <- res.port.devp[(res.port.devp$curr_past.fund <= -25),]
#dim(fund.dec)  # only 279 had a 25% decrease in fundamental
#head(fund.dec)


#now read in data that has the view on change and why
n.gbl.devp<-survey[survey$nation%in% developed,]
#dim(n.gbl.devp)
#head(n.gbl.devp)
#colnames(n.gbl.devp)
fund.dec.view.change <- n.gbl.devp[,c(12:18, 74, 77:79)]
fund.dec.view.change<-fund.dec.view.change[!fund.dec.view.change$view_change_of_type=="",]
fund.dec.view.change<-droplevels(fund.dec.view.change)
#head(fund.dec.view.change)

#now select for just the ones that had a decrease in fund as above with matching surveys from rand select of ca
#dim(fund.dec.view.change)  #1059
fund.dec.view.change <- fund.dec.view.change[fund.dec.view.change$id %in% fund.dec$id,]
#dim(fund.dec.view.change)  #279
#head(fund.dec.view.change)
#dim(fund.dec)
# they both have 279 rows

#now follow the same code to make the figure as in the next code chunk (figure 4.5)
fund.dec.view<-aggregate(gender~ view_change_of_type, fund.dec.view.change, length)
#fund.dec.view
# change order of the levels
fund.dec.view$view_change_of_type<-factor(fund.dec.view$view_change_of_type, 
                                        levels(fund.dec.view$view_change_of_type)[c(5,3,1,2,4)])

myColors5<-(brewer.pal(9, "Blues"))
myColors5<-myColors5[c(4,4,4,4,4,4)]

#pdf(file="figures/developed/4.5.2_ViewFieldChange_FundDecrease_randCA.pdf", width = 11, height= 7)

ggplot(fund.dec.view, aes(x=view_change_of_type, y=gender, fill=view_change_of_type)) + geom_bar(stat='identity')+
  theme(aspect.ratio=3/4, axis.text.x = element_text(angle=0, vjust=0.5, size=9), axis.text.y = element_text(size = 9), axis.title.y = element_text(size = 11), axis.title.x = element_text(size = 11), plot.title = element_text(hjust = 0.5)) +guides(fill=FALSE)+
  theme(panel.grid.major = element_blank(),legend.text=element_text(size = 9), panel.grid.minor = element_blank())+ labs(x="", y="Number of responses", title="Opinion of change in research type\nwhen Fundamental research decreased by 25%+ (developed nations, 340 CA)")+geom_text(aes(label=gender), vjust=-0.5, size=3)+scale_y_continuous(expand = c(0, 0), limits = c(0,85))+scale_fill_manual(name='view_change_of_type', values=myColors5)+annotate('text', 5.4,82, label= sum(fund.dec.view$gender), size=5) +annotate('text', 5.15,82, label= "n = ", size=5)#+annotate('text', 5.4,133, label="(c)", size=5)

#dev.off()


#### now look at why they changed
####reason for change  
fund.dec.change<-subset(fund.dec.view.change, select=c("nation", "gender", "Main_reason_change_interest_related",
                                       "Main_reason_change_Career_related","Main_reason_change_Funding_related", "Main_reason_change_Socially_related","Main_reason_change_Other"))

# switch to long format
require(tidyr)
fund.dec.change.long<-gather(fund.dec.change, reason.change.fund.dec, yes, -nation, -gender)
# using table to count cases of each category
sum.fund.dec<-data.frame(table(fund.dec.change.long$reason.change.fund.dec, fund.dec.change.long$yes))
#remove non-response
sum.fund.dec<-sum.fund.dec[!sum.fund.dec$Var1=="",]
#sum.fund.dec

sum.fund.dec$Var1<-revalue(sum.fund.dec$Var1, c("Main_reason_change_Career_related" = "Career", "Main_reason_change_Funding_related" = "Funding", "Main_reason_change_interest_related" = "Interest", "Main_reason_change_Other" = "Other", "Main_reason_change_Socially_related"  = "Social"))
# change order of the levels
sum.fund.dec$Var1<-factor(sum.fund.dec$Var1,levels(sum.fund.dec$Var1)[c(2,3,1,5,4)])

myColors4<-(brewer.pal(9, "Blues"))
myColors4<-myColors4[c(9, 8,7,6,5,3)]

#pdf(file="figures/developed/4.4.2_ReasonForFieldChange_FundDecrease_randCA.pdf", width = 11, height= 7)

ggplot(sum.fund.dec, aes(x=Var1, y=Freq, fill=Var1)) + geom_bar(stat='identity')+ 
  theme( axis.text.x = element_text(angle=0, vjust=0.5, size=9), axis.text.y=element_text(size = 9), axis.title=element_text(size = 11), panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),legend.text=element_text(size = 9),axis.title.x=element_blank(), plot.title = element_text(hjust = 0.5)) +guides(fill=FALSE) +
  scale_fill_manual(name = "Var1",values = myColors4)+
  labs(y="Number of responses", title="Reason for change in research type\nwhen Fundamental research decreased by 25%+ \n(developed nations, 340 CA)")+
  scale_y_continuous(expand = c(0, 0), limits = c(0, 240))+geom_text(aes(label=Freq), vjust=-0.5, size=3)
  

#dev.off()


```

```{r echo=FALSE, message=FALSE, warning=FALSE}
### now do it for the increase in Fundamental

#now select for the ones that had 25% + increase in Fundamental
#head(res.port.devp)
fund.inc <- res.port.devp[(res.port.devp$curr_past.fund >= 25),]

#head(fund.inc)
#dim(fund.inc)

#now read in data that has the view on change and why
#head(n.gbl.devp)
#colnames(n.gbl.devp)
fund.inc.view.change <- n.gbl.devp[,c(4,12:18, 74, 77:79)]
fund.inc.view.change<-fund.inc.view.change[!fund.inc.view.change$view_change_of_type=="",]
fund.inc.view.change<-droplevels(fund.inc.view.change)
#head(fund.inc.view.change)

#now select for just the ones that had a decrease in fund as above

fund.inc.view.change <- fund.inc.view.change[fund.inc.view.change$id %in% fund.inc$id,]

#head(fund.inc.view.change)
#dim(fund.inc)  #38
#dim(fund.inc.view.change)
# One has 38 and the other 37 so one of the surveys must not of answered the why and view questions

#now follow the same code to make the figure as in the next code chunk (figure 4.5)
fund.inc.view<-aggregate(gender~ view_change_of_type, fund.inc.view.change, length)
#fund.inc.view
fund.inc.view <- droplevels(fund.inc.view)
# change order of the levels
fund.inc.view$view_change_of_type<-factor(fund.inc.view$view_change_of_type, 
                                        levels(fund.inc.view$view_change_of_type)[c(5,3,1,2,4)])

myColors.view<-(brewer.pal(9, "Blues"))
myColors.view<-myColors.view[c(4,4,4,4,4)]

#pdf(file="figures/developed/4.5.3_ViewFieldChange_increaseFund_randCA.pdf", width = 11, height= 7)

ggplot(fund.inc.view, aes(x=view_change_of_type, y=gender, fill=view_change_of_type)) + geom_bar(stat='identity')+
  theme(axis.text.x = element_text(angle=0, vjust=0.5, size=9), axis.text.y = element_text(size = 9), axis.title.y = element_text(size = 11), axis.title.x = element_text(size = 11), plot.title = element_text(hjust = 0.5)) +guides(fill=FALSE)+
  theme(panel.grid.major = element_blank(),legend.text=element_text(size = 9), panel.grid.minor = element_blank())+ labs(x="", y="Number of responses", title="Opinion of change in research type when\nFundamental research increased by 25%+ (Developed nations, 340 CA)")+geom_text(aes(label=gender), vjust=-0.5, size=4)+scale_y_continuous(expand = c(0, 0), limits = c(0,22))+scale_fill_manual(name='view_change_of_type', values=myColors.view)+annotate('text', 5.45,20.5, label= sum(fund.inc.view$gender), size=5) +annotate('text', 5.3,20.5, label= "n = ", size=5)

#dev.off()


#### now look at why they changed
####reason for change  
fund.inc.change<-subset(fund.inc.view.change, select=c("nation", "gender", "Main_reason_change_interest_related",
                                       "Main_reason_change_Career_related","Main_reason_change_Funding_related", "Main_reason_change_Socially_related","Main_reason_change_Other"))

# switch to long format
require(tidyr)
fund.inc.change.long<-gather(fund.inc.change, reason.change.fund.inc, yes, -nation, -gender)
# using table to count cases of each category
sum.fund.inc<-data.frame(table(fund.inc.change.long$reason.change.fund.inc, fund.inc.change.long$yes))
#remove non-response
sum.fund.inc<-sum.fund.inc[!sum.fund.inc$Var1=="",]
#sum.fund.inc

sum.fund.inc$Var1<-revalue(sum.fund.inc$Var1, c("Main_reason_change_Career_related" = "Career", "Main_reason_change_Funding_related" = "Funding", "Main_reason_change_interest_related" = "Interest", "Main_reason_change_Other" = "Other", "Main_reason_change_Socially_related"  = "Social"))
# change order of the levels
sum.fund.inc$Var1<-factor(sum.fund.inc$Var1,levels(sum.fund.inc$Var1)[c(2,3,1,5,4)])

myColors.why<-(brewer.pal(9, "Blues"))
myColors.why<-myColors.why[c(9, 8,7,6,5,3)]

#pdf(file="figures/developed/4.4.3_ReasonForFieldChange_FundIncrease_randCA.pdf", width = 11, height= 7)

ggplot(sum.fund.inc, aes(x=Var1, y=Freq, fill=Var1)) + geom_bar(stat='identity')+ 
  theme( axis.text.x = element_text(angle=0, vjust=0.5, size=9), axis.text.y=element_text(size = 9), axis.title=element_text(size = 11), panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),legend.text=element_text(size = 9),axis.title.x=element_blank(), plot.title = element_text(hjust = 0.5)) +guides(fill=FALSE) +
  scale_fill_manual(name = "Var1",values = myColors.why)+
  labs(y="Number of responses", title="Reason for change in research type\nwhen Fundamental research increased by 25%+ \n(Developed nations, 340 CA)")+
  scale_y_continuous(expand = c(0, 0), limits = c(0, 23))+annotate('text', 5.35,84, label="(b)", size=5)+geom_text(aes(label=Freq), vjust=-0.5, size=3)
#+
#  annotate('text', 5.45,21, label= sum(sum.fund.dec$Freq), size=5) +annotate('text', 5.25,21, label= "n = ", size=5)

#dev.off()




```

```{r echo=FALSE, message=FALSE, warning=FALSE}
### now do it for the increase in applied and use

#now select for the ones that had 25% + increase in use or applied
#head(res.port.devp)
app.inc<- res.port.devp[((res.port.devp$curr_past.app >= 25)|(res.port.devp$curr_past.use >= 25)),]

#head(app.inc)
#dim(app.inc)

#now read in data that has the view on change and why
#head(n.gbl.devp)
#colnames(n.gbl.devp)
app.inc.view.change <- n.gbl.devp[,c(4,12:18, 74, 77:79)]
app.inc.view.change<-app.inc.view.change[!app.inc.view.change$view_change_of_type=="",]
app.inc.view.change<-droplevels(app.inc.view.change)
#head(app.inc.view.change)

#now select for just the ones that had a decrease in fund as above

app.inc.view.change <- app.inc.view.change[app.inc.view.change$id %in% app.inc$id,]

#head(app.inc.view.change)
#dim(app.inc.view.change)
#dim(app.inc)
# one has 291 and one has 292 so some one may not have answered the why or view questions

#now follow the same code to make the figure as in the next code chunk (figure 4.5)
app.inc.view<-aggregate(gender~ view_change_of_type, app.inc.view.change, length)
#app.inc.view
# change order of the levels
app.inc.view$view_change_of_type<-factor(app.inc.view$view_change_of_type, 
                                        levels(app.inc.view$view_change_of_type)[c(5,3,1,2,4)])

myColors.view<-(brewer.pal(9, "Blues"))
myColors.view<-myColors.view[c(4,4,4,4,4,4)]

#pdf(file="figures/developed/4.5.4_ViewFieldChange_increasedApp_randCA.pdf", width = 11, height= 7)

ggplot(app.inc.view, aes(x=view_change_of_type, y=gender, fill=view_change_of_type)) + geom_bar(stat='identity')+
  theme( axis.text.x = element_text(angle=0, vjust=0.5, size=9), axis.text.y = element_text(size = 9), axis.title.y = element_text(size = 11), axis.title.x = element_text(size = 11), plot.title = element_text(hjust = 0.5)) +
  guides(fill=FALSE)+
  theme(panel.grid.major = element_blank(),legend.text=element_text(size = 9), panel.grid.minor = element_blank())+ 
  labs(x="", y="Number of responses", title="Opinion of change in research type when\nUse-inspired or Applied research increased by 25%+ (Developed nations, 340 CA)")+
  geom_text(aes(label=gender), vjust=-0.5, size=4)+
  scale_y_continuous(expand = c(0, 0), limits = c(0,87))+
  scale_fill_manual(name='view_change_of_type', values=myColors.view)+
  annotate('text', 5.4,85, label= sum(app.inc.view$gender), size=5) +
  annotate('text', 5.23, 85, label= "n = ", size=5)

#dev.off()


#### now look at why they changed
####reason for change  
app.inc.change<-subset(app.inc.view.change, select=c("nation", "gender", "Main_reason_change_interest_related",
                                       "Main_reason_change_Career_related","Main_reason_change_Funding_related", "Main_reason_change_Socially_related","Main_reason_change_Other"))

# switch to long format
require(tidyr)
app.inc.change.long<-gather(app.inc.change, reason.change.app.inc, yes, -nation, -gender)
# using table to count cases of each category
sum.app.inc<-data.frame(table(app.inc.change.long$reason.change.app.inc, app.inc.change.long$yes))
#remove non-response
sum.app.inc<-sum.app.inc[!sum.app.inc$Var1=="",]
#sum.app.inc

sum.app.inc$Var1<-revalue(sum.app.inc$Var1, c("Main_reason_change_Career_related" = "Career", "Main_reason_change_Funding_related" = "Funding", "Main_reason_change_interest_related" = "Interest", "Main_reason_change_Other" = "Other", "Main_reason_change_Socially_related"  = "Social"))
# change order of the levels
sum.app.inc$Var1<-factor(sum.app.inc$Var1,levels(sum.app.inc$Var1)[c(2,3,1,5,4)])

myColors.why<-(brewer.pal(9, "Blues"))
myColors.why<-myColors.why[c(9, 8,7,6,5,3)]

#pdf(file="figures/developed/4.4.4_ReasonForFieldChange_IncreasedApp_randCA.pdf", width = 11, height= 7)

ggplot(sum.app.inc, aes(x=Var1, y=Freq, fill=Var1)) + geom_bar(stat='identity')+ 
  theme( axis.text.x = element_text(angle=0, vjust=0.5, size=9), axis.text.y=element_text(size = 9), axis.title=element_text(size = 11), panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),legend.text=element_text(size = 9),axis.title.x=element_blank(), plot.title = element_text(hjust = 0.5)) +guides(fill=FALSE) +
  scale_fill_manual(name = "Var1",values = myColors.why)+
  labs(y="Number of responses", title="Reason for change in research type when\nUse-inspired or Applied research increased by 25%+ \n(Developed nations, 340 CA)")+
  scale_y_continuous(expand = c(0, 0), limits = c(0, 230))+geom_text(aes(label=Freq), vjust=-0.5, size=3)
#+
#  annotate('text', 5.45,21, label= sum(sum.fund.dec$Freq), size=5) +annotate('text', 5.25,21, label= "n = ", size=5)

#dev.off()


```


```{r eval=FALSE, fig.cap="Figure 4.5 View of change in proportion of research. Researchers were asked how they viewed the change in the type of research they conduct/supervise.", fig.width=10, message=FALSE, warning=FALSE, include=FALSE}
n.gbl.devp<-survey[survey$nation%in% developed,]

view.propor<-n.gbl.devp[!n.gbl.devp$view_change_of_type=="",]
view.propor<-droplevels(view.propor)
change.view.devp<-aggregate(gender~ view_change_of_type, view.propor, length)
# change order of the levels
change.view.devp$view_change_of_type<-factor(change.view.devp$view_change_of_type, 
                                        levels(change.view.devp$view_change_of_type)[c(5,3,1,2,4)])

myColors5<-(brewer.pal(9, "Blues"))
myColors5<-myColors5[c(4,4,4,4,4,4)]

#pdf(file="figures/developed_randCA/4.5_ViewFieldChange.pdf", width = 11, height= 7)

ggplot(change.view.devp, aes(x=view_change_of_type, y=gender, fill=view_change_of_type)) + geom_bar(stat='identity')+
  theme(aspect.ratio=3/4, axis.text.x = element_text(angle=0, vjust=0.5, size=9), axis.text.y = element_text(size = 9), axis.title.y = element_text(size = 11), axis.title.x = element_text(size = 11), plot.title = element_text(hjust = 0.5)) +guides(fill=FALSE)+
  theme(panel.grid.major = element_blank(),legend.text=element_text(size = 9), panel.grid.minor = element_blank())+ labs(x="", y="Number of responses", title="Opinion of change in research type (developed nations, 340 CA)")+geom_text(aes(label=gender), vjust=-0.5, size=3)+scale_y_continuous(expand = c(0, 0), limits = c(0,330))+scale_fill_manual(name='view_change_of_type', values=myColors5)#+annotate('text', 5.4,133, label="(c)", size=5)

#dev.off()
```

```{r eval=FALSE, fig.cap="Figure Type of research (4.3, 4.4, 4.5 )", fig.width=10, message=FALSE, warning=FALSE, include=FALSE}

##plot 1

#old version which is now the correct version
#xs <- split(res.plot,f = res.plot$type)
#p1 <- ggplot(xs$Fundamental,aes(percent, fill=time)) +
#    geom_histogram(position='dodge', binwidth=10, bins=seq(0, 100, 10))  +
#    guides(fill=guide_legend(title=NULL, reverse=FALSE, nrow=2)) +
#    labs(x="Percent", y="Number of responses", title="")+
#    theme(panel.grid.major = element_blank(),
#          panel.grid.minor = element_blank(),
#          strip.text.x = element_text(size=12, face="bold", color="black"),
#          strip.background = element_rect(colour="white", fill="white"),
#          legend.position=c(0.93, 0.795), legend.spacing=unit(100,"cm"))+ 
#    facet_wrap(~type, nrow=3) +
#  scale_x_continuous(breaks=seq(0,100,10))+scale_y_continuous(expand=c(0,0), limits=c(0,35),breaks=c(0,10,20,30))

#p2 <- p1 %+% xs$`Use-inspired`
#p3 <- p1 %+% xs$Applied
#p1<-p1+scale_fill_manual(name = "ID",values =mycols[4:5], labels=c("2006-2010", "2011-2015"))+labs(x="")+ theme(plot.margin=unit(c(1,1,-0.45,1), "cm"))
#p2<-p2+scale_fill_manual(name = "ID",values =mycols[c(6,1)], labels=c("2006-2010", "2011-2015"))+labs(x="")+ theme(plot.margin=unit(c(-0.25,1,-0.3,1), "cm"))
#p3<-p3+scale_fill_manual(name = "ID",values =mycols[2:3], labels=c("2006-2010", "2011-2015"))+ theme(plot.margin=unit(c(-0.5,1,1,1), "cm"))
#grid.arrange(p1,p2,p3, left= textGrob("(a)", gp = gpar(fontsize=14), y=0.93, hjust = -.75), heights=c(0.35,0.3,0.35))


## newer version - 
# add colours to res.plot
mycols<-c('#33a02c','#a6cee3','#fb9a99','#1f78b4', '#e31a1c','#b2df8a')
mycols<-as.data.frame(mycols)
mycols$ID<-levels(res.plot$ID)
res.plot$col<-mycols$mycols[match(res.plot$ID, mycols$ID)]
res.plot$col<-factor(res.plot$col, levels(res.plot$col)[c(3,1,4,2,6,5)])
mycols<-as.character(unique(res.plot$col))
colScale <- scale_fill_manual(name = "ID",values =mycols, labels=c("2006-2010\nFundamental", "2011-2015\nFundamental","2006-2010\nUse-inspired", "2011-2015\nUse-inspired","2006-2010\nApplied", "2011-2015\nApplied"))

g1<-ggplot(res.plot, aes(percent, fill=ID)) +
    geom_histogram(position='dodge', binwidth=20, bins=seq(0, 100, 20))  +
    guides(fill=guide_legend(title=NULL, reverse=FALSE, nrow=2)) +
    labs(x="Percent", y="Number of responses")+
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),legend.text=element_text(size = 9),
          strip.text.y = element_text(size=12, face="bold", color="black"), legend.key.size=unit(0.65,"cm"),legend.key=element_rect(color=NA, size=40),
          strip.background = element_rect(colour="white", fill="white"),
          legend.position=c(0.78, 0.91), legend.margin=unit(100,"cm"), axis.title.y=element_text(size=11),
          axis.title.x=element_text(size=11), axis.text.x=element_text(size=9), axis.text.y=element_text(size=9), title=element_text(size = 12)) + colScale + 
  scale_x_continuous(breaks=seq(0,100,20), expand = c(0.015,0.015))+scale_y_continuous(expand=c(0,0), limits=c(0,35),breaks=c(0,10,20,30)) +annotate('text', -9,388, label="(a)", size=5)


###plot2

myColors4<-(brewer.pal(9, "Blues"))
myColors4<-myColors4[c(9, 8,7,6,5,3)]

g2<-ggplot(sum.israel, aes(x=Var1, y=Freq, fill=Var1)) + geom_bar(stat='identity')+ 
  theme( axis.text.x = element_text(angle=0, vjust=0.5, size=9), axis.text.y=element_text(size = 9), axis.title=element_text(size = 11),panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),legend.text=element_text(size = 9),axis.title.x=element_blank()) +guides(fill=FALSE) +scale_fill_manual(name = "Var1",values = myColors4)+
  labs(y="Number of responses", x="")+
  scale_y_continuous(expand = c(0, 0), limits = c(0,43))+annotate('text', 5.35,423, label="(b)", size=5)+
  scale_x_discrete(labels=c("Funding\n  ", "Interest\n  ", 
                                    "Career\n  ", "Social\n  ", "Other\n  "))+geom_text(aes(label=Freq), vjust=-0.5, size=3)


###plot 3
myColors5<-(brewer.pal(9, "Blues"))
myColors5<-myColors5[c(4,4,4,4,4,4)]

g3<-ggplot(change.view.is, aes(x=view_change_of_type, y=gender, fill=view_change_of_type)) + geom_bar(stat='identity')+
  theme(axis.text.x = element_text(angle=0, vjust=0.5, size=9), axis.text.y = element_text(size = 9), axis.title.y = element_text(size = 11), axis.title.x = element_text(size = 11)) +guides(fill=FALSE)+
  theme(panel.grid.major = element_blank(),legend.text=element_text(size = 9), panel.grid.minor = element_blank())+ labs(x=NULL, y="Number of responses")+geom_text(aes(label=gender), vjust=-0.5, size=3)+scale_y_continuous(expand = c(0, 0), limits = c(0,20))+scale_fill_manual(name='view_change_of_type', values=myColors5)+annotate('text', 5.35,133, label="(c)", size=5)+scale_x_discrete(labels=c("Very\npositive", "Slightly\npositive", 
                                    "Neutral", "Slightly\nnegative", "Very\nnegative"),limits = rev(levels(change.view.is$gender)))

#width<-matrix(c(50,10,50,10), ncol=1, nrow = 2)
g4<-NULL # to make a blank spot for 'a'

multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}

##Make layout - update changing 'a' back to the original (3 figures instead of one) so 'a' is wrong in this
#pdf(file="figures/developed/4.1_13apr_with.wrong.a.pdf", width = 8, height = 11)
#multiplot(g1, g2, g3, layout = matrix(c(1,1,2,3),nrow=2, byrow=TRUE))

##Make the layout but with the 'a' spot empty so the real 'a' can be put in by copy editor if I dont have time to try it on here
#pdf(file="figures/developed/4.1b.c._ResearchFoci_13apr_blank.a.pdf", width = 8, height = 11)
multiplot(g1, g2, g3, layout = matrix(c(1,1,2,3),nrow=2, byrow=TRUE))

##trying to put the right (old version) into the layout ###havent gotten it to work yet
#pdf(file="figures/developed/4.1_13apr_right.a.pdf", width = 8, height = 11)
#multiplot(arr(p1,p2,p3, left= textGrob("(a)", gp = gpar(fontsize=14), y=0.93, hjust = -.75), heights=c(0.35,0.3,0.35)), g2, g3, layout = matrix(c(1,1,1,1,1,1,2,3),nrow=4, byrow=TRUE))



#dev.off()
```


<!--Part 2 - External Partnerships-->
<!--**4.2 External Partnerships**   -->

```{r echo=FALSE, fig.cap="Figure 4.6 Current vs past level of partnership outside of academia. Researchers indicated the level of partnership that their current and past (10 years ago) research program had outside of academia).", message=FALSE, warning=FALSE}

b.part<-data.frame(table(n.gbl.devp$partnership_outside_before))
b.part<-b.part[!b.part$Var1=="",]
b.part<-droplevels(b.part)
b.part$time<-"Past"
a.part<-data.frame(table(n.gbl.devp$partnership_outside))
a.part<-a.part[!a.part$Var1=="",]
a.part<-droplevels(a.part)
a.part$time<-"Current"

part<-rbind(a.part, b.part)
part$Var1<-factor(part$Var1, levels(part$Var1)[c(1,4,3,2)])
part$time<-factor(part$time)
part$time<-factor(part$time, levels(part$time)[c(2,1)])

myColors6<-(brewer.pal(9, "Blues"))
myColors6<-rev(myColors6[c(9, 5)])
colScale <- scale_fill_manual(name = "Var1",values = myColors6)

#pdf(file="figures/developed_randCA/4.6_LevelsOfPartnership.pdf", width = 11, height= 7)

ggplot(part, aes(x=Var1, y=Freq, fill = time),  ylim(0,375)) + 
  geom_bar( stat='identity', position="dodge") +
  geom_text(aes(label=Freq), position=position_dodge(width=1), vjust=-0.5, size=3) +
  labs(x="", y="Number of responses", fill="", title="Level of partnership outside of academia (developed nations, 340 CA)")+
  theme(aspect.ratio=3/4, panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.key=element_blank(),legend.text=element_text(size = 9),
        axis.text.x = element_text(angle=0, size=9), axis.text.y=element_text(size = 9), axis.title=element_text(size = 11), 
        legend.position=c(0.08, 0.94), 
        legend.title=element_blank(), plot.title = element_text(hjust = 0.5)) +
  colScale+scale_y_continuous(expand = c(0, 0), limits = c(0,710))

#dev.off()
```

```{r echo=FALSE, fig.cap="Figure 4.7a&b Did it change and reasons for change in level of external research partnerships over the past decade.", message=FALSE, warning=FALSE}

### was there change

change.part.glb<-data.frame(table(n.gbl.devp$partnership_change_10yrs))
change.part.glb<-change.part.glb[!change.part.glb$Var1=="",]
change.part.glb$Var1<-revalue(change.part.glb$Var1, c("Can't comment (new researcher)"="Can't comment"))
change.part.glb$Var1<-factor(change.part.glb$Var1, levels=c("Yes", "No", "Can't comment"))
myColors<-(brewer.pal(9, "Blues"))
myColors<-myColors[c(9, 7,5)]
g1<-ggplot(data=change.part.glb, aes(x=Var1, y=Freq, fill=Var1))+ 
    geom_bar(stat='identity') + 
    guides(fill=FALSE) + 
    labs(x="", y="Number of responses",title="Change in level of external partnerships (developed nations, 340 CA)")+
  geom_text(aes(label=Freq), vjust=-0.5)+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), plot.title = element_text(hjust = 0.5)) + 
  scale_fill_manual(name = "Var1",values = myColors) +
  #annotate('text', 3.25,606, label="(a)", size=7)+
  scale_y_continuous(expand = c(0, 0), limits = c(0,840))

### reason
#selecting for developed countries
part2.reason.devp<-part2.reason[part2.reason$nation%in% developed,]
#dim(part2.reason.devp)   #2641

## now to randomly select for 340 canadian surveys so it does not scew the data 
#create two data frames 1:Canadian   2: non Canadian
#1: Canadian
ca <- part2.reason.devp[part2.reason.devp$nation == "Canada",]
#head(ca)
ca<-droplevels(ca)
#unique(ca$nation)

#2: others
other <- part2.reason.devp[!part2.reason.devp$nation == "Canada",]
#head(other)
other<- droplevels(other)
#unique(other$nation)

#now randomly select 340 Canadian
# dim(ca) #528   16
# randca <- ca[sample(nrow(ca), 340), ]
# dim(randca)  #340  16     188 subtracted
# randcaid<-unique(randca$id)  # now use this to select from for all future so it doesnt change everytime i run the code
#write a csv (then comment it out) with the data so it stays permanent
#write.csv(randcaid, "data/gya_survey_response_developed_randCA_IDs.csv", row.names = FALSE)

#now read in the csv so it will be the same random surveys from here on out
randcaid <- read.csv("data/gya_survey_response_developed_randCA_IDs.csv", col.names = TRUE)
randid <- unique(randcaid$TRUE.)
#head(randid)

randca <- ca[ca$id %in% randid,]
#head(randca)
#dim(randca)  #340   16
#dim(ca)   #1331  16     991 subtracted

#now combine them back together
part2.reason.devp <- rbind(randca, other)
#head(part2.reason.devp)
#dim(part2.reason.devp)  # 1650   16    991 subtracted so we are good to go

reason.pt.long<-gather(part2.reason.devp, change.reason, yes, -Country,-Country_work, -nation, -gender, -Location, -what_participant_group, -field_research, -id)
sum.global<-data.frame(table(reason.pt.long$change.reason, reason.pt.long$yes))

sum.global$Var1<-revalue(sum.global$Var1, c("reason_partnership_change_career" = "Career", "reason_partnership_change_funding" = "Funding", "reason_partnership_change_interest" = "Interest", "reason_partnership_change_other" = "Other", "reason_partnership_change_socially"  = "Social"))
sum.global$Var1<-reorder(sum.global$Var1, -sum.global$Freq)

myColors7<-(brewer.pal(9, "Blues"))
myColors7<-myColors7[c(9, 8,7,6,5,3)]

g2<-ggplot(sum.global, aes(x=Var1, y=Freq, fill=Var1)) + 
    geom_bar(stat='identity')+  guides(fill=FALSE) +
    theme(axis.text.x = element_text(angle=0, vjust=0.5, size = 9), axis.text.y=element_text(size = 9), axis.title.y=element_text(size = 11),
          legend.position=c(0.8, 0.8), 
          legend.title=element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), plot.title = element_text(hjust = 0.5)) + 
  geom_text(aes(label=Freq), vjust=-0.5, size=3)+
  labs(x="", y="Number of responses", title="Reason for change in level of external partnerships (developed nations, 340 CA)")+scale_fill_manual(name = "Var1",values = myColors7)+
  scale_y_continuous(expand = c(0, 0), limits = c(0,570))

#annotate('text', 5,420, label="(b)", size=7)+ 

#pdf(file="figures/developed_randCA/4.7a&b_PartnershipChange&Reason.pdf", width = 11, height= 7)

grid.arrange(g1, g2, ncol=1)

#dev.off()

```

```{r echo=FALSE, fig.cap="Figure 4.8 View of change in external partnerships. Researchers were asked how they viewed the change in the level of partnership with external groups.", message=FALSE, warning=FALSE}

view<-data.frame(table(n.gbl.devp$view_change_partnership))
view<-view[!view$Var1=="",]

# change order of the levels

view$Var1<-factor(view$Var1, levels(view$Var1)[c(6,4,2,3,5)])

myColors8<-(brewer.pal(9, "Blues"))
myColors8<-myColors8[c(4,4,4,4,4)]
colScale <- scale_fill_manual(name = "Var1",values = myColors8)

#pdf(file="figures/developed_randCA/4.8_ViewChangePartnership.pdf", width = 11, height= 7)

ggplot(view, aes(x=Var1, y=Freq, fill=Var1)) + geom_bar(stat='identity')+
  geom_text(aes(label=Freq, vjust=-0.5), size=3)+
  guides(fill=FALSE)+
  theme(aspect.ratio=3/4, panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle=0, vjust=0, size=9), axis.text.y=element_text(size = 9), axis.title.y=element_text(size=11), plot.title = element_text(hjust = 0.5)) + 
  labs(x="", y="Number of responses", title="Opinion of change in level of external partnerships (developed nations, 340 CA)") + colScale+scale_y_continuous(expand = c(0, 0), limits = c(0,240), breaks = seq(0,240,50))

#dev.off()

```
 
```{r eval=FALSE, fig.cap="Figure ( 4.6 + 4.7 + 4.8 ) External Research Partnerships. ", warning=FALSE, include=FALSE}
###4.6
myColors6<-(brewer.pal(9, "Blues"))
myColors6<-rev(myColors6[c(9, 5)])
colScale <- scale_fill_manual(name = "Var1",values = myColors6)

p4<-ggplot(part, aes(x=Var1, y=Freq, fill = time),  ylim(0,375)) + 
  geom_bar( stat='identity', position="dodge") +
  geom_text(aes(label=Freq), position=position_dodge(width=1), vjust=-0.5, size=3) +
  labs(x="", y="", fill="")+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.key=element_blank(),legend.text=element_text(size = 9),
        axis.text.x = element_text(angle=0, size=9), axis.text.y=element_text(size = 9), axis.title=element_text(size = 11), 
        legend.position=c(0.93, 0.88), 
        legend.title=element_blank()) +
  colScale+scale_y_continuous(expand = c(0, 0), limits = c(0,35))+scale_x_discrete(limits = rev(levels(part$Var1)))+annotate('text', 0.5,337, label="(a)", size=5)+labs(y="Number of responses")
p4

###4.7
myColors7<-(brewer.pal(9, "Blues"))
myColors7<-myColors7[c(9, 8,7,6,5,3)]

p5<-ggplot(sum.israel, aes(x=Var1, y=Freq, fill=Var1)) + 
    geom_bar(stat='identity')+  guides(fill=FALSE) +
    theme( axis.text.x = element_text(angle=0, vjust=0.5, size = 9), axis.text.y=element_text(size = 9), axis.title.y=element_text(size = 11),
          legend.position=c(0.8, 0.78), 
          legend.title=element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank()) + 
  geom_text(aes(label=Freq), vjust=-0.5, size=3)+
  labs(x="", y="Number of responses")+scale_fill_manual(name = "Var1",values = myColors7)+
  scale_y_continuous(expand = c(0, 0), limits = c(0,32))+annotate('text', 5.3,431, label="(b)", size=5)+scale_x_discrete(labels=c("Funding\n ", "Interest\n", 
                                    "Career\n", "Social\n", "Other\n "))
p5

###4.8
myColors8<-(brewer.pal(9, "Blues"))
myColors8<-myColors8[c(4,4,4,4,4)]
colScale <- scale_fill_manual(name = "Var1",values = myColors8)

p6<-ggplot(view, aes(x=Var1, y=Freq, fill=Var1)) + geom_bar(stat='identity')+
  geom_text(aes(label=Freq, vjust=-0.5), size=3)+
  guides(fill=FALSE)+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle=0, vjust=0, size=9), axis.text.y=element_text(size = 9), axis.title.y=element_text(size=11)) + 
  labs(x="", y="") + colScale + scale_y_continuous(expand = c(0, 0), limits = c(0,22), breaks = seq(0,10,10))+scale_x_discrete(labels=c("Very\npositive", "Slightly\npositive", "Neutral", "Slightly\nnegative", "Very\nnegative"))+annotate('text', 0.65,158, label="(c)", size=5)
p6


#put them all together


multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}

#pdf(file="figures/developed/4.2_13Apr.pdf")

multiplot(p4, p5, p6, layout = matrix(c(1,1,2,3),nrow=2, byrow=TRUE))

 
#dev.off()

```
 
 
 
 
<!--Part 3 - Grant Application History-->
<!--**4.3 Research Grants**  -->


```{r echo=FALSE, fig.cap="Fig. 4.9 Number of research grant applications by research category in 2006-2010 and 2011-2015.", fig.height=12, message=FALSE, warning=FALSE}
part3.grants.long<-read.csv(file="../data/gya-part3.grants.long.csv")

#selecting for developed countries
part3.grants.long.devp<-part3.grants.long[part3.grants.long$nation%in% developed,]
#dim(part3.grants.long.devp)   #15846

## now to randomly select for 340 canadian surveys so it does not scew the data 
#create two data frames 1:Canadian   2: non Canadian
#1: Canadian
ca <- part3.grants.long.devp[part3.grants.long.devp$nation == "Canada",]
#head(ca)
ca<-droplevels(ca)
#unique(ca$nation)

#2: others
other <- part3.grants.long.devp[!part3.grants.long.devp$nation == "Canada",]
#head(other)
other<- droplevels(other)
#unique(other$nation)

#now randomly select 340 Canadian
# dim(ca) #528   16
# randca <- ca[sample(nrow(ca), 340), ]
# dim(randca)  #340  16     188 subtracted
# randcaid<-unique(randca$id)  # now use this to select from for all future so it doesnt change everytime i run the code
#write a csv (then comment it out) with the data so it stays permanent
#write.csv(randcaid, "data/gya_survey_response_developed_randCA_IDs.csv", row.names = FALSE)

#now read in the csv so it will be the same random surveys from here on out
randcaid <- read.csv("data/gya_survey_response_developed_randCA_IDs.csv", col.names = TRUE)
randid <- unique(randcaid$TRUE.)
#head(randid)

randca <- ca[ca$id %in% randid,]
#head(randca)
#dim(randca)  #2040  
#dim(ca)   #7986   subtracted 5946

#now combine them back together
part3.grants.long.devp <- rbind(randca, other)
#head(n.gbl.devp)
#dim(part3.grants.long.devp)  # 9900     5946 subtracted so we are good to go

part3.grants.long.devp$type.grant<-as.character(part3.grants.long.devp$type.grant)


#add time variable
part3.grants.long.devp$time<-ifelse(grepl("11_15", part3.grants.long.devp$type.grant), "2011-2015", "2006-2010")
part3.grants.long.devp$type.grant[part3.grants.long.devp$type.grant=="external_pi_grant_11_15_fundamental"]<-"Fundamental"
part3.grants.long.devp$type.grant[part3.grants.long.devp$type.grant=="external_pi_grant_6_10_fundamental"]<-"Fundamental"
part3.grants.long.devp$type.grant[part3.grants.long.devp$type.grant=="external_pi_grant_11_15_use"]<-"Use-Inspired"
part3.grants.long.devp$type.grant[part3.grants.long.devp$type.grant=="external_pi_grant_6_10_use"]<-"Use-Inspired"
part3.grants.long.devp$type.grant[part3.grants.long.devp$type.grant=="external_pi_grant_11_15_applied"]<-"Applied"
part3.grants.long.devp$type.grant[part3.grants.long.devp$type.grant=="external_pi_grant_6_10_applied"]<-"Applied"
#dim(part3.grants.long.devp)
grants.gbl<-data.frame(with(part3.grants.long.devp, table(type.grant,time,number)))
grants.gbl$type.grant<-as.factor(grants.gbl$type.grant)
#dim(grants.gbl)

#change order of levels
grants.gbl$number<-factor(grants.gbl$number, levels(grants.gbl$number)[c(1,2,6,7,3,4,5)])
grants.gbl$type.grant<-factor(grants.gbl$type.grant, levels(grants.gbl$type.grant)[c(2,3,1)])

#myColors9<-(brewer.pal(9, "Blues"))
#myColors9<-rev(myColors9[c(9, 5)])
#colScale <- scale_fill_manual(name = "time",values = myColors9)

grants.gbl$ID<-paste(grants.gbl$type.grant, grants.gbl$time)

# change order of the levels
grants.gbl$ID<-as.factor(grants.gbl$ID)
grants.gbl$ID<-factor(grants.gbl$ID, levels(grants.gbl$ID)[c(4,3,6,5,2,1)])


## add colors
mycols<-c('#33a02c','#a6cee3','#fb9a99','#1f78b4', '#e31a1c','#b2df8a')

#pdf(file="figures/developed_randCA/4.9_NumberGrantApps.pdf", height=7, width =11)


#####add (a)
xs <- split(grants.gbl,f = grants.gbl$type.grant)
p1 <- ggplot(xs$Fundamental, aes(number, Freq, fill=time), width=0.7) + 
    geom_bar(stat="identity", position = "dodge")+
    #facet_wrap(~type.grant, ncol=3) +
    guides(fill=guide_legend(title=NULL, reverse=FALSE)) +
    labs(x="Number of grant applications", y="Number of responses")+
    theme(aspect.ratio=4/3, panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          legend.key=element_blank(),
           strip.text.x = element_text(size=12, face="bold", color="black"),
          strip.background = element_rect(colour="white", fill="white"),
          legend.position=c(0.81, 0.91), legend.text=element_text(size = 9), axis.title.x=element_text(size = 11),
          axis.title.y=element_text(size=11), axis.text.x=element_text(size=9), axis.text.y=element_text(size=9)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0,1200), breaks = c(0,200,400,600,800,1000,1200))

p2 <- p1 %+% xs$`Use-Inspired`
p3 <- p1 %+% xs$Applied
p1<-p1+scale_fill_manual(name = "ID",values =mycols[c(2,4)], labels=c("2006-2010", "2011-2015"))+labs(title="Fundamental")+ theme(plot.title = element_text(size=12, hjust=0.5, face = "bold"))
p2<-p2+scale_fill_manual(name = "ID",values =mycols[c(6,1)], labels=c("2006-2010", "2011-2015"))+labs(title="Use-inspired")+ theme(plot.title = element_text(size=12, hjust=0.5, face = "bold"))
p3<-p3+scale_fill_manual(name = "ID",values =mycols[c(3,5)], labels=c("2006-2010", "2011-2015"))+labs(title="Applied")+ theme(plot.title = element_text(size=12, hjust=0.5, face = "bold"))

grid.arrange(p1,p2,p3, nrow=1, top=textGrob("Number of research grant applications\n(developed nations, 340 CA)",gp=gpar(fontsize=17)))

#dev.off()

```

```{r echo=FALSE, fig.cap="Fig 4.10 Research grant application success over the past 10 years. Researchers were asked to estimate the percentage of their research grant applications that were successful in 2006-2010 and in 2011-2015. Respondents also had the choice to answer No need for applications for this research type.", message=FALSE, warning=FALSE}

part3.success.long<-read.csv(file="../data/gya-part3.success.long.csv")

#selecting for developed countries
part3.success.long<-part3.success.long[part3.success.long$nation%in% developed,]
#dim(part3.success.long)   #8934

## now to randomly select for 340 canadian surveys so it does not scew the data 
#create two data frames 1:Canadian   2: non Canadian
#1: Canadian
ca <- part3.success.long[part3.success.long$nation == "Canada",]
#head(ca)
ca<-droplevels(ca)
#unique(ca$nation)

#2: others
other <- part3.success.long[!part3.success.long$nation == "Canada",]
#head(other)
other<- droplevels(other)
#unique(other$nation)

#now randomly select 340 Canadian
# dim(ca) #528   16
# randca <- ca[sample(nrow(ca), 340), ]
# dim(randca)  #340  16     188 subtracted
# randcaid<-unique(randca$id)  # now use this to select from for all future so it doesnt change everytime i run the code
#write a csv (then comment it out) with the data so it stays permanent
#write.csv(randcaid, "data/gya_survey_response_developed_randCA_IDs.csv", row.names = FALSE)

#now read in the csv so it will be the same random surveys from here on out
randcaid <- read.csv("data/gya_survey_response_developed_randCA_IDs.csv", col.names = TRUE)
randid <- unique(randcaid$TRUE.)
#head(randid)

randca <- ca[ca$id %in% randid,]
#head(randca)
#dim(randca)  #1379  
#dim(ca)   #4584     3205  subtracted

#now combine them back together
part3.success.long <- rbind(randca, other)
#head(part3.success.long)
#dim(part3.success.long)  # 5729     3205 subtracted so we are good to go

part3.success.long$type<-as.character(part3.success.long$type)

#add time variable
part3.success.long$time<-ifelse(grepl("11_15", part3.success.long$type), "2011-2015", "2006-2010")
part3.success.long$type[part3.success.long$type=="successful_grants_11_15_fundamental"]<-"Fundamental"
part3.success.long$type[part3.success.long$type=="successful_grants_6_10_fundamental"]<-"Fundamental"
part3.success.long$type[part3.success.long$type=="successful_grants_11_15_use"]<-"Use-Inspired"
part3.success.long$type[part3.success.long$type=="successful_grants_6_10_use"]<-"Use-Inspired"
part3.success.long$type[part3.success.long$type=="successful_grants_11_15_applied"]<-"Applied"
part3.success.long$type[part3.success.long$type=="successful_grants_6_10_applied"]<-"Applied"

success.gbl<-data.frame(with(part3.success.long, table(type, percent,time)))



#change order of types
success.gbl$type<-as.factor(success.gbl$type)
success.gbl$type<-factor(success.gbl$type, levels(success.gbl$type)[c(2,3,1)])

success.gbl$id<-paste(success.gbl$type, success.gbl$time)

# change order of the levels
success.gbl$id<-as.factor(success.gbl$id)
success.gbl$id<-factor(success.gbl$id, levels(success.gbl$id)[c(3,4,5,6,1,2)])

mycols10<-c('#1f78b4','#a6cee3','#33a02c','#b2df8a','#e31a1c', '#fb9a99')
mycols10<-as.data.frame(mycols10)
mycols10$id<-levels(success.gbl$id)
success.gbl$col<-mycols10$mycols10[match(success.gbl$id, mycols10$id)]
success.gbl$col<-factor(success.gbl$col, levels(success.gbl$col)[c(3,1,4,2,6,5)])

#pdf(file="figures/developed_randCA/4.10_GrantAppSuccess.pdf", height=7, width =11)

out2<-by(data = success.gbl, INDICES = success.gbl$type, FUN = function(n){
  n <- droplevels(n)
  n$col<-factor(n$col, levels(n$col)[c(3,1,4,2,6,5)])
  mycols10<-as.character(unique(n$col))
  colScale <- scale_fill_manual(name = "id",values =mycols10, labels=c("2006-2010", "2011-2015"))
  n <- ggplot(n, aes(percent, Freq, fill=id)) +
    geom_bar(stat="identity", position='dodge')  +
    guides(fill=guide_legend(title=NULL, reverse=FALSE, nrow=2)) +
    labs(x="Percent of successful grants", y="Number of responses", title=n$type)+
    theme(aspect.ratio=1/4, panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          legend.key=element_blank(),legend.text=element_text(size = 9),
          strip.text.x = element_text(size=12, face="bold", color="black", hjust=0.5),
          strip.background = element_rect(colour="white", fill="white"),
           axis.title.y=element_text(size=11),plot.title = element_text(size=12, face="bold", hjust=0.5),
          axis.title.x=element_text(size=11), axis.text.x=element_text(size=9), axis.text.y=element_text(size=9), title=element_text(size = 12)) + colScale +
    scale_y_continuous(expand=c(0,0), limits=c(0,280), breaks = seq(0, 280, 50))
 })
do.call(grid.arrange, out2)

#dev.off()
```
 
```{r echo=FALSE, fig.cap="Fig 4.11 Change in grant success rates over the past 10 years. Researchers were asked if they thought that grant sucecss rates have changed in the past 10 years  for each research category.", message=FALSE, warning=FALSE}
#selecting for developed countries
part3.change.devp<-part3.change[part3.change$nation%in% developed,]
#dim(part3.change.devp)  #2641

## now to randomly select for 340 canadian surveys so it does not scew the data 
#create two data frames 1:Canadian   2: non Canadian
#1: Canadian
ca <- part3.change.devp[part3.change.devp$nation == "Canada",]
#head(ca)
ca<-droplevels(ca)
#unique(ca$nation)

#2: others
other <- part3.change.devp[!part3.change.devp$nation == "Canada",]
#head(other)
other<- droplevels(other)
#unique(other$nation)

#now randomly select 340 Canadian
# dim(ca) #528   16
# randca <- ca[sample(nrow(ca), 340), ]
# dim(randca)  #340  16     188 subtracted
# randcaid<-unique(randca$id)  # now use this to select from for all future so it doesnt change everytime i run the code
#write a csv (then comment it out) with the data so it stays permanent
#write.csv(randcaid, "data/gya_survey_response_developed_randCA_IDs.csv", row.names = FALSE)

#now read in the csv so it will be the same random surveys from here on out
randcaid <- read.csv("data/gya_survey_response_developed_randCA_IDs.csv", col.names = TRUE)
randid <- unique(randcaid$TRUE.)
#head(randid)

randca <- ca[ca$id %in% randid,]
#head(randca)
#dim(randca)  #340   
#dim(ca)   #1331    991 subtracted

#now combine them back together
part3.change.devp <- rbind(randca, other)
#head(part3.change.devp)
#dim(part3.change.devp)  # 1650  991 subtracted so we are good to go

##switch to long format
change.long.gbl<-gather(part3.change.devp, type, level, -Location, -nation, -gender, -Country, -Country_work, -what_participant_group, -field_research, -id)
success.change<-with(change.long.gbl, data.frame(table(type, level)))
#remove no response
success.change<-success.change[!success.change$level=="",]
success.change<-droplevels(success.change)

# add colour palette
myColors11<-c('#1f78b4','#33a02c','#e31a1c')
colScale <- scale_fill_manual(name = "type",values = myColors11, labels=c("Fundamental", "Use-inspired", "Applied"))

#change order of levels
success.change$level<-factor(success.change$level, levels(success.change$level)[c(5,4,6,2,3,1)])
success.change$type<-factor(success.change$type, levels(success.change$type)[c(2,3,1)])
success.change$type<-revalue(success.change$type, c("success_change_10yrs_fundamental"="Fundamental",
              'success_change_10yrs_use'='Use-inspired', 'success_change_10yrs_applied' = 'Applied'))

#pdf(file="figures/developed_randCA/4.11_ChangeSuccessRate.pdf", height=7, width =11)

ggplot(data=success.change, aes(x=level, Freq, fill=type))+ facet_wrap(~type, nrow=3)+
  geom_bar(stat="identity", position="dodge")+
  guides(fill=guide_legend(title=NULL)) +
  theme(aspect.ratio=1/4, axis.text.x = element_text(angle=0, vjust=0.5, size = 9), axis.text.y=element_text(size = 9), axis.title.y=element_text(size = 11),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
         strip.text.x = element_text(size=12, face="bold", color="black"),
          strip.background = element_rect(colour="white", fill="white"),
        legend.position=c(0.15, 0.9), plot.title = element_text(hjust = 0.5))+
  guides(fill=FALSE)+
  geom_text(aes(label=Freq, vjust=-0.4),size=3) +
  scale_x_discrete(labels=c("Increased\n considerably", "Increased\n slightly", 
                                    "Stayed the\n same", "Decreased\n slightly", "Decreased\n considerably", "Can't\n comment"),limits = (levels(success.change$level)))+
  labs(x="", y="Number of responses", fill="", title="Change in grant success rate (developed nations, 340 CA)")+ colScale+
  scale_y_continuous(expand = c(0, 0), limits = c(0,700))

#dev.off()


```

```{r echo=FALSE, fig.cap="Fig 4.12 Importance of practical application of research over the past 10 years. Researchers were asked how important it was to suggest practical applications of their research to ensure that the grant was successful in 2006-2010 and in 2011-2015.", message=FALSE, warning=FALSE}
#selecting for developed countries
part3.prac.long<-part3.prac.long[part3.prac.long$nation%in% developed,]
#dim(part3.prac.long)    #5148

## now to randomly select for 340 canadian surveys so it does not scew the data 
#create two data frames 1:Canadian   2: non Canadian
#1: Canadian
ca <- part3.prac.long[part3.prac.long$nation == "Canada",]
#head(ca)
ca<-droplevels(ca)
#unique(ca$nation)

#2: others
other <- part3.prac.long[!part3.prac.long$nation == "Canada",]
#head(other)
other<- droplevels(other)
#unique(other$nation)

#now randomly select 340 Canadian
# dim(ca) #528   16
# randca <- ca[sample(nrow(ca), 340), ]
# dim(randca)  #340  16     188 subtracted
# randcaid<-unique(randca$id)  # now use this to select from for all future so it doesnt change everytime i run the code
#write a csv (then comment it out) with the data so it stays permanent
#write.csv(randcaid, "data/gya_survey_response_developed_randCA_IDs.csv", row.names = FALSE)

#now read in the csv so it will be the same random surveys from here on out
randcaid <- read.csv("data/gya_survey_response_developed_randCA_IDs.csv", col.names = TRUE)
randid <- unique(randcaid$TRUE.)
#head(randid)

randca <- ca[ca$id %in% randid,]
#head(randca)
#dim(randca)  #671   
#dim(ca)   #2589  1918 subtracted

#now combine them back together
part3.prac.long <- rbind(randca, other)
#head(part3.prac.long)
#dim(part3.prac.long)  # 3230    1918 subtracted so we are good to go

part3.prac.long$year<-as.character(part3.prac.long$year)

part3.prac.long$year[part3.prac.long$year=="practical_applications_important_11_15"]<-"2011-2015"
part3.prac.long$year[part3.prac.long$year=="practical_applications_important_6_10"]<-"2006-2010"


prac.gbl<-data.frame(table(part3.prac.long$year, part3.prac.long$level))

#change order of levels
prac.gbl$Var2<-factor(prac.gbl$Var2, levels(prac.gbl$Var2)[c(2,6,4,5,3,1)])

myColors12<-(brewer.pal(9, "Blues"))
myColors12<-rev(myColors12[c(9, 5)])
colScale <- scale_fill_manual(name = "Var1",values = myColors12)

#pdf(file="figures/developed_randCA/4.12_ImportancePracticalApplication.pdf", height=7, width =11)

ggplot(prac.gbl, aes(Var2, Freq, fill=Var1)) + 
  geom_bar(stat="identity", position = "dodge")+geom_text(aes(label=Freq), vjust=-0.7, hjust=0.45, size=3, position = position_dodge(width = 0.95))+
  theme(aspect.ratio=3/4, panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.key=element_blank(),legend.text=element_text(size = 9),
        legend.position=c(0.89, 0.91),
        axis.text.x = element_text(angle=0, vjust=0.5, size = 9), axis.text.y=element_text(size = 9), axis.title.x=element_text(size = 11),
        axis.title.y=element_text(size = 11), plot.title = element_text(hjust = 0.5)) +
  guides(fill=guide_legend(title=NULL, reverse=FALSE)) + 
  scale_x_discrete(labels=c("Mandatory", "Very\n important","Quite\n important", 'Somewhat\n important', 'Not at all\n important', "Can't\n comment"))+
  labs(x="Importance of suggesting practical research applications", y="Number of responses", title="Importance of practical application for grant success (developed nations, 340 CA)")+ colScale+
  scale_y_continuous(expand = c(0, 0), limits = c(0,550))
  
#dev.off()
```

```{r echo=FALSE, fig.cap="Fig 4.13 Importance of including partners from for-profit or non-governmental sectors in grant success. Researchers were asked how important it was to include external partnerships in their research to ensure that the grant was successful in 2006-2010 and in 2011-2015.", message=FALSE, warning=FALSE}
#selecting for developed countries
part3.part.long<-part3.part.long[part3.part.long$nation%in% developed,]
#dim(part3.part.long)  #5126

## now to randomly select for 340 canadian surveys so it does not scew the data 
#create two data frames 1:Canadian   2: non Canadian
#1: Canadian
ca <- part3.part.long[part3.part.long$nation == "Canada",]
#head(ca)
ca<-droplevels(ca)
#unique(ca$nation)

#2: others
other <- part3.part.long[!part3.part.long$nation == "Canada",]
#head(other)
other<- droplevels(other)
#unique(other$nation)

#now randomly select 340 Canadian
# dim(ca) #528   16
# randca <- ca[sample(nrow(ca), 340), ]
# dim(randca)  #340  16     188 subtracted
# randcaid<-unique(randca$id)  # now use this to select from for all future so it doesnt change everytime i run the code
#write a csv (then comment it out) with the data so it stays permanent
#write.csv(randcaid, "data/gya_survey_response_developed_randCA_IDs.csv", row.names = FALSE)

#now read in the csv so it will be the same random surveys from here on out
randcaid <- read.csv("data/gya_survey_response_developed_randCA_IDs.csv", col.names = TRUE)
randid <- unique(randcaid$TRUE.)
#head(randid)

randca <- ca[ca$id %in% randid,]
#head(randca)
#dim(randca)  #667
#dim(ca)   #2577     1910  subtracted

#now combine them back together
part3.part.long <- rbind(randca, other)
#head(part3.part.long)
#dim(part3.part.long)  # 3216  1910 subtracted so we are good to go

part3.part.long$year<-as.character(part3.part.long$year)

part3.part.long$year[part3.part.long$year=="include_nonacademia_partners_success_11_15"]<-"2011-2015"
part3.part.long$year[part3.part.long$year=="include_nonacademia_partners_success_6_10"]<-"2006-2010"

part.gbl<-data.frame(table(part3.part.long$year, part3.part.long$level))
#change order of levels
part.gbl$Var2<-factor(part.gbl$Var2, levels(part.gbl$Var2)[c(2,5,6,4,3,1)])

## add colour scale
myColors13<-(brewer.pal(9, "Blues"))
myColors13<-rev(myColors13[c(9, 5)])
colScale <- scale_fill_manual(name = "Var1",values = myColors13)

#pdf(file="figures/developed_randCA/4.13_ImportancePartnersApplication.pdf", height=7, width =11)

ggplot(part.gbl, aes(Var2, Freq, fill=Var1))+ 
  geom_bar(stat="identity", position = "dodge")+geom_text(aes(label=Freq), vjust=-0.7, hjust=0.5, size=3, position = position_dodge(width = 0.8))+
    guides(fill=guide_legend(title=NULL, reverse=FALSE)) +
    labs(x="Importance of external partnerships", y="Number of responses", title="Importance of external partnership to the success of grants (developed nations, 340 CA)")+
  scale_x_discrete(labels=c("Mandatory", "Quite\n important", 'Somewhat\n important',"Not very\n important", 'Not at all\n important', "Can't\n comment"))+
    theme(aspect.ratio=3/4, panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),legend.text=element_text(size = 9),
          legend.key=element_blank(),
          legend.position=c(0.11, 0.93), axis.text.x=element_text(size = 9), axis.text.y=element_text(size=9),
          axis.title.x=element_text(size = 11), axis.title.y=element_text(size = 11), plot.title = element_text(hjust = 0.5)) + colScale+
  scale_y_continuous(expand = c(0, 0), limits = c(0,510))

#dev.off()
```

```{r eval=FALSE, fig.cap="Fig (4.12+4.13) Importance of practical applications and external partnerships.", warning=FALSE, include=FALSE}
###4.12
myColors12<-(brewer.pal(9, "Blues"))
myColors12<-rev(myColors12[c(9, 5)])
colScale <- scale_fill_manual(name = "Var1",values = myColors12)


p10<-ggplot(prac.is, aes(Var2, Freq, fill=Var1)) + 
  geom_bar(stat="identity", position = "dodge")+
  theme(aspect.ratio=3/4, panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.key=element_blank(),
        legend.position=c(0.88, 0.898), legend.text=element_text(size = 9),
        axis.text.x = element_text(angle=0, vjust=0.5, size = 9), axis.text.y=element_text(size = 9), axis.title.x=element_text(size = 11),
        axis.title.y=element_text(size = 11)) +
  guides(fill=guide_legend(title=NULL, reverse=FALSE)) + 
  scale_x_discrete(labels=c("Mandatory", "Very\n important","Quite\n important", 'Somewhat\n important', 'Not at all\n important', "Can't\n comment"))+
  labs(x="", y="Number of responses")+ colScale+
  scale_y_continuous(expand = c(0, 0), limits = c(0,50))+annotate('text', 0.65,423, label="(a)", size=5)
p10

###4.13
myColors13<-(brewer.pal(9, "Blues"))
myColors13<-rev(myColors13[c(9, 5)])
colScale <- scale_fill_manual(name = "Var1",values = myColors13)


p11<-ggplot(part.is, aes(Var2, Freq, fill=Var1))+ 
  geom_bar(stat="identity", position = "dodge")+
    guides(fill=guide_legend(title=NULL, reverse=FALSE)) +
    labs(x="", y="")+
  scale_x_discrete(labels=c("Mandatory", "Quite\n important", 'Somewhat\n important',"Not very\n important", 'Not at all\n important', "Can't\n comment"))+
    theme(aspect.ratio=3/4, panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          legend.key=element_blank(),legend.text=element_text(size = 9),
          legend.position=c(0.13, 0.898), axis.text.x=element_text(size = 9), axis.text.y=element_text(size=9),
          axis.title.x=element_text(size = 11), axis.title.y=element_text(size = 11)) + colScale+
  scale_y_continuous(expand = c(0, 0), limits = c(0,60))+annotate('text', 0.65,460, label="(b)", size=5)
p11

#pdf(file="figures/developed_randCA/4.3_13Apr.pdf", width = 11, height= 7)

grid.arrange(p10,p11, heights=c(0.5,0.5), ncol=1)

#dev.off()

```

```{r echo=FALSE, fig.cap="Fig 4.14 Distribution of research funding over the past 10 years. Researchers were asked to estimate the distribution of their research funding sources in 2006-2010 and 2011-2015.", message=FALSE, warning=FALSE}
#selecting for developed countries
p3_master.long.devp<-p3_master.long[p3_master.long$nation%in% developed,]
#dim(p3_master.long.devp)  #20855

## now to randomly select for 340 canadian surveys so it does not scew the data 
#create two data frames 1:Canadian   2: non Canadian
#1: Canadian
ca <- p3_master.long.devp[p3_master.long.devp$nation == "Canada",]
#head(ca)
ca<-droplevels(ca)
#unique(ca$nation)

#2: others
other <- p3_master.long.devp[!p3_master.long.devp$nation == "Canada",]
#head(other)
other<- droplevels(other)
#unique(other$nation)

#now randomly select 340 Canadian
# dim(ca) #528   16
# randca <- ca[sample(nrow(ca), 340), ]
# dim(randca)  #340  16     188 subtracted
# randcaid<-unique(randca$id)  # now use this to select from for all future so it doesnt change everytime i run the code
#write a csv (then comment it out) with the data so it stays permanent
#write.csv(randcaid, "data/gya_survey_response_developed_randCA_IDs.csv", row.names = FALSE)

#now read in the csv so it will be the same random surveys from here on out
randcaid <- read.csv("data/gya_survey_response_developed_randCA_IDs.csv", col.names = TRUE)
randid <- unique(randcaid$TRUE.)
#head(randid)

randca <- ca[ca$id %in% randid,]
#head(randca)
#dim(randca)  #2800
#dim(ca)   #10470     7670 subtracted

#now combine them back together
p3_master.long.devp <- rbind(randca, other)
#head(p3_master.long.devp)
#dim(p3_master.long.devp)  # 13185   7670 subtracted so we are good to go

p3_master.long.devp$year <- ifelse(grepl("11_15", p3_master.long.devp$type.year), "11_15", "6_10")
#head(p3_master.long.devp)

p3_master.long.devp$type <- 1
p3_master.long.devp$type <- ifelse(grepl("For-Profit", p3_master.long.devp$type.year), "For-Profit", p3_master.long.devp$type)
p3_master.long.devp$type <- ifelse(grepl("Government", p3_master.long.devp$type.year), "Government", p3_master.long.devp$type)
p3_master.long.devp$type <- ifelse(grepl("Internal", p3_master.long.devp$type.year), "Internal", p3_master.long.devp$type)
p3_master.long.devp$type <- ifelse(grepl("Non-governmental", p3_master.long.devp$type.year), "Non-governmental", p3_master.long.devp$type)
p3_master.long.devp$type <- ifelse(grepl("Other", p3_master.long.devp$type.year), "Other", p3_master.long.devp$type)

##revalue the year values
p3_master.long.devp$year<- revalue(p3_master.long.devp$year, c("11_15"="2011-2015", "6_10"="2006-2010"))

#change order of levels
#p3_master.long.devp$year<-factor(p3_master.long.devp$year, levels(p3_master.long.devp$year)[c(2,1)])

##For-Profit
fp<-p3_master.long.devp[p3_master.long.devp$type=="For-Profit",]

myColors14<-(brewer.pal(9, "Blues"))
myColors14<-rev(myColors14[c(9, 5)])
colScale <- scale_fill_manual(name = "year",values = myColors14)

p1<-ggplot(fp, aes(percent, fill=year))+ geom_histogram(position='dodge', binwidth=10)  + colScale +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.922, 0.98), 
          legend.key.size = unit(0.3, "cm"), plot.title = element_text(size=12, hjust = 0.5, face="bold"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), axis.text.x=element_text(size = 9), axis.text.y=element_text(size = 9), legend.key=element_blank(),
          axis.title.x=element_text(size=11), axis.title.y=element_text(size = 11)) +
  labs(list(title= "Industry", x="", y = "Number of responses"))+
  scale_y_continuous(expand =c(0,0), limits=c(0,1600), breaks=seq(0, 1600, 500))+
  scale_x_continuous( breaks = seq(0, 100, 10))



##Government
gov<-p3_master.long.devp[p3_master.long.devp$type=="Government",]

myColors14<-(brewer.pal(9, "Blues"))
myColors14<-rev(myColors14[c(9, 5)])
colScale <- scale_fill_manual(name = "year",values = myColors14)

p2<-ggplot(gov, aes(percent, fill=year))+ geom_histogram(position='dodge', binwidth=10)  + colScale +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.9, 0.91),
          legend.key.size = unit(0.3, "cm"),plot.title = element_text(size=12, hjust = 0.5, face="bold"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), axis.text.x=element_text(size = 9), axis.text.y=element_text(size = 9), legend.key=element_blank(),
          axis.title.x=element_text(size=11), axis.title.y=element_text(size = 11)) +
  labs(title="Government", x="", y = "")+
  scale_y_continuous(expand =c(0,0),limits=c(0,1600), breaks=seq(0, 1600, 500))+
  scale_x_continuous( breaks = seq(0, 100, 10))




##Internal

int<-p3_master.long.devp[p3_master.long.devp$type=="Internal",]

myColors14<-(brewer.pal(9, "Blues"))
myColors14<-rev(myColors14[c(9, 5)])
colScale <- scale_fill_manual(name = "year",values = myColors14)

p3<-ggplot(int, aes(percent, fill=year))+ geom_histogram(position='dodge', binwidth=10)  + colScale +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.922, 0.98),
          legend.key.size = unit(0.3, "cm"),plot.title = element_text(size=12, hjust = 0.5, face="bold"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), axis.text.x=element_text(size = 9), axis.text.y=element_text(size = 9), legend.key=element_blank(),
          axis.title.x=element_text(size=11), axis.title.y=element_text(size = 11)) +
  labs(title="Internal",x="% research funding", y = "Number of responses")+
  scale_y_continuous(expand =c(0,0), limits=c(0,1600), breaks=seq(0, 1600, 500))+
  scale_x_continuous( breaks = seq(0, 100, 10))




##Non-Governmental

ngov<-p3_master.long.devp[p3_master.long.devp$type=="Non-governmental",]

myColors14<-(brewer.pal(9, "Blues"))
myColors14<-rev(myColors14[c(9, 5)])
colScale <- scale_fill_manual(name = "year",values = myColors14)

p4<-ggplot(ngov, aes(percent, fill=year))+ geom_histogram(position='dodge', binwidth=10)  + colScale +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.922, 0.98),
          legend.key.size = unit(0.3, "cm"),plot.title = element_text(size=12, hjust = 0.5, face="bold"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), axis.text.x=element_text(size = 9), axis.text.y=element_text(size = 9), legend.key=element_blank(),
          axis.title.x=element_text(size=11), axis.title.y=element_text(size = 11)) +
  labs(title="Non-governmental", x="% research funding", y = "")+
  scale_y_continuous(expand =c(0,0),limits=c(0,1600), breaks=seq(0, 1600, 500))+
  scale_x_continuous( breaks = seq(0, 100, 10))



## Other

other<-p3_master.long.devp[p3_master.long.devp$type=="Other",]

myColors14<-(brewer.pal(9, "Blues"))
myColors14<-rev(myColors14[c(9, 5)])
colScale <- scale_fill_manual(name = "year",values = myColors14)

p5<-ggplot(other, aes(percent, fill=year))+ geom_histogram(position='dodge', binwidth=10)  + colScale +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.8, 0.91),
          legend.key.size = unit(0.3, "cm"),plot.title = element_text(size=12, hjust = 0.5, face="bold"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), axis.text.x=element_text(size = 9), axis.text.y=element_text(size = 9), legend.key=element_blank(),
          axis.title.x=element_text(size=11), axis.title.y=element_text(size = 11)) +
  labs(title="Other", x="% research funding", y = "")+
  scale_y_continuous(expand =c(0,0), limits=c(0,1600), breaks=seq(0, 1600, 500))+
  scale_x_continuous( breaks = seq(0, 100, 10))


##put them all together

legend = gtable_filter(ggplotGrob(p1), "guide-box") 
grid.draw(legend)

#pdf(file="figures/developed_randCA/4.14_DistributionFunding.pdf", height=7, width =11)

grid.arrange(arrangeGrob(p1+ theme(legend.position="none"), p2,
                         p3+ theme(legend.position="none"), p4+ theme(legend.position="none"),
                         p5,
                         layout_matrix=rbind(c(1,1,1,2,2,2),c(3,3,4,4,5,5))), top=textGrob("Distribution of research funding (developed nations, 340 CA)",gp=gpar(fontsize=17)))

#dev.off()

```


<!--Part 4 - Funding Trends in your country of work-->
<!--**4.4 Perspectives on the State of Fundamental Research**-->

```{r echo=FALSE, fig.cap="Fig 4.15 Perceived importance of fundamental research to their government. Researchers were asked how important they thought fundamental research was to the their government. Responses were/were not significantly different between genders.", message=FALSE, warning=FALSE}
#selecting for developed countries
part4.devp<-part4[part4$nation%in% developed,]
#dim(part4.devp)   #2641

## now to randomly select for 340 canadian surveys so it does not scew the data 
#create two data frames 1:Canadian   2: non Canadian
#1: Canadian
ca <- part4.devp[part4.devp$nation == "Canada",]
#head(ca)
ca<-droplevels(ca)
#unique(ca$nation)

#2: others
other <- part4.devp[!part4.devp$nation == "Canada",]
#head(other)
other<- droplevels(other)
#unique(other$nation)

#now randomly select 340 Canadian
# dim(ca) #528   16
# randca <- ca[sample(nrow(ca), 340), ]
# dim(randca)  #340  16     188 subtracted
# randcaid<-unique(randca$id)  # now use this to select from for all future so it doesnt change everytime i run the code
#write a csv (then comment it out) with the data so it stays permanent
#write.csv(randcaid, "data/gya_survey_response_developed_randCA_IDs.csv", row.names = FALSE)

#now read in the csv so it will be the same random surveys from here on out
randcaid <- read.csv("data/gya_survey_response_developed_randCA_IDs.csv", col.names = TRUE)
randid <- unique(randcaid$TRUE.)
#head(randid)

randca <- ca[ca$id %in% randid,]
#head(randca)
#dim(randca)  #340   
#dim(ca)   #1331  991 subtract

#now combine them back together
part4.devp <- rbind(randca, other)
#head(part4.devp)
#dim(part4.devp)  # 1650    991 subtracted so we are good to go

## order bars from very important (left) to can't comment (right)
important<-subset(part4.devp, select=c("Location","Country",'Country_work', "gender","opinion_fundamental_important"))

## using table to count cases of each category
sum.important<-data.frame(table(important$opinion_fundamental_important))
# remove non-responses
sum.important<-sum.important[!sum.important$Var1=="",]
sum.important$Var1<-factor(sum.important$Var1, levels(sum.important$Var1)[c(6,5,4,3,2,1)])

perceive<-aggregate(Freq~Var1, sum.important, sum)

### colour palette

myColors15<-(brewer.pal(9, "Blues"))
myColors15<-(myColors15[c(4,4,4,4,4,4)])
colScale <- scale_fill_manual(name = "Var1",values = myColors15)

#pdf(file="figures/developed_randCA/4.15_PerceivedImportanceFundamentalGovernment.pdf", height=7, width =11)

ggplot(data=perceive, aes(x=Var1, y=Freq, fill=Var1)) + 
      geom_bar(stat='identity', position='dodge')+ 
      labs(x="", y="Number of responses", fill="", title="Perceived importance of fundamental research to their government (developed nations, 340 CA)")+
      scale_x_discrete(labels=c("Very\n important", "Somewhat\n important", 'Not very\n important', 'Not at all\n important', "Can't\n comment"))+
      geom_text(aes(label=Freq, vjust=-0.5), size=3) + guides(fill=FALSE)+
      theme(aspect.ratio=3/4, axis.text.x = element_text(angle=0, vjust=0.4, size=9),
            panel.grid.major = element_blank(), 
            panel.grid.minor = element_blank(), axis.title.y=element_text(size=11), axis.text.y=element_text(size=9), plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0,585)) + colScale

#dev.off()
```

```{r echo=FALSE, fig.cap="Fig 4.16 Perceived change in research priority by their government. Researchers were asked whether any types of research had become higher priority for the their government. Responses were/were not significantly different between genders.", message=FALSE, warning=FALSE}
#selecting for developed countries
part4.devp<-part4[part4$nation%in% developed,]
#dim(part4.devp)    #2641

## now to randomly select for 340 canadian surveys so it does not scew the data 
#create two data frames 1:Canadian   2: non Canadian
#1: Canadian
ca <- part4.devp[part4.devp$nation == "Canada",]
#head(ca)
ca<-droplevels(ca)
#unique(ca$nation)

#2: others
other <- part4.devp[!part4.devp$nation == "Canada",]
#head(other)
other<- droplevels(other)
#unique(other$nation)

#now randomly select 340 Canadian
# dim(ca) #528   16
# randca <- ca[sample(nrow(ca), 340), ]
# dim(randca)  #340  16     188 subtracted
# randcaid<-unique(randca$id)  # now use this to select from for all future so it doesnt change everytime i run the code
#write a csv (then comment it out) with the data so it stays permanent
#write.csv(randcaid, "data/gya_survey_response_developed_randCA_IDs.csv", row.names = FALSE)

#now read in the csv so it will be the same random surveys from here on out
randcaid <- read.csv("data/gya_survey_response_developed_randCA_IDs.csv", col.names = TRUE)
randid <- unique(randcaid$TRUE.)
#head(randid)

randca <- ca[ca$id %in% randid,]
#head(randca)
#dim(randca)  #340   
#dim(ca)   #1331    991  subtracted

#now combine them back together
part4.devp <- rbind(randca, other)
#head(part4.devp)
#dim(part4.devp)  # 1650   16    991 subtracted so we are good to go

## order bars into applied > use > fundamental > no change
priority<-subset(part4.devp, select=c("Location","Country",'nation','Country_work', "gender", "high_priority_fundamental", "high_priority_use_inspired", "high_priority_applied", "high_priority_no_change"))

## switch to long format
priority.long<-gather(priority, what.type, higher.priority, -Location, -nation, -gender, -Country, -Country_work)
# remove non-responses (n = 1066)
priority.long<-priority.long[!priority.long$higher.priority=="",]
per.change<-aggregate(higher.priority~what.type, priority.long, sum)

# change order of the levels
per.change$what.type<-as.factor(per.change$what.type)
per.change$what.type<-factor(per.change$what.type, levels(per.change$what.type)[c(2,4,1,3)])

myColors16<-(brewer.pal(9, "Blues"))
myColors16<-(myColors16[c(4,4,4,4,4,4)])
colScale <- scale_fill_manual(name = "Var1",values = myColors16)

#pdf(file="figures/developed_randCA/4.16_PerceivedChangeResearchPriorityGovernment.pdf", height=7, width =11)

ggplot(data=per.change, aes(x=what.type, higher.priority, fill=what.type))+
        geom_bar(stat="identity", position='dodge')+ guides(fill=FALSE)+
        theme(aspect.ratio=3/4, 
              axis.text.x = element_text(angle=0, vjust=0.4, size=9),
              panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(), axis.title.y=element_text(size=11),  axis.text.y=element_text(size=9), plot.title = element_text(hjust = 0.5)) +
        labs(x="", y="Number of responses", fill="", title="Perceived change in research priority by their government (developed nations, 340 CA)") +
  scale_x_discrete(labels=c( "Fundamental", "Use-inspired","Applied", "No change"))   +
  geom_text(aes(label=higher.priority, vjust=-0.5), size=3) +scale_y_continuous(expand = c(0, 0), limits = c(0,1340))+ colScale

#dev.off()
```


```{r echo=FALSE, fig.cap="Fig 4.17 Anticipated change in research funding in next five years. Researchers were asked whether the availability of research funding would change in the next five years.", message=FALSE, warning=FALSE}
#selecting for developed countries
part4.devp<-part4[part4$nation%in% developed,]
#dim(part4.devp)   #2641

## now to randomly select for 340 canadian surveys so it does not scew the data 
#create two data frames 1:Canadian   2: non Canadian
#1: Canadian
ca <- part4.devp[part4.devp$nation == "Canada",]
#head(ca)
ca<-droplevels(ca)
#unique(ca$nation)

#2: others
other <- part4.devp[!part4.devp$nation == "Canada",]
#head(other)
other<- droplevels(other)
#unique(other$nation)

#now randomly select 340 Canadian
# dim(ca) #528   16
# randca <- ca[sample(nrow(ca), 340), ]
# dim(randca)  #340  16     188 subtracted
# randcaid<-unique(randca$id)  # now use this to select from for all future so it doesnt change everytime i run the code
#write a csv (then comment it out) with the data so it stays permanent
#write.csv(randcaid, "data/gya_survey_response_developed_randCA_IDs.csv", row.names = FALSE)

#now read in the csv so it will be the same random surveys from here on out
randcaid <- read.csv("data/gya_survey_response_developed_randCA_IDs.csv", col.names = TRUE)
randid <- unique(randcaid$TRUE.)
#head(randid)

randca <- ca[ca$id %in% randid,]
#head(randca)
#dim(randca)  #340 
#dim(ca)   #1331   991  subtracting

#now combine them back together
part4.devp <- rbind(randca, other)
#head(part4.devp)
#dim(part4.devp)  # 1650    991 subtracted so we are good to go

## change in funding on the x-axis, and colours = type of research
## order bars into increase considerably (left) to decrease considerably (right), then no comment at the far right
availability.change<-subset(part4.devp, select=c("Location", "Country","nation",'Country_work', "gender", "available_funding_fundamental",  
                                             "available_funding_use_inspired", "available_funding_applied"))
## switch to long format
availability.change.long.gbl<-gather(availability.change, what.type, level, -gender, -nation, -Location, -Country, -Country_work)
availability.gbl<-with(availability.change.long.gbl, data.frame(table(what.type, level)))

#remove non response
availability.gbl<-availability.gbl[!availability.gbl$level=="",]

## change type to factor with levels
availability.gbl$level<-str_replace_all(availability.gbl$level, "Will ", "")
availability.gbl$what.type<-as.factor(availability.gbl$what.type)
availability.gbl$level<-as.factor(availability.gbl$level)

## change order of levels
availability.gbl$level<-factor(availability.gbl$level, levels(availability.gbl$level)[c(4,5,6,3,2,1 )])
availability.gbl$what.type<-factor(availability.gbl$what.type, levels(availability.gbl$what.type)[c(2,3,1)])

availability.gbl$what.type<-revalue(availability.gbl$what.type, c("available_funding_fundamental"="Fundamental",
              'available_funding_use_inspired'='Use-inspired', 'available_funding_applied' = 'Applied'))

### colour palette

myColors17<-mycols<-c('#1f78b4','#33a02c','#e31a1c')
colScale <- scale_fill_manual(name = "what.type",values = myColors17)

#pdf(file="figures/developed_randCA/4.17_AnticipatedChangeFunding.pdf", height=7, width =11)

ggplot(data=availability.gbl, aes(x=level, Freq, fill=what.type))+
    geom_bar(stat="identity", position="dodge")+
    theme(aspect.ratio=1/4, axis.text.x = element_text(angle=0, vjust=0.5, size = 9),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
           strip.text.x = element_text(size=12, face="bold", color="black"),
          strip.background = element_rect(colour="white", fill="white"),
          legend.position=c(0.8, 0.2), axis.title.y=element_text(size=11), axis.text.y=element_text(size=9), plot.title = element_text(hjust = 0.5)) +
    guides(fill=FALSE)+
    labs(x="", y="Number of responses", fill="", title="Anticipated change in funding (developed nations, 340 CA)")+
    scale_x_discrete(labels=c("Increase\n considerably", "Increase\n slightly", 
                                    "Stay the same", "Decrease\n slightly", "Decrease\n considerably", "Can't\n comment"))+
    facet_wrap(~what.type,nrow=3)+
    geom_text(aes(label=Freq), vjust=-0.5, size=2.8) + colScale +
  scale_y_continuous(expand = c(0, 0), limits = c(0,620), breaks = seq(0,600,100))

#dev.off()


```

```{r echo=FALSE, fig.cap="Fig 4.18 Effect of change in research funding on research careers of next generation. Researchers were asked if they though that changes in funding availability would influence the likelihood of the next generation pursuing careers in research. Responses were/were not significantly different between genders.", message=FALSE, warning=FALSE}
#selecting for developed countries
part4.devp<-part4[part4$nation%in% developed,]
#dim(part4.devp)    #2641

## now to randomly select for 340 canadian surveys so it does not scew the data 
#create two data frames 1:Canadian   2: non Canadian
#1: Canadian
ca <- part4.devp[part4.devp$nation == "Canada",]
#head(ca)
ca<-droplevels(ca)
#unique(ca$nation)

#2: others
other <- part4.devp[!part4.devp$nation == "Canada",]
#head(other)
other<- droplevels(other)
#unique(other$nation)

#now randomly select 340 Canadian
# dim(ca) #528   16
# randca <- ca[sample(nrow(ca), 340), ]
# dim(randca)  #340  16     188 subtracted
# randcaid<-unique(randca$id)  # now use this to select from for all future so it doesnt change everytime i run the code
#write a csv (then comment it out) with the data so it stays permanent
#write.csv(randcaid, "data/gya_survey_response_developed_randCA_IDs.csv", row.names = FALSE)

#now read in the csv so it will be the same random surveys from here on out
randcaid <- read.csv("data/gya_survey_response_developed_randCA_IDs.csv", col.names = TRUE)
randid <- unique(randcaid$TRUE.)
#head(randid)

randca <- ca[ca$id %in% randid,]
#head(randca)
#dim(randca)  #340   
#dim(ca)   #1331    991 subtracted

#now combine them back together
part4.devp <- rbind(randca, other)
#head(part4.devp)
#dim(part4.devp)  # 1650   991 subtracted so we are good to go

## order bars into increase considerably (left) to decrease considerably (right), then no comment at the far right
next.generation<-subset(part4.devp, select=c("Location", "Country","Country_work", "gender","next_generation"))
# remove non-response
next.generation<-next.generation[!next.generation$next_generation=="",]

impact<-data.frame(table(next.generation$next_generation))

## change type to factor with levels
impact$Var1<-str_replace_all(impact$Var1, "Will ", "")
impact$Var1<-as.factor(impact$Var1)
impact<-impact[!impact$Var1=="",]
impact<-droplevels(impact)
## change order of Var1s
impact$Var1<-factor(impact$Var1, levels(impact$Var1)[c(4,5,6,3,2,1)])
 
myColors18<-(brewer.pal(9, "Blues"))
myColors18<-(myColors18[c(4,4,4,4,4,4)])
colScale <- scale_fill_manual(name = "Var1",values = myColors18)

#pdf(file="figures/developed_randCA/4.18_EffectNextGeneration.pdf", height=7, width =11)

ggplot(data=impact, aes(x=Var1, Freq, fill=Var1))+ 
    geom_bar(stat='identity', position="dodge")  +
        scale_x_discrete(labels=c("Increase\n considerably", "Increase\n slightly", 
                                    "Stay the same", "Decrease\n slightly", "Decrease\n considerably", "Can't\n comment"))+
    guides(fill=FALSE) +
 labs(x="", y="Number of responses", title="Effect of funding changes on the next generation of researchers (developed nations, 340 CA)")+
  theme(aspect.ratio=3/4, axis.text.x = element_text(angle=0, vjust=0.5, size=9),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
          axis.title.y=element_text(size=11), axis.text.y=element_text(size=9), plot.title = element_text(hjust = 0.5))+
  geom_text(aes(label=Freq, vjust=-0.5), size=3)+
  scale_y_continuous(expand = c(0, 0), limits = c(0,530))+colScale

#dev.off()
```
