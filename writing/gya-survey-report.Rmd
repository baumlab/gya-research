---
title: "GYA surveys"
author: "James Robinson; Kristina Tietjen"
date: "18 July 2016"
output: 
    pdf_document:
    fig_width: 10
    fig_height: 4
---

```{r, echo=FALSE, hide=TRUE, warning=FALSE, message=FALSE}
## load in survey data

#setwd("/Users/kristinatietjen/Documents/git_hub/gya-research")
setwd("/Users/IMAC3/Documents/git-jpwrobinson/gya-research")

survey.all<-read.csv("data/Jul 18 2016 1149am - Hamilton.csv", header=TRUE)
survey<-read.csv(file="data/gya-without-incomplete.csv")
survey.what<-read.csv(file="data/gya-country-responses.csv")
research<-read.csv(file="data/gya-surveys-cleaned-research.csv")
research.past<-read.csv(file="data/gya-surveys-cleaned-research-past.csv")
research.change<-read.csv(file="data/gya-change-reason.csv")
part4<-read.csv(file="data/gya-survey-part4")

## load required packages
require(gridExtra); require(tidyr); require(ggplot2); require(stringr);require(RColorBrewer)
theme_set(theme_bw())

gender<-aggregate(Location ~ gender, survey, length)
country_work<-aggregate(gender ~ Country_work, survey, length)
locations<-aggregate(gender ~ Country, survey.what, length)

```

### Summary statistics

As of `r date()`, `r dim(survey.what)[1]` surveys from `r length(unique(survey.what$Country_work))` countries have been completed.

The majority of surveys were completed by researchers based in Canada (n = `r country_work$gender[country_work$Country_work=="Canada"]`), followed by Israel (n = `r country_work$gender[country_work$Country_work=="Israel"]`) then by the UK (n = `r country_work$gender[country_work$Country_work=="United Kingdom"]`) and the USA (n = `r country_work$gender[country_work$Country_work=="United States"]`). `r country_work$gender[country_work$Country_work==""]` surveys did not identify their place of work.

```{r, echo=FALSE, fig.cap="Survey responses by country", warning=FALSE}

ggplot(country_work, aes(x = reorder(Country_work, -gender), gender)) + geom_bar(stat='identity',position = position_dodge(width=0.5)) + theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5)) + labs(y="Number of responses", x="")  + 
  geom_text(aes(label=gender), angle=90, hjust=-1, size=3) +
  #geom_text(aes(label=Country_work), angle=90, hjust=-0.5) 
   lims(y=c(0, 1600)) + theme(legend.title=element_text(size=12), 
    legend.text=element_text(size=10), axis.text=element_text(size=8), axis.title=element_text(size=12)) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```                               

```{r, echo=FALSE, fig.cap="Survey responses by field of research (global and Canada)", warning=FALSE}
## setting colour scale to keep colours identical between similar plots
myColors <- brewer.pal(8,"Set1")
names(myColors) <- levels(survey.what$field_research)
colScale <- scale_fill_manual(name = "field_research",values = myColors)

field<-aggregate(Location ~ field_research, survey.what, length)
## remove 1 case of no field recorded
field<-field[!field$field_research=="",]


g1<-ggplot(field, aes(x = reorder(field_research, -Location), Location, fill=field_research)) + geom_bar(stat='identity',position = position_dodge(width=0.5)) + ylim(c(0, 650)) + 
  theme(axis.text.x=element_blank()) + labs(y="Number of responses",x="", title="Global")  +
  geom_text(aes(label=Location), vjust=-0.25) + theme( axis.text=element_text(size=14), 
                                                                                            axis.title=element_text(size=10)) + guides(fill=FALSE) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + colScale



field.can<-aggregate(Location ~ field_research, survey.what[survey.what$Country=="Canada",], length)

g2<-ggplot(field.can, aes(x = reorder(field_research, -Location), Location, fill=field_research)) + geom_bar(stat='identity',position = position_dodge(width=0.5)) + ylim(c(0, 400)) +
  theme(axis.text.x=element_blank()) + labs(y="Number of responses",x="", title="Canada")  +
  geom_text(aes(label=Location), vjust=-0.25) + theme( axis.text=element_text(size=14), axis.title=element_text(size=10),
                                                       legend.position="bottom", legend.title=element_blank(), legend.text=element_text(size=9))+ 
  guides(fill=guide_legend(nrow=4)) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ colScale


grid.arrange(g1, g2, layout_matrix=rbind(1,2,2))


```



```{r, echo=FALSE, fig.cap="Survey responses by years of experience (global and Canada)", warning=FALSE}
## setting colour scale to keep colours identical between similar plots
myColors <- brewer.pal(6,"Set1")
names(myColors) <- levels(survey.what$what_participant_group)
colScale <- scale_fill_manual(name = "what_participant_group",values = myColors, labels=c("Senior academic researcher", "Postdoc or RA", "Non-academic researcher <10 yrs experience", "Non-academic researcher >10yrs experience", "Early career academic researcher"))


experience<-aggregate(Location ~ what_participant_group, survey.what, length)
experience<-experience[!experience$what_participant_group=="",]

g3<-ggplot(experience, aes(x = reorder(what_participant_group, -Location), Location, fill=what_participant_group)) + geom_bar(stat='identity',position = position_dodge(width=0.5)) +
  labs(y="Number of responses", x="", title="Global") +  theme(legend.position="bottom") + theme(axis.text.x=element_blank()) + 
  geom_text(aes(label=Location),size=4, vjust=-0.25) + guides(fill=guide_legend(title=NULL, reverse=TRUE, nrow=6)) + 
  theme( axis.text=element_text(size=14), axis.title=element_text(size=10),panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + colScale+ guides(fill=FALSE) + ylim(c(0, 1300))



experience_can<-aggregate(Location ~ what_participant_group, survey.what[survey.what$Country=="Canada",], length)
experience_can<-experience_can[!experience_can$what_participant_group=="",]

g4<-ggplot(experience_can, aes(x = reorder(what_participant_group, -Location), Location, fill=what_participant_group)) + geom_bar(stat='identity',position = position_dodge(width=0.5)) +
  labs(y="Number of responses", x="", title="Canada") +  theme(legend.position="bottom") + theme(axis.text.x=element_blank()) + 
  geom_text(aes(label=Location),size=4, vjust=-0.25)+ guides(fill=guide_legend(title=NULL, reverse=TRUE, nrow=3)) +  
  theme(legend.title=element_blank(), legend.text=element_text(size=10), axis.text=element_text(size=14), axis.title=element_text(size=10))+ 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + colScale+ ylim(c(0, 800))

grid.arrange(g3, g4, layout_matrix=rbind(1,2,2))

```

### GYA surveys: Canada

#### Part 1 - Type of Research Conducted
```{r, echo=FALSE, fig.cap="Current vs. past research type (Canada)", message=FALSE, warning=FALSE}

## make sure that Use-inspired is the middle level in the legend

res.plot<-subset(research, type%in%c("percent_fundemental_research_current",  "percent_Applied_Research_current" , "percent_Use_inspired_Research_current","percent_Applied_Research_past",  "percent_Fundamental_Research_past" , "percent_Use_inspired_Research_past"))
res.plot$percent<-str_replace_all(res.plot$percent, "%", "")
res.plot$percent<-as.numeric(as.character(res.plot$percent))
res.plot$type<-as.character(res.plot$type)
# add time variable
res.plot$time<-ifelse(grepl( "current", res.plot$type),"Current", "Past")
res.plot$type[res.plot$type=="percent_Applied_Research_past"]<-"Applied"
res.plot$type[res.plot$type=="percent_Applied_Research_current"]<-"Applied"
res.plot$type[res.plot$type=="percent_Fundamental_Research_past"]<-"Fundamental"
res.plot$type[res.plot$type=="percent_fundemental_research_current"]<-"Fundamental"
res.plot$type[res.plot$type=="percent_Use_inspired_Research_past"]<-"Use inspired"
res.plot$type[res.plot$type=="percent_Use_inspired_Research_current"]<-"Use inspired"


ggplot(res.plot[res.plot$Country=="Canada",], aes(type, percent, fill=time)) + geom_boxplot() +guides(fill=guide_legend(title=NULL, reverse=TRUE, nrow=2)) +
  labs(x="Research type", y="% research", title="Canada")

```

```{r, echo=FALSE, fig.cap="Reason for change in research over past 10 years (Canada)"}
## order bars from highest to lowest

# Change in the past 10 years? (yes, no, can't comment)
yes.no<-subset(research.change, select=c("Location","Country",  "gender", "changed_10yrs"))
canada<-subset(yes.no, Country=="Canada")
canada.yesno<-aggregate(Country~ changed_10yrs, canada, length)
canada.yesno<-canada.yesno[!canada.yesno$changed_10yrs=="",]

g1<-ggplot(data=canada.yesno, aes(x=changed_10yrs, y=Country, fill=Country))+ geom_bar(stat='identity') + guides(fill=FALSE) + 
  labs(x="", y="Number of responses",title="Change in research in past 10 years?")

# What is your main reason for change?
reason<-subset(research.change, select=c("Location","Country",  "gender", "Main_reason_change_interest_related", 
                                         "Main_reason_change_Career_related", "Main_reason_change_Funding_related","Main_reason_change_Socially_related",
                                         "Main_reason_change_Other"))

canada<-subset(reason, Country=="Canada")

## switch to long format
require(tidyr)
canada.long<-gather(canada, reason.change.ca, yes.ca, -Location, -gender, -Country)

## using table to count cases of each category
sum.canada<-data.frame(table(canada.long$reason.change.ca, canada.long$yes.ca))

# remove non-response
sum.canada<-sum.canada[!sum.canada$Var1=="",]

g2<-ggplot(sum.canada, aes(x=Var1, y=Freq, fill=Var1)) + geom_bar(stat='identity')+ 
  theme(axis.text.x = element_text(angle=90, vjust=0.5)) + theme(legend.position=c(0.8, 0.8), axis.text.x=element_blank(), legend.title=element_blank()) + scale_fill_discrete(labels=c("Career", "Funding", "Interest", "Other", "Social")) + labs(x="", y="", title="Reason for change in research type")

grid.arrange(g1, g2, nrow=1)
```


#### Part 4 - Funding Trends

```{r, echo=FALSE, fig.cap="Perceived importance of fundamental research to Canada"}
## order bars from very important (left) to can't comment (right)
important<-subset(part4, select=c("Location","Country", "gender","opinion_fundamental_important"))

canada<-subset(important, Country=="Canada")
## using table to count cases of each category
sum.important<-data.frame(table(canada$opinion_fundamental_important, canada$gender))
temp<-aggregate(Freq ~ Var2, sum.important, sum)

# remove non-response
sum.important<-sum.important[!sum.important$Var1=="",]
sum.important

ggplot(data=sum.important, aes(x=Var1, y=Freq, fill=Var1)) + geom_bar(stat='identity', position='dodge')+ 
  theme(axis.text.x = element_text(), legend.position=c(0.8, 0.8), legend.title=element_blank())  + labs(x="", y="Number of responses") + scale_x_discrete(limits=rev(levels(sum.important$Var1))) + guides(fill=FALSE)

```


```{r, echo=FALSE, fig.cap="Perceived change in research priority by Canadian government"}
## order bars into applied > use > fundamental > no change
priority<-subset(part4, select=c("Location","Country", "gender", "high_priority_fundamental", "high_priority_use_inspired", "high_priority_applied", 
                                 "high_priority_no_change"))
canada<-subset(priority, Country=="Canada")
## switch to long format
require(tidyr)
priority.long<-gather(canada, what.type, higher.priority, -Location, -gender, -Country)

high.priority<-aggregate(higher.priority~ what.type, priority.long, sum)
high.priority$what.type<-as.factor(high.priority$what.type)
high.priority$what.type<-factor(high.priority$what.type, levels(high.priority$what.type)[c(2,4,1,3)])

ggplot(data=high.priority, aes(x=what.type, higher.priority, fill=what.type)) + geom_bar(stat='identity') +  
  theme(axis.text.x = element_text()) + guides(fill=FALSE) + labs(x="", y="Number of responses") + scale_x_discrete(labels=c( "Fundamental", "Use-inspired","Applied", "No change"))

```


```{r, echo=FALSE, fig.cap="Anticipated change in research funding in next 5 years "}
## change in funding on the x-axis, and colours = type of research
## order bars into increase considerably (left) to decrease considerably (right), then no comment at the far right
availability.change<-subset(part4, select=c("Location", "Country", "gender", "available_funding_fundamental",  
                                             "available_funding_use_inspired", "available_funding_applied"))
canada<-subset(availability.change, Country=="Canada")

## switch to long format
require(tidyr)
availability.change.long.ca<-gather(canada, what.type, level, -Location, -gender, -Country)
availability.ca<-aggregate(gender~what.type+level, 
                         availability.change.long.ca,length)
# remove non-response
availability.ca<-availability.ca[!availability.ca$level=="",]

## change type to factor with levels
availability.ca$level<-str_replace_all(availability.ca$level, "Will ", "")
availability.ca$what.type<-as.factor(availability.ca$what.type)
availability.ca$level<-as.factor(availability.ca$level)

## change order of levels
availability.ca$level<-factor(availability.ca$level, levels(availability.ca$level)[c(4,5,6,3,2,1 )])
availability.ca$what.type<-factor(availability.ca$what.type, levels(availability.ca$what.type)[c(2,3,1)])

ggplot(data=availability.ca, aes(x=level, gender, fill=what.type))+ geom_bar(stat='identity', position="dodge") +  
  theme(axis.text.x = element_text(angle=0), legend.title=element_blank(), legend.position=c(0.8, 0.8)) + scale_fill_discrete(labels=c("Fundamental", "Use-inspired", "Applied")) +# scale_x_discrete(limits=rev(levels(availability.ca$level)))
 labs(x="", y="Number of responses")


```


```{r, echo=FALSE, fig.cap="Effect of change in research funding on research careers of next generation"}

## order bars into increase considerably (left) to decrease considerably (right), then no comment at the far right
next.generation<-subset(part4, select=c("Location", "Country", "gender","next_generation"))
# remove non-response
next.generation<-next.generation[!next.generation$next_generation=="",]
canada<-subset(next.generation, Country=="Canada")

impact<-aggregate(gender~ next_generation, canada, length)

## change type to factor with levels
impact$next_generation<-str_replace_all(impact$next_generation, "Will ", "")
impact$next_generation<-as.factor(impact$next_generation)
## change order of next_generations
impact$next_generation<-factor(impact$next_generation, factor(impact$next_generation)[c(4,5,6,3,2,1 )])


ggplot(data=impact, aes(x=next_generation, gender, fill=next_generation))+ geom_bar(stat='identity', position="dodge") +  
  theme(axis.text.x = element_text(angle=0), legend.title=element_blank(), legend.position=c(0.8, 0.8)) + scale_fill_discrete(labels=c("Fundamental", "Use-inspired", "Applied")) + guides(fill=FALSE) +
 labs(x="", y="Number of responses")



```



ADD GENDER TO PLOTS.....