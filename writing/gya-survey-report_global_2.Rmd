---
title: "Global online survey on fundamental research"
author: ''
date: "9 May 2017"
output:
  pdf_document: null
  fig_width: 18
  html_document: default
  fig_height: 4
  word_document: default
---

**Introduction**  
In addition to the official data presented in Chapters 2 and 3, we also developed and ran a quantitative online survey to query researchers about their perceptions of, and experiences with, funding for fundamental research. An important aim of the survey was to provide an understanding researcher's personal experiences and outlook on the research funding landscape. We had an excellent response to the survey, with over xxxx  researchers completing it, suggesting that fundamental research funding is a high priority topic for Canadian researchers. Herein, we detail the survey questions and results. 

**Methods**  
Online Survey  
The survey was open to researchers from all disciplines (e.g. science, social sciences, humanities, engineering, medicine) and career stages, with the proviso that they had some experience applying for research funding. The survey gathered detailed information in four major areas: 1) the types of research the scholars conduct (fundamental, use-inspired, applied), 2) the extent of external partnerships in their research, 3) their grant success rates, and 4) how important they perceive fundamental research is to the  federal government and its future prospects in . The survey also enquired how each of these factors have changed over time for the researchers. Finally, the survey gathered basic information from each respondent about gender, discipline, career stage and the year their PhD was obtained. The full survey is provided in Appendix 2. 

The online survey was open from the end of May through early October 2016, and ran on the Fluid Surveys platform (fluidsurveys.com). Note that the survey was open to researchers from any country in the world because it is was run as part of a global survey through the Global Young Academy. To disseminate the survey to researchers, we gathered email addresses from  university websites for as many faculty members as possible and emailed individual researchers directly. We also shared the survey broadly on social media, as well as through the Global Young Academy network, on scientific list serves, and through personal connections. 

Survey Data Analysis  

**Note that numbers not all the same because respondents did not always answer every question**
```{r, echo=FALSE, message=FALSE, loading_data, warning=FALSE}
#<!-- Import Canadian data, calculate sample sizes -->
 ## CHANGE WORKING DIRECTORY FOR YOUR LOCAL MACHINE BEFORE KNITTING ##
setwd("/Users/kristinatietjen/Documents/git_hub/gya-research/writing")
#setwd("/Users/IMAC3/Documents/git-jpwrobinson/gya-research")
#setwd("/Users/jpwrobinson/Documents/git_repos/gya-research")
#setwd("/Users/Julia_2013MacBookAir/Desktop/GitRepos/gya-research/writing")
## load in survey data
survey<-read.csv(file="../data/gya-without-incomplete.csv")
#Count how many responses from  researchers
survey.what<-read.csv(file="../data/gya-country-responses.csv")
research<-read.csv(file="../data/gya-surveys-cleaned-research.csv")
#research.past<-read.csv(file="data/gya-surveys-cleaned-research-past.csv")
research.change<-read.csv(file="../data/gya-change-reason.csv")
part4<-read.csv(file="../data/gya-survey-part4.csv")
part2.b.a<-read.csv(file="../data/gya-part2.before.after.csv")
part2.change<-read.csv(file="../data/gya-part2.change.csv")
part2.reason<-read.csv(file="../data/gya-part2.reason.csv")
part2.view<-read.csv(file="../data/gya-part2.view.csv")
part1.view<-read.csv(file="../data/gya-part1.view.csv")
part3.change<-read.csv(file="../data/gya-part3.change.csv")
part3.grants.long<-read.csv(file="../data/gya-part3.grants.long.csv")
part3.success.long<-read.csv(file="../data/gya-part3.success.long.csv")
part3.prac.long<-read.csv(file="../data/gya-part3.prac.long.csv")
part3.part.long<-read.csv(file="../data/gya-part3.part.long.csv")
p3_master.long<-read.csv(file="../data/gya-p3_master.long.csv")
p3_master <- read.csv(file="../data/gya-p3_master.csv")

#Gender:
survey <- survey[survey$gender=="Male",]               #Count how many responses from  male researchers
percent.men<-((dim(survey)[1])/(dim(survey)[1]))*100      #Calculate the % of responses from  male researchers
n.is.res.women <- survey[survey$gender=="Female",]           #Count how many responses from  female researchers
percent.women<-((dim(survey)[1])/(dim(survey)[1]))*100  #Calculate the % of responses from  female researchers

#Career Stage Tabulations:
#table(n.is.res$what_participant_group)
n.seniorac <- survey[survey$what_participant_group=="Senior academic researcher with >10 years of experience applying for research grants",]
percent.seniorac<-((dim(survey)[1])/(dim(survey)[1]))*100 #Calculate the % of responses from  senior academic researchers
n.earlyac <- survey[survey$what_participant_group=="Early career academic researcher with <10 years experience applying for research grants since completion of PhD",]
percent.earlyac<-((dim(n.earlyac)[1])/(dim(survey)[1]))*100 #Calculate the % of responses from  early academic researchers
n.pdf <- survey[survey$what_participant_group=="Postdoctoral fellow or research assistant with experience applying for research grants, or anticipating the need to apply for grants in the near future",]
percent.pdf<-((dim(n.pdf)[1])/(dim(survey)[1]))*100 #Calculate the % of responses from  post-docs
n.nonACearly <- survey[survey$what_participant_group=="Non-academic researcher conducting or managing research in industry or government with <10 years of experience",]
percent.nonACearly<-((dim(n.nonACearly)[1])/(dim(survey)[1]))*100 #Calculate the % of responses from early career non-academics
n.nonACsenior <- survey[survey$what_participant_group=="Non-academic researcher conducting or managing research in industry or government with >10 years of experience",]
percent.nonACsenior<-((dim(n.nonACsenior)[1])/(dim(survey)[1]))*100 #Calculate the % of responses from early career non-academics
n.unk <- survey[survey$what_participant_group=="",]
percent.unk<-((dim(n.unk)[1])/(dim(survey)[1]))*100 #Calculate the % of responses from unknown career stage

#Discipline Tabulations:
n.natural <- survey[survey$field_research=="Natural Science",]
percent.natural <- ((dim(n.natural)[1])/(dim(survey)[1]))*100 #Calculate the % of responses from  natural scientists
n.physics <- survey[survey$field_research=="Physical Science (eg. math, physics, chemistry, computer science)",]
percent.physics <- ((dim(n.physics)[1])/(dim(survey)[1]))*100 #Calculate the % of responses from  physical scientists
n.med <- survey[survey$field_research=="Medicine and Life Science",]
percent.med <- ((dim(n.med)[1])/(dim(survey)[1]))*100 #Calculate the % of responses from  med/life scientists
n.eng <- survey[survey$field_research=="Engineering",]
percent.eng <- ((dim(n.eng)[1])/(dim(survey)[1]))*100 #Calculate the % of responses from  engineering scientists
n.int <- survey[survey$field_research=="Interdisciplinary Science",]
percent.int <- ((dim(n.int)[1])/(dim(survey)[1]))*100 #Calculate the % of responses from  interdisciplinary scientists
n.ssh <- survey[survey$field_research=="Social Science / Humanities",]
percent.ssh <- ((dim(n.ssh)[1])/(dim(survey)[1]))*100 #Calculate the % of responses from  interdisciplinary scientists

```

**Results**  
In total, `r dim(n.is.res)[1]`  researchers completed the online survey. Of these, almost xxxxx were male (`r ceiling(percent.men)`%) and xxxxx were female (`r round(percent.women)`%); xxxx proportion either did not input their gender or selected other. xxxx of the survey respondents (`r round(sum(percent.seniorac,percent.earlyac))`%) were either senior academics (`r round(percent.seniorac)`%), defined as those researchers with more than ten years experience applying for research grants since completion of their PhD, or early career academics (`r round(percent.earlyac)`%) (Figure 4.1). xxxxx also came from post-doctoral researchers (`r round(percent.pdf)`%), non-academic researchers (`r  round(sum(percent.nonACearly,percent.nonACsenior))`%), or those who did not indicate their career stage (`r round(percent.unk, digits=1)`%).

Researchers from many different disciplines were represented in the survey. Almost xxxx percent of responses came from either the natural or physical sciences (Figure 4.2). The remaining responses were spread amongst the medical and life sciences (`r round(percent.med)`%), engineering (`r round(percent.eng)`%), interdisciplinary research (`r round(percent.int)`%), and social sciences and humanities (`r round(percent.ssh)`%). 

<!-- Generate  career stage figure -->
```{r, echo=FALSE, message=FALSE, fig.cap="Figure 4.1 Number of  survey respondents by career stage", warning=FALSE, fig.width=14}
## load required packages
require(gridExtra); require(tidyr); require(ggplot2); require(stringr);require(RColorBrewer); require(colorRamps); require(plotrix); require(plyr); require(grid);require(gtable)

theme_set(theme_bw())
## setting colour scale to keep colours identical between similar plots
## myColors <- brewer.pal(6,"Set1")

experience<-data.frame(table(survey$what_participant_group))
experience<-experience[!experience$Var1=="",]
experience<-droplevels(experience)

experience$Var1<-revalue(experience$Var1, c("Early career academic researcher with <10 years experience applying for research grants since completion of PhD" = "Early career academic researcher", "Non-academic researcher conducting or managing research in industry or government with > 10 years of experience" = "Non-academic research >10 yrs experience", "Non-academic researcher conducting or managing research in industry or government with <10 years of experience" = "Non-academic researcher <10 yrs experience", "Postdoctoral fellow or research assistant with experience applying for research grants, or anticipating the need to apply for grants in the near future" = "Postdoc or RA", "Senior academic researcher with > 10 years of experience applying for research grants" = "Senior academic researcher"))
experience$Var1<-reorder(experience$Var1, experience$Freq)

# assign colour scale
myColors1<-(brewer.pal(9, "Blues"))
myColors1<-myColors1[-c(1:2)]
names(myColors1)<- levels(experience$Var1)
colScale <- scale_fill_manual(name = "Var1",values = myColors1)

pdf(file="figures/global/4.1_CareerStage.pdf", width = 11, height= 7)

ggplot(experience, aes(x = reorder(Var1, -Freq), Freq, fill=Var1)) + 
  geom_bar(stat='identity',position = position_dodge(width=0.5)) + 
  geom_text(aes(label=Freq, vjust=-0.5), size=3)+
  scale_x_discrete(labels=c("Senior academic", "Early career\nacademic", "Postdoc or RA", "Senior\nnon-academic", "Early career\nnon-academic")) +
  labs(y="Number of responses", x="") +
  guides(fill=guide_legend(title=NULL, reverse=TRUE, nrow=3)) +  
  theme(aspect.ratio=1/2,legend.title=element_blank(), 
        legend.text=element_text(size=10), 
        axis.text.y=element_text(size=9),
        axis.text.x=element_text(angle=0, size=9), 
        axis.title=element_text(size=11),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) + 
  colScale + guides(fill=FALSE)+
  scale_y_continuous(expand = c(0,0), limits = c(0,1350))
dev.off()

```

<!-- Generate  research discipline figure -->
```{r, echo=FALSE, fig.cap="Figure 4.2 Survey responses by field of research", warning=FALSE, fig.width=14}
field<-data.frame(table(survey$field_research))
field<-field[!field$Var1=="",]
field$Var1<-reorder(field$Var1, field$Freq)
field$Var1<-revalue(field$Var1, c("Physical Science (eg. math, physics, chemistry, computer science)" = "Physical Science"))

## setting colour scale to keep colours identical between similar plots
myColors2<-(brewer.pal(9, "Blues"))
myColors2<-myColors2[-c(1)]
names(myColors2) <- levels(field$field_research)
colScale <- scale_fill_manual(name = "field_research",values = myColors2)

pdf(file="figures/global/4.2_FieldofResearch.pdf", width = 11, height= 7)

ggplot(field, aes(x = reorder(Var1, -Freq), Freq, fill=Var1)) + 
    geom_bar(stat='identity',position = position_dodge(width=0.5)) + 
  labs(y="Number of responses",x="", title="")  +
  scale_x_discrete(labels=c("Natural\n Science", "Physical\n Science", "Medicine &\nLife Science", "Engineering", "Interdisciplinary\nScience", "Social Science/\nHumanities", "Other")) +
  geom_text(aes(label=Freq), vjust=-0.25, size=3) + 
  theme( aspect.ratio=1/2, axis.text.y=element_text(size=9),
         axis.text.x=element_text(angle=0, size=9),
         axis.title=element_text(size=11),
         panel.grid.major = element_blank(),
         panel.grid.minor = element_blank()) + 
  guides(fill=FALSE) + colScale+
  scale_y_continuous(expand = c(0,0), limits = c(0,620))

dev.off()
```

```{r, eval=FALSE, fig.cap="Figure 4.1 + 4.2 Career Stage and Field of research", warning=FALSE, include=FALSE}
##plot1

# assign colour scale
myColors1<-(brewer.pal(9, "Blues"))
myColors1<-myColors1[-c(1:2)]
names(myColors1)<- levels(experience_is$Var1)
colScale <- scale_fill_manual(name = "Var1",values = myColors1)

g4.1<-ggplot(experience_is, aes(x = reorder(Var1, -Freq), Freq, fill=Var1)) + 
  geom_bar(stat='identity',position = position_dodge(width=0.5)) + 
  geom_text(aes(label=Freq, vjust=-1), size=3)+
  scale_x_discrete(labels=c("Senior academic", "Early career\nacademic", "Postdoc or RA", "Senior\nnon-academic", "Early career\nnon-academic")) +
  labs(y="Number of responses", x="") +
  guides(fill=guide_legend(title=NULL, reverse=TRUE, nrow=3)) +  
  theme(aspect.ratio=1/2,legend.title=element_blank(), 
        legend.text=element_text(size=10), 
        axis.text.y=element_text(size=9),
        axis.text.x=element_text(angle=0, size=9), 
        axis.title=element_text(size=11),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) + 
  colScale + guides(fill=FALSE)+
  scale_y_continuous(expand = c(0,0), limits = c(0,150))


##plot 2

## setting colour scale to keep colours identical between similar plots
myColors2<-(brewer.pal(9, "Blues"))
myColors2<-myColors2[-c(1)]
names(myColors2) <- levels(field.is$field_research)
colScale <- scale_fill_manual(name = "field_research",values = myColors2)

g4.2<-ggplot(field.is, aes(x = reorder(field_research, -Freq), Freq, fill=field_research)) + 
    geom_bar(stat='identity',position = position_dodge(width=0.5)) + 
  labs(y="Number of responses",x="", title="")  +
  scale_x_discrete(labels=c("Natural\n Science", "Physical\n Science", "Medicine\n& Life\nScience", "Engineering", "Inter-\ndisciplinary\nScience", "Social\nScience/\nHumanities", "Other")) +
  geom_text(aes(label=Freq), vjust=-0.25, size=3) + 
  theme( aspect.ratio=1/2, axis.text.y=element_text(size=9),
         axis.text.x=element_text(angle=0, size=9),
         axis.title=element_text(size=11),
         panel.grid.major = element_blank(),
         panel.grid.minor = element_blank()) + 
  guides(fill=FALSE) + colScale+
  scale_y_continuous(expand = c(0,0), limits = c(0,100))

#pdf(file="figures/4.1and4.2(old)_CareerStageAndFieldOfResearch.pdf", width = 11, height= 7)

grid.arrange(g4.1,g4.2, heights=c(0.475,0.525), ncol=1)

#dev.off()
```

<!--**4.1 Type of Research Conducted**  -->

<!-- Generate figure showing current and past fundamental, use-inspiried, and applied research %s -->
```{r, echo=FALSE, fig.cap="Figure 4.3 Respondents type of research describe in proportal amounts of fundamental, use-inspired and applied research. Reseachers were questioned about the percentage of funding allocated to Fundamental, Use-inspired or Applied research in the past and in their current research.", message=FALSE, warning=FALSE}

## make sure that Use-inspired is the middle level in the legend
res.plot<-subset(research, type%in%c("percent_fundemental_research_current",  "percent_Applied_Research_current" , "percent_Use_inspired_Research_current","percent_Applied_Research_past",  "percent_Fundamental_Research_past" , "percent_Use_inspired_Research_past"))

res.plot$percent<-str_replace_all(res.plot$percent, "%", "")
res.plot$percent<-as.numeric(as.character(res.plot$percent))
res.plot$type<-as.character(res.plot$type)

# add time variable
res.plot$time<-ifelse(grepl( "current", res.plot$type),"Current", "Past")
res.plot$type[res.plot$type=="percent_Applied_Research_past"]<-"Applied"
res.plot$type[res.plot$type=="percent_Applied_Research_current"]<-"Applied"
res.plot$type[res.plot$type=="percent_Fundamental_Research_past"]<-"Fundamental"
res.plot$type[res.plot$type=="percent_fundemental_research_current"]<-"Fundamental"
res.plot$type[res.plot$type=="percent_Use_inspired_Research_past"]<-"Use-inspired"
res.plot$type[res.plot$type=="percent_Use_inspired_Research_current"]<-"Use-inspired"

# change order of the levels
res.plot$time<-as.factor(res.plot$time)
res.plot$time<-factor(res.plot$time, levels(res.plot$time)[c(2,1)])

res.plot$type<-as.factor(res.plot$type)
res.plot$type<-factor(res.plot$type, levels(res.plot$type)[c(2,3,1)])

res.plot$time<-factor(res.plot$time)
res.plot$time<-factor(res.plot$time, levels(res.plot$time)[c(1,2)])

#myColors<-(brewer.pal(9, "Blues"))
#myColors<-myColors[c(5,9)]


mycols<-c('#a6cee3','#1f78b4','#b2df8a','#33a02c','#fb9a99','#e31a1c')

colScale <- scale_fill_manual(name = "ID",values = mycols)

res.plot$ID<-paste(res.plot$type, res.plot$time)

#table(res.plot$percent,res.plot$time,res.plot$type)
#write.csv(res.plot, file="data/4.1a.calculations.csv", row.names = FALSE)

# change order of the levels
res.plot$ID<-as.factor(res.plot$ID)
res.plot$ID<-factor(res.plot$ID, levels(res.plot$ID)[c(4,3,6,5,2,1)])

# add colours to res.plot
mycols<-c('#33a02c','#a6cee3','#fb9a99','#1f78b4', '#e31a1c','#b2df8a')
mycols<-as.data.frame(mycols)
mycols$ID<-levels(res.plot$ID)
res.plot$col<-mycols$mycols[match(res.plot$ID, mycols$ID)]
res.plot$col<-factor(res.plot$col, levels(res.plot$col)[c(3,1,4,2,6,5)])
mycols<-as.character(unique(res.plot$col))
colScale <- scale_fill_manual(name = "ID",values =mycols, labels=c("2006-2010 Fundamental", "2011-2015 Fundamental","2006-2010 Use-inspired", "2011-2015 Use-inspired","2006-2010 Applied", "2011-2015 Applied"))
#table(res.plot$type, res.plot$time, res.plot$col)

pdf(file="figures/global/4.3.1_ResearchProportion.pdf", width = 11, height= 7)

ggplot(res.plot, aes(percent, fill=ID)) +
    geom_histogram(position='dodge', binwidth=10, bins=seq(0, 100, 10))  +
    guides(fill=guide_legend(title=NULL, reverse=FALSE, nrow=4)) +
    labs(x="Percent", y="Number of responses")+
    theme(aspect.ratio=3/4, panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),legend.text=element_text(size = 9),
          strip.text.y = element_text(size=12, face="bold", color="black"),
          strip.background = element_rect(colour="white", fill="white"),
          legend.position=c(0.72, 0.92), legend.margin=unit(100,"cm"), axis.title.y=element_text(size=11),
          axis.title.x=element_text(size=11), axis.text.x=element_text(size=9), axis.text.y=element_text(size=9), title=element_text(size = 12)) + colScale + 
  scale_x_continuous(breaks=seq(0,100,10))+scale_y_continuous(expand=c(0,0), limits=c(0,550),breaks=c(0,100, 200, 300, 400, 500))

dev.off()

#+annotate('text',5.4 ,294, label="(a)", size=5)

#out<-by(data = res.plot, INDICES = res.plot$type, FUN = function(m){
#  m <- droplevels(m)
#  m$col<-factor(m$col, levels(m$col)[c(3,1,4,2,6,5)])
#  mycols<-as.character(unique(m$col))
#  colScale <- scale_fill_manual(name = "ID",values =mycols, labels=c("2006-2010", "2011-2015"))
#  m <- ggplot(m, aes(percent, fill=ID)) +
#    geom_histogram(position='dodge', binwidth=10, bins=seq(0, 100, 10))  +
#    guides(fill=guide_legend(title=NULL, reverse=FALSE, nrow=2)) +
#    labs(x="Percent", y="Number of responses", title=m$type)+
#    theme(panel.grid.major = element_blank(),
#          panel.grid.minor = element_blank(),
#          strip.text.y = element_text(size=12, face="bold", color="black"),
#          strip.background = element_rect(colour="white", fill="white"),
#          legend.position=c(0.94, 0.72), legend.margin=unit(100,"cm"), axis.title.y=element_text(size=11),
#          axis.title.x=element_text(size=11), axis.text.x=element_text(size=9), axis.text.y=element_text(size=9), title=element_text(size = 12)) + colScale + 
#  scale_x_continuous(breaks=seq(0,100,10))+scale_y_continuous(expand=c(0,0), limits=c(0,300),breaks=c(0,100,200,300)) 
# })
#do.call(grid.arrange, out)
  
```

```{r, echo=FALSE, fig.cap="Figure 4.3 (different layout) Respondents type of research describe in proportal amounts of fundamental, use-inspired and applied research. Reseachers were questioned about the percentage of funding allocated to Fundamental, Use-inspired or Applied research in the past and in their current research.", message=FALSE, warning=FALSE}

## make sure that Use-inspired is the middle level in the legend
res.plot<-subset(research, type%in%c("percent_fundemental_research_current",  "percent_Applied_Research_current" , "percent_Use_inspired_Research_current","percent_Applied_Research_past",  "percent_Fundamental_Research_past" , "percent_Use_inspired_Research_past"))

res.plot$percent<-str_replace_all(res.plot$percent, "%", "")
res.plot$percent<-as.numeric(as.character(res.plot$percent))
res.plot$type<-as.character(res.plot$type)

# add time variable
res.plot$time<-ifelse(grepl( "current", res.plot$type),"Current", "Past")
res.plot$type[res.plot$type=="percent_Applied_Research_past"]<-"Applied"
res.plot$type[res.plot$type=="percent_Applied_Research_current"]<-"Applied"
res.plot$type[res.plot$type=="percent_Fundamental_Research_past"]<-"Fundamental"
res.plot$type[res.plot$type=="percent_fundemental_research_current"]<-"Fundamental"
res.plot$type[res.plot$type=="percent_Use_inspired_Research_past"]<-"Use-inspired"
res.plot$type[res.plot$type=="percent_Use_inspired_Research_current"]<-"Use-inspired"
res.plot$time[res.plot$time=="Current"]<-"2011-2015"
res.plot$time[res.plot$time=="Past"]<-"2006-2010"

# change order of the levels
#res.plot$time<-as.factor(res.plot$time)
#res.plot$time<-factor(res.plot$time, levels(res.plot$time)[c(2,1)])

res.plot$type<-as.factor(res.plot$type)
res.plot$type<-factor(res.plot$type, levels(res.plot$type)[c(2,3,1)])

res.plot$time<-factor(res.plot$time)
res.plot$time<-factor(res.plot$time, levels(res.plot$time)[c(1,2)])

#myColors<-(brewer.pal(9, "Blues"))
#myColors<-myColors[c(5,9)]
#colScale <- scale_fill_manual(name = "time",values = myColors)

res.plot$ID<-paste(res.plot$type, res.plot$time)

# change order of the levels
res.plot$ID<-as.factor(res.plot$ID)
res.plot$ID<-factor(res.plot$ID, levels(res.plot$ID)[c(4,3,6,5,2,1)])


# add colours 
mycols<-c('#33a02c','#a6cee3','#fb9a99','#1f78b4', '#e31a1c','#b2df8a')
mycols<-as.data.frame(mycols)
mycols$ID<-levels(res.plot$ID)
res.plot$col<-mycols$mycols[match(res.plot$ID, mycols$ID)]
res.plot$col<-factor(res.plot$col, levels(res.plot$col)[c(3,5,4,2,6,1)])
mycols<-as.character(unique(res.plot$col))
colScale <- scale_fill_manual(name = "ID",values =mycols, labels=c("2006-2010", "2011-2015"))


#ggplot(res.plot, aes(percent, fill=time)) +
#    geom_histogram(position='dodge', binwidth=10, bins=seq(0, 100, 10))  +
#    guides(fill=guide_legend(title=NULL, reverse=FALSE, nrow=2)) +
#    labs(x="Percent", y="Number of responses", title="")+
#    theme(panel.grid.major = element_blank(),
#          panel.grid.minor = element_blank(),
#          strip.text.y = element_text(size=12, face="bold", color="black"),
#          strip.background = element_rect(colour="white", fill="white"),
#          legend.position=c(0.95, 0.19), legend.margin=unit(100,"cm")) + 
#    facet_wrap(~type, nrow=3) + colScale +
#  scale_x_continuous(breaks=seq(0,100,10))+scale_y_continuous(expand=c(0,0), limits=c(0,300),breaks=c(0,100,200,300))

library(gridExtra)
#####add (a)
xs <- split(res.plot,f = res.plot$type)
p1 <- ggplot(xs$Fundamental,aes(percent, fill=time)) +
    geom_histogram(position='dodge', binwidth=10, bins=seq(0, 100, 10))  +
    guides(fill=guide_legend(title=NULL, reverse=FALSE, nrow=2)) +
    labs(x="Percent", y="Number of responses", title="")+
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          strip.text.x = element_text(size=12, face="bold", color="black"),
          strip.background = element_rect(colour="white", fill="white"),
          legend.position=c(0.93, 0.795), legend.spacing=unit(100,"cm"))+ 
    facet_wrap(~type, nrow=3) +
  scale_x_continuous(breaks=seq(0,100,10))+scale_y_continuous(expand=c(0,0), limits=c(0,550),breaks=c(0,100,200,300, 400, 500))

p2 <- p1 %+% xs$`Use-inspired`
p3 <- p1 %+% xs$Applied
p1<-p1+scale_fill_manual(name = "ID",values =mycols[4:5], labels=c("2006-2010", "2011-2015"))+labs(x="")+ theme(plot.margin=unit(c(1,1,-0.45,1), "cm"))
p2<-p2+scale_fill_manual(name = "ID",values =mycols[c(6,1)], labels=c("2006-2010", "2011-2015"))+labs(x="")+ theme(plot.margin=unit(c(-0.25,1,-0.3,1), "cm"))
p3<-p3+scale_fill_manual(name = "ID",values =mycols[2:3], labels=c("2006-2010", "2011-2015"))+ theme(plot.margin=unit(c(-0.5,1,1,1), "cm"))


pdf(file="figures/global/4.3.2_ResearchProportion.pdf", width = 11, height= 7)

#grid.arrange(p1,p2,p3, left= textGrob("(a)", gp = gpar(fontsize=14), y=0.93, hjust = -.75), heights=c(0.35,0.3,0.35))
grid.arrange(p1,p2,p3, heights=c(0.35,0.3,0.35))

dev.off()
```


```{r, echo=FALSE, fig.cap="Figure 4.4a&b Change in research type proportions and the reasons. Researchers were asked to answer yes, no, or can't comment on if their type of research had changed in the last 10 years and to select what reasons for the change applied to them.", message=FALSE, warning=FALSE, fig.width=10}
#Change yes or no
yes.no<-subset(research.change, select=c("Location","Country", "Country_work",  "gender", "changed_10yrs"))

global.yes.no<-aggregate(Country~ changed_10yrs, yes.no, length)
global.yes.no<-global.yes.no[!global.yes.no$changed_10yrs=="",]

p1<-ggplot(data=global.yes.no, aes(x=changed_10yrs, y=Country, fill=Country))+ geom_bar(stat='identity') + guides(fill=FALSE)+
  theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), axis.title.x=element_blank())+geom_text(aes(label=Country), vjust=-0.5)+labs(y="Number of responses")+ scale_y_continuous(expand = c(0, 0), limits = c(0,1340))+ annotate('text', 3.5,660, label="(a)", size=5)
  
####reason for change  
reason<-subset(research.change, select=c("Location","Country","Country_work",  "gender", "Main_reason_change_interest_related",
                                       "Main_reason_change_Career_related","Main_reason_change_Funding_related", "Main_reason_change_Socially_related","Main_reason_change_Other"))

# switch to long format
require(tidyr)
global.long<-gather(reason, reason.change.glb, yes.glb, -Location, -gender, -Country_work, -Country)
# using table to count cases of each category
sum.global<-data.frame(table(global.long$reason.change.glb, global.long$yes.glb))
#remove non-response
sum.global<-sum.global[!sum.global$Var1=="",]

sum.global$Var1<-revalue(sum.global$Var1, c("Main_reason_change_Career_related" = "Career", "Main_reason_change_Funding_related" = "Funding", "Main_reason_change_interest_related" = "Interest", "Main_reason_change_Other" = "Other", "Main_reason_change_Socially_related"  = "Social"))
# change order of the levels
sum.global$Var1<-factor(sum.global$Var1,levels(sum.global$Var1)[c(2,3,1,5,4)])

myColors4<-(brewer.pal(9, "Blues"))
myColors4<-myColors4[c(9, 8,7,6,5,3)]

p2<-ggplot(sum.global, aes(x=Var1, y=Freq, fill=Var1)) + geom_bar(stat='identity')+ 
  theme(aspect.ratio=3/4, axis.text.x = element_text(angle=0, vjust=0.5, size=9), axis.text.y=element_text(size = 9), axis.title=element_text(size = 11), panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),legend.text=element_text(size = 9),axis.title.x=element_blank()) +guides(fill=FALSE) +
  scale_fill_manual(name = "Var1",values = myColors4)+
  labs(y="Number of responses")+
  scale_y_continuous(expand = c(0, 0), limits = c(0, 800))+annotate('text', 5.4,420, label="(b)", size=5)+geom_text(aes(label=Freq), vjust=-0.5, size=3)
  

#pdf(file="figures/global/4.4_ReasonForFieldChange.pdf", width = 11, height= 7)

#print(p2)

#dev.off()

pdf(file="figures/global/4.4a&b_ReasonForFieldChange.pdf", width = 11, height= 7)

grid.arrange(p1, p2, widths=c(0.5, 0.5), nrow=1)

dev.off()
```

```{r, echo=FALSE, fig.cap="Figure 4.5 View of change in proportion of research. Researchers were asked how they viewed the change in the type of research they conduct/supervise.", message=FALSE, warning=FALSE, fig.width=10}

view.propor<-survey[!survey$view_change_of_type=="",]
view.propor<-droplevels(view.propor)
change.view.glb<-aggregate(gender~ view_change_of_type, view.propor, length)
# change order of the levels
change.view.glb$view_change_of_type<-factor(change.view.glb$view_change_of_type, 
                                        levels(change.view.glb$view_change_of_type)[c(5,3,1,2,4)])

myColors5<-(brewer.pal(9, "Blues"))
myColors5<-myColors5[c(4,4,4,4,4,4)]

pdf(file="figures/global/4.5_ViewFieldChange.pdf", width = 11, height= 7)

ggplot(change.view.glb, aes(x=view_change_of_type, y=gender, fill=view_change_of_type)) + geom_bar(stat='identity')+
  theme(aspect.ratio=3/4, axis.text.x = element_text(angle=0, vjust=0.5, size=9), axis.text.y = element_text(size = 9), axis.title.y = element_text(size = 11), axis.title.x = element_text(size = 11)) +guides(fill=FALSE)+
  theme(panel.grid.major = element_blank(),legend.text=element_text(size = 9), panel.grid.minor = element_blank())+ labs(x="", y="Number of responses")+geom_text(aes(label=gender), vjust=-0.5, size=3)+scale_y_continuous(expand = c(0, 0), limits = c(0,240))+scale_fill_manual(name='view_change_of_type', values=myColors5)#+annotate('text', 5.4,133, label="(c)", size=5)

dev.off()
```

```{r, eval=FALSE, fig.cap="Figure Type of research (4.3, 4.4, 4.5 )", fig.width=10, message=FALSE, warning=FALSE, include=FALSE}

##plot 1

#old version which is now the correct version
#xs <- split(res.plot,f = res.plot$type)
#p1 <- ggplot(xs$Fundamental,aes(percent, fill=time)) +
#    geom_histogram(position='dodge', binwidth=10, bins=seq(0, 100, 10))  +
#    guides(fill=guide_legend(title=NULL, reverse=FALSE, nrow=2)) +
#    labs(x="Percent", y="Number of responses", title="")+
#    theme(panel.grid.major = element_blank(),
#          panel.grid.minor = element_blank(),
#          strip.text.x = element_text(size=12, face="bold", color="black"),
#          strip.background = element_rect(colour="white", fill="white"),
#          legend.position=c(0.93, 0.795), legend.spacing=unit(100,"cm"))+ 
#    facet_wrap(~type, nrow=3) +
#  scale_x_continuous(breaks=seq(0,100,10))+scale_y_continuous(expand=c(0,0), limits=c(0,35),breaks=c(0,10,20,30))

#p2 <- p1 %+% xs$`Use-inspired`
#p3 <- p1 %+% xs$Applied
#p1<-p1+scale_fill_manual(name = "ID",values =mycols[4:5], labels=c("2006-2010", "2011-2015"))+labs(x="")+ theme(plot.margin=unit(c(1,1,-0.45,1), "cm"))
#p2<-p2+scale_fill_manual(name = "ID",values =mycols[c(6,1)], labels=c("2006-2010", "2011-2015"))+labs(x="")+ theme(plot.margin=unit(c(-0.25,1,-0.3,1), "cm"))
#p3<-p3+scale_fill_manual(name = "ID",values =mycols[2:3], labels=c("2006-2010", "2011-2015"))+ theme(plot.margin=unit(c(-0.5,1,1,1), "cm"))
#grid.arrange(p1,p2,p3, left= textGrob("(a)", gp = gpar(fontsize=14), y=0.93, hjust = -.75), heights=c(0.35,0.3,0.35))


## newer version - 
# add colours to res.plot
mycols<-c('#33a02c','#a6cee3','#fb9a99','#1f78b4', '#e31a1c','#b2df8a')
mycols<-as.data.frame(mycols)
mycols$ID<-levels(res.plot$ID)
res.plot$col<-mycols$mycols[match(res.plot$ID, mycols$ID)]
res.plot$col<-factor(res.plot$col, levels(res.plot$col)[c(3,1,4,2,6,5)])
mycols<-as.character(unique(res.plot$col))
colScale <- scale_fill_manual(name = "ID",values =mycols, labels=c("2006-2010\nFundamental", "2011-2015\nFundamental","2006-2010\nUse-inspired", "2011-2015\nUse-inspired","2006-2010\nApplied", "2011-2015\nApplied"))

g1<-ggplot(res.plot, aes(percent, fill=ID)) +
    geom_histogram(position='dodge', binwidth=20, bins=seq(0, 100, 20))  +
    guides(fill=guide_legend(title=NULL, reverse=FALSE, nrow=2)) +
    labs(x="Percent", y="Number of responses")+
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),legend.text=element_text(size = 9),
          strip.text.y = element_text(size=12, face="bold", color="black"), legend.key.size=unit(0.65,"cm"),legend.key=element_rect(color=NA, size=40),
          strip.background = element_rect(colour="white", fill="white"),
          legend.position=c(0.78, 0.91), legend.margin=unit(100,"cm"), axis.title.y=element_text(size=11),
          axis.title.x=element_text(size=11), axis.text.x=element_text(size=9), axis.text.y=element_text(size=9), title=element_text(size = 12)) + colScale + 
  scale_x_continuous(breaks=seq(0,100,20), expand = c(0.015,0.015))+scale_y_continuous(expand=c(0,0), limits=c(0,35),breaks=c(0,10,20,30)) +annotate('text', -9,388, label="(a)", size=5)


###plot2

myColors4<-(brewer.pal(9, "Blues"))
myColors4<-myColors4[c(9, 8,7,6,5,3)]

g2<-ggplot(sum.israel, aes(x=Var1, y=Freq, fill=Var1)) + geom_bar(stat='identity')+ 
  theme( axis.text.x = element_text(angle=0, vjust=0.5, size=9), axis.text.y=element_text(size = 9), axis.title=element_text(size = 11),panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),legend.text=element_text(size = 9),axis.title.x=element_blank()) +guides(fill=FALSE) +scale_fill_manual(name = "Var1",values = myColors4)+
  labs(y="Number of responses", x="")+
  scale_y_continuous(expand = c(0, 0), limits = c(0,43))+annotate('text', 5.35,423, label="(b)", size=5)+
  scale_x_discrete(labels=c("Funding\n  ", "Interest\n  ", 
                                    "Career\n  ", "Social\n  ", "Other\n  "))+geom_text(aes(label=Freq), vjust=-0.5, size=3)


###plot 3
myColors5<-(brewer.pal(9, "Blues"))
myColors5<-myColors5[c(4,4,4,4,4,4)]

g3<-ggplot(change.view.is, aes(x=view_change_of_type, y=gender, fill=view_change_of_type)) + geom_bar(stat='identity')+
  theme(axis.text.x = element_text(angle=0, vjust=0.5, size=9), axis.text.y = element_text(size = 9), axis.title.y = element_text(size = 11), axis.title.x = element_text(size = 11)) +guides(fill=FALSE)+
  theme(panel.grid.major = element_blank(),legend.text=element_text(size = 9), panel.grid.minor = element_blank())+ labs(x=NULL, y="Number of responses")+geom_text(aes(label=gender), vjust=-0.5, size=3)+scale_y_continuous(expand = c(0, 0), limits = c(0,20))+scale_fill_manual(name='view_change_of_type', values=myColors5)+annotate('text', 5.35,133, label="(c)", size=5)+scale_x_discrete(labels=c("Very\npositive", "Slightly\npositive", 
                                    "Neutral", "Slightly\nnegative", "Very\nnegative"),limits = rev(levels(change.view.is$gender)))

#width<-matrix(c(50,10,50,10), ncol=1, nrow = 2)
g4<-NULL # to make a blank spot for 'a'

multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}

##Make layout - update changing 'a' back to the original (3 figures instead of one) so 'a' is wrong in this
#pdf(file="figures/4.1_13apr_with.wrong.a.pdf", width = 8, height = 11)
#multiplot(g1, g2, g3, layout = matrix(c(1,1,2,3),nrow=2, byrow=TRUE))

##Make the layout but with the 'a' spot empty so the real 'a' can be put in by copy editor if I dont have time to try it on here
#pdf(file="figures/4.1b.c._ResearchFoci_13apr_blank.a.pdf", width = 8, height = 11)
multiplot(g1, g2, g3, layout = matrix(c(1,1,2,3),nrow=2, byrow=TRUE))

##trying to put the right (old version) into the layout ###havent gotten it to work yet
#pdf(file="figures/4.1_13apr_right.a.pdf", width = 8, height = 11)
#multiplot(arr(p1,p2,p3, left= textGrob("(a)", gp = gpar(fontsize=14), y=0.93, hjust = -.75), heights=c(0.35,0.3,0.35)), g2, g3, layout = matrix(c(1,1,1,1,1,1,2,3),nrow=4, byrow=TRUE))



#dev.off()
```


<!--Part 2 - External Partnerships-->
<!--**4.2 External Partnerships**   -->

```{r, echo=FALSE, fig.cap="Figure 4.6 Current vs past level of partnership outside of academia. Researchers indicated the level of partnership that their current and past (10 years ago) research program had outside of academia).", warning=FALSE}

b.part<-data.frame(table(survey$partnership_outside_before))
b.part<-b.part[!b.part$Var1=="",]
b.part$time<-"Past"
a.part<-data.frame(table(survey$partnership_outside))
a.part<-a.part[!a.part$Var1=="",]
a.part$time<-"Current"

part<-rbind(a.part, b.part)
part$Var1<-factor(part$Var1, levels(part$Var1)[c(1,4,3,2)])
part$time<-factor(part$time)
part$time<-factor(part$time, levels(part$time)[c(2,1)])

myColors6<-(brewer.pal(9, "Blues"))
myColors6<-rev(myColors6[c(9, 5)])
colScale <- scale_fill_manual(name = "Var1",values = myColors6)

pdf(file="figures/global/4.6_LevelsOfPartnership.pdf", width = 11, height= 7)

ggplot(part, aes(x=Var1, y=Freq, fill = time),  ylim(0,375)) + 
  geom_bar( stat='identity', position="dodge") +
  geom_text(aes(label=Freq), position=position_dodge(width=1), vjust=-0.5, size=3) +
  labs(x="", y="Number of responses", fill="")+
  theme(aspect.ratio=3/4, panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.key=element_blank(),legend.text=element_text(size = 9),
        axis.text.x = element_text(angle=0, size=9), axis.text.y=element_text(size = 9), axis.title=element_text(size = 11), 
        legend.position=c(0.91, 0.92), 
        legend.title=element_blank()) +
  colScale+scale_y_continuous(expand = c(0, 0), limits = c(0,800))

dev.off()
```

```{r, echo=FALSE, fig.cap="Figure 4.7a&b Did it change and reasons for change in level of external research partnerships over the past decade.", warning=FALSE}
### was there change

change.part.glb<-data.frame(table(survey$partnership_change_10yrs))
change.part.glb<-change.part.glb[!change.part.glb$Var1=="",]
change.part.glb$Var1<-revalue(change.part.glb$Var1, c("Can't comment (new researcher)"="Can't comment"))
change.part.glb$Var1<-factor(change.part.glb$Var1, levels=c("Yes", "No", "Can't comment"))
myColors<-(brewer.pal(9, "Blues"))
myColors<-myColors[c(9, 7,5)]
g1<-ggplot(data=change.part.glb, aes(x=Var1, y=Freq, fill=Var1))+ 
    geom_bar(stat='identity') + 
    guides(fill=FALSE) + 
    labs(x="", y="No. of responses",title="")+
  geom_text(aes(label=Freq), vjust=-0.5)+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) + 
  scale_fill_manual(name = "Var1",values = myColors) +
  #annotate('text', 3.25,606, label="(a)", size=7)+
  scale_y_continuous(expand = c(0, 0), limits = c(0,1050))

### reason
reason.pt.long<-gather(part2.reason, change.reason, yes, -Country,-Country_work, -gender, -Location, -what_participant_group, -field_research)
sum.global<-data.frame(table(reason.pt.long$change.reason, reason.pt.long$yes))

sum.global$Var1<-revalue(sum.global$Var1, c("reason_partnership_change_career" = "Career", "reason_partnership_change_funding" = "Funding", "reason_partnership_change_interest" = "Interest", "reason_partnership_change_other" = "Other", "reason_partnership_change_socially"  = "Social"))
sum.global$Var1<-reorder(sum.global$Var1, -sum.global$Freq)

myColors7<-(brewer.pal(9, "Blues"))
myColors7<-myColors7[c(9, 8,7,6,5,3)]

g2<-ggplot(sum.global, aes(x=Var1, y=Freq, fill=Var1)) + 
    geom_bar(stat='identity')+  guides(fill=FALSE) +
    theme(aspect.ratio=3/4, axis.text.x = element_text(angle=0, vjust=0.5, size = 9), axis.text.y=element_text(size = 9), axis.title.y=element_text(size = 11),
          legend.position=c(0.8, 0.8), 
          legend.title=element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank()) + 
  geom_text(aes(label=Freq), vjust=-0.5, size=3)+
  labs(x="", y="Number of responses", title="")+scale_fill_manual(name = "Var1",values = myColors7)+
  scale_y_continuous(expand = c(0, 0), limits = c(0,795))

#annotate('text', 5,420, label="(b)", size=7)+ 

pdf(file="figures/global/4.7a&b_PartnershipChange&Reason.pdf", width = 11, height= 7)

grid.arrange(g1, g2, ncol=1)

dev.off()

```

```{r, echo=FALSE, fig.cap="Figure 4.8 View of change in external partnerships. Researchers were asked how they viewed the change in the level of partnership with external groups.", warning=FALSE}
#israel<-subset(part2.view, Country=="Israel")
israel<-part2.view[part2.view$Country_work=="Israel" | (!(part2.view$Country_work=="Israel") & part2.view$Country_work=="" & part2.view$Country=="Israel"),]
view<-data.frame(table(israel$view_change_partnership))
# change order of the levels

view$Var1<-factor(view$Var1, levels(view$Var1)[c(5,3,1,2,4)])

myColors8<-(brewer.pal(9, "Blues"))
myColors8<-myColors8[c(4,4,4,4,4)]
colScale <- scale_fill_manual(name = "Var1",values = myColors8)

pdf(file="figures/global/4.8_ViewChangePartnership.pdf", width = 11, height= 7)

ggplot(view, aes(x=Var1, y=Freq, fill=Var1)) + geom_bar(stat='identity')+
  geom_text(aes(label=Freq, vjust=-0.5), size=3)+
  guides(fill=FALSE)+
  theme(aspect.ratio=3/4, panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle=0, vjust=0, size=9), axis.text.y=element_text(size = 9), axis.title.y=element_text(size=11)) + 
  labs(x="", y="Number of responses") + colScale+scale_y_continuous(expand = c(0, 0), limits = c(0,22), breaks = seq(0,20,10))

dev.off()

```
 
```{r, eval=FALSE, fig.cap="Figure ( 4.6 + 4.7 + 4.8 ) External Research Partnerships. ", warning=FALSE, include=FALSE}
###4.6
myColors6<-(brewer.pal(9, "Blues"))
myColors6<-rev(myColors6[c(9, 5)])
colScale <- scale_fill_manual(name = "Var1",values = myColors6)

p4<-ggplot(part, aes(x=Var1, y=Freq, fill = time),  ylim(0,375)) + 
  geom_bar( stat='identity', position="dodge") +
  geom_text(aes(label=Freq), position=position_dodge(width=1), vjust=-0.5, size=3) +
  labs(x="", y="", fill="")+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.key=element_blank(),legend.text=element_text(size = 9),
        axis.text.x = element_text(angle=0, size=9), axis.text.y=element_text(size = 9), axis.title=element_text(size = 11), 
        legend.position=c(0.93, 0.88), 
        legend.title=element_blank()) +
  colScale+scale_y_continuous(expand = c(0, 0), limits = c(0,35))+scale_x_discrete(limits = rev(levels(part$Var1)))+annotate('text', 0.5,337, label="(a)", size=5)+labs(y="Number of responses")
p4

###4.7
myColors7<-(brewer.pal(9, "Blues"))
myColors7<-myColors7[c(9, 8,7,6,5,3)]

p5<-ggplot(sum.israel, aes(x=Var1, y=Freq, fill=Var1)) + 
    geom_bar(stat='identity')+  guides(fill=FALSE) +
    theme( axis.text.x = element_text(angle=0, vjust=0.5, size = 9), axis.text.y=element_text(size = 9), axis.title.y=element_text(size = 11),
          legend.position=c(0.8, 0.78), 
          legend.title=element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank()) + 
  geom_text(aes(label=Freq), vjust=-0.5, size=3)+
  labs(x="", y="Number of responses")+scale_fill_manual(name = "Var1",values = myColors7)+
  scale_y_continuous(expand = c(0, 0), limits = c(0,32))+annotate('text', 5.3,431, label="(b)", size=5)+scale_x_discrete(labels=c("Funding\n ", "Interest\n", 
                                    "Career\n", "Social\n", "Other\n "))
p5

###4.8
myColors8<-(brewer.pal(9, "Blues"))
myColors8<-myColors8[c(4,4,4,4,4)]
colScale <- scale_fill_manual(name = "Var1",values = myColors8)

p6<-ggplot(view, aes(x=Var1, y=Freq, fill=Var1)) + geom_bar(stat='identity')+
  geom_text(aes(label=Freq, vjust=-0.5), size=3)+
  guides(fill=FALSE)+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle=0, vjust=0, size=9), axis.text.y=element_text(size = 9), axis.title.y=element_text(size=11)) + 
  labs(x="", y="") + colScale + scale_y_continuous(expand = c(0, 0), limits = c(0,22), breaks = seq(0,10,10))+scale_x_discrete(labels=c("Very\npositive", "Slightly\npositive", "Neutral", "Slightly\nnegative", "Very\nnegative"))+annotate('text', 0.65,158, label="(c)", size=5)
p6


#put them all together


multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}

#pdf(file="figures/4.2_13Apr.pdf")

multiplot(p4, p5, p6, layout = matrix(c(1,1,2,3),nrow=2, byrow=TRUE))

 
#dev.off()

```
 
 
 
 
<!--Part 3 - Grant Application History-->
<!--**4.3 Research Grants**  -->


```{r, echo=FALSE, fig.cap="Fig. 4.9 Number of research grant applications by research category in 2006-2010 and 2011-2015.", fig.height=12, message=FALSE, warning=FALSE}
#israel<-subset(part3.grants.long, Country=="Israel")
israel<-part3.grants.long[part3.grants.long$Country_work=="Israel" | (!(part3.grants.long$Country_work=="Israel") & part3.grants.long$Country_work=="" & part3.grants.long$Country=="Israel"),]
israel$type.grant<-as.character(israel$type.grant)


#add time variable
israel$time<-ifelse(grepl("11_15", israel$type.grant), "2011-2015", "2006-2010")
israel$type.grant[israel$type.grant=="external_pi_grant_11_15_fundamental"]<-"Fundamental"
israel$type.grant[israel$type.grant=="external_pi_grant_6_10_fundamental"]<-"Fundamental"
israel$type.grant[israel$type.grant=="external_pi_grant_11_15_use"]<-"Use-Inspired"
israel$type.grant[israel$type.grant=="external_pi_grant_6_10_use"]<-"Use-Inspired"
israel$type.grant[israel$type.grant=="external_pi_grant_11_15_applied"]<-"Applied"
israel$type.grant[israel$type.grant=="external_pi_grant_6_10_applied"]<-"Applied"

grants.is<-data.frame(with(israel, table(type.grant,time,number)))
grants.is$type.grant<-as.factor(grants.is$type.grant)


#change order of levels
grants.is$number<-factor(grants.is$number, levels(grants.is$number)[c(1,2,6,7,3,4,5)])
grants.is$type.grant<-factor(grants.is$type.grant, levels(grants.is$type.grant)[c(2,3,1)])

#myColors9<-(brewer.pal(9, "Blues"))
#myColors9<-rev(myColors9[c(9, 5)])
#colScale <- scale_fill_manual(name = "time",values = myColors9)

grants.is$ID<-paste(grants.is$type.grant, grants.is$time)

# change order of the levels
grants.is$ID<-as.factor(grants.is$ID)
grants.is$ID<-factor(grants.is$ID, levels(grants.is$ID)[c(4,3,6,5,2,1)])

#pdf(file="figures/4.9(appendix)_12Apr.pdf", height=7, width =11)


#####add (a)
xs <- split(grants.is,f = grants.is$type.grant)
p1 <- ggplot(xs$Fundamental, aes(number, Freq, fill=time), width=0.7) + 
    geom_bar(stat="identity", position = "dodge")+
    #facet_wrap(~type.grant, ncol=3) +
    guides(fill=guide_legend(title=NULL, reverse=FALSE)) +
    labs(x="Number of grant applications", y="Number of responses")+
    theme(aspect.ratio=4/3, panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          legend.key=element_blank(),
           strip.text.x = element_text(size=12, face="bold", color="black"),
          strip.background = element_rect(colour="white", fill="white"),
          legend.position=c(0.81, 0.91), legend.text=element_text(size = 9), axis.title.x=element_text(size = 11),
          axis.title.y=element_text(size=11), axis.text.x=element_text(size=9), axis.text.y=element_text(size=9)) + 
  colScale+scale_y_continuous(expand = c(0, 0), limits = c(0,150), breaks = c(0,25,50,75,100,125, 150))

p2 <- p1 %+% xs$`Use-Inspired`
p3 <- p1 %+% xs$Applied
p1<-p1+scale_fill_manual(name = "ID",values =mycols[c(4,5)], labels=c("2006-2010", "2011-2015"))+labs(title="Fundamental")+ theme(plot.title = element_text(size=12, hjust=0.5, face = "bold"))
p2<-p2+scale_fill_manual(name = "ID",values =mycols[c(6,1)], labels=c("2006-2010", "2011-2015"))+labs(title="Use-inspired")+ theme(plot.title = element_text(size=12, hjust=0.5, face = "bold"))
p3<-p3+scale_fill_manual(name = "ID",values =mycols[c(2,3)], labels=c("2006-2010", "2011-2015"))+labs(title="Applied")+ theme(plot.title = element_text(size=12, hjust=0.5, face = "bold"))

grid.arrange(p1,p2,p3, nrow=1)

#dev.off()

 #ggplot(grants.is, aes(number, Freq, fill=time), width=0.7) + 
#    geom_bar(stat="identity", position = "dodge")+
#    facet_wrap(~type.grant, ncol=3) +
#    guides(fill=guide_legend(title=NULL, reverse=FALSE)) +
#    labs(x="Number of grant applications", y="Number of responses")+
#    theme(aspect.ratio=4/3, panel.grid.major = element_blank(),
#          panel.grid.minor = element_blank(),
#          legend.key=element_blank(),
#           strip.text.y = element_text(size=12, face="bold", color="black"),
#          strip.background = element_rect(colour="white", fill="white"),
#          legend.position=c(0.91, 0.89), legend.text=element_text(size = 9), axis.title.x=element_text(size = 11),
#          axis.title.y=element_text(size=11), axis.text.x=element_text(size=9), axis.text.y=element_text(size=9)) + 
#  colScale+scale_y_continuous(expand = c(0, 0), limits = c(0,950), breaks = c(0,250,500,750,950))
```

```{r, echo=FALSE, fig.cap="Fig 4.10 Research grant application success over the past 10 years. Researchers were asked to estimate the percentage of their research grant applications that were successful, in 2006-2010 and in 2011-2015. Respondents also had the choice to answer No need for applications for this research type.", warning=FALSE}
#israel<-subset(part3.success.long, Country=="Israel")
israel<-part3.success.long[part3.success.long$Country_work=="Israel" | (!(part3.success.long$Country_work=="Israel") & part3.success.long$Country_work=="" & part3.success.long$Country=="Israel"),]
israel$type<-as.character(israel$type)

#add time variable
israel$time<-ifelse(grepl("11_15", israel$type), "2011-2015", "2006-2010")
israel$type[israel$type=="successful_grants_11_15_fundamental"]<-"Fundamental"
israel$type[israel$type=="successful_grants_6_10_fundamental"]<-"Fundamental"
israel$type[israel$type=="successful_grants_11_15_use"]<-"Use-Inspired"
israel$type[israel$type=="successful_grants_6_10_use"]<-"Use-Inspired"
israel$type[israel$type=="successful_grants_11_15_applied"]<-"Applied"
israel$type[israel$type=="successful_grants_6_10_applied"]<-"Applied"

success.is<-data.frame(with(israel, table(type, percent,time)))



#change order of types
success.is$type<-as.factor(success.is$type)
success.is$type<-factor(success.is$type, levels(success.is$type)[c(2,3,1)])

success.is$id<-paste(success.is$type, success.is$time)

# change order of the levels
success.is$id<-as.factor(success.is$id)
success.is$id<-factor(success.is$id, levels(success.is$id)[c(3,4,5,6,1,2)])

mycols10<-c('#1f78b4','#a6cee3','#33a02c','#b2df8a','#e31a1c', '#fb9a99')
mycols10<-as.data.frame(mycols10)
mycols10$id<-levels(success.is$id)
success.is$col<-mycols10$mycols10[match(success.is$id, mycols10$id)]
success.is$col<-factor(success.is$col, levels(success.is$col)[c(3,1,4,2,6,5)])

#pdf(file="figures/global/4.10.pdf", height=7, width =11)

out2<-by(data = success.is, INDICES = success.is$type, FUN = function(n){
  n <- droplevels(n)
  n$col<-factor(n$col, levels(n$col)[c(3,1,4,2,6,5)])
  mycols10<-as.character(unique(n$col))
  colScale <- scale_fill_manual(name = "id",values =mycols10, labels=c("2006-2010", "2011-2015"))
  n <- ggplot(n, aes(percent, Freq, fill=id)) +
    geom_bar(stat="identity", position='dodge')  +
    guides(fill=guide_legend(title=NULL, reverse=FALSE, nrow=2)) +
    labs(x="Percent of successful grants", y="Number of responses", title=n$type)+
    theme(aspect.ratio=1/4, panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          legend.key=element_blank(),legend.text=element_text(size = 9),
          strip.text.x = element_text(size=12, face="bold", color="black", hjust=0.5),
          strip.background = element_rect(colour="white", fill="white"),
           axis.title.y=element_text(size=11),plot.title = element_text(size=12, face="bold", hjust=0.5),
          axis.title.x=element_text(size=11), axis.text.x=element_text(size=9), axis.text.y=element_text(size=9), title=element_text(size = 12)) + colScale +
    scale_y_continuous(expand=c(0,0), limits=c(0,35))
 })
do.call(grid.arrange, out2)

#dev.off()

#ggplot(success.ca, aes(percent, Freq, fill=time)) + 
#    geom_bar(stat="identity", position = "dodge")+
#     facet_wrap(~type, nrow=3) +
#    guides(fill=guide_legend(title=NULL, reverse=FALSE)) +
#    labs(x="Perceived percentage of successful grants", y="Number of responses")+
#    theme(panel.grid.major = element_blank(),
#          panel.grid.minor = element_blank(),
#           strip.text.y = element_text(size=12, face="bold", color="black"),
#          strip.background = element_rect(colour="white", fill="white"),
#          legend.position=c(0.955, 0.58), legend.margin=unit(-1000,"cm"), legend.text=element_text(size = 9), axis.title.x=element_text(size = 11),
#          axis.title.y=element_text(size=11), axis.text.x=element_text(size=9), axis.text.y=element_text(size=9)) + colScale+
#  scale_y_continuous(expand = c(0, 0), limits = c(0,300))



```
 
```{r, echo=FALSE, fig.cap="Fig 4.11 Change in grant success rates over the past 10 years. Researchers were asked if they thought that grant sucecss rates have changed in the past 10 years, for each research category.", warning=FALSE}
israel<-part3.change[part3.change$Country_work=="Israel" | (!(part3.change$Country_work=="Israel") & part3.change$Country_work=="" & part3.change$Country=="Israel"),]

##switch to long format
change.long.is<-gather(israel, type, level, -Location, -gender, -Country, -Country_work, -what_participant_group, -field_research)
success.change<-with(change.long.is, data.frame(table(type, level)))
#remove no response
success.change<-success.change[!success.change$level=="",]
success.change<-droplevels(success.change)

# add colour palette
myColors11<-c('#1f78b4','#33a02c','#e31a1c')
colScale <- scale_fill_manual(name = "type",values = myColors11, labels=c("Fundamental", "Use-inspired", "Applied"))

#change order of levels
success.change$level<-factor(success.change$level, levels(success.change$level)[c(5,4,6,2,3,1)])
success.change$type<-factor(success.change$type, levels(success.change$type)[c(2,3,1)])
success.change$type<-revalue(success.change$type, c("success_change_10yrs_fundamental"="Fundamental",
              'success_change_10yrs_use'='Use-inspired', 'success_change_10yrs_applied' = 'Applied'))

pdf(file="figures/global/4.11_ChangeSuccessRate.pdf", height=7, width =11)

ggplot(data=success.change, aes(x=level, Freq, fill=type))+ facet_wrap(~type, nrow=3)+
  geom_bar(stat="identity", position="dodge")+
  guides(fill=guide_legend(title=NULL)) +
  theme(aspect.ratio=1/4, axis.text.x = element_text(angle=0, vjust=0.5, size = 9), axis.text.y=element_text(size = 9), axis.title.y=element_text(size = 11),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
         strip.text.x = element_text(size=12, face="bold", color="black"),
          strip.background = element_rect(colour="white", fill="white"),
        legend.position=c(0.15, 0.9))+
  guides(fill=FALSE)+
  geom_text(aes(label=Freq, vjust=-0.4),size=3) +
  scale_x_discrete(labels=c("Increased\n considerably", "Increased\n slightly", 
                                    "Stayed the\n same", "Decreased\n slightly", "Decreased\n considerably", "Can't\n comment"),limits = (levels(success.change$level)))+
  labs(x="", y="Number of responses", fill="")+ colScale+
  scale_y_continuous(expand = c(0, 0), limits = c(0,95))

dev.off()


```

```{r, echo=FALSE, fig.cap="Fig 4.12 Importance of practical application of research over the past 10 years. Researchers were asked how important it was to suggest practical applications of their research to ensure that the grant was successful, in 2006-2010 and in 2011-2015.", warning=FALSE}

israel<-part3.prac.long[part3.prac.long$Country_work=="Israel" | (!(part3.prac.long$Country_work=="Israel") & part3.prac.long$Country_work=="" & part3.prac.long$Country=="Israel"),]

israel$year<-as.character(israel$year)

israel$year[israel$year=="practical_applications_important_11_15"]<-"2011-2015"
israel$year[israel$year=="practical_applications_important_6_10"]<-"2006-2010"


prac.is<-data.frame(table(israel$year, israel$level))

#change order of levels
prac.is$Var2<-factor(prac.is$Var2, levels(prac.is$Var2)[c(2,6,4,5,3,1)])

myColors12<-(brewer.pal(9, "Blues"))
myColors12<-rev(myColors12[c(9, 5)])
colScale <- scale_fill_manual(name = "Var1",values = myColors12)

pdf(file="figures/global/4.12_ImportancePracticalApplication.pdf", height=7, width =11)

ggplot(prac.is, aes(Var2, Freq, fill=Var1)) + 
  geom_bar(stat="identity", position = "dodge")+geom_text(aes(label=Freq), vjust=-0.5, hjust=0.2, size=3, position = position_dodge(width = 0.95))+
  theme(aspect.ratio=3/4, panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.key=element_blank(),legend.text=element_text(size = 9),
        legend.position=c(0.89, 0.91),
        axis.text.x = element_text(angle=0, vjust=0.5, size = 9), axis.text.y=element_text(size = 9), axis.title.x=element_text(size = 11),
        axis.title.y=element_text(size = 11)) +
  guides(fill=guide_legend(title=NULL, reverse=FALSE)) + 
  scale_x_discrete(labels=c("Mandatory", "Very\n important","Quite\n important", 'Somewhat\n important', 'Not at all\n important', "Can't\n comment"))+
  labs(x="Importance of suggesting practical research applications", y="Number of responses")+ colScale+
  scale_y_continuous(expand = c(0, 0), limits = c(0,50))
  
dev.off()
```

```{r, echo=FALSE, fig.cap="Fig 4.13 Importance of including partners from for-profit or non-governmental sectors in grant success. Researchers were asked how important it was to include external partnerships in their research to ensure that the grant was successful, in 2006-2010 and in 2011-2015.", warning=FALSE}

israel<-part3.part.long[part3.part.long$Country_work=="Israel" | (!(part3.part.long$Country_work=="Israel") & part3.part.long$Country_work=="" & part3.part.long$Country=="Israel"),]

israel$year<-as.character(israel$year)

israel$year[israel$year=="include_nonacademia_partners_success_11_15"]<-"2011-2015"
israel$year[israel$year=="include_nonacademia_partners_success_6_10"]<-"2006-2010"

part.is<-data.frame(table(israel$year, israel$level))
#change order of levels
part.is$Var2<-factor(part.is$Var2, levels(part.is$Var2)[c(2,5,6,4,3,1)])

## add colour scale
myColors13<-(brewer.pal(9, "Blues"))
myColors13<-rev(myColors13[c(9, 5)])
colScale <- scale_fill_manual(name = "Var1",values = myColors13)

pdf(file="figures/global/4.13_ImportancePartnersApplication.pdf", height=7, width =11)

ggplot(part.is, aes(Var2, Freq, fill=Var1))+ 
  geom_bar(stat="identity", position = "dodge")+geom_text(aes(label=Freq), vjust=-0.5, hjust=0.3, size=3, position = position_dodge(width = 0.8))+
    guides(fill=guide_legend(title=NULL, reverse=FALSE)) +
    labs(x="Importance of external partnerships", y="Number of responses")+
  scale_x_discrete(labels=c("Mandatory", "Quite\n important", 'Somewhat\n important',"Not very\n important", 'Not at all\n important', "Can't\n comment"))+
    theme(aspect.ratio=3/4, panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),legend.text=element_text(size = 9),
          legend.key=element_blank(),
          legend.position=c(0.13, 0.9), axis.text.x=element_text(size = 9), axis.text.y=element_text(size=9),
          axis.title.x=element_text(size = 11), axis.title.y=element_text(size = 11)) + colScale+
  scale_y_continuous(expand = c(0, 0), limits = c(0,60))

dev.off()
```

```{r, eval=FALSE, fig.cap="Fig (4.12+4.13) Importance of practical applications and external partnerships.", warning=FALSE, include=FALSE}
###4.12
myColors12<-(brewer.pal(9, "Blues"))
myColors12<-rev(myColors12[c(9, 5)])
colScale <- scale_fill_manual(name = "Var1",values = myColors12)


p10<-ggplot(prac.is, aes(Var2, Freq, fill=Var1)) + 
  geom_bar(stat="identity", position = "dodge")+
  theme(aspect.ratio=3/4, panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.key=element_blank(),
        legend.position=c(0.88, 0.898), legend.text=element_text(size = 9),
        axis.text.x = element_text(angle=0, vjust=0.5, size = 9), axis.text.y=element_text(size = 9), axis.title.x=element_text(size = 11),
        axis.title.y=element_text(size = 11)) +
  guides(fill=guide_legend(title=NULL, reverse=FALSE)) + 
  scale_x_discrete(labels=c("Mandatory", "Very\n important","Quite\n important", 'Somewhat\n important', 'Not at all\n important', "Can't\n comment"))+
  labs(x="", y="Number of responses")+ colScale+
  scale_y_continuous(expand = c(0, 0), limits = c(0,50))+annotate('text', 0.65,423, label="(a)", size=5)
p10

###4.13
myColors13<-(brewer.pal(9, "Blues"))
myColors13<-rev(myColors13[c(9, 5)])
colScale <- scale_fill_manual(name = "Var1",values = myColors13)


p11<-ggplot(part.is, aes(Var2, Freq, fill=Var1))+ 
  geom_bar(stat="identity", position = "dodge")+
    guides(fill=guide_legend(title=NULL, reverse=FALSE)) +
    labs(x="", y="")+
  scale_x_discrete(labels=c("Mandatory", "Quite\n important", 'Somewhat\n important',"Not very\n important", 'Not at all\n important', "Can't\n comment"))+
    theme(aspect.ratio=3/4, panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          legend.key=element_blank(),legend.text=element_text(size = 9),
          legend.position=c(0.13, 0.898), axis.text.x=element_text(size = 9), axis.text.y=element_text(size=9),
          axis.title.x=element_text(size = 11), axis.title.y=element_text(size = 11)) + colScale+
  scale_y_continuous(expand = c(0, 0), limits = c(0,60))+annotate('text', 0.65,460, label="(b)", size=5)
p11

#pdf(file="figures/4.3_13Apr.pdf", width = 11, height= 7)

grid.arrange(p10,p11, heights=c(0.5,0.5), ncol=1)

#dev.off()

```

```{r, echo=FALSE, fig.cap="Fig 4.14 Distribution of research funding over the past 10 years. Researchers were asked to estimate the distribution of their research funding sources in 2006-2010 and 2011-2015.",  warning=FALSE}

israel<-p3_master.long[p3_master.long$Country_work=="Israel" | (!(p3_master.long$Country_work=="Israel") & p3_master.long$Country_work=="" & p3_master.long$Country=="Israel"),]

##revalue the year values
israel$year<- revalue(israel$year, c("11_15"="2011-2015", "6_10"="2006-2010"))
#change order of levels
israel$year<-factor(israel$year, levels(israel$year)[c(2,1)])


##For-Profit
fp<-israel[israel$type=="For-Profit",]

myColors14<-(brewer.pal(9, "Blues"))
myColors14<-rev(myColors14[c(9, 5)])
colScale <- scale_fill_manual(name = "year",values = myColors14)

p1<-ggplot(fp, aes(percent, fill=year))+ geom_histogram(position='dodge', binwidth=10)  + colScale +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.922, 0.98), 
          legend.key.size = unit(0.3, "cm"), plot.title = element_text(size=12, hjust = 0.5, face="bold"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), axis.text.x=element_text(size = 9), axis.text.y=element_text(size = 9), legend.key=element_blank(),
          axis.title.x=element_text(size=11), axis.title.y=element_text(size = 11)) +
  labs(list(title= "Industry", x="", y = "Number of responses"))+
  scale_y_continuous(expand =c(0,0), limits=c(0,180), breaks=c(0, 25, 50, 75, 100, 125, 150, 175))+
  scale_x_continuous( breaks = seq(0, 100, 10))



##Government
gov<-israel[israel$type=="Government",]

myColors14<-(brewer.pal(9, "Blues"))
myColors14<-rev(myColors14[c(9, 5)])
colScale <- scale_fill_manual(name = "year",values = myColors14)

p2<-ggplot(gov, aes(percent, fill=year))+ geom_histogram(position='dodge', binwidth=10)  + colScale +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.9, 0.91),
          legend.key.size = unit(0.3, "cm"),plot.title = element_text(size=12, hjust = 0.5, face="bold"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), axis.text.x=element_text(size = 9), axis.text.y=element_text(size = 9), legend.key=element_blank(),
          axis.title.x=element_text(size=11), axis.title.y=element_text(size = 11)) +
  labs(title="Government", x="", y = "")+
  scale_y_continuous(expand =c(0,0), limits=c(0,180), breaks=c(0, 25, 50, 75, 100, 125, 150, 175))+
  scale_x_continuous( breaks = seq(0, 100, 10))




##Internal

int<-israel[israel$type=="Internal",]

myColors14<-(brewer.pal(9, "Blues"))
myColors14<-rev(myColors14[c(9, 5)])
colScale <- scale_fill_manual(name = "year",values = myColors14)

p3<-ggplot(int, aes(percent, fill=year))+ geom_histogram(position='dodge', binwidth=10)  + colScale +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.922, 0.98),
          legend.key.size = unit(0.3, "cm"),plot.title = element_text(size=12, hjust = 0.5, face="bold"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), axis.text.x=element_text(size = 9), axis.text.y=element_text(size = 9), legend.key=element_blank(),
          axis.title.x=element_text(size=11), axis.title.y=element_text(size = 11)) +
  labs(title="Internal",x="% research funding", y = "Number of responses")+
  scale_y_continuous(expand =c(0,0), limits=c(0,180), breaks=c(0, 25, 50, 75, 100, 125, 150, 175))+
  scale_x_continuous( breaks = seq(0, 100, 10))




##Non-Governmental

ngov<-israel[israel$type=="Non-governmental",]

myColors14<-(brewer.pal(9, "Blues"))
myColors14<-rev(myColors14[c(9, 5)])
colScale <- scale_fill_manual(name = "year",values = myColors14)

p4<-ggplot(ngov, aes(percent, fill=year))+ geom_histogram(position='dodge', binwidth=10)  + colScale +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.922, 0.98),
          legend.key.size = unit(0.3, "cm"),plot.title = element_text(size=12, hjust = 0.5, face="bold"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), axis.text.x=element_text(size = 9), axis.text.y=element_text(size = 9), legend.key=element_blank(),
          axis.title.x=element_text(size=11), axis.title.y=element_text(size = 11)) +
  labs(title="Non-governnmental", x="% research funding", y = "")+
  scale_y_continuous(expand =c(0,0), limits=c(0,180), breaks=c(0, 25, 50, 75, 100, 125, 150, 175))+
  scale_x_continuous( breaks = seq(0, 100, 10))



## Other

other<-israel[israel$type=="Other",]

myColors14<-(brewer.pal(9, "Blues"))
myColors14<-rev(myColors14[c(9, 5)])
colScale <- scale_fill_manual(name = "year",values = myColors14)

p5<-ggplot(other, aes(percent, fill=year))+ geom_histogram(position='dodge', binwidth=10)  + colScale +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.922, 0.98),
          legend.key.size = unit(0.3, "cm"),plot.title = element_text(size=12, hjust = 0.5, face="bold"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), axis.text.x=element_text(size = 9), axis.text.y=element_text(size = 9), legend.key=element_blank(),
          axis.title.x=element_text(size=11), axis.title.y=element_text(size = 11)) +
  labs(title="Other", x="% research funding", y = "")+
  scale_y_continuous(expand =c(0,0), limits=c(0,180), breaks=c(0, 25, 50, 75, 100, 125, 150, 175))+
  scale_x_continuous( breaks = seq(0, 100, 10))


##put them all together

legend = gtable_filter(ggplotGrob(p1), "guide-box") 
grid.draw(legend)

#pdf(file="figures/global/4.14.pdf", height=7, width =11)

grid.arrange(arrangeGrob(p1+ theme(legend.position="none"), p2+ theme(legend.position="none"),
                         p3+ theme(legend.position="none"), p4+ theme(legend.position="none"),
                         p5+ theme(legend.position="none"),
                         layout_matrix=rbind(c(1,1,1,2,2,2),c(3,3,4,4,5,5))))

#dev.off()

```


<!--Part 4 - Funding Trends in your country of work-->
<!--**4.4 Perspectives on the State of Fundamental Research**-->

```{r, echo=FALSE, fig.cap="Fig 4.15 Perceived importance of fundamental research to their government. Researchers were asked how important they thought fundamental research was to the their government. Responses were/were not significantly different between genders."}
## order bars from very important (left) to can't comment (right)
important<-subset(part4, select=c("Location","Country",'Country_work', "gender","opinion_fundamental_important"))

israel<-important[important$Country_work=="Israel" | (!(important$Country_work=="Israel") & important$Country_work=="" & important$Country=="Israel"),]

## using table to count cases of each category
sum.important<-data.frame(table(israel$opinion_fundamental_important))
# remove non-responses
sum.important<-sum.important[!sum.important$Var1=="",]
sum.important$Var1<-factor(sum.important$Var1, levels(sum.important$Var1)[c(6,5,4,3,2,1)])

perceive<-aggregate(Freq~Var1, sum.important, sum)

### colour palette

myColors15<-(brewer.pal(9, "Blues"))
myColors15<-(myColors15[c(4,4,4,4,4,4)])
colScale <- scale_fill_manual(name = "Var1",values = myColors15)

pdf(file="figures/global/4.15_PerceivedImportanceFundamentalGovernment.pdf", height=7, width =11)

ggplot(data=perceive, aes(x=Var1, y=Freq, fill=Var1)) + 
      geom_bar(stat='identity', position='dodge')+ 
      labs(x="", y="Number of responses", fill="")+
      scale_x_discrete(labels=c("Very\n important", "Somewhat\n important", 'Not very\n important', 'Not at all\n important', "Can't\n comment"))+
      geom_text(aes(label=Freq, vjust=-0.5), size=3) + guides(fill=FALSE)+
      theme(aspect.ratio=3/4, axis.text.x = element_text(angle=0, vjust=0.4, size=9),
            panel.grid.major = element_blank(), 
            panel.grid.minor = element_blank(), axis.title.y=element_text(size=11), axis.text.y=element_text(size=9)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0,85)) + colScale

dev.off()
```

```{r, echo=FALSE, fig.cap="Fig 4.16 Perceived change in research priority by their government. Researchers were asked whether any types of research had become higher priority for the their government. Responses were/were not significantly different between genders."}
## order bars into applied > use > fundamental > no change
priority<-subset(part4, select=c("Location","Country",'Country_work', "gender", "high_priority_fundamental", "high_priority_use_inspired", "high_priority_applied", 
                                 "high_priority_no_change"))

israel<-priority[priority$Country_work=="Israel" | (!(priority$Country_work=="Israel") & priority$Country_work=="" & priority$Country=="Israel"),]

## switch to long format
priority.long<-gather(israel, what.type, higher.priority, -Location, -gender, -Country, -Country_work)
# remove non-responses (n = 1066)
priority.long<-priority.long[!priority.long$higher.priority=="",]
per.change<-aggregate(higher.priority~what.type, priority.long, sum)

# change order of the levels
per.change$what.type<-as.factor(per.change$what.type)
per.change$what.type<-factor(per.change$what.type, levels(per.change$what.type)[c(2,4,1,3)])

myColors16<-(brewer.pal(9, "Blues"))
myColors16<-(myColors16[c(4,4,4,4,4,4)])
colScale <- scale_fill_manual(name = "Var1",values = myColors16)

pdf(file="figures/global/4.16_PerceivedChangeResearchPriorityGovernment.pdf", height=7, width =11)

ggplot(data=per.change, aes(x=what.type, higher.priority, fill=what.type))+
        geom_bar(stat="identity", position='dodge')+ guides(fill=FALSE)+
        theme(aspect.ratio=3/4, 
              axis.text.x = element_text(angle=0, vjust=0.4, size=9),
              panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(), axis.title.y=element_text(size=11),  axis.text.y=element_text(size=9)) +
        labs(x="", y="Number of responses", fill="") +
  scale_x_discrete(labels=c( "Fundamental", "Use-inspired","Applied", "No change"))   +
  geom_text(aes(label=higher.priority, vjust=-0.5), size=3) +scale_y_continuous(expand = c(0, 0), limits = c(0,107))+ colScale

dev.off()
```


```{r, echo=FALSE, fig.cap="Fig 4.17 Anticipated change in research funding in next five years. Researchers were asked whether the availability of research funding would change in the next five years, for each research category. Responses were/were not significantly different between genders. "}
## change in funding on the x-axis, and colours = type of research
## order bars into increase considerably (left) to decrease considerably (right), then no comment at the far right
availability.change<-subset(part4, select=c("Location", "Country",'Country_work', "gender", "available_funding_fundamental",  
                                             "available_funding_use_inspired", "available_funding_applied"))

israel<-availability.change[availability.change$Country_work=="Israel" | (!(availability.change$Country_work=="Israel") & availability.change$Country_work=="" & availability.change$Country=="Israel"),]

## switch to long format
availability.change.long.is<-gather(israel, what.type, level, -gender, -Location, -Country, -Country_work)
availability.is<-with(availability.change.long.is, data.frame(table(what.type, level)))

#remove non response
availability.is<-availability.is[!availability.is$level=="",]

## change type to factor with levels
availability.is$level<-str_replace_all(availability.is$level, "Will ", "")
availability.is$what.type<-as.factor(availability.is$what.type)
availability.is$level<-as.factor(availability.is$level)

## change order of levels
availability.is$level<-factor(availability.is$level, levels(availability.is$level)[c(4,5,6,3,2,1 )])
availability.is$what.type<-factor(availability.is$what.type, levels(availability.is$what.type)[c(2,3,1)])

availability.is$what.type<-revalue(availability.is$what.type, c("available_funding_fundamental"="Fundamental",
              'available_funding_use_inspired'='Use-inspired', 'available_funding_applied' = 'Applied'))

### colour palette

myColors17<-mycols<-c('#1f78b4','#33a02c','#e31a1c')
colScale <- scale_fill_manual(name = "what.type",values = myColors17)

pdf(file="figures/global/4.17_AnticipatedChangeFunding.pdf", height=7, width =11)

ggplot(data=availability.is, aes(x=level, Freq, fill=what.type))+
    geom_bar(stat="identity", position="dodge")+
    theme(aspect.ratio=1/4, axis.text.x = element_text(angle=0, vjust=0.5, size = 9),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
           strip.text.x = element_text(size=12, face="bold", color="black"),
          strip.background = element_rect(colour="white", fill="white"),
          legend.position=c(0.8, 0.2), axis.title.y=element_text(size=11), axis.text.y=element_text(size=9)) +
    guides(fill=FALSE)+
    labs(x="", y="Number of responses", fill="")+
    scale_x_discrete(labels=c("Increase\n considerably", "Increase\n slightly", 
                                    "Stay the same", "Decrease\n slightly", "Decrease\n considerably", "Can't\n comment"))+
    facet_wrap(~what.type,nrow=3)+
    geom_text(aes(label=Freq), vjust=-0.5, size=2.8) + colScale +
  scale_y_continuous(expand = c(0, 0), limits = c(0,70), breaks = seq(0,70,20))

dev.off()


```

```{r, echo=FALSE, fig.cap="Fig 4.18 Effect of change in research funding on research careers of next generation. Researchers were asked if they though that changes in funding availability would influence the likelihood of the next generation pursuing careers in research. Responses were/were not significantly different between genders."}

## order bars into increase considerably (left) to decrease considerably (right), then no comment at the far right
next.generation<-subset(part4, select=c("Location", "Country","Country_work", "gender","next_generation"))
# remove non-response
next.generation<-next.generation[!next.generation$next_generation=="",]
israel<-next.generation[next.generation$Country_work=="Israel" | (!(next.generation$Country_work=="Israel") & next.generation$Country_work=="" & next.generation$Country=="Israel"),]

impact<-data.frame(table(israel$next_generation))

## change type to factor with levels
impact$Var1<-str_replace_all(impact$Var1, "Will ", "")
impact$Var1<-as.factor(impact$Var1)
impact<-impact[!impact$Var1=="",]
impact<-droplevels(impact)
## change order of Var1s
impact$Var1<-factor(impact$Var1, levels(impact$Var1)[c(4,5,6,3,2,1)])
 
myColors18<-(brewer.pal(9, "Blues"))
myColors18<-(myColors18[c(4,4,4,4,4,4)])
colScale <- scale_fill_manual(name = "Var1",values = myColors18)

pdf(file="figures/global/4.18_EffectNextGeneration.pdf", height=7, width =11)

ggplot(data=impact, aes(x=Var1, Freq, fill=Var1))+ 
    geom_bar(stat='identity', position="dodge")  +
        scale_x_discrete(labels=c("Increase\n considerably", "Increase\n slightly", 
                                    "Stay the same", "Decrease\n slightly", "Decrease\n considerably", "Can't\n comment"))+
    guides(fill=FALSE) +
 labs(x="", y="Number of responses")+
  theme(aspect.ratio=3/4, axis.text.x = element_text(angle=0, vjust=0.5, size=9),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
          axis.title.y=element_text(size=11), axis.text.y=element_text(size=9))+
  geom_text(aes(label=Freq, vjust=-0.5), size=3)+
  scale_y_continuous(expand = c(0, 0), limits = c(0,58))+colScale

dev.off()
```
