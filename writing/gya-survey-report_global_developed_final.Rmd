---
title: "Developed countries (random Canadian) online survey on fundamental research - using data from Andre"
author: ''
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document: null
  fig_width: 18
  html_document: default
  word_document: default
  fig_height: 4
---

**Introduction**  
We developed and ran a quantitative online survey to query researchers about their perceptions of, and experiences with, funding for fundamental research. An important aim of the survey was to provide an understanding researcher's personal experiences and outlook on the research funding landscape. We had an excellent response to the survey, with over xxxx  researchers completing it, suggesting that fundamental research funding is a high priority topic for researchers. Herein, we detail the survey questions and results. 

**Methods**  
Online Survey  
The survey was open to researchers from all disciplines (e.g. science, social sciences, humanities, engineering, medicine) and career stages, with the proviso that they had some experience applying for research funding. The survey gathered detailed information in four major areas: 1) the types of research the scholars conduct (fundamental, use-inspired, applied), 2) the extent of external partnerships in their research, 3) their grant success rates, and 4) how important they perceive fundamental research is to the  federal government and its future prospects in . The survey also enquired how each of these factors have changed over time for the researchers. Finally, the survey gathered basic information from each respondent about gender, discipline, career stage and the year their PhD was obtained. The full survey is provided in Appendix 2. 

The online survey was open from the end of May through xxxxxxx , and ran on the Fluid Surveys platform (fluidsurveys.com). Note that the survey was open to researchers from any country in the world because it is was run as part of a global survey through the Global Young Academy. To disseminate the survey to researchers, we gathered email addresses from  university websites for as many faculty members as possible and emailed individual researchers directly. We also shared the survey broadly on social media, as well as through the Global Young Academy network, on scientific list serves, and through personal connections. 

Survey Data Analysis  

**Note that numbers not all the same because respondents did not always answer every question**
```{r, echo=FALSE, message=FALSE, loading_data, warning=FALSE}
rm(list=ls())

dev.off()

#<!-- Import Canadian data, calculate sample sizes -->
 ## CHANGE WORKING DIRECTORY FOR YOUR LOCAL MACHINE BEFORE KNITTING ##
setwd("/Users/kristinatietjen/Documents/github/gya-research")

#load data
dev <- read.csv("data/globalreport_fromAX/gya_survey_clean_final_developed.csv")

dim(dev)  #2913   86
head(dev)

##in the xcel from AX there was code to select for only developed and random Canadian responses
#this code blanks out the rows with developing country data so I need to get rid of those blank rows for ease of working with the data. 
#according to the table in the report already there should be 1661 surveys in this develop country part
unique(dev$Use.)
dev <- dev[!is.na(dev$Use.),]
dev <- droplevels(dev)
dim(dev) #1661  86 - perfect

#Count how many responses from researchers

#Gender:
dev.men <- dev[dev$gender=="Male",]               #Count how many responses from  male researchers
percent.men<-((dim(dev.men)[1])/(dim(dev)[1]))*100      #Calculate the % of responses from  male researchers
dev.women <- dev[dev$gender=="Female",]           #Count how many responses from  female researchers
percent.women<-((dim(dev.women)[1])/(dim(dev)[1]))*100  #Calculate the % of responses from  female researchers

#Career Stage Tabulations:
#table(dev$what_participant_group)
n.seniorac <- dev[dev$what_participant_group=="Senior academic researcher with >10 years of experience applying for research grants",]
percent.seniorac<-((dim(n.seniorac)[1])/(dim(dev)[1]))*100 #Calculate the % of responses from  senior academic researchers
n.earlyac <- dev[dev$what_participant_group=="Early career academic researcher with <10 years experience applying for research grants since completion of PhD",]
percent.earlyac<-((dim(n.earlyac)[1])/(dim(dev)[1]))*100 #Calculate the % of responses from  early academic researchers
n.pdf <- dev[dev$what_participant_group=="Postdoctoral fellow or research assistant with experience applying for research grants, or anticipating the need to apply for grants in the near future",]
percent.pdf<-((dim(n.pdf)[1])/(dim(dev)[1]))*100 #Calculate the % of responses from  post-docs
n.nonACearly <- dev[dev$what_participant_group=="Non-academic researcher conducting or managing research in industry or government with <10 years of experience",]
percent.nonACearly<-((dim(n.nonACearly)[1])/(dim(dev)[1]))*100 #Calculate the % of responses from early career non-academics
n.nonACsenior <- dev[dev$what_participant_group=="Non-academic researcher conducting or managing research in industry or government with >10 years of experience",]
percent.nonACsenior<-((dim(n.nonACsenior)[1])/(dim(dev)[1]))*100 #Calculate the % of responses from early career non-academics
n.unk <- dev[dev$what_participant_group=="",]
percent.unk<-((dim(n.unk)[1])/(dim(dev)[1]))*100 #Calculate the % of responses from unknown career stage

#Discipline Tabulations:
n.natural <- dev[dev$field_research=="Natural Science",]
percent.natural <- ((dim(n.natural)[1])/(dim(dev)[1]))*100 #Calculate the % of responses from  natural scientists
n.physics <- dev[dev$field_research=="Physical Science (eg. math, physics, chemistry, computer science)",]
percent.physics <- ((dim(n.physics)[1])/(dim(dev)[1]))*100 #Calculate the % of responses from  physical scientists
n.med <- dev[dev$field_research=="Medicine and Life Science",]
percent.med <- ((dim(n.med)[1])/(dim(dev)[1]))*100 #Calculate the % of responses from  med/life scientists
n.eng <- dev[dev$field_research=="Engineering",]
percent.eng <- ((dim(n.eng)[1])/(dim(dev)[1]))*100 #Calculate the % of responses from  engineering scientists
n.int <- dev[dev$field_research=="Interdisciplinary Science",]
percent.int <- ((dim(n.int)[1])/(dim(dev)[1]))*100 #Calculate the % of responses from  interdisciplinary scientists
n.ssh <- dev[dev$field_research=="Social Science / Humanities",]
percent.ssh <- ((dim(n.ssh)[1])/(dim(dev)[1]))*100 #Calculate the % of responses from  interdisciplinary scientists

## load required packages
require(gridExtra); require(tidyr); require(ggplot2); require(stringr);require(RColorBrewer); require(colorRamps); require(plotrix); require(plyr); require(grid);require(gtable); require(dplyr); require(tidyr); library(gridExtra);require(reshape2);library(rbin); require(svglite); require(systemfonts)


```

```{r set color scales, include=FALSE}

theme_set(theme_minimal())

## assign blue colour 
myColors1<-c("#42A3FF", "#42A3FF", "#42A3FF", "#42A3FF", "#42A3FF", "#42A3FF", "#42A3FF")
colScale <- scale_fill_manual(name = "Var1",values = myColors1)


## for 3 types of research

mycols<-c('#97CCFF','#42A3FF','#C8DF95','#9BC53D','#F0A490','#E55934')

colScale2 <- scale_fill_manual(name = "ID",values = mycols)

#past and current
myColors14<-c('#97CCFF','#42A3FF')
colScale7 <- scale_fill_manual(name = "data.year", values = myColors14)


```


**Results**  
In total, `r dim(dev)[1]`  researchers from developed countries completed the online survey. Of these, almost xxxxx were male (`r ceiling(percent.men)`%) and xxxxx were female (`r round(percent.women)`%); xxxx proportion either did not input their gender or selected other. xxxx of the survey respondents (`r round(sum(percent.seniorac,percent.earlyac))`%) were either senior academics (`r round(percent.seniorac)`%), defined as those researchers with more than ten years experience applying for research grants since completion of their PhD, or early career academics (`r round(percent.earlyac)`%) (Figure 4.1). xxxxx also came from post-doctoral researchers (`r round(percent.pdf)`%), non-academic researchers (`r  round(sum(percent.nonACearly,percent.nonACsenior))`%), or those who did not indicate their career stage (`r round(percent.unk, digits=1)`%).

Researchers from many different disciplines were represented in the survey. Almost xxxx percent of responses came from either the natural or physical sciences (Figure 4.2). The remaining responses were spread amongst the medical and life sciences (`r round(percent.med)`%), engineering (`r round(percent.eng)`%), interdisciplinary research (`r round(percent.int)`%), and social sciences and humanities (`r round(percent.ssh)`%). 


<!-- Generate  research discipline figure -->
```{r figure 4.1, echo=FALSE, fig.width=14, message=FALSE, warning=FALSE}
field<-data.frame(table(dev$field_research))
field<-field[!field$Var1=="0",]
field$Var1<-reorder(field$Var1, field$Freq)
field$Var1<-revalue(field$Var1, c("Physical Science (eg. math, physics, chemistry, computer science)" = "Physical Science"))


#pdf(file="figures/HI/4.1_FieldofResearch_HI.pdf", width = 13, height=8)
#tiff(file="figures/HI/4.1_FieldofResearch_HI.tiff", width = 13, height= 8, units = "in", res = 600)
#svg(file="figures/HI/4.1_FieldofResearch_HI_Dec2021.svg", width = 11, height= 7)


FoR.HI <- ggplot(field, aes(x = reorder(Var1, -Freq), Freq, fill=Var1)) + 
    geom_bar(stat='identity',position = position_dodge(width=0.5)) + 
  labs(y="Number of respondents",x="", title="Responses by field of research (HI)")  +
  scale_x_discrete(labels=c("Physical\nScience", "Natural\nScience", "Medicine\n& Life\nScience", "Engineering", "Social\n Science/\nHumanities","Inter-\ndisciplinary\nScience",  "Other")) +
  #geom_text(aes(label=Freq), vjust=-0.25, size=3) + 
  theme(axis.text.y=element_text(size=22, color = "black"),
         axis.text.x=element_text( size=22, color = "black"),
         axis.title=element_text(size=28),
         panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
         panel.grid.minor = element_blank(), plot.title = element_text(hjust = 0.5, size = 28)) + 
  guides(fill=FALSE) + colScale+
  scale_y_continuous(expand = c(0,0), limits = c(0,520))

FoR.HI

#dev.off()

ggsave("4.1_FieldofResearch_HI_Dec2021.svg", plot = FoR.HI, device = "svg", path = "figures/HI", height = 7, width  = 13 , units = "in", dpi = 500)

```


<!-- Generate  career stage figure -->
```{r 4.2, eval=FALSE, fig.width=14, message=FALSE, warning=FALSE, include=FALSE}

experience<-data.frame(table(dev$what_participant_group))
experience<-experience[!experience$Var1=="0",]
experience<-droplevels(experience)

experience$Var1<-revalue(experience$Var1, c("Early career academic researcher with <10 years experience applying for research grants since completion of PhD" = "Early career academic", 
                                            "Non-academic researcher conducting or managing research in industry or government with >10 years of experience" = "Senior non-academic",
                                            "Non-academic researcher conducting or managing research in industry or government with <10 years of experience" = "Early career non-academic", 
                                            "Postdoctoral fellow or research assistant with experience applying for research grants, or anticipating the need to apply for grants in the near future" = "Postdoc or RA",
                                            "Senior academic researcher with >10 years of experience applying for research grants" = "Senior academic"))
experience$Var1<-reorder(experience$Var1, experience$Freq)

#pdf(file="figures/HI/4.2_CareerStage_HI.pdf", width = 10, height= 12)
#pdf(file="figures/HI/4.2_CareerStage_HI_wide.pdf", width = 12, height= 6)
#tiff(file="figures/HI/4.2_CareerStage_HI.tiff", width = 8, height= 10, units = "in", res = 600)
#svg(file="figures/HI/4.2_CareerStage_HI.svg", width = 11, height= 7)

f4.2.HI <- ggplot(experience, aes(x = reorder(Var1, -Freq), Freq, fill=Var1)) + 
  geom_bar(stat='identity',position = position_dodge(width=0.5)) + 
  #geom_text(aes(label=Freq, vjust=-0.5), size=3)+
  scale_x_discrete(labels=c("Senior\nacademic", "Early\ncareer\nacademic", "Postdoc\nor RA", "Senior\nnon-\nacademic", "Early\ncareer\nnon-\nacademic")) + #narrow
  #scale_x_discrete(labels=c("Senior\nacademic", "Early career\nacademic", "Postdoc\nor RA", "Senior\nnon-academic", "Early career\nnon-academic")) + #wide
  labs(y="Number of respondents", x="", title="Responses by career stage (HI)") +
  guides(fill=guide_legend(title=NULL, reverse=TRUE, nrow=3)) +  
  theme(axis.text.y=element_text(size=22, color = "black"),
         axis.text.x=element_text(size=22, color = "black"),
         axis.title=element_text(size=28),
         panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
         panel.grid.minor = element_blank(), plot.title = element_text(hjust = 0.5, size = 28)) + 
  colScale + guides(fill=FALSE)+
  scale_y_continuous(expand = c(0,0), limits = c(0,1080))
f4.2.HI
#dev.off()

ggsave("4.2_CareerStage_HI_Dec2021.svg", plot = f4.2.HI, device = "svg", path = "figures/HI", height = 7, width  = 13 , units = "in", dpi = 500)

```



<!-- Generate figure showing current and past fundamental, use-inspiried, and applied research %s -->
  
```{r 4.3, echo=FALSE, message=FALSE, warning=FALSE}

## subset the data
res.plot<-subset(dev, select = c( "percent_fundamental_research_current",  "percent_applied_research_current" , "percent_use_inspired_research_current","percent_applied_research_past",  "percent_fundamental_research_past" , "percent_use_inspired_research_past"))

#str(res.plot)

#convert to long
res.plot.l<-gather(res.plot, type, percent)

#str(res.plot.l)

# add time variable
res.plot.l$time<-ifelse(grepl( "current", res.plot.l$type),"Current", "Past")
res.plot.l$type[res.plot.l$type=="percent_applied_research_past"]<-"Applied"
res.plot.l$type[res.plot.l$type=="percent_applied_research_current"]<-"Applied"
res.plot.l$type[res.plot.l$type=="percent_fundamental_research_past"]<-"Fundamental"
res.plot.l$type[res.plot.l$type=="percent_fundamental_research_current"]<-"Fundamental"
res.plot.l$type[res.plot.l$type=="percent_use_inspired_research_past"]<-"Use-inspired"
res.plot.l$type[res.plot.l$type=="percent_use_inspired_research_current"]<-"Use-inspired"

# change order of the levels
res.plot.l$time<-as.factor(res.plot.l$time)
res.plot.l$time<-factor(res.plot.l$time, levels(res.plot.l$time)[c(2,1)])

res.plot.l$type<-as.factor(res.plot.l$type)
res.plot.l$type<-factor(res.plot.l$type, levels(res.plot.l$type)[c(2,3,1)])

res.plot.l$ID<-paste(res.plot.l$type, res.plot.l$time)

# #count the number of people who responded in each category
# total <- aggregate(percent ~ ID, data = res.plot.l, FUN = length)
# 
# tot.by.proportion <- table(res.plot.l$percent, res.plot.l$ID)

# change order of the levels
res.plot.l$ID<-as.factor(res.plot.l$ID)
res.plot.l$ID<-factor(res.plot.l$ID, levels(res.plot.l$ID)[c(4,3,6,5,2,1)])



#####add (a)
xs <- split(res.plot.l,f = res.plot.l$type)
p1 <- ggplot(xs$Fundamental,aes(percent, fill=time)) +
    geom_histogram(position='dodge', binwidth=10, bins=seq(0, 100, 10))  +
    guides(fill=guide_legend(title=NULL, reverse=FALSE, nrow=2)) +
    labs(x="", y="Number of respondents", title="")+
    theme(panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
          panel.grid.minor = element_blank(),
          strip.text.x = element_text(size=22, color="black"),
          strip.background = element_rect(colour="white", fill="white"),
          legend.position=c(0.5, 0.75 ), legend.spacing=unit(100,"cm"), legend.background = element_rect(color = "white"),
        legend.text = element_text(size = 22),
        axis.title = element_text(size = 28),
          axis.text.y=element_text(size=22, color = "black"),
         axis.text.x=element_text(size=22, color = "black"),
         )+ 
    facet_wrap(~type, nrow=3) #+
 # scale_x_continuous(breaks=seq(0,100,10))+scale_y_continuous(expand=c(0,0), limits=c(0,570),breaks=seq(0,550,100))

p2 <- p1 %+% xs$`Use-inspired`
p3 <- p1 %+% xs$Applied
p1<-p1+scale_fill_manual(name = "ID",values = c('#97CCFF','#42A3FF'), labels=c("2006-2010", "2011-2015"))+labs(x="", y = "", title="Type of research by proportion (HI)")+ theme(plot.margin=unit(c(1,1,-0.45,1), "cm"), plot.title = element_text(hjust = 0.5, size = 28))+ scale_y_continuous(expand=c(0,0), limits=c(0,330),breaks=seq(0,300,100))
p2<-p2+scale_fill_manual(name = "ID",values =c('#C8DF95','#9BC53D'), labels=c("2006-2010", "2011-2015"))+labs(x="")+ theme(plot.margin=unit(c(-0.25,1,-0.3,1), "cm")) + scale_y_continuous(expand=c(0,0), limits=c(0,550),breaks=seq(0,500,100))
p3<-p3+scale_fill_manual(name = "ID",values =c('#F0A490','#E55934'), labels=c("2006-2010", "2011-2015"))+ labs(y="") theme(plot.margin=unit(c(-0.5,1,1,1), "cm"))+ scale_y_continuous(expand=c(0,0), limits=c(0,680),breaks=seq(0,600,200))


#pdf(file="figures/HI/4.3_ResearchProportion_HI.pdf", width = 11, height= 7)
#svg(file="figures/HI/4.3_ResearchProportion_HI.svg", width = 11, height= 7)

#grid.arrange(p1,p2,p3, left= textGrob("(a)", gp = gpar(fontsize=14), y=0.93, hjust = -.75), heights=c(0.35,0.3,0.35))
f4.3.hi <- grid.arrange(p1,p2,p3, heights=c(0.35,0.3,0.35))
f4.3.hi
#dev.off()



```


```{r 4.3 percent data prep, message=FALSE, warning=FALSE, include=FALSE}

## subset the data
res.plot<-subset(dev, select = c( "percent_fundamental_research_current",  "percent_applied_research_current" , "percent_use_inspired_research_current","percent_applied_research_past",  "percent_fundamental_research_past" , "percent_use_inspired_research_past"))

dim(res.plot)

#count how many total responses there were of current and past
current <- as.data.frame(length(na.omit(res.plot$percent_fundamental_research_current)))
colnames(current)<-c("totalcur")
past <- as.data.frame(length(na.omit(res.plot$percent_fundamental_research_past)))
colnames(past)<-c("totalpast")


## now to count how many responses of each percentage but need to bin them for graphing
head(res.plot)
breaks <- c(0, 0.01, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100)

fundcur <- cut(res.plot$percent_fundamental_research_current, breaks = breaks, include.lowest = TRUE)
fundcur <- as.data.frame(summary(fundcur))
fundcur
colnames(fundcur) <- c("freq")
sum(is.na(res.plot$percent_fundamental_research_current)) #double check the number of NAs
as.data.frame(table(res.plot$percent_fundamental_research_current)) #double check numbers

fundpast <- cut(res.plot$percent_fundamental_research_past, breaks = breaks, include.lowest = TRUE)
fundpast <- as.data.frame(summary(fundpast))
colnames(fundpast) <- c("freq")
fundpast
sum(is.na(res.plot$percent_fundamental_research_past)) #double check the number of NAs
as.data.frame(table(res.plot$percent_fundamental_research_past)) #double check numbers

usecur <- cut(res.plot$percent_use_inspired_research_current, breaks = breaks, include.lowest = TRUE)
usecur <- as.data.frame(summary(usecur))
colnames(usecur) <- c("freq")
usecur
sum(is.na(res.plot$percent_use_inspired_research_current)) #double check the number of NAs
as.data.frame(table(res.plot$percent_use_inspired_research_current)) #double check numbers

usepast <- cut(res.plot$percent_use_inspired_research_past, breaks = breaks, include.lowest = TRUE)
usepast <- as.data.frame(summary(usepast))
colnames(usepast) <- c("freq")
usepast
sum(is.na(res.plot$percent_use_inspired_research_past)) #double check the number of NAs
as.data.frame(table(res.plot$percent_use_inspired_research_past)) #double check numbers

appcur <- cut(res.plot$percent_applied_research_current, breaks = breaks, include.lowest = TRUE)
appcur <- as.data.frame(summary(appcur))
colnames(appcur) <- c("freq")
appcur
sum(is.na(res.plot$percent_applied_research_current)) #double check the number of NAs
as.data.frame(table(res.plot$percent_applied_research_current)) #double check numbers

apppast <- cut(res.plot$percent_applied_research_past, breaks = breaks, include.lowest = TRUE)
apppast <- as.data.frame(summary(apppast))
colnames(apppast) <- c("freq")
apppast
sum(is.na(res.plot$percent_applied_research_past)) #double check the number of NAs
as.data.frame(table(res.plot$percent_applied_research_past)) #double check numbers


#now stick the total numbers onto those df
fundcur$totalcur <- current$totalcur
fundcur
fundpast$totalpast <- past$totalpast
fundpast
usecur$totalcur <- current$totalcur
usecur
usepast$totalpast <- past$totalpast
usepast
appcur$totalcur <- current$totalcur
appcur
apppast$totalpast <- past$totalpast
apppast

#now calculate percentage
fundcur$perc <- (fundcur$freq/fundcur$totalcur)*100
fundcur
fundpast$perc <- (fundpast$freq/fundpast$totalpast)*100
fundpast
usecur$perc <- (usecur$freq/usecur$totalcur)*100
usecur
usepast$perc <- (usepast$freq/usepast$totalpast)*100
usepast
appcur$perc <- (appcur$freq/appcur$totalcur)*100
appcur
apppast$perc <- (apppast$freq/apppast$totalpast)*100
apppast

#now combine df
#make a base df with the bin names
perc.res <- as.data.frame(c("0","10", "20", "30", "40", "50", "60", "70", "80", "90", "100", "NAs"))
colnames(perc.res) <- "bins"
perc.res
perc.res <- cbind(perc.res, fundcur$perc)
perc.res
perc.res <- cbind(perc.res, fundpast$perc)
perc.res
perc.res <- cbind(perc.res, usecur$perc)
perc.res
perc.res <- cbind(perc.res, usepast$perc)
perc.res
perc.res <- cbind(perc.res, appcur$perc)
perc.res
perc.res <- cbind(perc.res, apppast$perc)
perc.res

colnames(perc.res) <- c("bins", "perc.fundcur", "perc.fundpast", "perc.usecur", "perc.usepast", "perc.appcur", "perc.apppast")
perc.res
perc.res <- perc.res[!perc.res$bins == "NAs",]
perc.res <- droplevels(perc.res)
perc.res

#ok make this long
perc.res.plot.l<-gather(perc.res, per.typetime, perc.bins)
head(perc.res.plot.l)
perc.res.plot.l <- melt(perc.res, na.rm = FALSE, id.vars = c("bins"))
head(perc.res.plot.l)
colnames(perc.res.plot.l) <- c("percent.bins", "perc.typetime", "perc.responses")
perc.res.plot.l

#str(res.plot.l)

# add time variable
perc.res.plot.l$time<-ifelse(grepl( "cur", perc.res.plot.l$perc.typetime),"Current", "Past")
perc.res.plot.l

# break out type
perc.res.plot.l$type <- "Applied"
perc.res.plot.l$type<-ifelse(grepl( "use", perc.res.plot.l$perc.typetime),"Use-inspired", perc.res.plot.l$type)
perc.res.plot.l$type<-ifelse(grepl( "fund", perc.res.plot.l$perc.typetime),"Fundamental", perc.res.plot.l$type)
perc.res.plot.l
#looks good

str(perc.res.plot.l)
# change order of the levels
perc.res.plot.l$time<-as.factor(perc.res.plot.l$time)
levels(perc.res.plot.l$time)
perc.res.plot.l$time<-factor(perc.res.plot.l$time, levels(perc.res.plot.l$time)[c(2,1)])

perc.res.plot.l$type<-as.factor(perc.res.plot.l$type)
levels(perc.res.plot.l$type)
perc.res.plot.l$type<-factor(perc.res.plot.l$type, levels(perc.res.plot.l$type)[c(2,3,1)])

perc.res.plot.l$percent.bins<-as.factor(perc.res.plot.l$percent.bins)
levels(perc.res.plot.l$percent.bins)
perc.res.plot.l$percent.bins<-factor(perc.res.plot.l$percent.bins, levels(perc.res.plot.l$percent.bins)[c(1,2,4,5,6,7,8,9,10,11,3)])


perc.res.plot.l$ID<-paste(perc.res.plot.l$type, perc.res.plot.l$time)

# change order of the levels
perc.res.plot.l$ID<-as.factor(perc.res.plot.l$ID)
levels(perc.res.plot.l$ID)
perc.res.plot.l$ID<-factor(perc.res.plot.l$ID, levels(perc.res.plot.l$ID)[c(4,3,6,5,2,1)])
head(perc.res.plot.l)

```

```{r echo=FALSE, message=FALSE, warning=FALSE}

#####add (a)

xs <- split(perc.res.plot.l,f = perc.res.plot.l$type)
p1 <- ggplot(xs$Fundamental,aes(percent.bins, perc.responses, fill=time)) +
    geom_bar(position='dodge', stat='identity')  +
    guides(fill=guide_legend(title=NULL, reverse=FALSE, nrow=2)) +
    labs(x="", y="Percent of responses", title="")+
    theme(panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
          panel.grid.minor = element_blank(),
          strip.background = element_rect(colour="white", fill="white"),
          legend.position=c(0.5, 0.75 ), legend.spacing=unit(100,"cm"), legend.background = element_rect(color = "white"), legend.text = element_text(size = 22),
          axis.text.y=element_text(size=22, color = "black"),
         axis.text.x=element_text(size=22, color = "black"),
          axis.title = element_text(size = 28)
         )+ 
    facet_wrap(~type, nrow=3) #+
 # scale_x_continuous(breaks=seq(0,100,10))+scale_y_continuous(expand=c(0,0), limits=c(0,570),breaks=seq(0,550,100))

p2 <- p1 %+% xs$`Use-inspired`
p3 <- p1 %+% xs$Applied
p1<-p1+scale_fill_manual(name = "ID",values = c('#97CCFF','#42A3FF'), labels=c("2006-2010", "2011-2015"))+labs(x="", title="Type of research by percent (HI)", y="")+ theme(plot.margin=unit(c(1,1,-0.45,1), "cm"), plot.title = element_text(hjust = 0.5, size = 28),  strip.text.x = element_text(size=24, color='#3b92e5'))+ scale_y_continuous(expand=c(0,0), limits=c(0,55.5),breaks=seq(0,55,10))
p2<-p2+scale_fill_manual(name = "ID",values =c('#C8DF95','#9BC53D'), labels=c("2006-2010", "2011-2015"))+labs(x="")+ theme(plot.margin=unit(c(-0.25,1,-0.3,1), "cm"), strip.text.x = element_text(size=24, color='#7c9d30')) + scale_y_continuous(expand=c(0,0), limits=c(0,55.5),breaks=seq(0,55,10)) + labs(x="", y="Percent of responses", title="")
p3<-p3+scale_fill_manual(name = "ID",values =c('#F0A490','#E55934'), labels=c("2006-2010", "2011-2015"))+ theme(plot.margin=unit(c(-0.5,1,1,1), "cm"), strip.text.x = element_text(size=24, color='#ce502e'))+ scale_y_continuous(expand=c(0,0), limits=c(0,55.5),breaks=seq(0,55,10)) + labs(x = "Percent of research", y = "")


#pdf(file="figures/HI/4.3_ResearchProportion_percent_HI.pdf", width = 11, height= 7)
#pdf(file="figures/HI/4.3_ResearchProportion_percent.narrow_HI.pdf", width = 7, height= 11)
#svg(file="figures/HI/4.3_ResearchProportion_HI.svg", width = 11, height= 7)

#grid.arrange(p1,p2,p3, left= textGrob("(a)", gp = gpar(fontsize=14), y=0.93, hjust = -.75), heights=c(0.35,0.3,0.35))
f4.3.hi<-grid.arrange(p1,p2,p3, heights=c(0.35,0.3,0.35))
f4.3.hi
 #dev.off()

ggsave("4.3_ResearchProportion_HI_dec2021.svg", plot = f4.3.hi, device = "svg", path = "figures/HI", height = 21, width  = 13 , units = "in", dpi = 500)

```

```{r 4.3b, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10}

## subset the data
reason<-subset(dev, select=c("main_reason_change_interest_related",
                                       "main_reason_change_career_related","main_reason_change_funding_related", "main_reason_change_socially_related","main_reason_change_other"))

# switch to long format
reason.l<-gather(reason, reason.change, yes)

# using table to count cases of each category
sum.reason<-data.frame(table(reason.l$reason.change, reason.l$yes))

sum.reason$Var1<-revalue(sum.reason$Var1, c("main_reason_change_career_related" = "Career", "main_reason_change_funding_related" = "Funding", "main_reason_change_interest_related" = "Interest", "main_reason_change_other" = "Other", "main_reason_change_socially_related"  = "Social"))
# change order of the levels
sum.reason$Var1<-factor(sum.reason$Var1,levels(sum.reason$Var1)[c(2,3,1,5,4)])

#pdf(file="figures/HI/4.3b_ReasonForFieldChange_HI.pdf", width = 7, height= 8)
#tiff(file="figures/HI/4.3b_ReasonForFieldChange_HI.tiff", width = 7, height= 8, units = "in", res = 600)
#svg(file="figures/HI/4.3b_ReasonForFieldChange_HI.svg", width = 11, height= 7)

f4.3b.hi <- ggplot(sum.reason, aes(x=Var1, y=Freq, fill=Var1)) + geom_bar(stat='identity')+ 
  theme( axis.text.x=element_text( size=22, color = "black"),
         axis.text.y=element_text(size = 22, color = "black"), 
         axis.title=element_text(size = 28), 
         legend.text=element_text(size = 12),
         axis.title.x=element_blank(), 
         plot.title = element_text(hjust = 0.5, size = 28),
         panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
         panel.grid.minor = element_blank()) +
  guides(fill=FALSE) +
  colScale+
  labs(y="Number of respondents", title="Reason for change in\nresearch type (HI)")+
  scale_y_continuous(expand = c(0, 0), limits = c(0, 500))#+annotate('text', 5.4,795, label="(b)", size=5)#+geom_text(aes(label=Freq), vjust=-0.5, size=3)
 
f4.3b.hi 

#dev.off()

ggsave("4.3b_ReasonForFieldChange_HI_Dec2021.svg", plot = f4.3b.hi, device = "svg", path = "figures/HI", height = 7, width  = 13 , units = "in", dpi = 500)

```

```{r 4.3c, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10}

view<-data.frame(table(dev$view_change_of_type))

view<-view[!view$Var1=="0",]
view<-droplevels(view)

# change order of the levels
view$Var1<-factor(view$Var1,levels(view$Var1)[c(5,3,1,2,4)])

#pdf(file="figures/HI/4.3C_ViewFieldChange_HI.pdf", width = 8, height= 9)
#pdf(file="figures/HI/4.3C_ViewFieldChange_HI_wide.pdf", width = 10, height= 7)
#svg(file="figures/HI/4.3C_ViewFieldChange_HI.svg", width = 11, height= 7)

f4.3c.hi <- ggplot(view, aes(x=Var1, y=Freq, fill = Var1)) + geom_bar(stat='identity')+
  theme(axis.text.x=element_text(size=22, color = "black"),
         axis.text.y=element_text(size = 22, color = "black"), 
        axis.title.y = element_text(size = 28), 
        plot.title = element_text(hjust = 0.5, size = 28), 
        panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank()) +
  guides(fill=FALSE)+ 
  colScale+
  scale_x_discrete(labels=c("Very\npositive", "Slightly\npositive", "Neutral", "Slightly\nnegative", "Very\nnegative")) +
  labs(x="", y="Number of respondents", title="Opinion of research type change (HI)")+
  #geom_text(aes(label=gender), vjust=-0.5, size=3)+
  scale_y_continuous(expand = c(0, 0), limits = c(0,250))#+
   #+annotate('text', 5.4,133, label="(c)", size=5)
f4.3c.hi
#dev.off()

ggsave("4.3C_ViewFieldChange_HI_Dec2021.svg", plot = f4.3c.hi, device = "svg", path = "figures/HI", height = 7, width  = 13 , units = "in", dpi = 500)
```

<!--**4.4 Perspectives on the State of Fundamental Research**-->

```{r 4.4a, echo=FALSE, message=FALSE, warning=FALSE}

import<-data.frame(table(dev$opinion_fundamental_important))

import<-import[!import$Var1=="0",]
import<-droplevels(import)

import$Var1<-factor(import$Var1, levels(import$Var1)[c(6,5,4,3,2,1)])

#pdf(file="figures/HI/4.4A_PerceivedImportanceFundamentalGovernment_HI.pdf", height=11, width =10)
#pdf(file="figures/HI/4.4A_PerceivedImportanceFundamentalGovernment_HI_wide.pdf", height=6, width =10)
#svg(file="figures/HI/4.4A_PerceivedImportanceFundamentalGovernment_HI.svg", width = 11, height= 7)

f4.4a.hi <- ggplot(data=import, aes(x=Var1, y=Freq, fill=Var1)) + 
      geom_bar(stat='identity', position='dodge')+ 
      labs(x="", y="Number of respondents", fill="", title="Perceived importance of fundamental research\nto their government (HI)")+
      scale_x_discrete(labels=c("Very\nimportant", "Somewhat\nimportant", 'Not very\nimportant', 'Not at all\nimportant', "Can't\ncomment"))+
      #geom_text(aes(label=Freq, vjust=-0.5), size=3) + guides(fill=FALSE)+
      theme(axis.text.x=element_text(size=22, color = "black"),
            axis.text.y=element_text(size = 22, color = "black"),
            panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
            panel.grid.minor = element_blank(), 
            axis.title.y=element_text(size=28),
            plot.title = element_text(hjust = 0.5, size = 28)) + guides(fill=FALSE)+ 
  scale_y_continuous(expand = c(0, 0), limits = c(0,601)) + colScale
f4.4a.hi
#dev.off()

ggsave("4.4A_PerceivedImportanceFundamentalGovernment_HI_Dec2021.svg", plot = f4.4a.hi, device = "svg", path = "figures/HI", height = 7, width  = 13 , units = "in", dpi = 500)
```
  

```{r 4.4b, echo=FALSE, message=FALSE, warning=FALSE}

## subset the data
priority<-subset(dev, select=c("high_priority_fundamental", "high_priority_use_inspired", "high_priority_applied", "high_priority_no_change"))

## switch to long format
priority.long<-gather(priority, what.type, higher.priority)

# using table to count cases of each category
sum.priority<-data.frame(table(priority.long$what.type, priority.long$higher.priority))

# change order of the levels
sum.priority$Var1<-factor(sum.priority$Var1, levels(sum.priority$Var1)[c(2,4,1,3)])

#pdf(file="figures/HI/4.4B_PerceivedChangeResearchPriorityGovernment.pdf", height=11, width =10)
#pdf(file="figures/HI/4.4B_PerceivedChangeResearchPriorityGovernment_wide.pdf", height=6, width =10)
#svg(file="figures/HI/4.4B_PerceivedChangeResearchPriorityGovernment.svg", width = 11, height= 7)

f4.4b.hi <- ggplot(data=sum.priority, aes(x=Var1, Freq, fill=Var1))+
        geom_bar(stat="identity", position='dodge')+ guides(fill=FALSE)+
        theme(axis.text.x=element_text(size=22, color = "black"),
         axis.text.y=element_text(size = 22, color = "black"), 
              panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
              panel.grid.minor = element_blank(), 
              axis.title.y=element_text(size=28),  
        plot.title = element_text(hjust = 0.5, size = 28)) +
        labs(x="", y="Number of respondents", fill="", title="Perceived change in research priority by\ntheir government (HI)") +
  scale_x_discrete(labels=c( "Fundamental", "Use-inspired","Applied", "No change"))   +
  #geom_text(aes(label=higher.priority, vjust=-0.5), size=3) +
  scale_y_continuous(expand = c(0, 0), limits = c(0,1500))+ colScale
f4.4b.hi
#dev.off()

#ggsave("4.4B_PerceivedChangeResearchPriorityGovernment_HI_Dec2021.svg", plot = f4.4b.hi, device = "svg", path = "figures/HI", height = 7, width  = 13 , units = "in", dpi = 500)
```

<!--**4.5 Research Grants**  -->

```{r 4.5, echo=FALSE, message=FALSE, warning=FALSE,warning=FALSE}

## subset the data
success<-subset(dev, select=c("success_change_10yrs_fundamental", "success_change_10yrs_use", "success_change_10yrs_applied"))

##switch to long format
success.l<-gather(success, type, level)

success.change<-with(success.l, data.frame(table(type, level)))
#remove no response
success.change<-success.change[!success.change$level=="0",]
success.change<-droplevels(success.change)

# add colour palette
myColors11<-c('#42A3FF','#9BC53D','#E55934')
colScale4 <- scale_fill_manual(name = "type",values = myColors11, labels=c("Fundamental", "Use-inspired", "Applied"))

#change order of levels
success.change$level<-factor(success.change$level, levels(success.change$level)[c(5,4,6,2,3,1)])
success.change$type<-factor(success.change$type, levels(success.change$type)[c(2,3,1)])
success.change$type<-revalue(success.change$type, c("success_change_10yrs_fundamental"="Fundamental",
              'success_change_10yrs_use'='Use-inspired', 'success_change_10yrs_applied' = 'Applied'))

#pdf(file="figures/HI/4.5_ChangeSuccessRate_HI.pdf", height=11, width =7)
#svg(file="figures/HI/4.5_ChangeSuccessRate_HI.svg", width = 11, height= 7)

ggplot(data=success.change, aes(x=level, Freq, fill=type))+ facet_wrap(~type, nrow=3)+
  geom_bar(stat="identity", position="dodge")+
  guides(fill=guide_legend(title=NULL)) +
  theme(axis.text.x = element_text(angle=0, vjust=0.5, size = 12, color = "black"), 
        axis.text.y=element_text(size = 12, color = "black"), axis.title.y=element_text(size = 12),
         panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
         strip.text.x = element_text(size=12, color="black"),
          strip.background = element_rect(colour="white", fill="white"),
         plot.title = element_text(hjust = 0.5, size = 14))+
  guides(fill=FALSE)+
  #geom_text(aes(label=Freq, vjust=-0.4),size=3) +
  scale_x_discrete(labels=c("Increased\n considerably", "Increased\n slightly", 
                                    "Stayed the\n same", "Decreased\n slightly", "Decreased\n considerably", "Can't\n comment"),limits = (levels(success.change$level)))+
  labs(x="", y="Number of responses", fill="", title="Change in grant success rate (HI)")+ colScale4+
  scale_y_continuous(expand = c(0, 0), limits = c(0,700))

#dev.off()


```


```{r 4.5 vr 2, echo=FALSE, message=FALSE, warning=FALSE,warning=FALSE}

## subset the data
success<-subset(dev, select=c("success_change_10yrs_fundamental", "success_change_10yrs_use", "success_change_10yrs_applied"))

##switch to long format
success.l<-gather(success, type, level)

success.change<-with(success.l, data.frame(table(type, level)))
#remove no response
success.change<-success.change[!success.change$level=="0",]
success.change<-droplevels(success.change)

# add colour palette
myColors11<-c('#42A3FF','#9BC53D','#E55934')
colScale4 <- scale_fill_manual(name = "type",values = myColors11, labels=c("Fundamental", "Use-inspired", "Applied"))

#change order of levels
success.change$level<-factor(success.change$level, levels(success.change$level)[c(5,4,6,2,3,1)])
success.change$type<-factor(success.change$type, levels(success.change$type)[c(2,3,1)])
success.change$type<-revalue(success.change$type, c("success_change_10yrs_fundamental"="Fundamental",
              'success_change_10yrs_use'='Use-inspired', 'success_change_10yrs_applied' = 'Applied'))


xs <- split(success.change,f = success.change$type)
p1 <- ggplot(xs$Fundamental, aes(x=level, Freq, fill=type))+ facet_wrap(~type, nrow=3) +
  geom_bar(stat="identity", position="dodge")+
  guides(fill=guide_legend(title=NULL)) +
  theme(axis.text.x = element_text(angle=0, vjust=0.5, size = 22, color = "black"), 
        axis.text.y=element_text(size = 22, color = "black"), axis.title.y=element_text(size = 28),
         panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
          strip.background = element_rect(colour="white", fill="white"),
         plot.title = element_text(hjust = 0.5, size = 28))+
  guides(fill=FALSE)+
  #geom_text(aes(label=Freq, vjust=-0.4),size=3) +
  scale_x_discrete(labels=c("Increased\n considerably", "Increased\n slightly", 
                                   "Stayed the\n same", "Decreased\n slightly", "Decreased\n considerably", "Can't\n comment"),limits = (levels(success.change$level)))
  

p2 <- p1 %+% xs$`Use-inspired`
p3 <- p1 %+% xs$Applied

p1<-p1+scale_fill_manual(name = "ID",values = "#42A3FF")+labs(x="", title="Change in grant success rate (HI)", y="Number of responses")+ theme(plot.margin=unit(c(1,1,-0.45,1), "cm"), plot.title = element_text(hjust = 0.5, size = 28), strip.text.x = element_text(size=24, color='#3b92e5'))+ scale_y_continuous(expand=c(0,0), limits=c(0,703), breaks = seq(0, 700, 100))

p2<-p2+scale_fill_manual(name = "ID",values ="#9BC53D")+ theme(plot.margin=unit(c(-0.5,1,1,1), "cm"), strip.text.x = element_text(size=24, color='#7c9d30')) + scale_y_continuous(expand=c(0,0), limits=c(0,703), breaks = seq(0, 700, 100)) + labs(x="  ", y="Number of responses", title="")

p3<-p3+scale_fill_manual(name = "ID",values ="#E55934")+ theme(plot.margin=unit(c(-0.5,1,0.5,1), "cm"), strip.text.x = element_text(size=24, color='#ce502e'))+ scale_y_continuous(expand=c(0,0), limits=c(0,703), breaks = seq(0, 700, 100)) + labs(x = "", y = "Number of responses")

#pdf(file="figures/HI/4.5_ChangeSuccessRate_HI_2.pdf", height=19, width =12)
#svg(file="figures/HI/4.5_ChangeSuccessRate_HI.svg", width = 11, height= 7)

f4.5.HI <- grid.arrange(p1,p2,p3, heights=c(0.33,0.33,0.33))

f4.5.HI
#dev.off()


#ggsave("4.5_ChangeSuccessRate_HI_2_Dec2021.svg", plot = f4.5.HI, device = "svg", path = "figures/HI", height = 21, width  = 13 , units = "in", dpi = 500)

```



```{r 4.5 vr 3, echo=FALSE, message=FALSE, warning=FALSE,warning=FALSE}

## subset the data
success<-subset(dev, select=c("success_change_10yrs_fundamental", "success_change_10yrs_use", "success_change_10yrs_applied"))

##switch to long format
success.l<-gather(success, type, level)

success.change<-with(success.l, data.frame(table(type, level)))
#remove no response
success.change<-success.change[!success.change$level=="0",]
success.change<-droplevels(success.change)

# add colour palette
myColors11<-c('#42A3FF','#9BC53D','#E55934')
colScale4 <- scale_fill_manual(name = "type",values = myColors11, labels=c("Fundamental", "Use-inspired", "Applied"))

#change order of levels
success.change$level<-factor(success.change$level, levels(success.change$level)[c(5,4,6,2,3,1)])
success.change$type<-factor(success.change$type, levels(success.change$type)[c(2,3,1)])
success.change$type<-revalue(success.change$type, c("success_change_10yrs_fundamental"="Fundamental",
              'success_change_10yrs_use'='Use-inspired', 'success_change_10yrs_applied' = 'Applied'))


xs <- split(success.change,f = success.change$type)
p1 <- ggplot(xs$Fundamental, aes(x=level, Freq, fill=type))+ facet_wrap(~type, nrow=2, ncol = 2) +
  geom_bar(stat="identity", position="dodge")+
  guides(fill=guide_legend(title=NULL)) +
  theme(axis.text.x = element_text(angle=0, vjust=0.5, size = 22, color = "black"), 
        axis.text.y=element_text(size = 22, color = "black"), axis.title.y=element_text(size = 28),
         panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
          strip.background = element_rect(colour="white", fill="white"),
         plot.title = element_text(hjust = 0.5, size = 28))+
  guides(fill=FALSE)+
  #geom_text(aes(label=Freq, vjust=-0.4),size=3) +
  scale_x_discrete(labels=c("Increased\n considerably", "Increased\n slightly", 
                                    "Stayed the\n same", "Decreased\n slightly", "Decreased\n considerably", "Can't\n comment"),limits = (levels(success.change$level)))
  

p2 <- p1 %+% xs$`Use-inspired`
p3 <- p1 %+% xs$Applied

p1<-p1+scale_fill_manual(name = "ID",values = "#42A3FF")+labs(x="", title="", y="Number of responses")+ theme(plot.margin=unit(c(-0.5,1,1,1), "cm"), plot.title = element_text(hjust = 0.5, size = 28), strip.text.x = element_text(size=24, color='#3b92e5'))+ scale_y_continuous(expand=c(0,0), limits=c(0,703),breaks=seq(0,700,100))

p2<-p2+scale_fill_manual(name = "ID",values ="#9BC53D")+ theme(plot.margin=unit(c(-0.5,1,1,1), "cm"), strip.text.x = element_text(size=24, color='#7c9d30')) + scale_y_continuous(expand=c(0,0), limits=c(0,703),breaks=seq(0,700,100)) + labs(x="  ", y="Number of responses", title="")

p3<-p3+scale_fill_manual(name = "ID",values ="#E55934")+ theme(plot.margin=unit(c(-0.5,1,1,1), "cm"), strip.text.x = element_text(size=24, color='#ce502e'))+ scale_y_continuous(expand=c(0,0), limits=c(0,703),breaks=seq(0,700,100)) + labs(x = "", y = "Number of responses")

#pdf(file="figures/HI/4.5_ChangeSuccessRate_HI_3.pdf", height=17, width =25)
#svg(file="figures/HI/4.5_ChangeSuccessRate_HI.svg", width = 11, height= 7)

#grid.arrange(p1,p2,p3, heights=c(0.33,0.33,0.33))


f4.5.3.hi <- grid.arrange(arrangeGrob(p1, p2, p3, 
                         layout_matrix=rbind(c(1,1,2,2),
                                             c(NA,3,3,NA))), top=textGrob("Change in grant success rate (HI)",gp=gpar(fontsize=28)))
f4.5.3.hi
#dev.off()

#ggsave("4.5_ChangeSuccessRate_HI_3_Dec2021.svg", plot = f4.5.3.hi, device = "svg", path = "figures/HI", height = 14, width  = 26 , units = "in", dpi = 500)

```



```{r 4.6, echo=FALSE,  message=FALSE, warning=FALSE}

## subset the data
distribution<-subset(dev, select=c("distribution_funding_11_15_for_profit"  ,   
 "distribution_funding_11_15_government"  ,    "distribution_funding_11_15_internal"    ,   
 "distribution_funding_11_15_nongov"  ,        "distribution_funding_11_15_other"   ,       
          "distribution_funding_6_10_for_profit"   ,   
 "distribution_funding_6_10_government"   ,    "distribution_funding_6_10_internal"  ,      
 "distribution_funding_6_10_nongov" ,          "distribution_funding_6_10_other"))

#convert to long format 
distribution.l <- gather(distribution, type.year, percent)

distribution.l$year <- ifelse(grepl("11_15", distribution.l$type.year), "11_15", "6_10")
#head(distribution.l)

distribution.l$type <- 1
distribution.l$type <- ifelse(grepl("for_profit", distribution.l$type.year), "For-Profit", distribution.l$type)
distribution.l$type <- ifelse(grepl("government", distribution.l$type.year), "Government", distribution.l$type)
distribution.l$type <- ifelse(grepl("internal", distribution.l$type.year), "Internal", distribution.l$type)
distribution.l$type <- ifelse(grepl("nongov", distribution.l$type.year), "Non-governmental", distribution.l$type)
distribution.l$type <- ifelse(grepl("other", distribution.l$type.year), "Other", distribution.l$type)

##revalue the year values
distribution.l$year<- revalue(distribution.l$year, c("11_15"="2011-2015", "6_10"="2006-2010"))
#change order of levels
#distribution.l$year<-factor(distribution.l$year, levels(distribution.l$year)[c(2,1)])

myColors14<-c('#97CCFF','#42A3FF')
colScale7 <- scale_fill_manual(name = "data.year", values = myColors14)

##For-Profit
fp<-distribution.l[distribution.l$type=="For-Profit",]

p1<-ggplot(fp, aes(percent, fill=year))+ geom_histogram(position='dodge', binwidth=10)  + colScale7 +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.922, 0.98), 
          legend.key.size = unit(0.3, "cm"), plot.title = element_text(size=12, hjust = 0.5, face="bold"),
           panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
         panel.grid.minor = element_blank(), 
        axis.text.x=element_text(size = 12, color= "black"), axis.text.y=element_text(size = 12, color = "black"), 
        legend.key=element_blank(),
          axis.title.x=element_text(size=12), axis.title.y=element_text(size = 12),
        legend.text = element_text(size = 14), legend.background = element_rect(color = "white")) +
  labs(title= "Industry", x="", y = "Number of respondents")+
  scale_y_continuous(expand =c(0,0), limits=c(0,1601), breaks=seq(0, 1600, 200))+
  scale_x_continuous( breaks = seq(0, 100, 10))



##Government
gov<-distribution.l[distribution.l$type=="Government",]


p2<-ggplot(gov, aes(percent, fill=year))+ geom_histogram(position='dodge', binwidth=10)  + colScale7 +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.78, 0.91),
          legend.key.size = unit(0.3, "cm"), plot.title = element_text(size=12, hjust = 0.5, face="bold"),
           panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
         panel.grid.minor = element_blank(), 
        axis.text.x=element_text(size = 12, color= "black"), axis.text.y=element_text(size = 12, color = "black"), 
        legend.key=element_blank(),
          axis.title.x=element_text(size=12), axis.title.y=element_text(size = 12),
         legend.text = element_text(size = 14), legend.background = element_rect(color = "white")) +
  labs(title="Government", x="", y = "")+
  scale_y_continuous(expand =c(0,0), limits=c(0,1601), breaks=seq(0, 1600, 200))+
  scale_x_continuous( breaks = seq(0, 100, 10))




##Internal

int<-distribution.l[distribution.l$type=="Internal",]


p3<-ggplot(int, aes(percent, fill=year))+ geom_histogram(position='dodge', binwidth=10)  + colScale7 +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.922, 0.98),
          legend.key.size = unit(0.3, "cm"), plot.title = element_text(size=12, hjust = 0.5, face="bold"),
           panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
         panel.grid.minor = element_blank(), 
        axis.text.x=element_text(size = 12, color= "black"), axis.text.y=element_text(size = 12, color = "black"), 
        legend.key=element_blank(),
          axis.title.x=element_text(size=12), axis.title.y=element_text(size = 12),
         legend.text = element_text(size = 14), legend.background = element_rect(color = "white")) +
  labs(title="Internal",x="% research funding", y = "Number of respondents")+
  scale_y_continuous(expand =c(0,0), limits=c(0,1601), breaks=seq(0, 1600, 200))+
  scale_x_continuous( breaks = seq(0, 100, 10))




##Non-Governmental

ngov<-distribution.l[distribution.l$type=="Non-governmental",]


p4<-ggplot(ngov, aes(percent, fill=year))+ geom_histogram(position='dodge', binwidth=10)  + colScale7 +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.78, 0.93),
         legend.key.size = unit(0.3, "cm"), plot.title = element_text(size=12, hjust = 0.5, face="bold"),
           panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
         panel.grid.minor = element_blank(), 
        axis.text.x=element_text(size = 12, color= "black"), axis.text.y=element_text(size = 12, color = "black"), 
        legend.key=element_blank(),
          axis.title.x=element_text(size=12), axis.title.y=element_text(size = 12),
         legend.text = element_text(size = 14), legend.background = element_rect(color = "white")) +
  labs(title="Non-governmental", x="% research funding", y = "")+
  scale_y_continuous(expand =c(0,0), limits=c(0,1601), breaks=seq(0, 1600, 200))+
  scale_x_continuous( breaks = seq(0, 100, 10))



## Other

other<-distribution.l[distribution.l$type=="Other",]


p5<-ggplot(other, aes(percent, fill=year))+ geom_histogram(position='dodge', binwidth=10)  + colScale7 +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.7, 0.91),
         legend.key.size = unit(0.3, "cm"), plot.title = element_text(size=12, hjust = 0.5, face="bold"),
           panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
         panel.grid.minor = element_blank(), 
        axis.text.x=element_text(size = 12, color= "black"), axis.text.y=element_text(size = 12, color = "black"), 
        legend.key=element_blank(),
          axis.title.x=element_text(size=12), axis.title.y=element_text(size = 12),
         legend.text = element_text(size = 14), legend.background = element_rect(color = "white")) +
  labs(title="Other", x="% research funding", y = "")+
  scale_y_continuous(expand =c(0,0), limits=c(0,1601), breaks=seq(0, 1600, 200))+
  scale_x_continuous( breaks = seq(0, 100, 10))


##put them all together

legend = gtable_filter(ggplotGrob(p1), "guide-box") 
grid.draw(legend)

#pdf(file="figures/HI/4.6_DistributionFunding_HI.pdf", height=11, width =7)
#svg(file="figures/HI/4.6_DistributionFunding_HI.svg", width = 11, height= 7)

#for wide view 
# grid.arrange(arrangeGrob(p1+ theme(legend.position="none"), p2,
#                          p3+ theme(legend.position="none"), p4+ theme(legend.position="none"),
#                          p5,
#                          layout_matrix=rbind(c(1,1,1,2,2,2),c(3,3,4,4,5,5))), top=textGrob("Distribution of research funding (HI)",gp=gpar(fontsize=17)))

#for narrow view
grid.arrange(arrangeGrob(p1+ theme(legend.position="none"), p2,
                         p3+ theme(legend.position="none"), p4,
                         p5,
                         layout_matrix=rbind(c(1,1,2,2),c(3,3,4,4), c(NA,5,5,NA))), top=textGrob("Distribution of research funding (HI)",gp=gpar(fontsize=17)))

#dev.off()

```


```{r 4.6 percent data prep, message=FALSE, warning=FALSE, include=FALSE}

## subset the data
distribution<-subset(dev, select=c("distribution_funding_11_15_for_profit"  ,   
 "distribution_funding_11_15_government"  ,    "distribution_funding_11_15_internal"    ,   
 "distribution_funding_11_15_nongov"  ,        "distribution_funding_11_15_other"   ,       
          "distribution_funding_6_10_for_profit"   ,   
 "distribution_funding_6_10_government"   ,    "distribution_funding_6_10_internal"  ,      
 "distribution_funding_6_10_nongov" ,          "distribution_funding_6_10_other"))

head(distribution)

#count how many total responses there were of current and past
current.dist <- as.data.frame(length(na.omit(distribution$distribution_funding_11_15_other)))
colnames(current.dist)<-c("totalcur")
current.dist
past.dist <- as.data.frame(length(na.omit(distribution$distribution_funding_6_10_other)))
colnames(past.dist)<-c("totalpast")
past.dist


## now to count how many responses of each percentage but need to bin them for graphing
head(distribution)
breaks <- c(0, 0.01, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100)

#for profit
profcur <- cut(distribution$distribution_funding_11_15_for_profit, breaks = breaks, include.lowest = TRUE)
profcur <- as.data.frame(summary(profcur))
profcur
colnames(profcur) <- c("freq")
sum(is.na(distribution$distribution_funding_11_15_for_profit)) #double check the number of NAs
as.data.frame(table(distribution$distribution_funding_11_15_for_profit)) #double check numbers


profpast <- cut(distribution$distribution_funding_6_10_for_profit, breaks = breaks, include.lowest = TRUE)
profpast <- as.data.frame(summary(profpast))
profpast
colnames(profpast) <- c("freq")
sum(is.na(distribution$distribution_funding_6_10_for_profit)) #double check the number of NAs
as.data.frame(table(distribution$distribution_funding_6_10_for_profit)) #double check numbers

#gov
govcur <- cut(distribution$distribution_funding_11_15_government, breaks = breaks, include.lowest = TRUE)
govcur <- as.data.frame(summary(govcur))
govcur
colnames(govcur) <- c("freq")
sum(is.na(distribution$distribution_funding_11_15_government)) #double check the number of NAs
as.data.frame(table(distribution$distribution_funding_11_15_government)) #double check numbers


govpast <- cut(distribution$distribution_funding_6_10_government, breaks = breaks, include.lowest = TRUE)
govpast <- as.data.frame(summary(govpast))
govpast
colnames(govpast) <- c("freq")
sum(is.na(distribution$distribution_funding_6_10_government)) #double check the number of NAs
as.data.frame(table(distribution$distribution_funding_6_10_government)) #double check numbers

#internal
intcur <- cut(distribution$distribution_funding_11_15_internal, breaks = breaks, include.lowest = TRUE)
intcur <- as.data.frame(summary(intcur))
intcur
colnames(intcur) <- c("freq")
sum(is.na(distribution$distribution_funding_11_15_internal)) #double check the number of NAs
as.data.frame(table(distribution$distribution_funding_11_15_internal)) #double check numbers


intpast <- cut(distribution$distribution_funding_6_10_internal, breaks = breaks, include.lowest = TRUE)
intpast <- as.data.frame(summary(intpast))
intpast
colnames(intpast) <- c("freq")
sum(is.na(distribution$distribution_funding_6_10_internal)) #double check the number of NAs
as.data.frame(table(distribution$distribution_funding_6_10_internal)) #double check numbers

#non governmental
nongovcur <- cut(distribution$distribution_funding_11_15_nongov, breaks = breaks, include.lowest = TRUE)
nongovcur <- as.data.frame(summary(nongovcur))
nongovcur
colnames(nongovcur) <- c("freq")
sum(is.na(distribution$distribution_funding_11_15_nongov)) #double check the number of NAs
as.data.frame(table(distribution$distribution_funding_11_15_nongov)) #double check numbers


nongovpast <- cut(distribution$distribution_funding_6_10_nongov, breaks = breaks, include.lowest = TRUE)
nongovpast <- as.data.frame(summary(nongovpast))
nongovpast
colnames(nongovpast) <- c("freq")
sum(is.na(distribution$distribution_funding_6_10_nongov)) #double check the number of NAs
as.data.frame(table(distribution$distribution_funding_6_10_nongov)) #double check numbers

#other
othcur <- cut(distribution$distribution_funding_11_15_other, breaks = breaks, include.lowest = TRUE)
othcur <- as.data.frame(summary(othcur))
othcur
colnames(othcur) <- c("freq")
sum(is.na(distribution$distribution_funding_11_15_other)) #double check the number of NAs
as.data.frame(table(distribution$distribution_funding_11_15_other)) #double check numbers


othpast <- cut(distribution$distribution_funding_6_10_other, breaks = breaks, include.lowest = TRUE)
othpast <- as.data.frame(summary(othpast))
profpast
colnames(othpast) <- c("freq")
sum(is.na(distribution$distribution_funding_6_10_other)) #double check the number of NAs
as.data.frame(table(distribution$distribution_funding_6_10_other)) #double check numbers


#now stick the total numbers onto those df
profcur$totalcur <- current.dist$totalcur
profcur
profpast$totalpast <- past.dist$totalpast
profpast
govcur$totalcur <- current.dist$totalcur
govcur
govpast$totalpast <- past.dist$totalpast
govpast
intcur$totalcur <- current.dist$totalcur
intcur
intpast$totalpast <- past.dist$totalpast
intpast
nongovcur$totalcur <- current.dist$totalcur
nongovcur
nongovpast$totalpast <- past.dist$totalpast
nongovpast
othcur$totalcur <- current.dist$totalcur
othcur
othpast$totalpast <- past.dist$totalpast
othpast

#now calculate percentage
profcur$perc <- (profcur$freq/profcur$totalcur)*100
profcur
profpast$perc <- (profpast$freq/profpast$totalpast)*100
profpast
govcur$perc <- (govcur$freq/govcur$totalcur)*100
govcur
govpast$perc <- (govpast$freq/govpast$totalpast)*100
govpast
intcur$perc <- (intcur$freq/intcur$totalcur)*100
intcur
intpast$perc <- (intpast$freq/intpast$totalpast)*100
intpast
nongovcur$perc <- (nongovcur$freq/nongovcur$totalcur)*100
nongovcur
nongovpast$perc <- (nongovpast$freq/nongovpast$totalpast)*100
nongovpast
othcur$perc <- (othcur$freq/othcur$totalcur)*100
othcur
othpast$perc <- (othpast$freq/othpast$totalpast)*100
othpast

#now combine df
#make a base df with the bin names
perc.fund <- as.data.frame(c("0","10", "20", "30", "40", "50", "60", "70", "80", "90", "100", "NAs"))
colnames(perc.fund) <- "bins"
perc.fund
perc.fund <- cbind(perc.fund, profcur$perc)
perc.fund
perc.fund <- cbind(perc.fund, profpast$perc)
perc.fund
perc.fund <- cbind(perc.fund, govcur$perc)
perc.fund
perc.fund <- cbind(perc.fund, govpast$perc)
perc.fund
perc.fund <- cbind(perc.fund, intcur$perc)
perc.fund
perc.fund <- cbind(perc.fund, intpast$perc)
perc.fund
perc.fund <- cbind(perc.fund, nongovcur$perc)
perc.fund
perc.fund <- cbind(perc.fund, nongovpast$perc)
perc.fund
perc.fund <- cbind(perc.fund, othcur$perc)
perc.fund
perc.fund <- cbind(perc.fund, othpast$perc)
perc.fund

colnames(perc.fund) <- c("bins", "perc.profcur", "perc.profpast", "perc.govcur", "perc.govpast", "perc.intcur", "perc.intpast", "perc.nongovcur", "perc.nongovpast", "perc.othcur", "perc.othpast")
perc.fund
perc.fund <- perc.fund[!perc.fund$bins == "NAs",]
perc.fund <- droplevels(perc.fund)
perc.fund


#ok make this long
perc.fund.l <- melt(perc.fund, na.rm = FALSE, id.vars = c("bins"))
head(perc.fund.l)
colnames(perc.fund.l) <- c("percent.bins", "perc.typetime", "perc.responses")
perc.fund.l

str(perc.fund.l)

# add time variable
perc.fund.l$time<-ifelse(grepl( "cur", perc.fund.l$perc.typetime),"Current", "Past")
perc.fund.l

# break out type
perc.fund.l$type <- "Industry"
perc.fund.l$type<-ifelse(grepl( "gov", perc.fund.l$perc.typetime),"Government", perc.fund.l$type)
perc.fund.l$type<-ifelse(grepl( "int", perc.fund.l$perc.typetime),"Internal", perc.fund.l$type)
perc.fund.l$type<-ifelse(grepl( "nongov", perc.fund.l$perc.typetime),"Non-governmental", perc.fund.l$type)
perc.fund.l$type<-ifelse(grepl( "oth", perc.fund.l$perc.typetime),"Other", perc.fund.l$type)
perc.fund.l
#looks good

str(perc.fund.l)
# change order of the levels
perc.fund.l$time<-as.factor(perc.fund.l$time)
levels(perc.fund.l$time)
perc.fund.l$time<-factor(perc.fund.l$time, levels(perc.fund.l$time)[c(2,1)])

perc.fund.l$type<-as.factor(perc.fund.l$type)
levels(perc.fund.l$type)
perc.fund.l$type<-factor(perc.fund.l$type, levels(perc.fund.l$type)[c(2,1,3,4,5)])

perc.fund.l$percent.bins<-as.factor(perc.fund.l$percent.bins)
levels(perc.fund.l$percent.bins)
perc.fund.l$percent.bins<-factor(perc.fund.l$percent.bins, levels(perc.fund.l$percent.bins)[c(1,2,4,5,6,7,8,9,10,11,3)])


#revalue the year values
perc.fund.l$time<- revalue(perc.fund.l$time, c("Current"="2011-2015", "Past"="2006-2010"))
#change order of levels
#distribution.l$year<-factor(distribution.l$year, levels(distribution.l$year)[c(2,1)])
perc.fund.l

myColors14<-c('#97CCFF','#42A3FF')
colScale7 <- scale_fill_manual(name = "data.year", values = myColors14)

```

```{r 4.6 percent, echo=FALSE, message=FALSE, warning=FALSE}

##For-Profit
fp<-perc.fund.l[perc.fund.l$type=="Industry",]

p1<-ggplot(fp, aes(percent.bins, perc.responses, fill=time))+ geom_bar(position='dodge', stat='identity')  + colScale7 +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.922, 0.98), 
          legend.key.size = unit(0.3, "cm"), plot.title = element_text(size=28, hjust = 0.5, face="bold"),
           panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
         panel.grid.minor = element_blank(), 
        axis.text.x=element_text(size = 22, color= "black"), axis.text.y=element_text(size = 22, color = "black"), 
        legend.key=element_blank(),
          axis.title.x=element_text(size=24), axis.title.y=element_text(size = 28),
        legend.text = element_text(size = 22), legend.background = element_rect(color = "white")) +
  labs(title= "Industry", x="", y = "Percent of responses")+
  scale_y_continuous(expand =c(0,0), limits=c(0,101), breaks=seq(0, 100, 20)) 



##Government
gov<-perc.fund.l[perc.fund.l$type=="Government",]


p2<-ggplot(gov, aes(percent.bins, perc.responses, fill=time))+ geom_bar(position='dodge', stat='identity')  + colScale7 +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.78, 0.91),
          legend.key.size = unit(0.3, "cm"), plot.title = element_text(size=28, hjust = 0.5, face="bold"),
           panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
         panel.grid.minor = element_blank(), 
        axis.text.x=element_text(size = 22, color= "black"), axis.text.y=element_text(size = 22, color = "black"), 
        legend.key=element_blank(),
          axis.title.x=element_text(size=24), axis.title.y=element_text(size = 24),
         legend.text = element_text(size = 22), legend.background = element_rect(color = "white")) +
  labs(title="Government", x="", y = "")+
  scale_y_continuous(expand =c(0,0), limits=c(0,101), breaks=seq(0, 100, 20)) 




##Internal

int<-perc.fund.l[perc.fund.l$type=="Internal",]


p3<-ggplot(int, aes(percent.bins, perc.responses, fill=time))+ geom_bar(position='dodge', stat='identity') + colScale7 +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.922, 0.98),
          legend.key.size = unit(0.3, "cm"), plot.title = element_text(size=28, hjust = 0.5, face="bold"),
           panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
         panel.grid.minor = element_blank(), 
        axis.text.x=element_text(size = 22, color= "black"), axis.text.y=element_text(size = 22, color = "black"), 
        legend.key=element_blank(),
          axis.title.x=element_text(size=28), axis.title.y=element_text(size = 28),
         legend.text = element_text(size = 22), legend.background = element_rect(color = "white")) +
  labs(title="Internal",x="% research funding", y = "Percent of responses")+
  scale_y_continuous(expand =c(0,0), limits=c(0,101), breaks=seq(0, 100, 20)) 




##Non-Governmental

ngov<-perc.fund.l[perc.fund.l$type=="Non-governmental",]


p4<-ggplot(ngov, aes(percent.bins, perc.responses, fill=time))+ geom_bar(position='dodge', stat='identity') + colScale7 +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.78, 0.93),
         legend.key.size = unit(0.3, "cm"), plot.title = element_text(size=28, hjust = 0.5, face="bold"),
           panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
         panel.grid.minor = element_blank(), 
        axis.text.x=element_text(size = 22, color= "black"), axis.text.y=element_text(size = 22, color = "black"), 
        legend.key=element_blank(),
          axis.title.x=element_text(size=28), axis.title.y=element_text(size = 24),
         legend.text = element_text(size = 22), legend.background = element_rect(color = "white")) +
  labs(title="Non-governmental", x="% research funding", y = "")+
  scale_y_continuous(expand =c(0,0), limits=c(0,101), breaks=seq(0, 100, 20)) 



## Other

other<-perc.fund.l[perc.fund.l$type=="Other",]


p5<-ggplot(other, aes(percent.bins, perc.responses, fill=time))+ geom_bar(position='dodge', stat='identity')  + colScale7 +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.7, 0.91),
         legend.key.size = unit(0.3, "cm"), plot.title = element_text(size=28, hjust = 0.5, face="bold"),
           panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
         panel.grid.minor = element_blank(), 
        axis.text.x=element_text(size = 22, color= "black"), axis.text.y=element_text(size = 22, color = "black"), 
        legend.key=element_blank(),
          axis.title.x=element_text(size=28), axis.title.y=element_text(size = 28),
         legend.text = element_text(size = 22), legend.background = element_rect(color = "white")) +
  labs(title="Other", x="% research funding", y = "Percent of responses")+
  scale_y_continuous(expand =c(0,0), limits=c(0,101), breaks=seq(0, 100, 20)) 


##put them all together

legend = gtable_filter(ggplotGrob(p1), "guide-box") 
grid.draw(legend)

#pdf(file="figures/HI/4.6_DistributionFunding_HI_percentnarrow.pdf", height=17, width =13)

#for wide view
# grid.arrange(arrangeGrob(p1+ theme(legend.position="none"), p2,
#                          p3+ theme(legend.position="none"), p4+ theme(legend.position="none"),
#                          p5,
#                          layout_matrix=rbind(c(1,1,1,2,2,2),c(3,3,4,4,5,5))), top=textGrob("Distribution of research funding (HI)",gp=gpar(fontsize=17)))


#for narrow view
f4.6.narrow.hi <- grid.arrange(arrangeGrob(p1+ theme(legend.position="none"), p2,
                         p3+ theme(legend.position="none"), p4,
                         p5,
                         layout_matrix=rbind(c(1,1,2,2),c(3,3,4,4), c(NA,5,5,NA))), top=textGrob("Distribution of research funding (HI)",gp=gpar(fontsize=28)))

f4.6.narrow.hi
#dev.off()

#ggsave("4.6_DistributionFunding_HI_percentnarrow_Dec2021.svg", plot = f4.6.narrow.hi, device = "svg", path = "figures/HI", height = 21, width  = 26 , units = "in", dpi = 500)

```


```{r 4.6 percent v2, echo=FALSE, message=FALSE, warning=FALSE}

##For-Profit
fp<-perc.fund.l[perc.fund.l$type=="Industry",]

p1<-ggplot(fp, aes(percent.bins, perc.responses, fill=time))+ geom_bar(position='dodge', stat='identity')  + colScale7 +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.922, 0.98), 
          legend.key.size = unit(0.3, "cm"), plot.title = element_text(size=26, hjust = 0.5, face="bold"),
           panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
         panel.grid.minor = element_blank(), 
        axis.text.x=element_text(size = 22, color= "black"), axis.text.y=element_text(size = 22, color = "black"), 
        legend.key=element_blank(),
          axis.title.x=element_text(size=24), axis.title.y=element_text(size = 28),
        legend.text = element_text(size = 22), legend.background = element_rect(color = "white")) +
  labs(title= "Industry", x="", y = "Percent of responses")+
  scale_y_continuous(expand =c(0,0), limits=c(0,101), breaks=seq(0, 100, 20)) 



##Government
gov<-perc.fund.l[perc.fund.l$type=="Government",]


p2<-ggplot(gov, aes(percent.bins, perc.responses, fill=time))+ geom_bar(position='dodge', stat='identity')  + colScale7 +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.88, 0.93),
          legend.key.size = unit(0.3, "cm"), plot.title = element_text(size=26, hjust = 0.5, face="bold"),
           panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
         panel.grid.minor = element_blank(), 
        axis.text.x=element_text(size = 22, color= "black"), axis.text.y=element_text(size = 22, color = "black"), 
        legend.key=element_blank(),
          axis.title.x=element_text(size=24), axis.title.y=element_text(size = 24),
         legend.text = element_text(size = 22), legend.background = element_rect(color = "white")) +
  labs(title="Government", x="", y = "")+
  scale_y_continuous(expand =c(0,0), limits=c(0,101), breaks=seq(0, 100, 20)) 




##Internal

int<-perc.fund.l[perc.fund.l$type=="Internal",]


p3<-ggplot(int, aes(percent.bins, perc.responses, fill=time))+ geom_bar(position='dodge', stat='identity') + colScale7 +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.8, 0.93),
          legend.key.size = unit(0.3, "cm"), plot.title = element_text(size=26, hjust = 0.5, face="bold"),
           panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
         panel.grid.minor = element_blank(), 
        axis.text.x=element_text(size = 22, color= "black"), axis.text.y=element_text(size = 22, color = "black"), 
        legend.key=element_blank(),
          axis.title.x=element_text(size=28), axis.title.y=element_text(size = 28),
         legend.text = element_text(size = 22), legend.background = element_rect(color = "white")) +
  labs(title="Internal",x="", y = "")+
  scale_y_continuous(expand =c(0,0), limits=c(0,101), breaks=seq(0, 100, 20)) 




##Non-Governmental

ngov<-perc.fund.l[perc.fund.l$type=="Non-governmental",]


p4<-ggplot(ngov, aes(percent.bins, perc.responses, fill=time))+ geom_bar(position='dodge', stat='identity') + colScale7 +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.88, 0.93),
         legend.key.size = unit(0.3, "cm"), plot.title = element_text(size=26, hjust = 0.5, face="bold"),
           panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
         panel.grid.minor = element_blank(), 
        axis.text.x=element_text(size = 22, color= "black"), axis.text.y=element_text(size = 22, color = "black"), 
        legend.key=element_blank(),
          axis.title.x=element_text(size=28), axis.title.y=element_text(size = 24),
         legend.text = element_text(size = 22), legend.background = element_rect(color = "white")) +
  labs(title="Non-governmental", x="% research funding", y = "Percent of responses")+
  scale_y_continuous(expand =c(0,0), limits=c(0,101), breaks=seq(0, 100, 20)) 



## Other

other<-perc.fund.l[perc.fund.l$type=="Other",]


p5<-ggplot(other, aes(percent.bins, perc.responses, fill=time))+ geom_bar(position='dodge', stat='identity')  + colScale7 +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.8, 0.93),
         legend.key.size = unit(0.3, "cm"), plot.title = element_text(size=26, hjust = 0.5, face="bold"),
           panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
         panel.grid.minor = element_blank(), 
        axis.text.x=element_text(size = 22, color= "black"), axis.text.y=element_text(size = 22, color = "black"), 
        legend.key=element_blank(),
          axis.title.x=element_text(size=28), axis.title.y=element_text(size = 28),
         legend.text = element_text(size = 22), legend.background = element_rect(color = "white")) +
  labs(title="Other", x="% research funding", y = "")+
  scale_y_continuous(expand =c(0,0), limits=c(0,101), breaks=seq(0, 100, 20)) 


##put them all together

legend = gtable_filter(ggplotGrob(p1), "guide-box") 
grid.draw(legend)

#pdf(file="figures/HI/4.6_DistributionFunding_HI_percentwide.pdf", height=10, width =20)

#for wide view
# grid.arrange(arrangeGrob(p1+ theme(legend.position="none"), p2,
#                          p3+ theme(legend.position="none"), p4+ theme(legend.position="none"),
#                          p5,
#                          layout_matrix=rbind(c(1,1,1,2,2,2),c(3,3,4,4,5,5))), top=textGrob("Distribution of research funding (HI)",gp=gpar(fontsize=17)))


#for narrow view
f4.6.2.hi <- grid.arrange(arrangeGrob(p1+ theme(legend.position="none"), p2 + theme(legend.position="none"),
                         p3 , p4 +theme(legend.position="none"),
                         p5,
                         layout_matrix=rbind(c(1,1,2,2,3,3),
                                             c(NA,4,4,5,5,NA))), 
             top=textGrob("Distribution of research funding (HI)",gp=gpar(fontsize=30)))

#dev.off()

ggsave("4.6_DistributionFunding_HI_percentwide_Dec2021.svg", plot = f4.6.2.hi, device = "svg", path = "figures/HI", height = 14, width  = 39 , units = "in", dpi = 500)

```


```{r 4.6 percent v3, echo=FALSE, message=FALSE, warning=FALSE}

##For-Profit
fp<-perc.fund.l[perc.fund.l$type=="Industry",]

p1<-ggplot(fp, aes(percent.bins, perc.responses, fill=time))+ geom_bar(position='dodge', stat='identity')  + colScale7 +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.922, 0.98), 
          legend.key.size = unit(0.3, "cm"), plot.title = element_text(size=28, hjust = 0.5, face="bold"),
           panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
         panel.grid.minor = element_blank(), 
        axis.text.x=element_text(size = 26, color= "black"), axis.text.y=element_text(size = 26, color = "black"), 
        legend.key=element_blank(),
          axis.title.x=element_text(size=24), axis.title.y=element_text(size = 28),
        legend.text = element_text(size = 26), legend.background = element_rect(color = "white")) +
  labs(title= "Industry", x="", y = "Percent of responses")+
  scale_y_continuous(expand =c(0,0), limits=c(0,101), breaks=seq(0, 100, 20)) 



##Government
gov<-perc.fund.l[perc.fund.l$type=="Government",]


p2<-ggplot(gov, aes(percent.bins, perc.responses, fill=time))+ geom_bar(position='dodge', stat='identity')  + colScale7 +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.8, 0.91),
          legend.key.size = unit(0.3, "cm"), plot.title = element_text(size=28, hjust = 0.5, face="bold"),
           panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
         panel.grid.minor = element_blank(), 
        axis.text.x=element_text(size = 26, color= "black"), axis.text.y=element_text(size = 26, color = "black"), 
        legend.key=element_blank(),
          axis.title.x=element_text(size=24), axis.title.y=element_text(size = 24),
         legend.text = element_text(size = 26), legend.background = element_rect(color = "white")) +
  labs(title="Government", x="", y = "")+
  scale_y_continuous(expand =c(0,0), limits=c(0,101), breaks=seq(0, 100, 20)) 




##Internal

int<-perc.fund.l[perc.fund.l$type=="Internal",]


p3<-ggplot(int, aes(percent.bins, perc.responses, fill=time))+ geom_bar(position='dodge', stat='identity') + colScale7 +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.922, 0.98),
          legend.key.size = unit(0.3, "cm"), plot.title = element_text(size=28, hjust = 0.5, face="bold"),
           panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
         panel.grid.minor = element_blank(), 
        axis.text.x=element_text(size = 26, color= "black"), axis.text.y=element_text(size = 26, color = "black"), 
        legend.key=element_blank(),
          axis.title.x=element_text(size=28), axis.title.y=element_text(size = 28),
         legend.text = element_text(size = 26), legend.background = element_rect(color = "white")) +
  labs(title="Internal",x="% research funding", y = "Percent of responses")+
  scale_y_continuous(expand =c(0,0), limits=c(0,101), breaks=seq(0, 100, 20)) 




##Non-Governmental

ngov<-perc.fund.l[perc.fund.l$type=="Non-governmental",]


p4<-ggplot(ngov, aes(percent.bins, perc.responses, fill=time))+ geom_bar(position='dodge', stat='identity') + colScale7 +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.8, 0.93),
         legend.key.size = unit(0.3, "cm"), plot.title = element_text(size=28, hjust = 0.5, face="bold"),
           panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
         panel.grid.minor = element_blank(), 
        axis.text.x=element_text(size = 26, color= "black"), axis.text.y=element_text(size = 26, color = "black"), 
        legend.key=element_blank(),
          axis.title.x=element_text(size=28), axis.title.y=element_text(size = 28),
         legend.text = element_text(size = 26), legend.background = element_rect(color = "white")) +
  labs(title="Non-governmental", x="% research funding", y = "")+
  scale_y_continuous(expand =c(0,0), limits=c(0,101), breaks=seq(0, 100, 20)) 



## Other

other<-perc.fund.l[perc.fund.l$type=="Other",]


p5<-ggplot(other, aes(percent.bins, perc.responses, fill=time))+ geom_bar(position='dodge', stat='identity')  + colScale7 +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.8, 0.91),
         legend.key.size = unit(0.3, "cm"), plot.title = element_text(size=28, hjust = 0.5, face="bold"),
           panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
         panel.grid.minor = element_blank(), 
        axis.text.x=element_text(size = 26, color= "black"), axis.text.y=element_text(size = 26, color = "black"), 
        legend.key=element_blank(),
          axis.title.x=element_text(size=28), axis.title.y=element_text(size = 28),
         legend.text = element_text(size = 26), legend.background = element_rect(color = "white")) +
  labs(title="Other", x="% research funding", y = "Percent of responses")+
  scale_y_continuous(expand =c(0,0), limits=c(0,101), breaks=seq(0, 100, 20)) 


##put them all together

legend = gtable_filter(ggplotGrob(p1), "guide-box") 
grid.draw(legend)

#pdf(file="figures/HI/4.6_DistributionFunding_HI_percent_3.pdf", height=17, width =17)

#for wide view
# grid.arrange(arrangeGrob(p1+ theme(legend.position="none"), p2,
#                          p3+ theme(legend.position="none"), p4+ theme(legend.position="none"),
#                          p5,
#                          layout_matrix=rbind(c(1,1,1,2,2,2),c(3,3,4,4,5,5))), top=textGrob("Distribution of research funding (LMI)",gp=gpar(fontsize=17)))


#for narrow view
f4.6.3.hi <- grid.arrange(arrangeGrob(p1+ theme(legend.position="none"), p2,
                         p3 +theme(legend.position="none"), p4 ,
                         p5,
                         layout_matrix=rbind(c(1,1,2,2),
                                             c(3,3,4,4), 
                                             c(NA,5,5,NA))),
             top=textGrob("Distribution of research funding (HI)",gp=gpar(fontsize=35)))

#dev.off()

ggsave("4.6_DistributionFunding_HI_percent_3_Dec2021.svg", plot = f4.6.3.hi, device = "svg", path = "figures/HI", height = 21, width  = 26 , units = "in", dpi = 500)

```


```{r 4.7a, echo=FALSE, message=FALSE, warning=FALSE}

## subset the data
practical<-subset(dev, select=c("practical_applications_important_11_15", "practical_applications_important_6_10"))

## switch to long format
practical.l<-gather(practical, year, level)

practical.l$year[practical.l$year=="practical_applications_important_11_15"]<-"2011-2015"
practical.l$year[practical.l$year=="practical_applications_important_6_10"]<-"2006-2010"


prac<-data.frame(table(practical.l$year, practical.l$level))

prac<- prac[!prac$Var2 == "0",]
prac<-droplevels(prac)

#change order of levels
prac$Var2<-factor(prac$Var2, levels(prac$Var2)[c(2,6,4,5,3,1)])

#pdf(file="figures/HI/4.7A_ImportancePracticalApplication.pdf", height=7, width =11)
#svg(file="figures/HI/4.7A_ImportancePracticalApplication.svg", width = 11, height= 7)

ggplot(prac, aes(Var2, Freq, fill=Var1)) + 
  geom_bar(stat="identity", position = "dodge")+
  #geom_text(aes(label=Freq), vjust=-0.7, hjust=0.45, size=3, position = position_dodge(width = 0.95))+
  theme(panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        legend.key=element_blank(),legend.text=element_text(size = 12),
        legend.position=c(0.89, 0.91),
        axis.text.x=element_text(angle=-45, hjust = 0.1, size=12, color = "black"),
         axis.text.y=element_text(size = 12, color = "black"),
        axis.title.x=element_text(size = 12),
        axis.title.y=element_text(size = 12), plot.title = element_text(hjust = 0.5, size = 14)) +
  guides(fill=guide_legend(title=NULL, reverse=FALSE)) + 
  scale_x_discrete(labels=c("Mandatory", "Very\n important","Quite\n important", 'Somewhat\n important', 'Not at all\n important', "Can't\n comment"))+
  labs(x="", y="Number of respondents", title="Importance of practical application of research for grant success (HI)")+ colScale7+
  scale_y_continuous(expand = c(0, 0), limits = c(0,520))
  
#dev.off()
```


```{r 4.7a percent data prep, message=FALSE, warning=FALSE, include=FALSE}

## subset the data
practical<-subset(dev, select=c("practical_applications_important_11_15", "practical_applications_important_6_10"))

head(practical)

#count how many total responses there were of current and past
current.prac <- as.data.frame(length(na.omit(practical$practical_applications_important_11_15)))
colnames(current.prac)<-c("totalcur")
current.prac
current.prac <- current.prac - 18
current.prac
past.prac <- as.data.frame(length(na.omit(practical$practical_applications_important_6_10)))
colnames(past.prac)<-c("totalpast")
past.prac
past.prac <- past.prac-62
past.prac

#now calculate number of each

praccur <- as.data.frame(table(practical$practical_applications_important_11_15))
praccur
colnames(praccur) <- c("opinion", "num.opin")
praccur
dev[dev$practical_applications_important_11_15 == 0, ] # not sure how they managed to get the 0 but need to take them out of here an the total numbers
praccur <- praccur[!praccur$opinion == 0, ]
praccur <- droplevels(praccur)
praccur

pracpast <- as.data.frame(table(practical$practical_applications_important_6_10))
pracpast
colnames(pracpast) <- c("opinion", "num.opin")
pracpast
pracpast <- pracpast[!pracpast$opinion == 0, ]
pracpast <- droplevels(pracpast)
pracpast

#now stick the total numbers onto those df
praccur$totalcur <- current.prac$totalcur
praccur

pracpast$totalpast <- past.prac$totalpast
pracpast

#now calculate percentage
praccur$perc <- (praccur$num.opin/praccur$totalcur)*100
praccur
pracpast$perc <- (pracpast$num.opin/pracpast$totalpast)*100
pracpast

#combine
prac.perc <- praccur
prac.perc$"num.opin" <- NULL
prac.perc$"totalcur" <- NULL
prac.perc
prac.perc <- cbind(prac.perc, pracpast$perc)
prac.perc
colnames(prac.perc) <- c("opinion", "prac.current", "prac.past")
prac.perc

## switch to long format
prac.perc.l<-melt(prac.perc, na.rm = FALSE, id.vars = c("opinion"))
prac.perc.l
colnames(prac.perc.l) <- c("opinion", "time", "percent")
prac.perc.l

# add time variable
prac.perc.l$year<-ifelse(grepl( "current", prac.perc.l$time),"2011-2015", "2006-2010")
prac.perc.l

str(prac.perc.l)

#change order of levels
prac.perc.l$year <- as.factor(prac.perc.l$year)
levels(prac.perc.l$year)
levels(prac.perc.l$opinion)
prac.perc.l$opinion<-factor(prac.perc.l$opinion, levels(prac.perc.l$opinion)[c(2,6,4,5,3,1)])

```

```{r 4.7a percent, echo=FALSE, message=FALSE, warning=FALSE}
#pdf(file="figures/HI/4.7A_ImportancePracticalApplication_HI_percent.pdf", height=6, width =10)


f4.7a.hi <- ggplot(prac.perc.l, aes(opinion, percent, fill=year)) + 
  geom_bar(stat="identity", position = "dodge")+
  #geom_text(aes(label=Freq), vjust=-0.7, hjust=0.45, size=3, position = position_dodge(width = 0.95))+
  theme(panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        legend.key=element_blank(),legend.text=element_text(size = 22),
        legend.position=c(0.89, 0.91),
        axis.text.x=element_text( size=22, color = "black"),
         axis.text.y=element_text(size = 22, color = "black"),
        axis.title.x=element_text(size = 28),
        axis.title.y=element_text(size = 28), plot.title = element_text(hjust = 0.5, size = 28)) +
  guides(fill=guide_legend(title=NULL, reverse=FALSE)) + 
  scale_x_discrete(labels=c("Mandatory", "Very\n important","Quite\n important", 'Somewhat\n important', 'Not at all\n important', "Can't\n comment"))+
  labs(x="", y="Percent of responses", title="Importance of practical application of research\nfor grant success (HI)")+ colScale7+
  scale_y_continuous(expand = c(0, 0), limits = c(0,41))

f4.7a.hi
#dev.off()

#ggsave("4.7A_ImportancePracticalApplication_HI_percent_Dec2021.svg", plot = f4.7a.hi, device = "svg", path = "figures/HI", height = 7, width  = 13 , units = "in", dpi = 500)
```


```{r 4.7b, echo=FALSE, message=FALSE, warning=FALSE}

## subset the data
partners<-subset(dev, select=c("include_nonacademia_partners_success_11_15", "include_nonacademia_partners_success_6_10"))

## switch to long format
partners.l<-gather(partners, year, level)

partners.l$year[partners.l$year=="include_nonacademia_partners_success_11_15"]<-"2011-2015"
partners.l$year[partners.l$year=="include_nonacademia_partners_success_6_10"]<-"2006-2010"

part<-data.frame(table(partners.l$year, partners.l$level))
part<-part[!part$Var2 == "0",]
part<-droplevels(part)

#change order of levels
part$Var2<-factor(part$Var2, levels(part$Var2)[c(2,5,6,4,3,1)])

#pdf(file="figures/HI/4.7B_ImportancePartnersApplication_HI.pdf", height=7, width =11)
#svg(file="figures/HI/4.7B_ImportancePartnersApplication_HI.svg", width = 11, height= 7)

ggplot(part, aes(Var2, Freq, fill=Var1))+ 
  geom_bar(stat="identity", position = "dodge")+
  #geom_text(aes(label=Freq), vjust=-0.7, hjust=0.5, size=3, position = position_dodge(width = 0.8))+
    guides(fill=guide_legend(title=NULL, reverse=FALSE)) +
    labs(x="", y="Number of respondents", title="Importance of including partners (non-academia) for the success of grant applications (HI)")+
  scale_x_discrete(labels=c("Mandatory", "Quite\n important", 'Somewhat\n important',"Not very\n important", 'Not at all\n important', "Can't\n comment"))+
    theme(panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
          panel.grid.minor = element_blank(),legend.text=element_text(size = 12),
          legend.key=element_blank(),
          legend.position=c(0.11, 0.93), 
        axis.text.x=element_text(angle=-45, hjust = 0.1, size=12, color = "black"),
         axis.text.y=element_text(size = 12, color = "black"),
          axis.title.x=element_text(size = 12), axis.title.y=element_text(size = 12), plot.title = element_text(hjust = 0.5, size = 14)) + colScale7+
  scale_y_continuous(expand = c(0, 0), limits = c(0,500))

#dev.off()
```


```{r 4.7b percent data prep, message=FALSE, warning=FALSE, include=FALSE}

## subset the data
partners<-subset(dev, select=c("include_nonacademia_partners_success_11_15", "include_nonacademia_partners_success_6_10"))

head(partners)

#count how many total responses there were of current and past
current.part <- as.data.frame(length(na.omit(partners$include_nonacademia_partners_success_11_15)))
colnames(current.part)<-c("totalcur")
current.part
current.part <- current.part - 18
current.part
past.part <- as.data.frame(length(na.omit(partners$include_nonacademia_partners_success_6_10)))
colnames(past.part)<-c("totalpast")
past.part
past.part <- past.part-79
past.part

#now calculate number of each

partcur <- as.data.frame(table(partners$include_nonacademia_partners_success_11_15))
partcur
colnames(partcur) <- c("opinion", "num.opin")
partcur
dev[dev$include_nonacademia_partners_success_11_15 == 0, ] # not sure how they managed to get the 0 but need to take them out of here an the total numbers
partcur <- partcur[!partcur$opinion == 0, ]
partcur <- droplevels(partcur)
partcur

partpast <- as.data.frame(table(partners$include_nonacademia_partners_success_6_10))
partpast
colnames(partpast) <- c("opinion", "num.opin")
partpast
partpast <- partpast[!partpast$opinion == 0, ]
partpast <- droplevels(partpast)
partpast

#now stick the total numbers onto those df
partcur$totalcur <- current.part$totalcur
partcur

partpast$totalpast <- past.part$totalpast
partpast

#now calculate percentage
partcur$perc <- (partcur$num.opin/partcur$totalcur)*100
partcur
partpast$perc <- (partpast$num.opin/partpast$totalpast)*100
partpast

#combine
part.perc <- partcur
part.perc$"num.opin" <- NULL
part.perc$"totalcur" <- NULL
part.perc
part.perc <- cbind(part.perc, partpast$perc)
part.perc
colnames(part.perc) <- c("opinion", "part.current", "part.past")
part.perc

## switch to long format
part.perc.l<-melt(part.perc, na.rm = FALSE, id.vars = c("opinion"))
part.perc.l
colnames(part.perc.l) <- c("opinion", "time", "percent")
part.perc.l

# add time variable
part.perc.l$year<-ifelse(grepl( "current", part.perc.l$time),"2011-2015", "2006-2010")
part.perc.l

str(part.perc.l)

#change order of levels
part.perc.l$year <- as.factor(part.perc.l$year)
levels(part.perc.l$year)
levels(part.perc.l$opinion)
part.perc.l$opinion<-factor(part.perc.l$opinion, levels(part.perc.l$opinion)[c(2,5,6,4,3,1)])


```

```{r 4.7b percent, echo=FALSE, message=FALSE, warning=FALSE}

#pdf(file="figures/HI/4.7B_ImportancePartnersApplication_HI_percent.pdf", height=6, width =10)

f4.7b.hi <- ggplot(part.perc.l, aes(opinion, percent, fill=year))+ 
  geom_bar(stat="identity", position = "dodge")+
  #geom_text(aes(label=Freq), vjust=-0.7, hjust=0.5, size=3, position = position_dodge(width = 0.8))+
    guides(fill=guide_legend(title=NULL, reverse=FALSE)) +
    labs(x="", y="Percent of responses", title="Importance of including partners (non-academia)\nfor the success of grant applications (HI)")+
  scale_x_discrete(labels=c("Mandatory", "Quite\n important", 'Somewhat\n important',"Not very\n important", 'Not at all\n important', "Can't\n comment"))+
    theme(panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
          panel.grid.minor = element_blank(),legend.text=element_text(size = 22),
          legend.key=element_blank(),
          legend.position=c(0.11, 0.89), 
        axis.text.x=element_text(size=22, color = "black"),
         axis.text.y=element_text(size = 22, color = "black"),
          axis.title.x=element_text(size = 28), axis.title.y=element_text(size = 28), plot.title = element_text(hjust = 0.5, size = 28)) + colScale7+
  scale_y_continuous(expand = c(0, 0), limits = c(0,35))

f4.7b.hi
#dev.off()

ggsave("4.7B_ImportancePartnersApplication_HI_percent_Aug2022.svg", plot = f4.7b.hi, device = "svg", path = "figures/HI", height = 7, width  = 13 , units = "in", dpi = 500)

```


<!--**4.2 External Partnerships**   -->

```{r 4.8a, echo=FALSE, message=FALSE, warning=FALSE}

## subset the data
partner.level<-subset(dev, select=c("partnership_outside_current", "partnership_outside_before"))

## switch to long format
part.level.l<-gather(partner.level, year, level)

part.level.l$year[part.level.l$year=="partnership_outside_current"]<-"2011-2015"
part.level.l$year[part.level.l$year=="partnership_outside_before"]<-"2006-2010"

part.level<-data.frame(table(part.level.l$year, part.level.l$level))
part.level<-part.level[!part.level$Var2 == "0",]
part.level<-droplevels(part.level)

#change order of levels
part.level$Var2<-factor(part.level$Var2, levels(part.level$Var2)[c(1,4,3,2)])


#pdf(file="figures/HI/4.8A_LevelsOfPartnership.pdf", width = 9.5, height= 11)
#svg(file="figures/HI/4.8A_LevelsOfPartnership.svg", width = 11, height= 7)

ggplot(part.level, aes(x=Var2, y=Freq, fill = Var1),  ylim(0,375)) + 
  geom_bar( stat='identity', position="dodge") +
  #geom_text(aes(label=Freq), position=position_dodge(width=1), vjust=-0.5, size=3) +
  labs(x="", y="Number of respondents", fill="", title="Levels of partnerships outside of academia (HI)")+
  theme(panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        legend.key=element_blank(),legend.text=element_text(size = 12),
        axis.text.x=element_text(angle=-45, hjust = 0.1, size=12, color = "black"),
         axis.text.y=element_text(size = 12, color = "black"),
        axis.title=element_text(size = 12), 
        legend.position=c(0.1, 0.9), 
        legend.title=element_blank(), plot.title = element_text(hjust = 0.5, size = 14)) +
  colScale7+scale_y_continuous(expand = c(0, 0), limits = c(0,800))

#dev.off()
```


```{r 4.8a percent data prep, message=FALSE, warning=FALSE, include=FALSE}

## subset the data
partner.level<-subset(dev, select=c("partnership_outside_current", "partnership_outside_before"))
head(partner.level)


#count how many total responses there were of current and past
current.partlevel <- as.data.frame(length(na.omit(partner.level$partnership_outside_current)))
colnames(current.partlevel)<-c("totalcur")
current.partlevel
current.partlevel <- current.partlevel - 7
current.partlevel
past.partlevel <- as.data.frame(length(na.omit(partner.level$partnership_outside_before)))
colnames(past.partlevel)<-c("totalpast")
past.partlevel
past.partlevel <- past.partlevel-1016
past.partlevel

#now calculate number of each

partlevelcur <- as.data.frame(table(partner.level$partnership_outside_current))
partlevelcur
colnames(partlevelcur) <- c("level", "num.level")
partlevelcur
dev[dev$partnership_outside_current == 0, ] # not sure how they managed to get the 0 but need to take them out of here an the total numbers
partlevelcur <- partlevelcur[!partlevelcur$level == 0, ]
partlevelcur <- droplevels(partlevelcur)
partlevelcur

partlevelpast <- as.data.frame(table(partner.level$partnership_outside_before))
partlevelpast
colnames(partlevelpast) <- c("level", "num.level")
partlevelpast
partlevelpast <- partlevelpast[!partlevelpast$level == 0, ]
partlevelpast <- droplevels(partlevelpast)
partlevelpast

#now stick the total numbers onto those df
partlevelcur$totalcur <- current.partlevel$totalcur
partlevelcur

partlevelpast$totalpast <- past.partlevel$totalpast
partlevelpast

#now calculate percentage
partlevelcur$perc <- (partlevelcur$num.level/partlevelcur$totalcur)*100
partlevelcur
partlevelpast$perc <- (partlevelpast$num.level/partlevelpast$totalpast)*100
partlevelpast

#combine
partlevel.perc <- partlevelcur
partlevel.perc$"num.level" <- NULL
partlevel.perc$"totalcur" <- NULL
partlevel.perc
partlevel.perc <- cbind(partlevel.perc, partlevelpast$perc)
partlevel.perc
colnames(partlevel.perc) <- c("level", "partlevel.current", "partlevel.past")
partlevel.perc

## switch to long format
partlevel.perc.l<-melt(partlevel.perc, na.rm = FALSE, id.vars = c("level"))
partlevel.perc.l
colnames(partlevel.perc.l) <- c("level", "time", "percent")
partlevel.perc.l

# add time variable
partlevel.perc.l$year<-ifelse(grepl( "current", partlevel.perc.l$time),"2011-2015", "2006-2010")
partlevel.perc.l

str(partlevel.perc.l)

#change order of levels
partlevel.perc.l$year <- as.factor(partlevel.perc.l$year)
levels(partlevel.perc.l$year)
levels(partlevel.perc.l$level)
partlevel.perc.l$level<-factor(partlevel.perc.l$level, levels(partlevel.perc.l$level)[c(1,4,3,2)])

```

```{r 4.8a percent, echo=FALSE, message=FALSE, warning=FALSE}

#pdf(file="figures/HI/4.8A_LevelsOfPartnership_HI_percent.pdf", width = 9.5, height= 11)
#pdf(file="figures/HI/4.8A_LevelsOfPartnership_HI_percent_wide.pdf", width = 10, height= 6)

f4.8a.hi <- ggplot(partlevel.perc.l, aes(x=level, y=percent, fill = year),  ylim(0,375)) + 
  geom_bar( stat='identity', position="dodge") +
  #geom_text(aes(label=Freq), position=position_dodge(width=1), vjust=-0.5, size=3) +
  labs(x="", y="Percent of responses", fill="", title="Levels of partnerships outside of academia (HI)")+
  scale_x_discrete(labels=c("Exclusive\npartnership", "Strong\npartnership", 'Some\npartnership',"No\npartnership"))+
  theme(panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        legend.key=element_blank(),legend.text=element_text(size = 24),
        axis.text.x=element_text(angle=0, size=26, color = "black"),
         axis.text.y=element_text(size = 24, color = "black"),
        axis.title=element_text(size = 28), 
        legend.position=c(0.15, 0.85), 
        legend.title=element_blank(), plot.title = element_text(hjust = 0.5, size = 28)) +
  colScale7+scale_y_continuous(expand = c(0, 0), limits = c(0,55))

f4.8a.hi
#dev.off()

#ggsave("4.8A_LevelsOfPartnership_HI_percent_Dec2021.svg", plot = f4.8a.hi, device = "svg", path = "figures/HI", height = 7, width  = 13 , units = "in", dpi = 500)

```


```{r 4.8b, echo=FALSE, message=FALSE, warning=FALSE}

### was there change

part.change<-data.frame(table(dev$partnership_change_10yrs))
part.change<-part.change[!part.change$Var1=="0",]
part.change<-droplevels(part.change)

part.change$Var1<-revalue(part.change$Var1, c("Can't comment (new researcher)"="Can't comment"))
part.change$Var1<-factor(part.change$Var1, levels=c("Yes", "No", "Can't comment"))


g1<-ggplot(data=part.change, aes(x=Var1, y=Freq, fill=Var1))+ 
    geom_bar(stat='identity') + 
    guides(fill=FALSE) + 
    labs(x="", y="Number of respondents",title="Change in level of partnerships (HI)")+
  #geom_text(aes(label=Freq), vjust=-0.5)+
  theme(panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(), 
         axis.text.x=element_text( size=28, color = "black"),
         axis.text.y=element_text(size = 26, color = "black"),
        axis.title = element_text(size = 30, color = "black"),
        plot.title = element_text(hjust = 0.5, size = 32)) + 
  colScale +
  #annotate('text', 3.25,606, label="(a)", size=7)+
  scale_y_continuous(expand = c(0, 0), limits = c(0,900), breaks = seq(0,900, 200))

### reason

## subset the data
change.partner<-subset(dev, select=c("reason_partnership_change_career", "reason_partnership_change_interest", "reason_partnership_change_socially", "reason_partnership_change_funding", "reason_partnership_change_other"))

## switch to long format
change.part.l<-gather(change.partner, reason, level)

change.part<-data.frame(table(change.part.l$reason, change.part.l$level))

change.part$Var1<-revalue(change.part$Var1, c("reason_partnership_change_career" = "Career", "reason_partnership_change_funding" = "Funding", "reason_partnership_change_interest" = "Interest", "reason_partnership_change_other" = "Other", "reason_partnership_change_socially"  = "Social"))
change.part$Var1<-reorder(change.part$Var1, -change.part$Freq)

g2<-ggplot(change.part, aes(x=Var1, y=Freq, fill=Var1)) + 
    geom_bar(stat='identity')+  guides(fill=FALSE) +
    theme(axis.text.x=element_text( size=28, color = "black"),
         axis.text.y=element_text(size = 26, color = "black"),
          axis.title.y=element_text(size = 30),
         legend.text = element_text(size = 22),
          legend.position=c(0.8, 0.8), 
          legend.title=element_blank(),
          panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
          panel.grid.minor = element_blank(), plot.title = element_text(hjust = 0.5, size = 32)) + 
  #geom_text(aes(label=Freq), vjust=-0.5, size=3)+
  labs(x="", y="Number of respondents", title="Reason for change in level\nof partnerships (HI)")+
  colScale+
  scale_y_continuous(expand = c(0, 0), limits = c(0,501))

#annotate('text', 5,420, label="(b)", size=7)+ 

#pdf(file="figures/HI/4.8B_PartnershipChange&Reason.pdf", width = 10, height= 17)
#svg(file="figures/HI/4.8B_PartnershipChange.svg", width = 11, height= 7)

f4.8b.hi <- grid.arrange(g1, g2, ncol=1)

dev.off()

#ggsave("4.8B_PartnershipChange&Reason_HI_Dec2021.svg", plot = f4.8b.hi, device = "svg", path = "figures/HI", height = 14, width  = 13 , units = "in", dpi = 500)


#pdf(file="figures/HI/4.8B_PartnershipChange&Reason_wide.pdf", width = 25, height= 10)
#svg(file="figures/HI/4.8B_PartnershipChange.svg", width = 11, height= 7)

f4.8b.wide.hi <- grid.arrange(g1, g2, nrow=1)

#dev.off()

#ggsave("4.8B_PartnershipChange&Reason_wide_HI_Dec2021.svg", plot = f4.8b.wide.hi, device = "svg", path = "figures/HI", height = 7, width  = 26 , units = "in", dpi = 500)

```


```{r 4.8c, echo=FALSE,  message=FALSE, warning=FALSE}

view<-data.frame(table(dev$view_change_partnership))
view<-view[!view$Var1=="0",]
view<-droplevels(view)

# change order of the levels

view$Var1<-factor(view$Var1, levels(view$Var1)[c(5,3,1,2,4)])

#pdf(file="figures/HI/4.8C_ViewChangePartnership.pdf", width = 10, height= 12)
#svg(file="figures/HI/4.8C_ViewChangePartnership.svg", width = 11, height= 7)

f4.8c.hi <- ggplot(view, aes(x=Var1, y=Freq, fill=Var1)) + geom_bar(stat='identity')+
  #geom_text(aes(label=Freq, vjust=-0.5), size=3)+
  guides(fill=FALSE)+
  theme(panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
         axis.text.x=element_text(size=30, color = "black"),
         axis.text.y=element_text(size = 30, color = "black"),
        axis.title.y=element_text(size=32), 
        plot.title = element_text(hjust = 0.5, size = 34)) + 
  labs(x="", y="Number of respondents", title="Opinion of change in\npartnership level (HI)") + 
  scale_x_discrete(labels=c("Very\npositive", "Slightly\npositive", "Neutral", "Slightly\nnegative", "Very\nnegative")) +
  colScale+
  scale_y_continuous(expand = c(0, 0), limits = c(0,210), breaks = seq(0,200,50))

f4.8c.hi
#dev.off()

#ggsave("4.8C_ViewChangePartnership_HI_Dec2021.svg", plot = f4.8c.hi, device = "svg", path = "figures/HI", height = 7, width  = 13 , units = "in", dpi = 500)

```
 
 
```{r 4.9, echo=FALSE, message=FALSE, warning=FALSE}

## subset the data
anticipated<-subset(dev, select=c("available_funding_fundamental", "available_funding_use_inspired", "available_funding_applied"))

## switch to long format
anticipated.l<-gather(anticipated, type, level)

anticipated.l$type[anticipated.l$type=="available_funding_fundamental"]<-"Fundamental"
anticipated.l$type[anticipated.l$type=="available_funding_use_inspired"]<-"Use-inspired"
anticipated.l$type[anticipated.l$type=="available_funding_applied"]<-"Applied"

ant<-data.frame(table(anticipated.l$type, anticipated.l$level))
ant<-ant[!ant$Var2 == "0",]
ant<-droplevels(ant)

## change type to factor with levels
ant$Var2 <- as.character(levels(ant$Var2))[ant$Var2]
ant$Var2[ant$Var2=="Will decrease considerably"]<-"Decrease considerably"
ant$Var2[ant$Var2=="Will decrease slightly"]<-"Decrease slightly"
ant$Var2[ant$Var2=="Will increase considerably"]<-"Increase considerably"
ant$Var2[ant$Var2=="Will increase slightly"]<-"Increase slightly"
ant$Var2[ant$Var2=="Will stay the same"]<-"Stay the same"

ant$Var2<- as.factor(ant$Var2)

## change order of levels
ant$Var2<-factor(ant$Var2, levels(ant$Var2)[c(4,5,6,3,2,1 )])
ant$Var1<-factor(ant$Var1, levels(ant$Var1)[c(2,3,1)])

### colour palette

myColors17<-mycols<-c('#E55934','#9BC53D','#42A3FF')
colScale9 <- scale_fill_manual(name = "what.type",values = rev(myColors17))



xs <- split(ant,f = ant$Var1)
p1 <- ggplot(xs$Fundamental, aes(x=Var2, Freq, fill=Var1))+
    geom_bar(stat="identity", position="dodge")+
    theme( axis.text.x=element_text(size=22, color = "black"),
         axis.text.y=element_text(size = 22, color = "black"),
          panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
          panel.grid.minor = element_blank(),
           strip.text.x = element_text(size=22, color="black"),
          strip.background = element_rect(colour="white", fill="white"),
          legend.position=c(0.8, 0.2), 
          axis.title.y=element_text(size=28), 
          plot.title = element_text(hjust = 0.5, size = 28)) +
    guides(fill=FALSE)+
    scale_x_discrete(labels=c("Increase\n considerably", "Increase\n slightly", 
                                    "Stay the\nsame", "Decrease\n slightly", "Decrease\n considerably", "Can't\n comment"))+
    facet_wrap(~Var1,nrow=3)
    #geom_text(aes(label=Freq), vjust=-0.5, size=2.8) + 

p2 <- p1 %+% xs$`Use-inspired`
p3 <- p1 %+% xs$Applied


p1<-p1+scale_fill_manual(name = "ID",values = "#42A3FF")+labs(x="", title="Anticipated change in research funding (HI)", y="Number of responses")+ theme(plot.margin=unit(c(1,1,-0.45,1), "cm"), plot.title = element_text(hjust = 0.5, size = 28), strip.text.x = element_text(size=24, color='#3b92e5'))+ scale_y_continuous(expand=c(0,0), limits = c(0,703), breaks = seq(0,700,100))

p2<-p2+scale_fill_manual(name = "ID",values ="#9BC53D")+ theme(plot.margin=unit(c(-0.5,1,1,1), "cm"), strip.text.x = element_text(size=24, color='#7c9d30')) + scale_y_continuous(expand=c(0,0), limits = c(0,703), breaks = seq(0,700,100)) + labs(x="  ", y="Number of responses", title="")

p3<-p3+scale_fill_manual(name = "ID",values ="#E55934")+ theme(plot.margin=unit(c(-0.5,1,0.5,1), "cm"), strip.text.x = element_text(size=24, color='#ce502e'))+ scale_y_continuous(expand=c(0,0), limits = c(0,703), breaks = seq(0,700,100)) + labs(x = "", y = "Number of responses")

#pdf(file="figures/HI/4.9_AnticipatedChangeFunding.pdf", height=19, width =12)
#tiff(file="figures/HI/4.9_AnticipatedChangeFunding_HI.tiff", height=17, width =10, units = "in", res = 600)
#svg(file="figures/HI/4.9_AnticipatedChangeFunding.svg", width = 11, height= 7)

f4.9.hi <- grid.arrange(p1,p2,p3, heights=c(0.33,0.33,0.33))

#dev.off()

#ggsave("4.9_AnticipatedChangeFunding_HI_Dec2021.svg", plot = f4.9.hi, device = "svg", path = "figures/HI", height = 21, width  = 13 , units = "in", dpi = 500)


```


```{r 4.10, echo=FALSE, message=FALSE, warning=FALSE}

future<-data.frame(table(dev$next_generation))
future<-future[!future$Var1=="0",]
future<-droplevels(future)

future$Var1 <- as.character(levels(future$Var1))[future$Var1]

## change type to factor with levels
future$Var1<-str_replace_all(future$Var1, "Will ", "")
future$Var1<-as.factor(future$Var1)

## change order of Var1s
future$Var1<-factor(future$Var1, levels(future$Var1)[c(4,5,6,3,2,1)])

#pdf(file="figures/HI/4.10_EffectNextGeneration.pdf", height=7, width =11)
#tiff(file="figures/HI/4.10_EffectNextGeneration_HI.tiff", height=11, width =10, units = "in", res = 600)
#svg(file="figures/HI/4.10_EffectNextGeneration.svg", width = 11, height= 7)

f4.10.hi <- ggplot(data=future, aes(x=Var1, Freq, fill=Var1))+ 
    geom_bar(stat='identity', position="dodge")  +
        scale_x_discrete(labels=c("Increase\nconsiderably", "Increase\nslightly", 
                                    "Stay the\nsame", "Decrease\nslightly", "Decrease\nconsiderably", "Can't\ncomment"))+
    guides(fill=FALSE) +
 labs(x="", y="Number of respondents", title="Effect of funding changes on the next\ngeneration of researchers (HI)")+
  theme(axis.text.x=element_text(size=22, color = "black"),
         axis.text.y=element_text(size = 22, color = "black"),
       panel.grid.major.y = element_line(linetype = 3, color = "darkgrey", size = .3),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
          axis.title.y=element_text(size=28), 
        plot.title = element_text(hjust = 0.5, size = 28))+
  #geom_text(aes(label=Freq, vjust=-0.5), size=3)+
  scale_y_continuous(expand = c(0, 0), limits = c(0,530))+colScale

f4.10.hi
#dev.off()

#ggsave("4.10_EffectNextGeneration_HI_Dec2021.svg", plot = f4.10.hi, device = "svg", path = "figures/HI", height = 7, width  = 13 , units = "in", dpi = 500)
```
