---
title: "Sub-Sahara Africa"
author: "Kristina Tietjen"
date: "3/9/2018"
output: pdf_document
---

Survey Data Analysis  

**Note that numbers not all the same because respondents did not always answer every question**
```{r message=FALSE, warning=FALSE, include=FALSE, loading_data, warning=FALSE}
rm(list=ls())

dev.off()

#<!-- Import data, calculate sample sizes -->
 ## CHANGE WORKING DIRECTORY FOR YOUR LOCAL MACHINE BEFORE KNITTING ##
setwd("/Users/kristinatietjen/Documents/git_hub/gya-research/writing")
#setwd("/Users/IMAC3/Documents/git-jpwrobinson/gya-research")
#setwd("/Users/jpwrobinson/Documents/git_repos/gya-research")
#setwd("/Users/Julia_2013MacBookAir/Desktop/GitRepos/gya-research/writing")
## load in survey data
survey<-read.csv(file="../data/gya-without-incomplete.csv")
#Count how many responses from  researchers
survey.what<-read.csv(file="../data/gya-country-responses.csv")
research<-read.csv(file="../data/gya-surveys-cleaned-research.csv")
#research.past<-read.csv(file="data/gya-surveys-cleaned-research-past.csv")
research.change<-read.csv(file="../data/gya-change-reason.csv")
part4<-read.csv(file="../data/gya-survey-part4.csv")
part2.b.a<-read.csv(file="../data/gya-part2.before.after.csv")
part2.change<-read.csv(file="../data/gya-part2.change.csv")
part2.reason<-read.csv(file="../data/gya-part2.reason.csv")
part2.view<-read.csv(file="../data/gya-part2.view.csv")
part1.view<-read.csv(file="../data/gya-part1.view.csv")
part3.change<-read.csv(file="../data/gya-part3.change.csv")
part3.grants.long<-read.csv(file="../data/gya-part3.grants.long.csv")
part3.success.long<-read.csv(file="../data/gya-part3.success.long.csv")
part3.prac.long<-read.csv(file="../data/gya-part3.prac.long.csv")
part3.part.long<-read.csv(file="../data/gya-part3.part.long.csv")
p3_master.long<-read.csv(file="../data/gya-p3_master.long.csv")
p3_master <- read.csv(file="../data/gya-p3_master.csv")


##selecting for sub saharan african countries
subsaharaafrica<-read.csv("../data/subsahara.csv")
subsaharaafrica <- as.data.frame(subsaharaafrica)
subsaharaafrica <- subsaharaafrica[ , 1]

subsahara<-survey[survey$nation%in%subsaharaafrica,]

#check
unique(subsahara$nation)
subsahara <- droplevels(subsahara)


#Gender:
n.subsahara.res.men <- subsahara[subsahara$gender=="Male",]               #Count how many responses from  male researchers
percent.men<-((dim(n.subsahara.res.men)[1])/(dim(subsahara)[1]))*100      #Calculate the % of responses from  male researchers
n.subsahara.res.women <- subsahara[subsahara$gender=="Female",]           #Count how many responses from  female researchers
percent.women<-((dim(n.subsahara.res.women)[1])/(dim(subsahara)[1]))*100  #Calculate the % of responses from  female researchers

#Career Stage Tabulations:
#table(subsahara$what_participant_group)
n.seniorac <- subsahara[subsahara$what_participant_group=="Senior academic researcher with >10 years of experience applying for research grants",]
percent.seniorac<-((dim(n.seniorac)[1])/(dim(subsahara)[1]))*100 #Calculate the % of responses from  senior academic researchers
n.earlyac <- subsahara[subsahara$what_participant_group=="Early career academic researcher with <10 years experience applying for research grants since completion of PhD",]
percent.earlyac<-((dim(n.earlyac)[1])/(dim(subsahara)[1]))*100 #Calculate the % of responses from  early academic researchers
n.pdf <- subsahara[subsahara$what_participant_group=="Postdoctoral fellow or research assistant with experience applying for research grants, or anticipating the need to apply for grants in the near future",]
percent.pdf<-((dim(n.pdf)[1])/(dim(subsahara)[1]))*100 #Calculate the % of responses from  post-docs
n.nonACearly <- subsahara[subsahara$what_participant_group=="Non-academic researcher conducting or managing research in industry or government with <10 years of experience",]
percent.nonACearly<-((dim(n.nonACearly)[1])/(dim(subsahara)[1]))*100 #Calculate the % of responses from early career non-academics
n.nonACsenior <- subsahara[subsahara$what_participant_group=="Non-academic researcher conducting or managing research in industry or government with >10 years of experience",]
percent.nonACsenior<-((dim(n.nonACsenior)[1])/(dim(subsahara)[1]))*100 #Calculate the % of responses from early career non-academics
n.unk <- subsahara[subsahara$what_participant_group=="",]
percent.unk<-((dim(n.unk)[1])/(dim(subsahara)[1]))*100 #Calculate the % of responses from unknown career stage

#Discipline Tabulations:
n.natural <- subsahara[subsahara$field_research=="Natural Science",]
percent.natural <- ((dim(n.natural)[1])/(dim(subsahara)[1]))*100 #Calculate the % of responses from  natural scientists
n.physics <- subsahara[subsahara$field_research=="Physical Science (eg. math, physics, chemistry, computer science)",]
percent.physics <- ((dim(n.physics)[1])/(dim(subsahara)[1]))*100 #Calculate the % of responses from  physical scientists
n.med <- subsahara[subsahara$field_research=="Medicine and Life Science",]
percent.med <- ((dim(n.med)[1])/(dim(subsahara)[1]))*100 #Calculate the % of responses from  med/life scientists
n.eng <- subsahara[subsahara$field_research=="Engineering",]
percent.eng <- ((dim(n.eng)[1])/(dim(subsahara)[1]))*100 #Calculate the % of responses from  engineering scientists
n.int <- subsahara[subsahara$field_research=="Interdisciplinary Science",]
percent.int <- ((dim(n.int)[1])/(dim(subsahara)[1]))*100 #Calculate the % of responses from  interdisciplinary scientists
n.ssh <- subsahara[subsahara$field_research=="Social Science / Humanities",]
percent.ssh <- ((dim(n.ssh)[1])/(dim(subsahara)[1]))*100 #Calculate the % of responses from  interdisciplinary scientists


require(ggplot2)
```

**Results**  
In total, `r dim(subsahara)[1]`  researchers completed the online survey. Of these, almost xxxxx were male (`r ceiling(percent.men)`%) and xxxxx were female (`r round(percent.women)`%); xxxx proportion either did not input their gender or selected other. xxxx of the survey respondents (`r round(sum(percent.seniorac,percent.earlyac))`%) were either senior academics (`r round(percent.seniorac)`%), defined as those researchers with more than ten years experience applying for research grants since completion of their PhD, or early career academics (`r round(percent.earlyac)`%) (Figure 4.1). xxxxx also came from post-doctoral researchers (`r round(percent.pdf)`%), non-academic researchers (`r  round(sum(percent.nonACearly,percent.nonACsenior))`%), or those who did not indicate their career stage (`r round(percent.unk, digits=1)`%).

Researchers from many different disciplines were represented in the survey. `r round(sum(percent.natural,percent.physics))` percent of responses came from either the natural or physical sciences (Figure 4.2). The remaining responses were spread amongst the medical and life sciences (`r round(percent.med)`%), engineering (`r round(percent.eng)`%), interdisciplinary research (`r round(percent.int)`%), and social sciences and humanities (`r round(percent.ssh)`%). 


##Figures of number of responses by country (these are also saved as individual PDFs)
```{r echo=FALSE, fig.cap="Number of responses by country", fig.width=11, fig.height=8, message=FALSE, warning=FALSE}
###create figures

locations<-aggregate(gender ~ nation, subsahara, length)
locations<-locations[!locations$nation=="",]
locations<-droplevels(locations)

#pdf(file="figures/subsahara/responses_country_12Mar18.pdf", width = 11, height= 8)

ggplot(locations, aes(x = reorder(nation, -gender), gender)) + geom_bar(stat='identity',position = position_dodge(width=0.5),fill='#1f78b4') + theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5)) + labs(y="Number of responses", x="", title="Responses by Country")  + 
  geom_text(aes(label=gender), angle=90, hjust=-0.5, size=3) +
  #geom_text(aes(label=Country), angle=90, hjust=-0.5) 
   theme(legend.title=element_text(size=12), 
                             legend.text=element_text(size=10), axis.text=element_text(size=8), axis.title=element_text(size=12), plot.title = element_text(hjust = 0.5)) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+scale_y_continuous(expand = c(0,0), limits=c(0, 8)) 

#dev.off()  
#   
# ### responses by country gap plot
# locations<-aggregate(gender ~ nation, subsahara, length)
# locations<-locations[!locations$nation=="",]
# require(colorRamps);require(plotrix)
# barlabs<-locations$nation[order(locations$gender, decreasing=TRUE)]
# 
# #pdf(file="figures/subsahara/responses_country_gapplot_4Jan18.pdf", height=8, width=11)
# 
# par(mar=c(11,4,4,2))
# gap.barplot(sort(locations$gender,decreasing=TRUE), gap=c(60,170),horiz=F, xaxlab=barlabs, xlab="     ", 
#             ylab="Number of responses", ytics=c(0,10,20,30,40,50,60,170,180,190,200), main = "Responses by country",las=2, col=c(blue2red(29)))
# 
# #dev.off()


## >10 responses
# 
# locations.more<-aggregate(gender ~ nation, subsahara, length)
# locations.more<-locations.more[!locations.more$nation=="",]
# locations.more$gender<-as.numeric(locations.more$gender)
# locations.more<-locations.more[locations.more$gender>10,]
# require(colorRamps);require(plotrix)
# barlabs<-locations.more$nation[order(locations.more$gender, decreasing=TRUE)]
# 
# color1<-c('#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4')
# 
# 
# #pdf(file="figures/subsahara/responses_country_10+_gapplot_4Jan18.pdf", height=8, width=11)
# 
# par(mar=c(7,4,4,2))
# gap.barplot(sort(locations.more$gender,decreasing=TRUE), gap=c(61,169),horiz=F, xaxlab=barlabs, xlab="     ", 
#             ylab="Number of responses", ytics=c(52,55,60,170,180,200), main = "Countries with greater than 10 responses",las=2, col=color1)
# 
# #dev.off()

#col=c(blue2red(29))
# 
# ## <=10 responses
# 
# locations.less<-aggregate(gender ~ nation, subsahara, length)
# locations.less<-locations.less[!locations.less$nation=="",]
# locations.less$gender<-as.numeric(locations.less$gender)
# locations.less<-locations.less[locations.less$gender<=10,]
# require(colorRamps);require(plotrix)
# barlabs<-locations.less$nation[order(locations.less$gender, decreasing=TRUE)]
# 
# color2<-'#1f78b4'
# color2<-rep(color2,55)
# 
# #pdf(file="figures/subsahara/responses_country_10-_gapplot_4Jan18.pdf", height=8, width=11)
# 
# par(mar=c(11,4,4,2))
# barplot(sort(locations.less$gender,decreasing=TRUE), names.arg = locations.less$nation[order(locations.less$gender, decreasing=TRUE)] ,horiz=F, xlab="", 
#             ylab="Number of responses", main = "Countries with 10 or fewer responses",las=2, ylim=c(-0.1,7),col=color2, axis.lty="solid", space=0, xaxs="i")
# box()
# 
# #dev.off()

#c(blue2red(55)

# 
# ##combine  >10 and <= 10 figures
# 
# locations.more<-aggregate(gender ~ nation, subsahara, length)
# locations.more<-locations.more[!locations.more$nation=="",]
# locations.more$gender<-as.numeric(locations.more$gender)
# locations.more<-locations.more[locations.more$gender>10,]
# require(colorRamps);require(plotrix)
# barlabs<-locations.more$nation[order(locations.more$gender, decreasing=TRUE)]
# 
# color1<-c('#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4','#1f78b4')
# #pdf(file="figures/subsahara/responses_country_10+&10-_gapplot_4Jan18.pdf", height=8, width=15)
# layout(matrix(c(1,2),1,2, byrow = TRUE), widths=c(0.7,2))
# par(mar=c(11,4,4,2))
# gap.barplot(sort(locations.more$gender,decreasing=TRUE), gap=c(61,169),horiz=F, xaxlab=barlabs, xlab="     ", 
#             ylab="Number of responses", ytics=c(52,55,60,170,180,200), main = "Countries with greater than 10 responses",las=2, col=color1)
# par(mar=c(11,2,4,1))
# barplot(sort(locations.less$gender,decreasing=TRUE), names.arg = locations.less$nation[order(locations.less$gender, decreasing=TRUE)] ,horiz=F, xlab="", 
#             ylab="", main = "Countries with 10 or\nfewer responses",las=2, ylim=c(-0.1,10),col=color2, axis.lty="solid", space=0, xaxs="i")
# box()
# 
# #dev.off()

```


<!-- Generate  career stage figure -->
```{r echo=FALSE, fig.cap="Figure 4.1 Number of  survey respondents by career stage", message=FALSE, warning=FALSE, fig.width=11, fig.height=7}
## load required packages
require(gridExtra); require(tidyr); require(ggplot2); require(stringr);require(RColorBrewer); require(colorRamps); require(plotrix); require(plyr); require(grid);require(gtable)

theme_set(theme_bw())
## setting colour scale to keep colours identical between similar plots
## myColors <- brewer.pal(6,"Set1")

experience<-data.frame(table(subsahara$what_participant_group))
experience<-experience[!experience$Var1=="",]
experience<-droplevels(experience)

experience$Var1<-revalue(experience$Var1, c("Early career academic researcher with <10 years experience applying for research grants since completion of PhD" = "Early career academic researcher", "Non-academic researcher conducting or managing research in industry or government with >10 years of experience" = "Non-academic research >10 yrs experience", "Non-academic researcher conducting or managing research in industry or government with <10 years of experience" = "Non-academic researcher <10 yrs experience", "Postdoctoral fellow or research assistant with experience applying for research grants, or anticipating the need to apply for grants in the near future" = "Postdoc or RA", "Senior academic researcher with >10 years of experience applying for research grants" = "Senior academic researcher"))
experience$Var1<-reorder(experience$Var1, experience$Freq)

# assign colour scale
myColors1<-(brewer.pal(9, "Blues"))
myColors1<-myColors1[-c(1:2)]
names(myColors1)<- levels(experience$Var1)
colScale <- scale_fill_manual(name = "Var1",values = myColors1)

#pdf(file="figures/subsahara/4.1_CareerStage_9March18.pdf", width = 11, height= 7)

ggplot(experience, aes(x = reorder(Var1, -Freq), Freq, fill=Var1)) + 
  geom_bar(stat='identity',position = position_dodge(width=0.5)) + 
  geom_text(aes(label=Freq, vjust=-0.5), size=3)+
  scale_x_discrete(labels=c("Senior academic", "Early career\nacademic", "Postdoc or RA", "Senior\nnon-academic", "Early career\nnon-academic")) +
  labs(y="Number of responses", x="", title="Responses by Career Stage") +
  guides(fill=guide_legend(title=NULL, reverse=TRUE, nrow=3)) +  
  theme(aspect.ratio=1/2,legend.title=element_blank(), 
        legend.text=element_text(size=10), 
        axis.text.y=element_text(size=9),
        axis.text.x=element_text(angle=0, size=9), 
        axis.title=element_text(size=11),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), plot.title = element_text(hjust = 0.5)) + 
  colScale + guides(fill=FALSE)+
  scale_y_continuous(expand = c(0,0), limits = c(0,20))
#dev.off()

```

<!-- Generate  research discipline figure -->
```{r echo=FALSE, fig.cap="Figure 4.2 Survey responses by field of research", message=FALSE,fig.width=11, fig.height=7, warning=FALSE}
field<-data.frame(table(subsahara$field_research))
field<-field[!field$Var1=="",]
field$Var1<-reorder(field$Var1, field$Freq)
field$Var1<-revalue(field$Var1, c("Physical Science (eg. math, physics, chemistry, computer science)" = "Physical Science"))

## setting colour scale to keep colours identical between similar plots
myColors2<-(brewer.pal(9, "Blues"))
myColors2<-myColors2[-c(1)]
names(myColors2) <- levels(field$field_research)
colScale <- scale_fill_manual(name = "field_research",values = myColors2)

#pdf(file="figures/subsahara/4.2_FieldofResearch.pdf", width = 11, height= 7)

ggplot(field, aes(x = reorder(Var1, -Freq), Freq, fill=Var1)) + 
    geom_bar(stat='identity',position = position_dodge(width=0.5)) + 
  labs(y="Number of responses",x="", title=" Responses by field of research")  +
  scale_x_discrete(labels=c("Natural\n Science", "Physical\n Science", "Medicine &\nLife Science", "Engineering", "Interdisciplinary\nScience", "Social Science/\nHumanities", "Other")) +
  geom_text(aes(label=Freq), vjust=-0.25, size=3) + 
  theme( aspect.ratio=1/2, axis.text.y=element_text(size=9),
         axis.text.x=element_text(angle=0, size=9),
         axis.title=element_text(size=11),
         panel.grid.major = element_blank(),
         panel.grid.minor = element_blank(), plot.title = element_text(hjust = 0.5)) + 
  guides(fill=FALSE) + colScale+
  scale_y_continuous(expand = c(0,0), limits = c(0,10), breaks = c(0,5,10))

#dev.off()
```

```{r eval=FALSE, fig.cap="Figure 4.1 + 4.2 Career Stage and Field of research", message=FALSE, warning=FALSE, include=FALSE, fig.width=11, fig.height=7}
##plot1

# assign colour scale
myColors1<-(brewer.pal(9, "Blues"))
myColors1<-myColors1[-c(1:2)]
names(myColors1)<- levels(experience$Var1)
colScale <- scale_fill_manual(name = "Var1",values = myColors1)

g4.1<-ggplot(experience, aes(x = reorder(Var1, -Freq), Freq, fill=Var1)) + 
  geom_bar(stat='identity',position = position_dodge(width=0.5)) + 
  geom_text(aes(label=Freq, vjust=-0.5), size=3)+
  scale_x_discrete(labels=c("Senior academic", "Early career\nacademic", "Postdoc or RA", "Senior\nnon-academic", "Early career\nnon-academic")) +
  labs(y="Number of responses", x="", title="Responses by Career Stage") +
  guides(fill=guide_legend(title=NULL, reverse=TRUE, nrow=3)) +  
  theme(aspect.ratio=1/2,legend.title=element_blank(), 
        legend.text=element_text(size=10), 
        axis.text.y=element_text(size=9),
        axis.text.x=element_text(angle=0, size=9), 
        axis.title=element_text(size=11),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), plot.title = element_text(hjust = 0.5)) + 
  colScale + guides(fill=FALSE)+
  scale_y_continuous(expand = c(0,0), limits = c(0,20))

##plot 2

## setting colour scale to keep colours identical between similar plots
myColors2<-(brewer.pal(9, "Blues"))
myColors2<-myColors2[-c(1)]
names(myColors2) <- levels(field$field_research)
colScale <- scale_fill_manual(name = "field_research",values = myColors2)

g4.2<-ggplot(field, aes(x = reorder(Var1, -Freq), Freq, fill=Var1)) + 
    geom_bar(stat='identity',position = position_dodge(width=0.5)) + 
  labs(y="Number of responses",x="", title=" Responses by field of research")  +
  scale_x_discrete(labels=c("Natural\n Science", "Physical\n Science", "Medicine &\nLife Science", "Engineering", "Interdisciplinary\nScience", "Social Science/\nHumanities", "Other")) +
  geom_text(aes(label=Freq), vjust=-0.25, size=3) + 
  theme( aspect.ratio=1/2, axis.text.y=element_text(size=9),
         axis.text.x=element_text(angle=0, size=9),
         axis.title=element_text(size=11),
         panel.grid.major = element_blank(),
         panel.grid.minor = element_blank(), plot.title = element_text(hjust = 0.5)) + 
  guides(fill=FALSE) + colScale+
  scale_y_continuous(expand = c(0,0), limits = c(0,10))

#pdf(file="figures/subsahara/4.1and4.2_CareerStageAndFieldOfResearch.pdf", width = 11, height= 7)

grid.arrange(g4.1,g4.2, heights=c(0.475,0.525), ncol=1)

#dev.off()
```

<!--**4.1 Type of Research Conducted**  -->

<!-- Generate figure showing current and past fundamental, use-inspiried, and applied research %s -->
```{r echo=FALSE, fig.cap="Figure 4.3 Respondents type of research describe in proportal amounts of fundamental use-inspired and applied research. Reseachers were questioned about the percentage of funding allocated to Fundamental Use-inspired or Applied research in the past and in their current research.", message=FALSE, warning=FALSE, fig.width=11, fig.height=7}

# select for subsaraha countries
research.subsahara<-research[research$nation%in%subsaharaafrica,]
research.subsahara <- droplevels(research.subsahara)
#check
unique(research.subsahara$nation)


## make sure that Use-inspired is the middle level in the legend
res.plot.sub<-subset(research.subsahara, type%in%c("percent_fundemental_research_current",  "percent_Applied_Research_current" , "percent_Use_inspired_Research_current","percent_Applied_Research_past",  "percent_Fundamental_Research_past" , "percent_Use_inspired_Research_past"))

res.plot.sub$percent<-str_replace_all(res.plot.sub$percent, "%", "")
res.plot.sub$percent<-as.numeric(as.character(res.plot.sub$percent))
res.plot.sub$type<-as.character(res.plot.sub$type)

# add time variable
res.plot.sub$time<-ifelse(grepl( "current", res.plot.sub$type),"Current", "Past")
res.plot.sub$type[res.plot.sub$type=="percent_Applied_Research_past"]<-"Applied"
res.plot.sub$type[res.plot.sub$type=="percent_Applied_Research_current"]<-"Applied"
res.plot.sub$type[res.plot.sub$type=="percent_Fundamental_Research_past"]<-"Fundamental"
res.plot.sub$type[res.plot.sub$type=="percent_fundemental_research_current"]<-"Fundamental"
res.plot.sub$type[res.plot.sub$type=="percent_Use_inspired_Research_past"]<-"Use-inspired"
res.plot.sub$type[res.plot.sub$type=="percent_Use_inspired_Research_current"]<-"Use-inspired"

# change order of the levels
res.plot.sub$time<-as.factor(res.plot.sub$time)
res.plot.sub$time<-factor(res.plot.sub$time, levels(res.plot.sub$time)[c(2,1)])

res.plot.sub$type<-as.factor(res.plot.sub$type)
res.plot.sub$type<-factor(res.plot.sub$type, levels(res.plot.sub$type)[c(2,3,1)])

res.plot.sub$time<-factor(res.plot.sub$time)
res.plot.sub$time<-factor(res.plot.sub$time, levels(res.plot.sub$time)[c(1,2)])

#myColors<-(brewer.pal(9, "Blues"))
#myColors<-myColors[c(5,9)]


mycols<-c('#a6cee3','#1f78b4','#b2df8a','#33a02c','#fb9a99','#e31a1c')

colScale <- scale_fill_manual(name = "ID",values = mycols)

res.plot.sub$ID<-paste(res.plot.sub$type, res.plot.sub$time)

#table(res.plot$percent,res.plot$time,res.plot$type)
#write.csv(res.plot, file="data/4.1a.calculations.csv", row.names = FALSE)

# change order of the levels
res.plot.sub$ID<-as.factor(res.plot.sub$ID)
res.plot.sub$ID<-factor(res.plot.sub$ID, levels(res.plot.sub$ID)[c(4,3,6,5,2,1)])

# add colours to res.plot
mycols<-c('#33a02c','#a6cee3','#fb9a99','#1f78b4', '#e31a1c','#b2df8a')
mycols<-as.data.frame(mycols)
mycols$ID<-levels(res.plot.sub$ID)
res.plot.sub$col<-mycols$mycols[match(res.plot.sub$ID, mycols$ID)]
res.plot.sub$col<-factor(res.plot.sub$col, levels(res.plot.sub$col)[c(3,1,4,2,6,5)])
mycols<-as.character(unique(res.plot.sub$col))
colScale <- scale_fill_manual(name = "ID",values =mycols, labels=c("2006-2010 Fundamental", "2011-2015 Fundamental","2006-2010 Use-inspired", "2011-2015 Use-inspired","2006-2010 Applied", "2011-2015 Applied"))
#table(res.plot$type, res.plot$time, res.plot$col)

#pdf(file="figures/subsahara/4.3.1_ResearchProportion_9March18.pdf", width = 11, height= 7)

ggplot(res.plot.sub, aes(percent, fill=ID)) +
    geom_histogram(position='dodge', binwidth=10, bins=seq(0, 100, 10))  +
    guides(fill=guide_legend(title=NULL, reverse=FALSE, nrow=2)) +
    labs(x="Percent", y="Number of responses", title="Type of research by proportion")+
    theme(aspect.ratio=3/4, panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),legend.text=element_text(size = 9),
          strip.text.y = element_text(size=12, face="bold", color="black"),
          strip.background = element_rect(colour="white", fill="white"),
          legend.position=c(0.7, 0.92), 
          #legend.margin=unit(100,"cm"),
          axis.title.y=element_text(size=11),
          axis.title.x=element_text(size=11), axis.text.x=element_text(size=9), axis.text.y=element_text(size=9), title=element_text(size = 12), plot.title = element_text(hjust = 0.5)) + colScale + 
  scale_x_continuous(breaks=seq(0,100,10))+scale_y_continuous(expand=c(0,0), limits=c(0,6),breaks=c(0,2,4,6))

#dev.off()

#+annotate('text',5.4 ,294, label="(a)", size=5)

```

```{r echo=FALSE, fig.cap="Figure 4.3 (different layout) Respondents type of research describe in proportal amounts of fundamental, use-inspired and applied research. Reseachers were questioned about the percentage of funding allocated to Fundamental, Use-inspired or Applied research in the past and in their current research.", message=FALSE, warning=FALSE, fig.width=11, fig.height=7}

# select for subsaraha countries
research.subsahara<-research[research$nation%in%subsaharaafrica,]
research.subsahara <- droplevels(research.subsahara)
#check
unique(research.subsahara$nation)

## make sure that Use-inspired is the middle level in the legend
res.plot.sub<-subset(research.subsahara, type%in%c("percent_fundemental_research_current",  "percent_Applied_Research_current" , "percent_Use_inspired_Research_current","percent_Applied_Research_past",  "percent_Fundamental_Research_past" , "percent_Use_inspired_Research_past"))

res.plot.sub$percent<-str_replace_all(res.plot.sub$percent, "%", "")
res.plot.sub$percent<-as.numeric(as.character(res.plot.sub$percent))
res.plot.sub$type<-as.character(res.plot.sub$type)

# add time variable
res.plot.sub$time<-ifelse(grepl( "current", res.plot.sub$type),"Current", "Past")
res.plot.sub$type[res.plot.sub$type=="percent_Applied_Research_past"]<-"Applied"
res.plot.sub$type[res.plot.sub$type=="percent_Applied_Research_current"]<-"Applied"
res.plot.sub$type[res.plot.sub$type=="percent_Fundamental_Research_past"]<-"Fundamental"
res.plot.sub$type[res.plot.sub$type=="percent_fundemental_research_current"]<-"Fundamental"
res.plot.sub$type[res.plot.sub$type=="percent_Use_inspired_Research_past"]<-"Use-inspired"
res.plot.sub$type[res.plot.sub$type=="percent_Use_inspired_Research_current"]<-"Use-inspired"
res.plot.sub$time[res.plot.sub$time=="Current"]<-"2011-2015"
res.plot.sub$time[res.plot.sub$time=="Past"]<-"2006-2010"

# change order of the levels
#res.plot.sub$time<-as.factor(res.plot.sub$time)
#res.plot.sub$time<-factor(res.plot.sub$time, levels(res.plot.sub$time)[c(2,1)])

res.plot.sub$type<-as.factor(res.plot.sub$type)
res.plot.sub$type<-factor(res.plot.sub$type, levels(res.plot.sub$type)[c(2,3,1)])

res.plot.sub$time<-factor(res.plot.sub$time)
res.plot.sub$time<-factor(res.plot.sub$time, levels(res.plot.sub$time)[c(1,2)])

#myColors<-(brewer.pal(9, "Blues"))
#myColors<-myColors[c(5,9)]
#colScale <- scale_fill_manual(name = "time",values = myColors)

res.plot.sub$ID<-paste(res.plot.sub$type, res.plot.sub$time)

# change order of the levels
res.plot.sub$ID<-as.factor(res.plot.sub$ID)
res.plot.sub$ID<-factor(res.plot.sub$ID, levels(res.plot.sub$ID)[c(4,3,6,5,2,1)])


# add colours 
mycols<-c('#33a02c','#a6cee3','#fb9a99','#1f78b4', '#e31a1c','#b2df8a')
mycols<-as.data.frame(mycols)
mycols$ID<-levels(res.plot.sub$ID)
res.plot.sub$col<-mycols$mycols[match(res.plot.sub$ID, mycols$ID)]
res.plot.sub$col<-factor(res.plot.sub$col, levels(res.plot.sub$col)[c(3,5,4,2,6,1)])
mycols<-as.character(unique(res.plot.sub$col))
colScale <- scale_fill_manual(name = "ID",values =mycols, labels=c("2006-2010", "2011-2015"))


#ggplot(res.plot.sub, aes(percent, fill=time)) +
#    geom_histogram(position='dodge', binwidth=10, bins=seq(0, 100, 10))  +
#    guides(fill=guide_legend(title=NULL, reverse=FALSE, nrow=2)) +
#    labs(x="Percent", y="Number of responses", title="")+
#    theme(panel.grid.major = element_blank(),
#          panel.grid.minor = element_blank(),
#          strip.text.y = element_text(size=12, face="bold", color="black"),
#          strip.background = element_rect(colour="white", fill="white"),
#          legend.position=c(0.95, 0.19), legend.margin=unit(100,"cm")) + 
#    facet_wrap(~type, nrow=3) + colScale +
#  scale_x_continuous(breaks=seq(0,100,10))+scale_y_continuous(expand=c(0,0), limits=c(0,300),breaks=c(0,100,200,300))

library(gridExtra)
#####add (a)
xs <- split(res.plot.sub,f = res.plot.sub$type)
p1 <- ggplot(xs$Fundamental,aes(percent, fill=time)) +
    geom_histogram(position='dodge', binwidth=10, bins=seq(0, 100, 10))  +
    guides(fill=guide_legend(title=NULL, reverse=FALSE, nrow=2)) +
    labs(x="Percent", y="Number of responses", title="Type of research by proportion")+
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          strip.text.x = element_text(size=12, face="bold", color="black"),
          strip.background = element_rect(colour="white", fill="white"),
          legend.position=c(0.93, 0.74), legend.spacing=unit(100,"cm"), plot.title = element_text(hjust = 0.5))+ 
    facet_wrap(~type, nrow=3) +
  scale_x_continuous(breaks=seq(0,100,10))+scale_y_continuous(expand=c(0,0), limits=c(0,6),breaks=c(0,2,4,6))

p2 <- p1 %+% xs$`Use-inspired`
p3 <- p1 %+% xs$Applied
p1<-p1+scale_fill_manual(name = "ID",values =mycols[4:5], labels=c("2006-2010", "2011-2015"))+labs(x="")+ theme(plot.margin=unit(c(1,1,-0.45,1), "cm"))
p2<-p2+scale_fill_manual(name = "ID",values =mycols[c(6,1)], labels=c("2006-2010", "2011-2015"))+labs(x="",title="")+ theme(plot.margin=unit(c(-0.25,1,-0.3,1), "cm"))
p3<-p3+scale_fill_manual(name = "ID",values =mycols[2:3], labels=c("2006-2010", "2011-2015"))+ labs(title="")+ theme(plot.margin=unit(c(-0.5,1,1,1), "cm"))


#pdf(file="figures/subsahara/4.3.2_ResearchProportion_9March18.pdf", width = 11, height= 7)

#grid.arrange(p1,p2,p3, left= textGrob("(a)", gp = gpar(fontsize=14), y=0.93, hjust = -.75), heights=c(0.35,0.3,0.35))
grid.arrange(p1,p2,p3, heights=c(0.35,0.3,0.35))

#dev.off()
```


```{r eval=FALSE, fig.cap="Figure 4.4a&b Change in research type proportions and the reasons. Researchers were asked to answer yes, no, or can't comment on if their type of research had changed in the last 10 years and to select what reasons for the change applied to them.",  message=FALSE, include=FALSE,warning=FALSE, fig.width=11, fig.height=7}

# select for subsaraha countries
research.change.subsahara<-research.change[research.change$nation%in%subsaharaafrica,]
research.change.subsahara <- droplevels(research.change.subsahara)
#check
unique(research.change.subsahara$nation)

#Change yes or no
yes.no<-subset(research.change.subsahara, select=c("Location","Country", "Country_work",  "gender", "changed_10yrs"))

yes.no.sub<-aggregate(Country~ changed_10yrs, yes.no, length)
yes.no.sub<-yes.no.sub[!yes.no.sub$changed_10yrs=="",]

p1<-ggplot(data=yes.no.sub, aes(x=changed_10yrs, y=Country, fill=Country))+ geom_bar(stat='identity') + guides(fill=FALSE)+
  theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), axis.title.x=element_blank(), plot.title = element_text(hjust = 0.5))+
  geom_text(aes(label=Country), vjust=-0.5)+labs(y="Number of responses", title="Change in research type")+ scale_y_continuous(expand = c(0, 0), limits = c(0,15))+ annotate('text', 0.5,14.3, label="(a)", size=5)

####reason for change  
reason.sub<-subset(research.change.subsahara, select=c("Location","Country","Country_work",  "gender", "Main_reason_change_interest_related",
                                       "Main_reason_change_Career_related","Main_reason_change_Funding_related", "Main_reason_change_Socially_related","Main_reason_change_Other"))

# switch to long format
require(tidyr)
sub.long<-gather(reason.sub, reason.change.sub, yes.sub, -Location, -gender, -Country_work, -Country)
# using table to count cases of each category
sum.sub<-data.frame(table(sub.long$reason.change.sub, sub.long$yes.sub))
#remove non-response
sum.sub<-sum.sub[!sum.sub$Var1=="",]

sum.sub$Var1<-revalue(sum.sub$Var1, c("Main_reason_change_Career_related" = "Career", "Main_reason_change_Funding_related" = "Funding", "Main_reason_change_interest_related" = "Interest", "Main_reason_change_Other" = "Other", "Main_reason_change_Socially_related"  = "Social"))
# change order of the levels
sum.sub$Var1<-factor(sum.sub$Var1,levels(sum.sub$Var1)[c(2,3,1,5,4)])

myColors4<-(brewer.pal(9, "Blues"))
myColors4<-myColors4[c(9, 8,7,6,5,3)]

p2<-ggplot(sum.sub, aes(x=Var1, y=Freq, fill=Var1)) + geom_bar(stat='identity')+ 
  theme( axis.text.x = element_text(angle=0, vjust=0.5, size=9), axis.text.y=element_text(size = 9), axis.title=element_text(size = 11), panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),legend.text=element_text(size = 9),axis.title.x=element_blank(), plot.title = element_text(hjust = 0.5)) +guides(fill=FALSE) +
  scale_fill_manual(name = "Var1",values = myColors4)+
  labs(y="Number of responses", title="Reason for change in research type")+
  scale_y_continuous(expand = c(0, 0), limits = c(0, 10))+annotate('text', 5.4,9.6, label="(b)", size=5)+geom_text(aes(label=Freq), vjust=-0.5, size=3)

# 
# pdf(file="figures/subsahara/4.4_ReasonForFieldChange_9March19.pdf", width = 11, height= 7)
# 
# print(p2)
# 
# dev.off()
# 
# pdf(file="figures/subsahara/4.4a&b_ReasonForFieldChange_9March18.pdf", width = 11, height= 7)
# 
grid.arrange(p1, p2, widths=c(0.5, 0.5), nrow=1)
# 
# dev.off()
```

```{r echo=FALSE, fig.cap="Figure 4.5 View of change in proportion of research. Researchers were asked how they viewed the change in the type of research they conduct/supervise.", fig.width=11, fig.height=7, message=FALSE, warning=FALSE}

view.propor.sub<-subsahara[!subsahara$view_change_of_type=="",]
view.propor.sub<-droplevels(view.propor.sub)
change.view.sub<-aggregate(gender~ view_change_of_type, view.propor.sub, length)
# change order of the levels
change.view.sub$view_change_of_type<-factor(change.view.sub$view_change_of_type, 
                                        levels(change.view.sub$view_change_of_type)[c(5,3,1,2,4)])

myColors5<-(brewer.pal(9, "Blues"))
myColors5<-myColors5[c(4,4,4,4,4,4)]

#pdf(file="figures/subsahara/4.5_ViewFieldChange_10March18.pdf", width = 11, height= 7)

ggplot(change.view.sub, aes(x=view_change_of_type, y=gender, fill=view_change_of_type)) + geom_bar(stat='identity')+
  theme(aspect.ratio=3/4, axis.text.x = element_text(angle=0, vjust=0.5, size=9), axis.text.y = element_text(size = 9), axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11), plot.title = element_text(hjust = 0.5)) +guides(fill=FALSE)+
  theme(panel.grid.major = element_blank(),legend.text=element_text(size = 9), panel.grid.minor = element_blank())+ labs(x="", y="Number of responses", title="Opinion of research type change")+geom_text(aes(label=gender), vjust=-0.5, size=3)+scale_y_continuous(expand = c(0, 0), limits = c(0,6))+scale_fill_manual(name='view_change_of_type', values=myColors5)#+annotate('text', 5.4,133, label="(c)", size=5)

#dev.off()
```

```{r eval=FALSE, fig.cap="Figure Type of research (4.3, 4.4, 4.5 )", fig.width=11, fig.height=7, message=FALSE, warning=FALSE, include=FALSE}
######*************!!!!!!!!!!! Not updated !!!!!!!!!!************##########
##plot 1

#old version which is now the correct version
#xs <- split(res.plot,f = res.plot$type)
#p1 <- ggplot(xs$Fundamental,aes(percent, fill=time)) +
#    geom_histogram(position='dodge', binwidth=10, bins=seq(0, 100, 10))  +
#    guides(fill=guide_legend(title=NULL, reverse=FALSE, nrow=2)) +
#    labs(x="Percent", y="Number of responses", title="")+
#    theme(panel.grid.major = element_blank(),
#          panel.grid.minor = element_blank(),
#          strip.text.x = element_text(size=12, face="bold", color="black"),
#          strip.background = element_rect(colour="white", fill="white"),
#          legend.position=c(0.93, 0.795), legend.spacing=unit(100,"cm"))+ 
#    facet_wrap(~type, nrow=3) +
#  scale_x_continuous(breaks=seq(0,100,10))+scale_y_continuous(expand=c(0,0), limits=c(0,35),breaks=c(0,10,20,30))

#p2 <- p1 %+% xs$`Use-inspired`
#p3 <- p1 %+% xs$Applied
#p1<-p1+scale_fill_manual(name = "ID",values =mycols[4:5], labels=c("2006-2010", "2011-2015"))+labs(x="")+ theme(plot.margin=unit(c(1,1,-0.45,1), "cm"))
#p2<-p2+scale_fill_manual(name = "ID",values =mycols[c(6,1)], labels=c("2006-2010", "2011-2015"))+labs(x="")+ theme(plot.margin=unit(c(-0.25,1,-0.3,1), "cm"))
#p3<-p3+scale_fill_manual(name = "ID",values =mycols[2:3], labels=c("2006-2010", "2011-2015"))+ theme(plot.margin=unit(c(-0.5,1,1,1), "cm"))
#grid.arrange(p1,p2,p3, left= textGrob("(a)", gp = gpar(fontsize=14), y=0.93, hjust = -.75), heights=c(0.35,0.3,0.35))


## newer version - 
# add colours to res.plot
mycols<-c('#33a02c','#a6cee3','#fb9a99','#1f78b4', '#e31a1c','#b2df8a')
mycols<-as.data.frame(mycols)
mycols$ID<-levels(res.plot$ID)
res.plot$col<-mycols$mycols[match(res.plot$ID, mycols$ID)]
res.plot$col<-factor(res.plot$col, levels(res.plot$col)[c(3,1,4,2,6,5)])
mycols<-as.character(unique(res.plot$col))
colScale <- scale_fill_manual(name = "ID",values =mycols, labels=c("2006-2010\nFundamental", "2011-2015\nFundamental","2006-2010\nUse-inspired", "2011-2015\nUse-inspired","2006-2010\nApplied", "2011-2015\nApplied"))

g1<-ggplot(res.plot, aes(percent, fill=ID)) +
    geom_histogram(position='dodge', binwidth=20, bins=seq(0, 100, 20))  +
    guides(fill=guide_legend(title=NULL, reverse=FALSE, nrow=2)) +
    labs(x="Percent", y="Number of responses", title="")+
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),legend.text=element_text(size = 9),
          strip.text.y = element_text(size=12, face="bold", color="black"), legend.key.size=unit(0.65,"cm"),legend.key=element_rect(color=NA, size=40),
          strip.background = element_rect(colour="white", fill="white"),
          legend.position=c(0.78, 0.91), legend.margin=unit(100,"cm"), axis.title.y=element_text(size=11),
          axis.title.x=element_text(size=11), axis.text.x=element_text(size=9), axis.text.y=element_text(size=9), title=element_text(size = 12), plot.title = element_text(hjust = 0.5)) + colScale + 
  scale_x_continuous(breaks=seq(0,100,20), expand = c(0.015,0.015))+scale_y_continuous(expand=c(0,0), limits=c(0,650),breaks=c(0,100,200,300,400,500,600)) +annotate('text', -9,388, label="(a)", size=5)
g1

###plot2

myColors4<-(brewer.pal(9, "Blues"))
myColors4<-myColors4[c(9, 8,7,6,5,3)]

g2<-ggplot(sum.israel, aes(x=Var1, y=Freq, fill=Var1)) + geom_bar(stat='identity')+ 
  theme( axis.text.x = element_text(angle=0, vjust=0.5, size=9), axis.text.y=element_text(size = 9), axis.title=element_text(size = 11),panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),legend.text=element_text(size = 9),axis.title.x=element_blank(), plot.title = element_text(hjust = 0.5)) +guides(fill=FALSE) +scale_fill_manual(name = "Var1",values = myColors4)+
  labs(y="Number of responses", x="")+
  scale_y_continuous(expand = c(0, 0), limits = c(0,43))+annotate('text', 5.35,423, label="(b)", size=5)+
  scale_x_discrete(labels=c("Funding\n  ", "Interest\n  ", 
                                    "Career\n  ", "Social\n  ", "Other\n  "))+geom_text(aes(label=Freq), vjust=-0.5, size=3)


###plot 3
myColors5<-(brewer.pal(9, "Blues"))
myColors5<-myColors5[c(4,4,4,4,4,4)]

g3<-ggplot(change.view.is, aes(x=view_change_of_type, y=gender, fill=view_change_of_type)) + geom_bar(stat='identity')+
  theme(axis.text.x = element_text(angle=0, vjust=0.5, size=9), axis.text.y = element_text(size = 9), axis.title.y = element_text(size = 11), axis.title.x = element_text(size = 11)) +guides(fill=FALSE)+
  theme(panel.grid.major = element_blank(),legend.text=element_text(size = 9), panel.grid.minor = element_blank(), plot.title = element_text(hjust = 0.5))+ labs(x=NULL, y="Number of responses")+geom_text(aes(label=gender), vjust=-0.5, size=3)+scale_y_continuous(expand = c(0, 0), limits = c(0,20))+scale_fill_manual(name='view_change_of_type', values=myColors5)+annotate('text', 5.35,133, label="(c)", size=5)+scale_x_discrete(labels=c("Very\npositive", "Slightly\npositive", 
                                    "Neutral", "Slightly\nnegative", "Very\nnegative"),limits = rev(levels(change.view.is$gender)))

#width<-matrix(c(50,10,50,10), ncol=1, nrow = 2)
g4<-NULL # to make a blank spot for 'a'

multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}

##Make layout - update changing 'a' back to the original (3 figures instead of one) so 'a' is wrong in this
#pdf(file="figures/4.1_13apr_with.wrong.a.pdf", width = 8, height = 11)
#multiplot(g1, g2, g3, layout = matrix(c(1,1,2,3),nrow=2, byrow=TRUE))

##Make the layout but with the 'a' spot empty so the real 'a' can be put in by copy editor if I dont have time to try it on here
#pdf(file="figures/4.1b.c._ResearchFoci_13apr_blank.a.pdf", width = 8, height = 11)
multiplot(g1, g2, g3, layout = matrix(c(1,1,2,3),nrow=2, byrow=TRUE))

##trying to put the right (old version) into the layout ###havent gotten it to work yet
#pdf(file="figures/4.1_13apr_right.a.pdf", width = 8, height = 11)
#multiplot(arr(p1,p2,p3, left= textGrob("(a)", gp = gpar(fontsize=14), y=0.93, hjust = -.75), heights=c(0.35,0.3,0.35)), g2, g3, layout = matrix(c(1,1,1,1,1,1,2,3),nrow=4, byrow=TRUE))



#dev.off()
```


<!--Part 2 - External Partnerships-->
<!--**4.2 External Partnerships**   -->

```{r echo=FALSE, fig.cap="Figure 4.6 Current vs past level of partnership outside of academia. Researchers indicated the level of partnership that their current and past (10 years ago) research program had outside of academia).", message=FALSE, warning=FALSE, fig.width=11, fig.height=7}

b.part.sub<-data.frame(table(subsahara$partnership_outside_before))
b.part.sub<-b.part.sub[!b.part.sub$Var1=="",]
b.part.sub<-droplevels(b.part.sub)
b.part.sub$time<-"Past"
a.part.sub<-data.frame(table(subsahara$partnership_outside))
a.part.sub<-a.part.sub[!a.part.sub$Var1=="",]
a.part.sub<-droplevels(a.part.sub)
a.part.sub$time<-"Current"

part.sub<-rbind(a.part.sub, b.part.sub)
part.sub$Var1<-factor(part.sub$Var1, levels(part.sub$Var1)[c(1,4,3,2)])
part.sub$time<-factor(part.sub$time)
part.sub$time<-factor(part.sub$time, levels(part.sub$time)[c(2,1)])

myColors6<-(brewer.pal(9, "Blues"))
myColors6<-rev(myColors6[c(9, 5)])
colScale <- scale_fill_manual(name = "Var1",values = myColors6)

#pdf(file="figures/subsahara/4.6_LevelsOfPartnership_10March18.pdf", width = 11, height= 7)

ggplot(part.sub, aes(x=Var1, y=Freq, fill = time)) + 
  geom_bar( stat='identity', position="dodge") +
  geom_text(aes(label=Freq), position=position_dodge(width=1), vjust=-0.5, size=3) +
  labs(x="", y="Number of responses", fill="", title="Levels of partnerships outside of academia")+
  theme(aspect.ratio=3/4, panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.key=element_blank(),legend.text=element_text(size = 9),
        axis.text.x = element_text(angle=0, size=9), axis.text.y=element_text(size = 9), axis.title=element_text(size = 11), 
        legend.position=c(0.08, 0.94), 
        legend.title=element_blank(), plot.title = element_text(hjust = 0.5)) +
  colScale+scale_y_continuous(expand = c(0, 0), limits = c(0,16))

#dev.off()
```

```{r echo=FALSE, fig.cap="Figure 4.7a&b Did it change and reasons for change in level of external research partnerships over the past decade.", message=FALSE, warning=FALSE, fig.width=11, fig.height=7}
### was there change

change.part.sub<-data.frame(table(subsahara$partnership_change_10yrs))
change.part.sub<-change.part.sub[!change.part.sub$Var1=="",]
change.part.sub$Var1<-revalue(change.part.sub$Var1, c("Can't comment (new researcher)"="Can't comment"))
change.part.sub$Var1<-factor(change.part.sub$Var1, levels=c("Yes", "No", "Can't comment"))
myColors<-(brewer.pal(9, "Blues"))
myColors<-myColors[c(9, 7,5)]
g1<-ggplot(data=change.part.sub, aes(x=Var1, y=Freq, fill=Var1))+ 
    geom_bar(stat='identity') + 
    guides(fill=FALSE) + 
    labs(x="", y="Number of responses",title="Change in level of partnership")+
  geom_text(aes(label=Freq), vjust=-0.5)+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), plot.title = element_text(hjust = 0.5)) + 
  scale_fill_manual(name = "Var1",values = myColors) +
  #annotate('text', 3.25,606, label="(a)", size=7)+
  scale_y_continuous(expand = c(0, 0), limits = c(0,15))

### reason

# select for subsaraha countries
part2.reason.sub<-part2.reason[part2.reason$nation%in%subsaharaafrica,]
part2.reason.sub <- droplevels(part2.reason.sub)
#check
unique(part2.reason.sub$nation)

reason.pt.long<-gather(part2.reason.sub, change.reason, yes, -Country,-Country_work, -gender, -nation, -Location, -what_participant_group, -field_research)
sum.subsahara<-data.frame(table(reason.pt.long$change.reason, reason.pt.long$yes))

sum.subsahara$Var1<-revalue(sum.subsahara$Var1, c("reason_partnership_change_career" = "Career", "reason_partnership_change_funding" = "Funding", "reason_partnership_change_interest" = "Interest", "reason_partnership_change_other" = "Other", "reason_partnership_change_socially"  = "Social"))
sum.subsahara$Var1<-reorder(sum.subsahara$Var1, -sum.subsahara$Freq)

myColors7<-(brewer.pal(9, "Blues"))
myColors7<-myColors7[c(9, 8,7,6,5,3)]

g2<-ggplot(sum.subsahara, aes(x=Var1, y=Freq, fill=Var1)) + 
    geom_bar(stat='identity')+  guides(fill=FALSE) +
    theme(axis.text.x = element_text(angle=0, vjust=0.5, size = 9), axis.text.y=element_text(size = 9), axis.title.y=element_text(size = 11),
          legend.position=c(0.8, 0.8), 
          legend.title=element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), plot.title = element_text(hjust = 0.5)) + 
  geom_text(aes(label=Freq), vjust=-0.5, size=3)+
  labs(x="", y="Number of responses", title="Reason for change in level of partnership")+scale_fill_manual(name = "Var1",values = myColors7)+
  scale_y_continuous(expand = c(0, 0), limits = c(0,7))

#annotate('text', 5,420, label="(b)", size=7)+ 

#pdf(file="figures/subsahara/4.7a&b_PartnershipChange&Reason_10March18.pdf", width = 11, height= 7)

grid.arrange(g1, g2, ncol=1)

#dev.off()

```

```{r echo=FALSE, fig.cap="Figure 4.8 View of change in external partnerships. Researchers were asked how they viewed the change in the level of partnership with external groups.", message=FALSE, warning=FALSE, fig.width=11, fig.height=7}

view.sub<-data.frame(table(subsahara$view_change_partnership))
view.sub<-view.sub[!view.sub$Var1=="",]

# change order of the levels

view.sub$Var1<-factor(view.sub$Var1, levels(view.sub$Var1)[c(6,4,2,3,5)])

myColors8<-(brewer.pal(9, "Blues"))
myColors8<-myColors8[c(4,4,4,4,4)]
colScale <- scale_fill_manual(name = "Var1",values = myColors8)

#pdf(file="figures/subsahara/4.8_ViewChangePartnership_10March18.pdf", width = 11, height= 7)

ggplot(view.sub, aes(x=Var1, y=Freq, fill=Var1)) + geom_bar(stat='identity')+
  geom_text(aes(label=Freq, vjust=-0.5), size=3)+
  guides(fill=FALSE)+
  theme(aspect.ratio=3/4, panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle=0, vjust=0, size=9), axis.text.y=element_text(size = 9), axis.title.y=element_text(size=11), plot.title = element_text(hjust = 0.5)) + 
  labs(x="", y="Number of responses", title="Opinion of change in partnership level") + colScale+scale_y_continuous(expand = c(0, 0), limits = c(0,10), breaks = seq(0,10,2))

#dev.off()

```
 
```{r eval=FALSE, fig.cap="Figure ( 4.6 + 4.7 + 4.8 ) External Research Partnerships. ", message=FALSE, warning=FALSE, include=FALSE}
###4.6
myColors6<-(brewer.pal(9, "Blues"))
myColors6<-rev(myColors6[c(9, 5)])
colScale <- scale_fill_manual(name = "Var1",values = myColors6)

p4<-ggplot(part, aes(x=Var1, y=Freq, fill = time),  ylim(0,375)) + 
  geom_bar( stat='identity', position="dodge") +
  geom_text(aes(label=Freq), position=position_dodge(width=1), vjust=-0.5, size=3) +
  labs(x="", y="", fill="")+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.key=element_blank(),legend.text=element_text(size = 9),
        axis.text.x = element_text(angle=0, size=9), axis.text.y=element_text(size = 9), axis.title=element_text(size = 11), 
        legend.position=c(0.93, 0.88), 
        legend.title=element_blank(), plot.title = element_text(hjust = 0.5)) +
  colScale+scale_y_continuous(expand = c(0, 0), limits = c(0,35))+scale_x_discrete(limits = rev(levels(part$Var1)))+annotate('text', 0.5,337, label="(a)", size=5)+labs(y="Number of responses")
p4

###4.7
myColors7<-(brewer.pal(9, "Blues"))
myColors7<-myColors7[c(9, 8,7,6,5,3)]

p5<-ggplot(sum.israel, aes(x=Var1, y=Freq, fill=Var1)) + 
    geom_bar(stat='identity')+  guides(fill=FALSE) +
    theme( axis.text.x = element_text(angle=0, vjust=0.5, size = 9), axis.text.y=element_text(size = 9), axis.title.y=element_text(size = 11),
          legend.position=c(0.8, 0.78), 
          legend.title=element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), plot.title = element_text(hjust = 0.5)) + 
  geom_text(aes(label=Freq), vjust=-0.5, size=3)+
  labs(x="", y="Number of responses")+scale_fill_manual(name = "Var1",values = myColors7)+
  scale_y_continuous(expand = c(0, 0), limits = c(0,32))+annotate('text', 5.3,431, label="(b)", size=5)+scale_x_discrete(labels=c("Funding\n ", "Interest\n", 
                                    "Career\n", "Social\n", "Other\n "))
p5

###4.8
myColors8<-(brewer.pal(9, "Blues"))
myColors8<-myColors8[c(4,4,4,4,4)]
colScale <- scale_fill_manual(name = "Var1",values = myColors8)

p6<-ggplot(view, aes(x=Var1, y=Freq, fill=Var1)) + geom_bar(stat='identity')+
  geom_text(aes(label=Freq, vjust=-0.5), size=3)+
  guides(fill=FALSE)+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle=0, vjust=0, size=9), axis.text.y=element_text(size = 9), axis.title.y=element_text(size=11), plot.title = element_text(hjust = 0.5)) + 
  labs(x="", y="") + colScale + scale_y_continuous(expand = c(0, 0), limits = c(0,22), breaks = seq(0,10,10))+scale_x_discrete(labels=c("Very\npositive", "Slightly\npositive", "Neutral", "Slightly\nnegative", "Very\nnegative"))+annotate('text', 0.65,158, label="(c)", size=5)
p6


#put them all together


multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}

#pdf(file="figures/4.2_13Apr.pdf")

multiplot(p4, p5, p6, layout = matrix(c(1,1,2,3),nrow=2, byrow=TRUE))

 
#dev.off()

```
 
 
 
 
<!--Part 3 - Grant Application History-->
<!--**4.3 Research Grants**  -->


```{r echo=FALSE, fig.cap="Fig. 4.9 Number of research grant applications by research category in 2006-2010 and 2011-2015.", fig.width=11, fig.height=7, message=FALSE, warning=FALSE}
part3.grants.long<-read.csv(file="../data/gya-part3.grants.long.csv")

# select for subsaraha countries
part3.grants.long.sub<-part3.grants.long[part3.grants.long$nation%in%subsaharaafrica,]
part3.grants.long.sub <- droplevels(part3.grants.long.sub)
#check
unique(part3.grants.long.sub$nation)


part3.grants.long.sub$type.grant<-as.character(part3.grants.long.sub$type.grant)


#add time variable
part3.grants.long.sub$time<-ifelse(grepl("11_15", part3.grants.long.sub$type.grant), "2011-2015", "2006-2010")
part3.grants.long.sub$type.grant[part3.grants.long.sub$type.grant=="external_pi_grant_11_15_fundamental"]<-"Fundamental"
part3.grants.long.sub$type.grant[part3.grants.long.sub$type.grant=="external_pi_grant_6_10_fundamental"]<-"Fundamental"
part3.grants.long.sub$type.grant[part3.grants.long.sub$type.grant=="external_pi_grant_11_15_use"]<-"Use-Inspired"
part3.grants.long.sub$type.grant[part3.grants.long.sub$type.grant=="external_pi_grant_6_10_use"]<-"Use-Inspired"
part3.grants.long.sub$type.grant[part3.grants.long.sub$type.grant=="external_pi_grant_11_15_applied"]<-"Applied"
part3.grants.long.sub$type.grant[part3.grants.long.sub$type.grant=="external_pi_grant_6_10_applied"]<-"Applied"

grants.sub<-data.frame(with(part3.grants.long.sub, table(type.grant,time,number)))
grants.sub$type.grant<-as.factor(grants.sub$type.grant)


#change order of levels
grants.sub$number<-factor(grants.sub$number, levels(grants.sub$number)[c(1,2,6,7,3,4,5)])
grants.sub$type.grant<-factor(grants.sub$type.grant, levels(grants.sub$type.grant)[c(2,3,1)])

grants.sub$ID<-paste(grants.sub$type.grant, grants.sub$time)

# change order of the levels
grants.sub$ID<-as.factor(grants.sub$ID)
grants.sub$ID<-factor(grants.sub$ID, levels(grants.sub$ID)[c(4,3,6,5,2,1)])

##colors
mycols<-c('#33a02c','#a6cee3','#fb9a99','#1f78b4', '#e31a1c','#b2df8a')

#pdf(file="figures/subsahara/4.9_NumberGrantApps_10March18.pdf", height=7, width =11)


#####add (a)
xs <- split(grants.sub,f = grants.sub$type.grant)
p1 <- ggplot(xs$Fundamental, aes(number, Freq, fill=time), width=0.7) + 
    geom_bar(stat="identity", position = "dodge")+
    #facet_wrap(~type.grant, ncol=3) +
    guides(fill=guide_legend(title=NULL, reverse=FALSE)) +
    labs(x="Number of grant applications", y="Number of responses")+
    theme(aspect.ratio=4/3, panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          legend.key=element_blank(),
           strip.text.x = element_text(size=12, face="bold", color="black"),
          strip.background = element_rect(colour="white", fill="white"),
          legend.position=c(0.81, 0.91), legend.text=element_text(size = 9), axis.title.x=element_text(size = 11),
          axis.title.y=element_text(size=11), axis.text.x=element_text(size=9), axis.text.y=element_text(size=9), plot.title = element_text(hjust = 0.5)) + 
  colScale+scale_y_continuous(expand = c(0, 0), limits = c(0,20), breaks = c(0,5,10,15,20))

p2 <- p1 %+% xs$`Use-Inspired`
p3 <- p1 %+% xs$Applied
p1<-p1+scale_fill_manual(name = "ID",values =mycols[c(2,4)], labels=c("2006-2010", "2011-2015"))+labs(title="Fundamental")+ theme(plot.title = element_text(size=12, hjust=0.5, face = "bold"))
p2<-p2+scale_fill_manual(name = "ID",values =mycols[c(6,1)], labels=c("2006-2010", "2011-2015"))+labs(title="Use-inspired")+ theme(plot.title = element_text(size=12, hjust=0.5, face = "bold"))
p3<-p3+scale_fill_manual(name = "ID",values =mycols[c(3,5)], labels=c("2006-2010", "2011-2015"))+labs(title="Applied")+ theme(plot.title = element_text(size=12, hjust=0.5, face = "bold"))

grid.arrange(p1,p2,p3, nrow=1, top=textGrob("Number of research grant applications",gp=gpar(fontsize=17)))

#dev.off()

```

```{r echo=FALSE, fig.cap="Fig 4.10 Research grant application success over the past 10 years. Researchers were asked to estimate the percentage of their research grant applications that were successful, in 2006-2010 and in 2011-2015. Respondents also had the choice to answer No need for applications for this research type.", message=FALSE, fig.width=11, fig.height=7}
part3.success.long<-read.csv(file="../data/gya-part3.success.long.csv")

# select for subsaraha countries
part3.success.long.sub<-part3.success.long[part3.success.long$nation%in%subsaharaafrica,]
part3.success.long.sub <- droplevels(part3.success.long.sub)
#check
unique(part3.success.long.sub$nation)

part3.success.long.sub$type<-as.character(part3.success.long.sub$type)

#add time variable
part3.success.long.sub$time<-ifelse(grepl("11_15", part3.success.long.sub$type), "2011-2015", "2006-2010")
part3.success.long.sub$type[part3.success.long.sub$type=="successful_grants_11_15_fundamental"]<-"Fundamental"
part3.success.long.sub$type[part3.success.long.sub$type=="successful_grants_6_10_fundamental"]<-"Fundamental"
part3.success.long.sub$type[part3.success.long.sub$type=="successful_grants_11_15_use"]<-"Use-Inspired"
part3.success.long.sub$type[part3.success.long.sub$type=="successful_grants_6_10_use"]<-"Use-Inspired"
part3.success.long.sub$type[part3.success.long.sub$type=="successful_grants_11_15_applied"]<-"Applied"
part3.success.long.sub$type[part3.success.long.sub$type=="successful_grants_6_10_applied"]<-"Applied"

success.sub<-data.frame(with(part3.success.long.sub, table(type, percent,time)))

#change order of types
success.sub$type<-as.factor(success.sub$type)
success.sub$type<-factor(success.sub$type, levels(success.sub$type)[c(2,3,1)])

success.sub$id<-paste(success.sub$type, success.sub$time)

# change order of the levels
success.sub$id<-as.factor(success.sub$id)
success.sub$id<-factor(success.sub$id, levels(success.sub$id)[c(3,4,5,6,1,2)])

mycols10<-c('#1f78b4','#a6cee3','#33a02c','#b2df8a','#e31a1c', '#fb9a99')
mycols10<-as.data.frame(mycols10)
mycols10$id<-levels(success.sub$id)
success.sub$col<-mycols10$mycols10[match(success.sub$id, mycols10$id)]
success.sub$col<-factor(success.sub$col, levels(success.sub$col)[c(3,1,4,2,6,5)])

#pdf(file="figures/subsahara/4.10_GrantAppSuccess_10March18.pdf", height=7, width =11)

out2<-by(data = success.sub, INDICES = success.sub$type, FUN = function(n){
  n <- droplevels(n)
  n$col<-factor(n$col, levels(n$col)[c(3,1,4,2,6,5)])
  mycols10<-as.character(unique(n$col))
  colScale <- scale_fill_manual(name = "id",values =mycols10, labels=c("2006-2010", "2011-2015"))
  n <- ggplot(n, aes(percent, Freq, fill=id)) +
    geom_bar(stat="identity", position='dodge')  +
    guides(fill=guide_legend(title=NULL, reverse=FALSE, nrow=2)) +
    labs(x="Percent of successful grants", y="Number of responses", title=n$type)+
    theme(aspect.ratio=1/4, panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          legend.key=element_blank(),legend.text=element_text(size = 9),
          strip.text.x = element_text(size=12, face="bold", color="black", hjust=0.5),
          strip.background = element_rect(colour="white", fill="white"),
           axis.title.y=element_text(size=11),plot.title = element_text(size=12, face="bold", hjust=0.5),
          axis.title.x=element_text(size=11), axis.text.x=element_text(size=9), axis.text.y=element_text(size=9), title=element_text(size = 12)) + colScale +
    scale_y_continuous(expand=c(0,0), limits=c(0,10), breaks = c(0,2,4,6,8,10))
 })
do.call(grid.arrange, out2)

#dev.off()


```
 
```{r eval=FALSE, fig.cap="Fig 4.11 Change in grant success rates over the past 10 years. Researchers were asked if they thought that grant sucecss rates have changed in the past 10 years, for each research category.", message=FALSE, include=FALSE, fig.width=11, fig.height=7}

# select for subsaraha countries
part3.change.sub<-part3.change[part3.change$nation%in%subsaharaafrica,]
part3.change.sub <- droplevels(part3.change.sub)
#check
unique(part3.change.sub$nation)

##switch to long format
change.long.sub<-gather(part3.change.sub, type, level, -Location, -gender, -Country,-nation, -Country_work, -what_participant_group, -field_research)
success.change.sub<-with(change.long.sub, data.frame(table(type, level)))
#remove no response
success.change.sub<-success.change.sub[!success.change.sub$level=="",]
success.change.sub<-droplevels(success.change.sub)

# add colour palette
myColors11<-c('#1f78b4','#33a02c','#e31a1c')
colScale <- scale_fill_manual(name = "type",values = myColors11, labels=c("Fundamental", "Use-inspired", "Applied"))

#change order of levels
success.change.sub$level<-factor(success.change.sub$level, levels(success.change.sub$level)[c(5,4,6,2,3,1)])
success.change.sub$type<-factor(success.change.sub$type, levels(success.change.sub$type)[c(2,3,1)])
success.change.sub$type<-revalue(success.change.sub$type, c("success_change_10yrs_fundamental"="Fundamental",
              'success_change_10yrs_use'='Use-inspired', 'success_change_10yrs_applied' = 'Applied'))

#pdf(file="figures/subsahara/4.11_ChangeSuccessRate_10March18.pdf", height=7, width =11)

ggplot(data=success.change.sub, aes(x=level, Freq, fill=type))+ facet_wrap(~type, nrow=3)+
  geom_bar(stat="identity", position="dodge")+
  guides(fill=guide_legend(title=NULL)) +
  theme(aspect.ratio=1/4, axis.text.x = element_text(angle=0, vjust=0.5, size = 9), axis.text.y=element_text(size = 9), axis.title.y=element_text(size = 11),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
         strip.text.x = element_text(size=12, face="bold", color="black"),
          strip.background = element_rect(colour="white", fill="white"),
        legend.position=c(0.15, 0.9), plot.title = element_text(hjust = 0.5))+
  guides(fill=FALSE)+
  geom_text(aes(label=Freq, vjust=-0.4),size=3) +
  scale_x_discrete(labels=c("Increased\n considerably", "Increased\n slightly", 
                                    "Stayed the\n same", "Decreased\n slightly", "Decreased\n considerably", "Can't\n comment"),limits = (levels(success.change.sub$level)))+
  labs(x="", y="Number of responses", fill="", title="Change in grant success rates")+ colScale+
  scale_y_continuous(expand = c(0, 0), limits = c(0,12))

#dev.off()


```

```{r echo=FALSE, fig.cap="Fig 4.12 Importance of practical application of research over the past 10 years. Researchers were asked how important it was to suggest practical applications of their research to ensure that the grant was successful, in 2006-2010 and in 2011-2015.", message=FALSE, fig.width=11, fig.height=7, include=FALSE}

# select for subsaraha countries
part3.prac.long.sub<-part3.prac.long[part3.prac.long$nation%in%subsaharaafrica,]
part3.prac.long.sub <- droplevels(part3.prac.long.sub)
#check
unique(part3.prac.long.sub$nation)

part3.prac.long.sub$year<-as.character(part3.prac.long.sub$year)

part3.prac.long.sub$year[part3.prac.long.sub$year=="practical_applications_important_11_15"]<-"2011-2015"
part3.prac.long.sub$year[part3.prac.long.sub$year=="practical_applications_important_6_10"]<-"2006-2010"


prac.sub<-data.frame(table(part3.prac.long.sub$year, part3.prac.long.sub$level))

#change order of levels
prac.sub$Var2<-factor(prac.sub$Var2, levels(prac.sub$Var2)[c(2,6,4,5,3,1)])

myColors12<-(brewer.pal(9, "Blues"))
myColors12<-rev(myColors12[c(9, 5)])
colScale <- scale_fill_manual(name = "Var1",values = myColors12)

#pdf(file="figures/subsahara/4.12_ImportancePracticalApplication_10March18.pdf", height=7, width =11)

ggplot(prac.sub, aes(Var2, Freq, fill=Var1)) + 
  geom_bar(stat="identity", position = "dodge")+geom_text(aes(label=Freq), vjust=-0.7, hjust=0.45, size=3, position = position_dodge(width = 0.95))+
  theme(aspect.ratio=3/4, panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.key=element_blank(),legend.text=element_text(size = 9),
        legend.position=c(0.89, 0.91),
        axis.text.x = element_text(angle=0, vjust=0.5, size = 9), axis.text.y=element_text(size = 9), axis.title.x=element_text(size = 11),
        axis.title.y=element_text(size = 11), plot.title = element_text(hjust = 0.5)) +
  guides(fill=guide_legend(title=NULL, reverse=FALSE)) + 
  scale_x_discrete(labels=c("Mandatory", "Very\n important","Quite\n important", 'Somewhat\n important', 'Not at all\n important', "Can't\n comment"))+
  labs(x="Importance of suggesting practical research applications", y="Number of responses", title="Importance of practical application of research for grant success")+ colScale+
  scale_y_continuous(expand = c(0, 0), limits = c(0,15))
  
#dev.off()
```

```{r echo=FALSE, fig.cap="Fig 4.13 Importance of including partners from for-profit or non-governmental sectors in grant success. Researchers were asked how important it was to include external partnerships in their research to ensure that the grant was successful, in 2006-2010 and in 2011-2015.", fig.width=11, fig.height=7, message=FALSE}

# select for subsaraha countries
part3.part.long.sub<-part3.part.long[part3.part.long$nation%in%subsaharaafrica,]
part3.part.long.sub <- droplevels(part3.part.long.sub)
#check
unique(part3.part.long.sub$nation)


part3.part.long.sub$year<-as.character(part3.part.long.sub$year)

part3.part.long.sub$year[part3.part.long.sub$year=="include_nonacademia_partners_success_11_15"]<-"2011-2015"
part3.part.long.sub$year[part3.part.long.sub$year=="include_nonacademia_partners_success_6_10"]<-"2006-2010"

part.sub<-data.frame(table(part3.part.long.sub$year, part3.part.long.sub$level))
#change order of levels
part.sub$Var2<-factor(part.sub$Var2, levels(part.sub$Var2)[c(2,5,6,4,3,1)])

## add colour scale
myColors13<-(brewer.pal(9, "Blues"))
myColors13<-rev(myColors13[c(9, 5)])
colScale <- scale_fill_manual(name = "Var1",values = myColors13)

#pdf(file="figures/subsahara/4.13_ImportancePartnersApplication_10March18.pdf", height=7, width =11)

ggplot(part.sub, aes(Var2, Freq, fill=Var1))+ 
  geom_bar(stat="identity", position = "dodge")+geom_text(aes(label=Freq), vjust=-0.7, hjust=0.5, size=3, position = position_dodge(width = 0.8))+
    guides(fill=guide_legend(title=NULL, reverse=FALSE)) +
    labs(x="Importance of external partnerships", y="Number of responses", title="Importance of including partners (non-academia) for the success of grant applications")+
  scale_x_discrete(labels=c("Mandatory", "Quite\n important", 'Somewhat\n important',"Not very\n important", 'Not at all\n important', "Can't\n comment"))+
    theme(aspect.ratio=3/4, panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),legend.text=element_text(size = 9),
          legend.key=element_blank(),
          legend.position=c(0.11, 0.93), axis.text.x=element_text(size = 9), axis.text.y=element_text(size=9),
          axis.title.x=element_text(size = 11), axis.title.y=element_text(size = 11), plot.title = element_text(hjust = 0.5)) + colScale+
  scale_y_continuous(expand = c(0, 0), limits = c(0,12))

#dev.off()
```

```{r eval=FALSE, fig.cap="Fig (4.12+4.13) Importance of practical applications and external partnerships.", message=FALSE, warning=FALSE, include=FALSE}

######!!!!!!!!!!!!!!!************ Not updated

###4.12
myColors12<-(brewer.pal(9, "Blues"))
myColors12<-rev(myColors12[c(9, 5)])
colScale <- scale_fill_manual(name = "Var1",values = myColors12)


p10<-ggplot(prac.is, aes(Var2, Freq, fill=Var1)) + 
  geom_bar(stat="identity", position = "dodge")+
  theme(aspect.ratio=3/4, panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.key=element_blank(),
        legend.position=c(0.88, 0.898), legend.text=element_text(size = 9),
        axis.text.x = element_text(angle=0, vjust=0.5, size = 9), axis.text.y=element_text(size = 9), axis.title.x=element_text(size = 11),
        axis.title.y=element_text(size = 11), plot.title = element_text(hjust = 0.5)) +
  guides(fill=guide_legend(title=NULL, reverse=FALSE)) + 
  scale_x_discrete(labels=c("Mandatory", "Very\n important","Quite\n important", 'Somewhat\n important', 'Not at all\n important', "Can't\n comment"))+
  labs(x="", y="Number of responses")+ colScale+
  scale_y_continuous(expand = c(0, 0), limits = c(0,50))+annotate('text', 0.65,423, label="(a)", size=5)
p10

###4.13
myColors13<-(brewer.pal(9, "Blues"))
myColors13<-rev(myColors13[c(9, 5)])
colScale <- scale_fill_manual(name = "Var1",values = myColors13)


p11<-ggplot(part.is, aes(Var2, Freq, fill=Var1))+ 
  geom_bar(stat="identity", position = "dodge")+
    guides(fill=guide_legend(title=NULL, reverse=FALSE)) +
    labs(x="", y="")+
  scale_x_discrete(labels=c("Mandatory", "Quite\n important", 'Somewhat\n important',"Not very\n important", 'Not at all\n important', "Can't\n comment"))+
    theme(aspect.ratio=3/4, panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          legend.key=element_blank(),legend.text=element_text(size = 9),
          legend.position=c(0.13, 0.898), axis.text.x=element_text(size = 9), axis.text.y=element_text(size=9),
          axis.title.x=element_text(size = 11), axis.title.y=element_text(size = 11), plot.title = element_text(hjust = 0.5)) + colScale+
  scale_y_continuous(expand = c(0, 0), limits = c(0,60))+annotate('text', 0.65,460, label="(b)", size=5)
p11

#pdf(file="figures/4.3_13Apr.pdf", width = 11, height= 7)

grid.arrange(p10,p11, heights=c(0.5,0.5), ncol=1)

#dev.off()

```

```{r echo=FALSE, fig.cap="Fig 4.14 Distribution of research funding over the past 10 years. Researchers were asked to estimate the distribution of their research funding sources in 2006-2010 and 2011-2015.", message=FALSE, warning=FALSE, fig.width=11, fig.height=7}
p3_master.long<-read.csv(file="../data/gya-p3_master.long.csv")

# select for subsaraha countries
p3_master.long.sub<-p3_master.long[p3_master.long$nation%in%subsaharaafrica,]
p3_master.long.sub <- droplevels(p3_master.long.sub)
#check
unique(p3_master.long.sub$nation)


##revalue the year values
p3_master.long.sub$year<- revalue(p3_master.long.sub$year, c("11_15"="2011-2015", "6_10"="2006-2010"))
#change order of levels
p3_master.long.sub$year<-factor(p3_master.long.sub$year, levels(p3_master.long.sub$year)[c(2,1)])

##For-Profit
fp.sub<-p3_master.long.sub[p3_master.long.sub$type=="For-Profit",]

myColors14<-(brewer.pal(9, "Blues"))
myColors14<-rev(myColors14[c(9, 5)])
colScale <- scale_fill_manual(name = "year",values = myColors14)

p1<-ggplot(fp.sub, aes(percent, fill=year))+ geom_histogram(position='dodge', binwidth=10)  + colScale +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.922, 0.98), 
          legend.key.size = unit(0.3, "cm"), plot.title = element_text(size=12, hjust = 0.5, face="bold"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), axis.text.x=element_text(size = 9), axis.text.y=element_text(size = 9), legend.key=element_blank(),
          axis.title.x=element_text(size=11), axis.title.y=element_text(size = 11)) +
  labs(list(title= "Industry", x="", y = "Number of responses"))+
  scale_y_continuous(expand =c(0,0),limits=c(0,25), breaks=seq(0, 25, 5))+
  scale_x_continuous( breaks = seq(0, 100, 10))


##Government
gov.sub<-p3_master.long.sub[p3_master.long.sub$type=="Government",]

myColors14<-(brewer.pal(9, "Blues"))
myColors14<-rev(myColors14[c(9, 5)])
colScale <- scale_fill_manual(name = "year",values = myColors14)

p2<-ggplot(gov.sub, aes(percent, fill=year))+ geom_histogram(position='dodge', binwidth=10)  + colScale +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.9, 0.91),
          legend.key.size = unit(0.3, "cm"),plot.title = element_text(size=12, hjust = 0.5, face="bold"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), axis.text.x=element_text(size = 9), axis.text.y=element_text(size = 9), legend.key=element_blank(),
          axis.title.x=element_text(size=11), axis.title.y=element_text(size = 11)) +
  labs(title="Government", x="", y = "")+
  scale_y_continuous(expand =c(0,0), limits=c(0,25), breaks=seq(0, 25, 5))+
  scale_x_continuous( breaks = seq(0, 100, 10))




##Internal

int.sub<-p3_master.long.sub[p3_master.long.sub$type=="Internal",]

myColors14<-(brewer.pal(9, "Blues"))
myColors14<-rev(myColors14[c(9, 5)])
colScale <- scale_fill_manual(name = "year",values = myColors14)

p3<-ggplot(int.sub, aes(percent, fill=year))+ geom_histogram(position='dodge', binwidth=10)  + colScale +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.922, 0.98),
          legend.key.size = unit(0.3, "cm"),plot.title = element_text(size=12, hjust = 0.5, face="bold"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), axis.text.x=element_text(size = 9), axis.text.y=element_text(size = 9), legend.key=element_blank(),
          axis.title.x=element_text(size=11), axis.title.y=element_text(size = 11)) +
  labs(title="Internal",x="% research funding", y = "Number of responses")+
  scale_y_continuous(expand =c(0,0), limits=c(0,25), breaks=seq(0, 25, 5))+
  scale_x_continuous( breaks = seq(0, 100, 10))




##Non-Governmental

ngov.sub<-p3_master.long.sub[p3_master.long.sub$type=="Non-governmental",]

myColors14<-(brewer.pal(9, "Blues"))
myColors14<-rev(myColors14[c(9, 5)])
colScale <- scale_fill_manual(name = "year",values = myColors14)

p4<-ggplot(ngov.sub, aes(percent, fill=year))+ geom_histogram(position='dodge', binwidth=10)  + colScale +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.922, 0.98),
          legend.key.size = unit(0.3, "cm"),plot.title = element_text(size=12, hjust = 0.5, face="bold"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), axis.text.x=element_text(size = 9), axis.text.y=element_text(size = 9), legend.key=element_blank(),
          axis.title.x=element_text(size=11), axis.title.y=element_text(size = 11)) +
  labs(title="Non-governmental", x="% research funding", y = "")+
  scale_y_continuous(expand =c(0,0), limits=c(0,25), breaks=seq(0, 25, 5))+
  scale_x_continuous( breaks = seq(0, 100, 10))



## Other

other.sub<-p3_master.long.sub[p3_master.long.sub$type=="Other",]

myColors14<-(brewer.pal(9, "Blues"))
myColors14<-rev(myColors14[c(9, 5)])
colScale <- scale_fill_manual(name = "year",values = myColors14)

p5<-ggplot(other.sub, aes(percent, fill=year))+ geom_histogram(position='dodge', binwidth=10)  + colScale +
   guides(fill=guide_legend(title=NULL)) +
    theme(legend.position=c(0.8, 0.91),
          legend.key.size = unit(0.3, "cm"),plot.title = element_text(size=12, hjust = 0.5, face="bold"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), axis.text.x=element_text(size = 9), axis.text.y=element_text(size = 9), legend.key=element_blank(),
          axis.title.x=element_text(size=11), axis.title.y=element_text(size = 11)) +
  labs(title="Other", x="% research funding", y = "")+
  scale_y_continuous(expand =c(0,0), limits=c(0,25), breaks=seq(0, 25, 5))+
  scale_x_continuous( breaks = seq(0, 100, 10))

##put them all together

legend = gtable_filter(ggplotGrob(p1), "guide-box") 
grid.draw(legend)

#pdf(file="figures/subsahara/4.14_DistributionFunding_10March18.pdf", height=7, width =11)

grid.arrange(arrangeGrob(p1+ theme(legend.position="none"), p2,
                         p3+ theme(legend.position="none"), p4+ theme(legend.position="none"),
                         p5,
                         layout_matrix=rbind(c(1,1,1,2,2,2),c(3,3,4,4,5,5))), top=textGrob("Distribution of research funding",gp=gpar(fontsize=17)))

#dev.off()

```


<!--Part 4 - Funding Trends in your country of work-->
<!--**4.4 Perspectives on the State of Fundamental Research**-->

```{r echo=FALSE, fig.cap="Fig 4.15 Perceived importance of fundamental research to their government. Researchers were asked how important they thought fundamental research was to the their government. Responses were/were not significantly different between genders.", message=FALSE,fig.width=11, fig.height=7, warning=FALSE}
# select for subsaraha countries
part4.sub<-part4[part4$nation%in%subsaharaafrica,]
part4.sub <- droplevels(part4.sub)
#check
unique(part4.sub$nation)

## order bars from very important (left) to can't comment (right)
important.sub<-subset(part4.sub, select=c("Location","Country","nation",'Country_work', "gender","opinion_fundamental_important"))

## using table to count cases of each category
sum.important.sub<-data.frame(table(important.sub$opinion_fundamental_important))
# remove non-responses
sum.important.sub<-sum.important.sub[!sum.important.sub$Var1=="",]
sum.important.sub$Var1<-factor(sum.important.sub$Var1, levels(sum.important.sub$Var1)[c(6,5,4,3,2,1)])

perceive.sub<-aggregate(Freq~Var1, sum.important.sub, sum)

### colour palette

myColors15<-(brewer.pal(9, "Blues"))
myColors15<-(myColors15[c(4,4,4,4,4,4)])
colScale <- scale_fill_manual(name = "Var1",values = myColors15)

#pdf(file="figures/subsahara/4.15_PerceivedImportanceFundamentalGovernment_10March18.pdf", height=7, width =11)

ggplot(data=perceive.sub, aes(x=Var1, y=Freq, fill=Var1)) + 
      geom_bar(stat='identity', position='dodge')+ 
      labs(x="", y="Number of responses", fill="", title="Perceived importance of fundamental research to their government")+
      scale_x_discrete(labels=c("Very\n important", "Somewhat\n important", 'Not very\n important', 'Not at all\n important', "Can't\n comment"))+
      geom_text(aes(label=Freq, vjust=-0.5), size=3) + guides(fill=FALSE)+
      theme(aspect.ratio=3/4, axis.text.x = element_text(angle=0, vjust=0.4, size=9),
            panel.grid.major = element_blank(), 
            panel.grid.minor = element_blank(), axis.title.y=element_text(size=11), axis.text.y=element_text(size=9), plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0,12)) + colScale

#dev.off()
```

```{r echo=FALSE, fig.cap="Fig 4.16 Perceived change in research priority by their government. Researchers were asked whether any types of research had become higher priority for the their government. Responses were/were not significantly different between genders.", message=FALSE,fig.width=11, fig.height=7, warning=FALSE}
# select for subsaraha countries
part4.sub<-part4[part4$nation%in%subsaharaafrica,]
part4.sub <- droplevels(part4.sub)
#check
unique(part4.sub$nation)
## order bars into applied > use > fundamental > no change
priority.sub<-subset(part4.sub, select=c("Location","Country",'Country_work', "gender", "high_priority_fundamental", "high_priority_use_inspired", "high_priority_applied", "high_priority_no_change"))

## switch to long format
priority.long.sub<-gather(priority.sub, what.type, higher.priority, -Location, -gender, -Country, -Country_work)
# remove non-responses (n = 1066)
priority.long.sub<-priority.long.sub[!priority.long.sub$higher.priority=="",]
per.change.sub<-aggregate(higher.priority~what.type, priority.long.sub, sum)

# change order of the levels
per.change.sub$what.type<-as.factor(per.change.sub$what.type)
per.change.sub$what.type<-factor(per.change.sub$what.type, levels(per.change.sub$what.type)[c(2,4,1,3)])

myColors16<-(brewer.pal(9, "Blues"))
myColors16<-(myColors16[c(4,4,4,4,4,4)])
colScale <- scale_fill_manual(name = "Var1",values = myColors16)

#pdf(file="figures/subsahara/4.16_PerceivedChangeResearchPriorityGovernment_10March18.pdf", height=7, width =11)

ggplot(data=per.change.sub, aes(x=what.type, higher.priority, fill=what.type))+
        geom_bar(stat="identity", position='dodge')+ guides(fill=FALSE)+
        theme(aspect.ratio=3/4, 
              axis.text.x = element_text(angle=0, vjust=0.4, size=9),
              panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(), axis.title.y=element_text(size=11),  axis.text.y=element_text(size=9), plot.title = element_text(hjust = 0.5)) +
        labs(x="", y="Number of responses", fill="", title="Perceived change in reserach priority by their government") +
  scale_x_discrete(labels=c( "Fundamental", "Use-inspired","Applied", "No change"))   +
  geom_text(aes(label=higher.priority, vjust=-0.5), size=3) +scale_y_continuous(expand = c(0, 0), limits = c(0,22))+ colScale

#dev.off()
```


```{r echo=FALSE, fig.cap="Fig 4.17 Anticipated change in research funding in next five years. Researchers were asked whether the availability of research funding would change in the next five years.", message=FALSE, warning=FALSE, fig.width=11, fig.height=7}
# select for subsaraha countries
part4.sub<-part4[part4$nation%in%subsaharaafrica,]
part4.sub <- droplevels(part4.sub)
#check
unique(part4.sub$nation)
## change in funding on the x-axis, and colours = type of research
## order bars into increase considerably (left) to decrease considerably (right), then no comment at the far right
availability.change.sub<-subset(part4.sub, select=c("Location", "Country",'Country_work', "gender", "available_funding_fundamental",  
                                             "available_funding_use_inspired", "available_funding_applied"))
## switch to long format
availability.change.long.sub<-gather(availability.change.sub, what.type, level, -gender, -Location, -Country, -Country_work)
availability.sub<-with(availability.change.long.sub, data.frame(table(what.type, level)))

#remove non response
availability.sub<-availability.sub[!availability.sub$level=="",]

## change type to factor with levels
availability.sub$level<-str_replace_all(availability.sub$level, "Will ", "")
availability.sub$what.type<-as.factor(availability.sub$what.type)
availability.sub$level<-as.factor(availability.sub$level)

## change order of levels
availability.sub$level<-factor(availability.sub$level, levels(availability.sub$level)[c(4,5,6,3,2,1 )])
availability.sub$what.type<-factor(availability.sub$what.type, levels(availability.sub$what.type)[c(2,3,1)])

availability.sub$what.type<-revalue(availability.sub$what.type, c("available_funding_fundamental"="Fundamental",
              'available_funding_use_inspired'='Use-inspired', 'available_funding_applied' = 'Applied'))

### colour palette

myColors17<-mycols<-c('#1f78b4','#33a02c','#e31a1c')
colScale <- scale_fill_manual(name = "what.type",values = myColors17)

#pdf(file="figures/subsahara/4.17_AnticipatedChangeFunding_10March18.pdf", height=7, width =11)

ggplot(data=availability.sub, aes(x=level, Freq, fill=what.type))+
    geom_bar(stat="identity", position="dodge")+
    theme(aspect.ratio=1/4, axis.text.x = element_text(angle=0, vjust=0.5, size = 9),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
           strip.text.x = element_text(size=12, face="bold", color="black"),
          strip.background = element_rect(colour="white", fill="white"),
          legend.position=c(0.8, 0.2), axis.title.y=element_text(size=11), axis.text.y=element_text(size=9), plot.title = element_text(hjust = 0.5)) +
    guides(fill=FALSE)+
    labs(x="", y="Number of responses", fill="", title="Anticipated change in research funding")+
    scale_x_discrete(labels=c("Increase\n considerably", "Increase\n slightly", 
                                    "Stay the same", "Decrease\n slightly", "Decrease\n considerably", "Can't\n comment"))+
    facet_wrap(~what.type,nrow=3)+
    geom_text(aes(label=Freq), vjust=-0.5, size=2.8) + colScale +
  scale_y_continuous(expand = c(0, 0), limits = c(0,14), breaks = seq(0,14,2))

#dev.off()


```

```{r echo=FALSE, fig.cap="Fig 4.18 Effect of change in research funding on research careers of next generation. Researchers were asked if they though that changes in funding availability would influence the likelihood of the next generation pursuing careers in research. Responses were/were not significantly different between genders.", message=FALSE, warning=FALSE, fig.width=11, fig.height=7}
# select for subsaraha countries
part4.sub<-part4[part4$nation%in%subsaharaafrica,]
part4.sub <- droplevels(part4.sub)
#check
unique(part4.sub$nation)
## order bars into increase considerably (left) to decrease considerably (right), then no comment at the far right
next.generation.sub<-subset(part4.sub, select=c("Location", "Country","Country_work", "gender","next_generation"))
# remove non-response
next.generation.sub<-next.generation.sub[!next.generation.sub$next_generation=="",]

impact.sub<-data.frame(table(next.generation.sub$next_generation))

## change type to factor with levels
impact.sub$Var1<-str_replace_all(impact.sub$Var1, "Will ", "")
impact.sub$Var1<-as.factor(impact.sub$Var1)
impact.sub<-impact.sub[!impact.sub$Var1=="",]
impact.sub<-droplevels(impact.sub)
## change order of Var1s
impact.sub$Var1<-factor(impact.sub$Var1, levels(impact.sub$Var1)[c(4,5,6,3,2,1)])
 
myColors18<-(brewer.pal(9, "Blues"))
myColors18<-(myColors18[c(4,4,4,4,4,4)])
colScale <- scale_fill_manual(name = "Var1",values = myColors18)

#pdf(file="figures/subsahara/4.18_EffectNextGeneration_10March18.pdf", height=7, width =11)

ggplot(data=impact.sub, aes(x=Var1, Freq, fill=Var1))+ 
    geom_bar(stat='identity', position="dodge")  +
        scale_x_discrete(labels=c("Increase\n considerably", "Increase\n slightly", 
                                    "Stay the same", "Decrease\n slightly", "Decrease\n considerably", "Can't\n comment"))+
    guides(fill=FALSE) +
 labs(x="", y="Number of responses", title="Effect of funding changes on the next generation of researchers")+
  theme(aspect.ratio=3/4, axis.text.x = element_text(angle=0, vjust=0.5, size=9),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
          axis.title.y=element_text(size=11), axis.text.y=element_text(size=9), plot.title = element_text(hjust = 0.5))+
  geom_text(aes(label=Freq, vjust=-0.5), size=3)+
  scale_y_continuous(expand = c(0, 0), limits = c(0,10), breaks = c(0,2,4,6,8,10))+colScale

#dev.off()
```
